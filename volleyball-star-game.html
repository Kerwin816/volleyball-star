<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>排球之星 - 从菜鸟到冠军</title>
    
    <!-- SEO优化 -->
    <meta name="description" content="体验从大一新生到市级冠军的排球之旅！训练、比赛、成长，书写你的排球传奇！">
    <meta name="keywords" content="排球游戏,文字冒险,体育游戏,成长游戏,排球之星">
    <meta name="author" content="小水">
    
    <!-- 微信分享优化 -->
    <meta property="og:title" content="排球之星 - 从菜鸟到冠军的成长之路" />
    <meta property="og:description" content="体验从大一新生到市级冠军的排球之旅！训练、比赛、成长，书写你的排球传奇！" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://via.placeholder.com/1200x630/667eea/ffffff?text=排球之星" />
    
    <!-- 移动端优化 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="排球之星">
    <meta name="theme-color" content="#667eea">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        #game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }
        
        #game-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            text-align: center;
            display: none;
        }
        
        #game-header.show {
            display: block;
        }
        
        #game-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        #current-goal {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        #current-goal h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        
        #current-goal p {
            margin: 3px 0;
        }
        
        .goal-requirement {
            color: #fff;
            font-weight: bold;
        }
        
        .goal-met {
            color: #2ecc71;
        }
        
        .goal-not-met {
            color: #ffeb3b;
        }
        
        #event-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        #event-modal.show {
            display: flex;
        }
        
        #event-modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        #event-modal-content h2 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        #event-modal-content p {
            line-height: 1.8;
            margin-bottom: 20px;
        }
        
        #event-modal-choices {
            display: grid;
            gap: 10px;
        }
        
        /* 比赛弹窗样式 */
        #match-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        #match-modal.show {
            display: flex;
        }
        
        #match-modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        #match-modal-content h2 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #match-score-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        #match-log {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .match-log-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            animation: slideIn 0.3s ease-out;
            opacity: 0;
            animation-fill-mode: forwards;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .match-log-item.my-point {
            border-left: 4px solid #2ecc71;
            background: rgba(46, 204, 113, 0.2);
        }
        
        .match-log-item.opponent-point {
            border-left: 4px solid #e74c3c;
            background: rgba(231, 76, 60, 0.2);
        }
        
        .match-log-score {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .match-log-description {
            color: #ddd;
            font-size: 14px;
        }
        
        #match-modal-choices {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* 目标面板样式 */
        #goals-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        
        #goals-panel.show {
            display: flex;
        }
        
        #goals-panel-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        #goals-panel-content h2 {
            color: white;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .goal-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid;
        }
        
        .goal-card.current {
            border-left-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }
        
        .goal-card.next {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.15);
        }
        
        .goal-card.future {
            border-left-color: #9E9E9E;
            background: rgba(158, 158, 158, 0.1);
        }
        
        .goal-card.completed {
            border-left-color: #2196F3;
            background: rgba(33, 150, 243, 0.15);
            opacity: 0.7;
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .goal-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .goal-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .goal-badge.current {
            background: #ffd700;
            color: #333;
        }
        
        .goal-badge.next {
            background: #4CAF50;
            color: white;
        }
        
        .goal-badge.completed {
            background: #2196F3;
            color: white;
        }
        
        .goal-description {
            margin: 10px 0;
            font-size: 14px;
            color: #ddd;
        }
        
        .goal-requirements {
            margin: 15px 0;
        }
        
        .goal-requirements h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .requirement-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 13px;
        }
        
        .requirement-met {
            color: #4CAF50;
        }
        
        .requirement-not-met {
            color: #ff6b6b;
        }
        
        .goal-tips {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            font-size: 12px;
            color: #ddd;
        }
        
        .tab-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        #stats-bar {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }

        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }
        
        #game-content {
            padding: 30px;
        }
        
        #story-text {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 150px;
            line-height: 1.8;
            font-size: 16px;
        }
        
        #choices {
            display: grid;
            gap: 10px;
        }
        
        /* 课余生活分类布局 */
        .life-categories {
            display: grid;
            gap: 20px;
        }
        
        .life-category {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid;
        }
        
        .life-category.sports {
            border-left-color: #ff6b6b;
        }
        
        .life-category.rest {
            border-left-color: #4ecdc4;
        }
        
        .life-category.social {
            border-left-color: #95e1d3;
        }
        
        .life-category.shopping {
            border-left-color: #ffd93d;
        }
        
        .life-category.work {
            border-left-color: #6c5ce7;
        }
        
        .category-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .category-choices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .life-choice-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .life-choice-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .life-choice-card:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .life-choice-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .life-choice-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .life-choice-effects {
            font-size: 11px;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .choice-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            text-align: left;
        }
        
        .choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .choice-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* 职业选择卡片样式 */
        .position-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .position-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }
        
        .position-card:hover:not(.disabled) {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .position-card.disabled {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .position-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .position-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .position-desc {
            font-size: 13px;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .position-skills {
            font-size: 12px;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        
        .position-requirements {
            font-size: 11px;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            line-height: 1.6;
        }
        
        .position-restrictions {
            font-size: 10px;
            margin-top: 8px;
            padding: 5px;
            background: rgba(255,100,100,0.3);
            border-radius: 5px;
            color: #ffeb3b;
        }
        
        .position-locked {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .position-cards {
                grid-template-columns: 1fr;
            }
        }

        
        #character-panel {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        #character-panel.show {
            display: block;
        }
        
        .skills-container {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 15px;
        }
        
        .skills-left {
            flex: 1;
            min-width: 0;
        }
        
        .skills-right {
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .skills-container {
                flex-direction: column;
            }
            
            .skills-left {
                width: 100%;
            }
        }
        
        #name-input-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        #name-input-panel h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        #name-input-panel input {
            width: calc(100% - 60px);
            padding: 15px;
            font-size: 18px;
            border: 2px solid #667eea;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s;
            display: inline-block;
        }
        
        #name-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #random-name-btn {
            background: #f093fb;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        #random-name-btn:hover {
            background: #e082ea;
            transform: rotate(360deg) scale(1.1);
        }
        
        #initial-attributes {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        #initial-attributes h3 {
            text-align: center;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .init-attr-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .init-attr-item:last-child {
            border-bottom: none;
        }
        
        .init-attr-value {
            font-weight: bold;
            color: #667eea;
        }
        
        .init-attr-rating {
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #667eea;
            font-weight: bold;
            color: #f5576c;
        }
        
        #reroll-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        #reroll-btn {
            background: #f093fb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #reroll-btn:hover:not(:disabled) {
            background: #e082ea;
            transform: scale(1.05);
        }
        
        #reroll-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #reroll-count {
            color: #666;
            font-size: 14px;
        }
        
        #name-input-panel button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #name-input-panel button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .hidden {
            display: none;
        }
        
        .attribute-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .attribute-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .attribute-item:last-child {
            border-bottom: none;
        }
        
        .attribute-value {
            font-weight: bold;
            color: #667eea;
        }
        
        .skill-bar {
            margin: 10px 0;
        }
        
        .skill-name {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .progress-bar {
            background: #dee2e6;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            height: 100%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* 开发者署名 */
        .developer-credit {
            text-align: center;
            padding: 15px;
            font-size: 11px;
            color: #999;
            opacity: 0.6;
            margin-top: 20px;
            border-top: 1px solid #eee;
        }
        
        /* 分享按钮 */
        .share-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .share-btn:active {
            transform: translateY(0);
        }
        
        @media (max-width: 768px) {
            .share-btn {
                bottom: 15px;
                right: 15px;
                padding: 10px 16px;
                font-size: 13px;
            }
        }
        
        /* 跳过按钮 */
        .skip-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .skip-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .skip-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>🏐 排球之星</h1>
                <button id="goals-tab-btn" class="tab-btn" onclick="game.toggleGoalsPanel()">🎯 目标</button>
            </div>
            <div id="current-goal">
                <h3>📍 当前目标</h3>
                <p id="goal-text">加载中...</p>
            </div>
            <div id="stats-bar">
                <div class="stat">
                    <span class="stat-label">周次</span>
                    <span class="stat-value" id="week">1</span>
                </div>
                <div class="stat">
                    <span class="stat-label">训练</span>
                    <span class="stat-value" id="training-count">0/3</span>
                </div>

                <div class="stat">
                    <span class="stat-label">体力</span>
                    <span class="stat-value" id="energy">100</span>
                </div>
                <div class="stat">
                    <span class="stat-label">心情</span>
                    <span class="stat-value" id="mood">80</span>
                </div>
                <div class="stat">
                    <span class="stat-label">压力</span>
                    <span class="stat-value" id="stress">20</span>
                </div>
                <div class="stat">
                    <span class="stat-label">声望</span>
                    <span class="stat-value" id="reputation">10</span>
                </div>
                <div class="stat">
                    <span class="stat-label">金钱</span>
                    <span class="stat-value" id="money">100</span>
                </div>
                <div class="stat">
                    <span class="stat-label">队伍</span>
                    <span class="stat-value" id="team">无</span>
                </div>
                <div class="stat" id="position-stat" style="display: none;">
                    <span class="stat-label">职业</span>
                    <span class="stat-value" id="position">未选择</span>
                </div>
            </div>
        </div>
        
        <div id="game-content">
            <div id="character-panel">
                <h3>📊 能力值</h3>
                <div class="skills-container">
                    <div class="skills-left">
                        <div class="skill-bar">
                            <div class="skill-name">
                                <span>发球</span>
                                <span id="serve-value">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="serve-bar" style="width: 0%">0</div>
                            </div>
                        </div>
                        <div class="skill-bar">
                            <div class="skill-name">
                                <span>扣球</span>
                                <span id="spike-value">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="spike-bar" style="width: 0%">0</div>
                            </div>
                        </div>
                        <div class="skill-bar">
                            <div class="skill-name">
                                <span>拦网</span>
                                <span id="block-value">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="block-bar" style="width: 0%">0</div>
                            </div>
                        </div>
                        <div class="skill-bar">
                            <div class="skill-name">
                                <span>垫球</span>
                                <span id="dig-value">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="dig-bar" style="width: 0%">0</div>
                            </div>
                        </div>
                        <div class="skill-bar">
                            <div class="skill-name">
                                <span>托球</span>
                                <span id="set-value">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="set-bar" style="width: 0%">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="skills-right">
                        <canvas id="skills-radar" width="260" height="260"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="story-text"></div>
            <div id="choices"></div>
        </div>
        
        <!-- 开发者署名 -->
        <div class="developer-credit">开发者：小水</div>
    </div>
    
    <!-- 分享按钮 -->
    <button class="share-btn" onclick="shareGame()">
        <span>📤</span>
        <span>分享游戏</span>
    </button>
    
    <!-- 事件弹窗 -->
    <div id="event-modal">
        <div id="event-modal-content">
            <h2 id="event-modal-title">事件</h2>
            <p id="event-modal-text"></p>
            <div id="event-modal-choices"></div>
        </div>
    </div>
    
    <!-- 比赛弹窗 -->
    <div id="match-modal">
        <div id="match-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="match-modal-title" style="margin: 0;">🏐 比赛进行中</h2>
                <button id="skip-match-btn" class="skip-btn" onclick="game.skipMatch()">⏭️ 跳过</button>
            </div>
            <div id="match-score-display">
                <span id="my-score">0</span>
                <span style="margin: 0 20px;">:</span>
                <span id="opponent-score">0</span>
            </div>
            <div id="match-log"></div>
            <div id="match-modal-choices"></div>
        </div>
    </div>
    
    <!-- 目标面板 -->
    <div id="goals-panel">
        <div id="goals-panel-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>🎯 成长目标</h2>
                <button class="close-btn" onclick="game.toggleGoalsPanel()">✕</button>
            </div>
            <div id="goals-list"></div>
        </div>
    </div>

    <script>
        // 姓氏库
        const SURNAMES = [
            // 常见单姓
            '张', '王', '李', '刘', '陈', '杨', '黄', '赵', '吴', '周',
            '徐', '孙', '马', '朱', '胡', '郭', '何', '林', '高', '罗',
            '郑', '梁', '谢', '宋', '唐', '许', '韩', '冯', '邓', '曹',
            '彭', '曾', '肖', '田', '董', '袁', '潘', '于', '蒋', '蔡',
            // 复姓
            '欧阳', '司马', '上官', '诸葛', '东方', '独孤', '南宫', '西门',
            '慕容', '轩辕', '令狐', '皇甫', '公孙', '澹台'
        ];
        
        // 名字库（排球/运动相关）
        const GIVEN_NAMES = [
            // 排球技术相关
            '发球', '扣杀', '拦网', '防守', '传球', '垫球', '飘球', '跳发',
            '暴扣', '轻吊', '快攻', '强攻', '后攻', '跳飘', '救球', '一传',
            
            // 运动特质相关
            '如风', '似电', '破空', '凌云', '冲天', '惊雷', '闪电', '疾风',
            '翱翔', '腾跃', '飞扬', '奔雷', '追风', '逐日', '破浪', '凌空',
            
            // 励志相关
            '必胜', '争先', '超越', '拼搏', '奋进', '向前', '冲锋', '突破',
            '登峰', '夺冠', '称霸', '无敌', '制霸', '王者', '霸主', '至尊',
            
            // 品质相关
            '坚韧', '刚毅', '勇猛', '果敢', '无畏', '英勇', '威武', '神勇',
            '灵动', '敏捷', '迅捷', '矫健', '强健', '雄壮', '威猛', '刚强',
            
            // 谐音梗（更像名字）
            '球胜', '网罗', '排云', '跃进', '高飞', '远志', '凌峰', '震天',
            '惊鸿', '绝尘', '无双', '独秀', '出众', '超群', '卓越', '非凡',
            
            // 单字名
            '跃', '飞', '翔', '腾', '冲', '闯', '拼', '搏',
            '强', '刚', '勇', '威', '猛', '锐', '峰', '杰',
            '灵', '敏', '捷', '快', '迅', '疾', '速', '风'
        ];
        
        // 生成随机名字
        function generateRandomName() {
            const surname = SURNAMES[Math.floor(Math.random() * SURNAMES.length)];
            const givenName = GIVEN_NAMES[Math.floor(Math.random() * GIVEN_NAMES.length)];
            return surname + givenName;
        }
        
        // 随机事件库（扩展版）
        const RANDOM_EVENTS = [
            // 训练相关事件
            {
                id: 'senior_guidance',
                type: 'training',
                title: '🎓 学长指导',
                text: '训练时，一位学长注意到了你，主动过来指导你的动作。',
                choices: [
                    {
                        text: '虚心请教，认真学习',
                        effect: { serve: 3, spike: 3, mood: 5, reputation: 2 },
                        result: '学长很高兴，教了你一些技巧，你的技能有所提升！'
                    },
                    {
                        text: '礼貌感谢，自己琢磨',
                        effect: { mood: 2, stress: -2 },
                        result: '你保持了自己的训练节奏。'
                    }
                ]
            },
            {
                id: 'injury_risk',
                type: 'training',
                title: '⚠️ 训练意外',
                text: '训练强度有点大，你感觉身体有些不适...',
                condition: { energy: 30, operator: '<' },
                weight: 3,
                choices: [
                    {
                        text: '坚持完成训练',
                        effect: { serve: 2, spike: 2, energy: -10, stress: 5 },
                        result: '你咬牙坚持了下来，技能有所提升，但很疲惫。'
                    },
                    {
                        text: '适当休息，保护身体',
                        effect: { energy: 5, mood: 3, stress: -3 },
                        result: '你明智地选择了休息，身体恢复了一些。'
                    }
                ]
            },
            {
                id: 'coach_praise',
                type: 'training',
                title: '👍 教练表扬',
                text: '教练注意到你最近的进步，当众表扬了你！',
                choices: [
                    {
                        text: '谦虚回应，继续努力',
                        effect: { mood: 8, reputation: 3, stress: -3 },
                        result: '你的谦虚赢得了大家的好感。'
                    },
                    {
                        text: '信心大增，加练一会',
                        effect: { serve: 3, spike: 3, energy: -8, mood: 10 },
                        result: '你趁热打铁，又练了一会儿，收获满满！'
                    }
                ]
            },
            {
                id: 'teammate_competition',
                type: 'training',
                title: '🔥 队友切磋',
                text: '一位队友向你发起友好的技术切磋。',
                choices: [
                    {
                        text: '全力应战',
                        effect: { spike: 4, dig: 2, set: 2, energy: -10, mood: 8, relationship: 3 },
                        result: '激烈的对抗让你们都有所收获，友谊也加深了！'
                    },
                    {
                        text: '婉拒，保存体力',
                        effect: { energy: 5, stress: -2 },
                        result: '你选择了休息，保存体力。'
                    }
                ]
            },
            
            // 生活相关事件
            {
                id: 'meet_friend',
                type: 'life',
                title: '👋 偶遇朋友',
                text: '在食堂遇到了老朋友，他邀请你一起吃饭聊天。',
                choices: [
                    {
                        text: '愉快聊天，分享近况',
                        effect: { mood: 10, stress: -5, money: -15 },
                        result: '你们聊得很开心，心情舒畅了许多！'
                    },
                    {
                        text: '简单寒暄，各自离开',
                        effect: { mood: 2 },
                        result: '你们简单聊了几句就分开了。'
                    }
                ]
            },
            {
                id: 'study_pressure',
                type: 'life',
                title: '📝 课业压力',
                text: '突然想起明天有个作业要交，还没开始做...',
                choices: [
                    {
                        text: '熬夜赶作业',
                        effect: { energy: -15, mood: -5, stress: 8, reputation: 2 },
                        result: '你熬夜完成了作业，但很疲惫。'
                    },
                    {
                        text: '先休息，明早早起做',
                        effect: { energy: 10, stress: 3 },
                        result: '你选择了先休息，明天再说。'
                    },
                    {
                        text: '找同学借鉴一下',
                        effect: { mood: 5, stress: -5, relationship: -2 },
                        result: '同学帮了你，但你有点不好意思。'
                    }
                ]
            },
            {
                id: 'lucky_money',
                type: 'life',
                title: '💰 意外之财',
                text: '在路上捡到了一些钱！',
                choices: [
                    {
                        text: '交给失物招领处',
                        effect: { mood: 5, reputation: 5 },
                        result: '你做了正确的事，心里很踏实。'
                    },
                    {
                        text: '自己留着用',
                        effect: { money: 30, mood: 8, stress: 2 },
                        result: '你把钱留下了，但心里有点不安。'
                    }
                ]
            },
            {
                id: 'club_activity',
                type: 'life',
                title: '🎉 社团活动',
                text: '排球社团组织聚餐活动，邀请你参加。',
                choices: [
                    {
                        text: '积极参加',
                        effect: { mood: 15, stress: -8, money: -30, relationship: 8 },
                        result: '聚餐很愉快，你和队友们的关系更近了！'
                    },
                    {
                        text: '婉拒邀请',
                        effect: { energy: 10, money: 10 },
                        result: '你选择了休息，省下了一笔开销。'
                    }
                ]
            },
            {
                id: 'equipment_sale',
                type: 'life',
                title: '🛍️ 装备促销',
                text: '体育用品店在打折，有一双很不错的排球鞋。',
                choices: [
                    {
                        text: '买下来（花费80元）',
                        effect: { money: -80, mood: 12, serve: 2, spike: 2 },
                        requirement: { money: 80 },
                        result: '新鞋很舒适，训练效果更好了！'
                    },
                    {
                        text: '不买，省钱',
                        effect: { mood: -3 },
                        result: '你忍住了购买的冲动。'
                    }
                ]
            },
            {
                id: 'weather_good',
                type: 'life',
                title: '☀️ 好天气',
                text: '今天天气特别好，阳光明媚，心情舒畅。',
                choices: [
                    {
                        text: '出去散散步',
                        effect: { mood: 10, stress: -5, energy: 5 },
                        result: '你享受了美好的天气，神清气爽！'
                    },
                    {
                        text: '在宿舍休息',
                        effect: { energy: 8, mood: 3 },
                        result: '你在宿舍好好休息了一下。'
                    }
                ]
            },
            
            // 新增事件 - 基于属性触发
            {
                id: 'serious_injury',
                type: 'training',
                title: '🚑 运动损伤',
                text: '糟糕！训练时你不小心扭伤了脚踝，疼痛难忍...',
                condition: { energy: 20, operator: '<' },
                weight: 5,
                choices: [
                    {
                        text: '立即去医务室（花费50元）',
                        effect: { energy: -5, mood: -10, stress: 5, money: -50 },
                        requirement: { money: 50 },
                        result: '医生给你做了处理，需要休息几天。'
                    },
                    {
                        text: '忍一忍，自己处理',
                        effect: { energy: -15, mood: -15, stress: 10, serve: -2, spike: -2 },
                        result: '伤势加重了，影响了你的状态和技能...'
                    }
                ]
            },
            {
                id: 'perfect_state',
                type: 'training',
                title: '✨ 完美状态',
                text: '今天状态特别好，感觉浑身充满力量！',
                condition: { energy: 80, mood: 70, operator: '>' },
                weight: 4,
                choices: [
                    {
                        text: '抓住机会，强化训练',
                        effect: { serve: 6, spike: 6, block: 6, dig: 3, set: 3, energy: -20, mood: 10 },
                        result: '你充分利用了这个状态，技能大幅提升！'
                    },
                    {
                        text: '正常训练即可',
                        effect: { serve: 3, spike: 3, energy: -10, mood: 5 },
                        result: '你完成了正常的训练。'
                    }
                ]
            },
            {
                id: 'technique_breakthrough',
                type: 'training',
                title: '💡 技术突破',
                text: '训练中你突然领悟了一个新技巧！',
                choices: [
                    {
                        text: '反复练习，巩固技巧',
                        effect: { serve: 5, spike: 5, energy: -15, mood: 12 },
                        result: '你把新技巧练得很熟练了！'
                    },
                    {
                        text: '记在心里，下次再练',
                        effect: { serve: 2, spike: 2, mood: 5 },
                        result: '你记住了这个技巧。'
                    }
                ]
            },
            {
                id: 'equipment_broken',
                type: 'training',
                title: '💔 装备损坏',
                text: '训练时你的球鞋开胶了，影响了训练效果。',
                choices: [
                    {
                        text: '马上去买新的（花费100元）',
                        effect: { money: -100, mood: -5, serve: 3, spike: 3 },
                        requirement: { money: 100 },
                        result: '新鞋很合脚，训练效果更好了！'
                    },
                    {
                        text: '凑合着用',
                        effect: { mood: -8, serve: -2, spike: -2 },
                        result: '破鞋影响了你的发挥...'
                    }
                ]
            },
            {
                id: 'depression',
                type: 'life',
                title: '😔 情绪低落',
                text: '最近心情一直不太好，感觉有些抑郁...',
                condition: { mood: 30, operator: '<' },
                weight: 4,
                choices: [
                    {
                        text: '找朋友倾诉',
                        effect: { mood: 15, stress: -10, relationship: 5 },
                        result: '朋友的安慰让你感觉好多了。'
                    },
                    {
                        text: '自己调节，出去走走',
                        effect: { mood: 8, stress: -5, energy: -5 },
                        result: '散步让你的心情稍微好了一些。'
                    },
                    {
                        text: '一个人待着',
                        effect: { mood: -5, stress: 5 },
                        result: '你独自待了一会儿，但心情没有好转。'
                    }
                ]
            },
            {
                id: 'stress_overload',
                type: 'life',
                title: '😰 压力爆表',
                text: '压力太大了，你感觉快要崩溃了...',
                condition: { stress: 80, operator: '>' },
                weight: 5,
                choices: [
                    {
                        text: '放下一切，好好休息',
                        effect: { stress: -20, mood: 10, energy: 15 },
                        result: '你给自己放了个假，感觉轻松多了。'
                    },
                    {
                        text: '找心理咨询（花费50元）',
                        effect: { stress: -25, mood: 8, money: -50 },
                        requirement: { money: 50 },
                        result: '专业的帮助让你释放了压力。'
                    },
                    {
                        text: '继续硬撑',
                        effect: { stress: 5, mood: -10, energy: -10 },
                        result: '你的状态越来越差...'
                    }
                ]
            },
            {
                id: 'broke',
                type: 'life',
                title: '💸 手头紧张',
                text: '钱快花光了，这周的生活费不够用了...',
                condition: { money: 50, operator: '<' },
                weight: 4,
                choices: [
                    {
                        text: '找兼职打工',
                        effect: { money: 100, energy: -20, stress: 5, mood: -5 },
                        result: '你辛苦打工赚了些钱。'
                    },
                    {
                        text: '向家里要钱',
                        effect: { money: 200, mood: -5, stress: 3 },
                        result: '家里给你打了钱，但你有些愧疚。'
                    },
                    {
                        text: '节衣缩食',
                        effect: { mood: -8, energy: -5 },
                        result: '你开始省吃俭用。'
                    }
                ]
            },
            {
                id: 'scholarship',
                type: 'life',
                title: '🎓 奖学金通知',
                text: '你获得了学校的奖学金！',
                condition: { reputation: 50, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '开心接受',
                        effect: { money: 300, mood: 20, reputation: 5 },
                        result: '这是对你努力的认可！'
                    }
                ]
            },
            {
                id: 'love_confession',
                type: 'life',
                title: '💕 有人表白',
                text: '一位同学向你表白了！',
                condition: { reputation: 60, operator: '>' },
                weight: 1,
                choices: [
                    {
                        text: '接受，开始恋爱',
                        effect: { mood: 25, stress: -15, energy: -5, money: -50 },
                        result: '你们在一起了，感觉很幸福！'
                    },
                    {
                        text: '婉拒，专注排球',
                        effect: { mood: -5, stress: 5, serve: 3, spike: 3 },
                        result: '你选择了专注于排球事业。'
                    }
                ]
            },
            {
                id: 'family_call',
                type: 'life',
                title: '📞 家人来电',
                text: '家里打来电话，关心你的近况。',
                choices: [
                    {
                        text: '聊聊近况',
                        effect: { mood: 12, stress: -8 },
                        result: '和家人聊天让你感到温暖。'
                    },
                    {
                        text: '简单报平安',
                        effect: { mood: 3 },
                        result: '你简单说了几句就挂了电话。'
                    }
                ]
            },
            {
                id: 'roommate_conflict',
                type: 'life',
                title: '😤 室友矛盾',
                text: '和室友因为一些小事发生了争执。',
                choices: [
                    {
                        text: '主动道歉和解',
                        effect: { mood: 5, stress: -5, relationship: 3 },
                        result: '你们和好了，关系反而更近了。'
                    },
                    {
                        text: '冷战处理',
                        effect: { mood: -10, stress: 8 },
                        result: '宿舍气氛变得很尴尬...'
                    }
                ]
            },
            {
                id: 'game_addiction',
                type: 'life',
                title: '🎮 游戏诱惑',
                text: '新游戏上线了，朋友们都在玩，你也很想试试...',
                choices: [
                    {
                        text: '玩一整天',
                        effect: { mood: 20, stress: -15, energy: -15, serve: -2, spike: -2 },
                        result: '游戏很好玩，但荒废了训练...'
                    },
                    {
                        text: '玩一会就停',
                        effect: { mood: 10, stress: -5, energy: -5 },
                        result: '你适度娱乐，保持了平衡。'
                    },
                    {
                        text: '拒绝诱惑',
                        effect: { mood: -3, serve: 3, spike: 3 },
                        result: '你坚持训练，技能有所提升。'
                    }
                ]
            },
            {
                id: 'food_poisoning',
                type: 'life',
                title: '🤢 食物中毒',
                text: '吃了不干净的东西，肚子很不舒服...',
                choices: [
                    {
                        text: '去医院看病（花费80元）',
                        effect: { energy: -10, mood: -5, money: -80 },
                        requirement: { money: 80 },
                        result: '医生给你开了药，休息几天就好了。'
                    },
                    {
                        text: '自己买药吃（花费20元）',
                        effect: { energy: -15, mood: -8, money: -20 },
                        requirement: { money: 20 },
                        result: '吃了药，但还是很难受。'
                    }
                ]
            },
            {
                id: 'volunteer_activity',
                type: 'life',
                title: '🤝 志愿者活动',
                text: '学校组织志愿者活动，邀请你参加。',
                choices: [
                    {
                        text: '积极参与',
                        effect: { mood: 15, stress: -5, energy: -10, reputation: 8 },
                        result: '帮助他人让你感到很充实！'
                    },
                    {
                        text: '婉拒邀请',
                        effect: { energy: 5 },
                        result: '你选择了休息。'
                    }
                ]
            },
            {
                id: 'talent_show',
                type: 'life',
                title: '🎤 才艺表演',
                text: '学校举办才艺表演，有人建议你展示排球技巧。',
                condition: { serve: 40, spike: 40, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '上台表演',
                        effect: { mood: 18, stress: 5, reputation: 10, relationship: 8 },
                        result: '你的表演赢得了热烈掌声！'
                    },
                    {
                        text: '害羞拒绝',
                        effect: { mood: -3, stress: -2 },
                        result: '你不好意思上台。'
                    }
                ]
            },
            {
                id: 'exam_week',
                type: 'life',
                title: '📚 考试周',
                text: '期末考试周到了，需要平衡学习和训练。',
                choices: [
                    {
                        text: '专心复习，暂停训练',
                        effect: { stress: 10, energy: -10, serve: -3, spike: -3, reputation: 5 },
                        result: '你通过了考试，但技能有所退步。'
                    },
                    {
                        text: '两者兼顾',
                        effect: { stress: 15, energy: -20, mood: -10 },
                        result: '你很累，但都坚持了下来。'
                    },
                    {
                        text: '优先训练',
                        effect: { serve: 5, spike: 5, stress: 8, reputation: -5 },
                        result: '训练效果不错，但成绩不太理想。'
                    }
                ]
            },
            {
                id: 'birthday',
                type: 'life',
                title: '🎂 生日快乐',
                text: '今天是你的生日，队友们给你准备了惊喜！',
                choices: [
                    {
                        text: '开心庆祝',
                        effect: { mood: 25, stress: -15, relationship: 10, money: -30 },
                        result: '这是难忘的一天！'
                    }
                ]
            },
            {
                id: 'rainy_day',
                type: 'life',
                title: '🌧️ 阴雨天',
                text: '连续下了好几天雨，心情有些低落。',
                choices: [
                    {
                        text: '室内训练',
                        effect: { serve: 3, spike: 3, energy: -10, mood: -3 },
                        result: '虽然天气不好，但你坚持了训练。'
                    },
                    {
                        text: '休息放松',
                        effect: { energy: 10, mood: 5, stress: -5 },
                        result: '你好好休息了一下。'
                    }
                ]
            },
            {
                id: 'inspiration',
                type: 'life',
                title: '💫 观赛启发',
                text: '看了一场精彩的排球比赛，深受启发！',
                choices: [
                    {
                        text: '马上去训练',
                        effect: { serve: 5, spike: 5, block: 5, energy: -15, mood: 15 },
                        result: '你充满动力，训练效果很好！'
                    },
                    {
                        text: '记在心里',
                        effect: { mood: 8, serve: 2, spike: 2 },
                        result: '你学到了一些新东西。'
                    }
                ]
            },
            {
                id: 'senior_retire',
                type: 'life',
                title: '👋 学长毕业',
                text: '一直指导你的学长要毕业了，他送给你一些训练心得。',
                condition: { reputation: 40, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '认真学习心得',
                        effect: { serve: 4, spike: 4, block: 4, dig: 2, set: 2, mood: 10, reputation: 5 },
                        result: '学长的经验让你受益匪浅！'
                    },
                    {
                        text: '感谢并道别',
                        effect: { mood: 5, reputation: 2 },
                        result: '你们互相祝福。'
                    }
                ]
            },
            {
                id: 'media_interview',
                type: 'life',
                title: '📰 媒体采访',
                text: '校报记者想采访你这位排球新星。',
                condition: { reputation: 80, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '接受采访',
                        effect: { mood: 12, stress: 5, reputation: 10 },
                        result: '你的故事登上了校报！'
                    },
                    {
                        text: '低调拒绝',
                        effect: { mood: 3, stress: -3 },
                        result: '你选择保持低调。'
                    }
                ]
            },
            {
                id: 'lucky_day',
                type: 'life',
                title: '🍀 幸运日',
                text: '今天运气特别好，好事连连！',
                choices: [
                    {
                        text: '享受这一天',
                        effect: { mood: 15, stress: -10, money: 50, reputation: 3 },
                        result: '真是美好的一天！'
                    }
                ]
            },
            {
                id: 'part_time_offer',
                type: 'life',
                title: '💼 兼职机会',
                text: '体育用品店老板看中了你，邀请你来店里做兼职。',
                choices: [
                    {
                        text: '接受兼职（金钱+200，体力-15，压力+5）',
                        effect: { money: 200, energy: -15, stress: 5, mood: 5 },
                        result: '你在店里工作了一段时间，赚了不少钱。'
                    },
                    {
                        text: '婉拒，专注训练',
                        effect: { serve: 3, spike: 3, mood: 3 },
                        result: '你选择把时间用在训练上。'
                    }
                ]
            },
            {
                id: 'shopping_temptation',
                type: 'life',
                title: '🛍️ 购物诱惑',
                text: '路过商场，看到很多想买的东西...',
                condition: { money: 200, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '疯狂购物（心情+30，花费300元）',
                        effect: { mood: 30, stress: -15, money: -300 },
                        requirement: { money: 300 },
                        result: '买买买！心情大好！'
                    },
                    {
                        text: '理性消费（心情+10，花费50元）',
                        effect: { mood: 10, money: -50 },
                        requirement: { money: 50 },
                        result: '你只买了必需品。'
                    },
                    {
                        text: '忍住不买',
                        effect: { mood: -5, stress: 3 },
                        result: '你忍住了购物的冲动，但有点不开心。'
                    }
                ]
            },
            {
                id: 'sponsor_offer',
                type: 'life',
                title: '🤝 赞助邀约',
                text: '一家运动品牌看中了你的潜力，愿意提供赞助！',
                condition: { reputation: 70, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '接受赞助',
                        effect: { money: 500, mood: 20, reputation: 10, serve: 3, spike: 3 },
                        result: '你获得了品牌赞助，还得到了专业装备！'
                    },
                    {
                        text: '暂时拒绝',
                        effect: { mood: 5 },
                        result: '你觉得时机还不成熟。'
                    }
                ]
            },
            {
                id: 'lottery_win',
                type: 'life',
                title: '🎰 中奖了',
                text: '你买的彩票中了小奖！',
                choices: [
                    {
                        text: '开心收钱',
                        effect: { money: 100, mood: 15 },
                        result: '意外之财，真开心！'
                    }
                ]
            },
            {
                id: 'friend_borrow',
                type: 'life',
                title: '💸 朋友借钱',
                text: '一位朋友遇到困难，向你借200元。',
                condition: { money: 200, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '借给他',
                        effect: { money: -200, mood: 5, relationship: 10, reputation: 5 },
                        result: '朋友很感激你的帮助。'
                    },
                    {
                        text: '婉拒',
                        effect: { mood: -5, relationship: -5 },
                        result: '你拒绝了，但心里有些不安。'
                    }
                ]
            },
            {
                id: 'expensive_equipment',
                type: 'life',
                title: '⭐ 顶级装备',
                text: '发现一套顶级排球装备，但价格昂贵（500元）。',
                condition: { money: 500, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '买下来',
                        effect: { money: -500, mood: 25, serve: 5, spike: 5, block: 5, dig: 3, set: 3 },
                        requirement: { money: 500 },
                        result: '顶级装备让你的训练效果大幅提升！'
                    },
                    {
                        text: '太贵了，不买',
                        effect: { mood: -8 },
                        result: '你忍痛放弃了。'
                    }
                ]
            },
            {
                id: 'treat_teammates',
                type: 'life',
                title: '🍕 请客吃饭',
                text: '队友们提议聚餐，大家都看着你...',
                choices: [
                    {
                        text: '我请客！（花费150元）',
                        effect: { money: -150, mood: 15, relationship: 20, reputation: 8 },
                        requirement: { money: 150 },
                        result: '你的慷慨赢得了大家的好感！'
                    },
                    {
                        text: 'AA制吧（花费30元）',
                        effect: { money: -30, mood: 8, relationship: 5 },
                        requirement: { money: 30 },
                        result: '大家AA制，气氛也不错。'
                    },
                    {
                        text: '我没钱，不去了',
                        effect: { mood: -10, relationship: -5 },
                        result: '你错过了这次聚餐。'
                    }
                ]
            }
        ];
        
        const SCENES = {
            nameInput: {
                text: `<div id="name-input-panel">
                    <h2>🏐 欢迎来到排球之星</h2>
                    <p style="margin-bottom: 20px; color: #666;">你即将开始一段从菜鸟到冠军的排球之旅</p>
                    <div id="name-input-container">
                        <input type="text" id="player-name-input" placeholder="请输入你的名字" maxlength="10" />
                        <button id="random-name-btn" onclick="game.randomName()" title="随机名字">🎲</button>
                    </div>
                    <div id="initial-attributes">
                        <h3>🎲 初始能力</h3>
                        <div class="init-attr-item">
                            <span>🎯 发球</span>
                            <span class="init-attr-value" id="init-serve">0</span>
                        </div>
                        <div class="init-attr-item">
                            <span>⚡ 扣球</span>
                            <span class="init-attr-value" id="init-spike">0</span>
                        </div>
                        <div class="init-attr-item">
                            <span>🛡️ 拦网</span>
                            <span class="init-attr-value" id="init-block">0</span>
                        </div>
                        <div class="init-attr-item">
                            <span>🏐 垫球</span>
                            <span class="init-attr-value" id="init-dig">0</span>
                        </div>
                        <div class="init-attr-item">
                            <span>🤲 托球</span>
                            <span class="init-attr-value" id="init-set">0</span>
                        </div>
                        <div class="init-attr-item">
                            <span>💪 体力上限</span>
                            <span class="init-attr-value" id="init-energy">100</span>
                        </div>
                        <div class="init-attr-rating" id="init-rating">综合评价：-</div>
                        <div id="reroll-container">
                            <button id="reroll-btn" onclick="game.rerollAttributes()">🎲 重新随机</button>
                            <span id="reroll-count">剩余次数：5/5</span>
                        </div>
                    </div>
                    <button onclick="game.submitName()">开始游戏</button>
                </div>`,
                choices: []
            },
            
            start: {
                text: `<h2>🎓 大学新生活</h2>
                <p>你是一名刚入学的大一新生，从未接触过排球。</p>
                <p>开学第一周，你路过体育馆，看到排球社团正在招新。阳光透过窗户洒在球场上，学长学姐们矫健的身影让你心生向往。</p>
                <p>"想试试吗？"一位学姐笑着向你招手。</p>`,
                choices: [
                    {
                        text: '🏐 加入排球社团，开始训练！',
                        next: 'weeklyHub'
                    },
                    {
                        text: '📚 先观察一下，了解更多信息',
                        next: 'observe'
                    }
                ]
            },

            
            observe: {
                text: `<h2>👀 观察学习</h2>
                <p>你在场边观察了一会儿，看到学长学姐们在练习各种技术：</p>
                <p>• 发球：将球高高抛起，用力击打过网<br>
                • 扣球：跳起来用力将球砸向对方场地<br>
                • 拦网：在网前跳起阻挡对方的进攻<br>
                • 防守：快速移动接起对方的攻击</p>
                <p>看起来很有趣！你决定...</p>`,
                choices: [
                    {
                        text: '💪 现在就加入，开始训练！',
                        next: 'weeklyHub'
                    }
                ]
            },
            
            weeklyHub: {
                text: '',
                choices: []
            },
            
            trainingChoice: {
                text: `<h2>🏋️ 选择训练项目</h2>
                <p>今天你想重点训练哪个技能？</p>
                <p style="color: #999; font-size: 14px;">训练会消耗体力和心情，但能提升技能</p>`,
                choices: [
                    {
                        text: '🎯 发球训练（体力-15，心情-5）',
                        next: 'lifeChoice',
                        requirement: { energy: 15 },
                        effect: { serve: 3, energy: -15, mood: -5, stress: 3, trained: true, eventType: 'training' }
                    },
                    {
                        text: '⚡ 扣球训练（体力-20，心情-8）',
                        next: 'lifeChoice',
                        requirement: { energy: 20 },
                        effect: { spike: 3, energy: -20, mood: -8, stress: 5, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🛡️ 拦网训练（体力-18，心情-6）',
                        next: 'lifeChoice',
                        requirement: { energy: 18 },
                        effect: { block: 3, energy: -18, mood: -6, stress: 4, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🤸 垫球训练（体力-15，心情-5）',
                        next: 'lifeChoice',
                        requirement: { energy: 15 },
                        effect: { dig: 3, energy: -15, mood: -5, stress: 3, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🙌 托球训练（体力-15，心情-5）',
                        next: 'lifeChoice',
                        requirement: { energy: 15 },
                        effect: { set: 3, energy: -15, mood: -5, stress: 3, trained: true, eventType: 'training' }
                    },
                    {
                        text: '� 返回',
                        next: 'weeklyHub'
                    }
                ]
            },
            
            lifeChoice: {
                text: `<h2>🌟 课余生活</h2>
                <p>训练结束了，你想做些什么来放松一下？</p>`,
                choices: [
                    {
                        text: '🍜 吃夜宵（心情+15，体力-5，压力-5，花费20元）',
                        next: 'checkRandomEvent',
                        requirement: { money: 20 },
                        effect: { mood: 15, energy: -5, stress: -5, money: -20, eventType: 'life' }
                    },
                    {
                        text: '🏐 打野球（25分制比赛，体力-20）',
                        next: 'casualMatch',
                        requirement: { energy: 20 },
                        effect: { matchType: 'casual', energy: -20 }
                    },
                    {
                        text: '🎮 打游戏（心情+10，压力-8，体力-3）',
                        next: 'checkRandomEvent',
                        effect: { mood: 10, stress: -8, energy: -3, eventType: 'life' }
                    },
                    {
                        text: '� 去图书馆（心情+5，压力+3，声望+2）',
                        next: 'checkRandomEvent',
                        effect: { mood: 5, stress: 3, reputation: 2, eventType: 'life' }
                    },
                    {
                        text: '� 早点休息（体力+20，心情+8，压力-5）',
                        next: 'checkRandomEvent',
                        effect: { energy: 20, mood: 8, stress: -5, eventType: 'life' }
                    },
                    {
                        text: '👥 和队友聊天（心情+12，压力-6，关系+5）',
                        next: 'checkRandomEvent',
                        effect: { mood: 12, stress: -6, relationship: 5, eventType: 'life' }
                    },
                    {
                        text: '🍿 看电影（心情+18，压力-10，花费50元）',
                        next: 'checkRandomEvent',
                        requirement: { money: 50 },
                        effect: { mood: 18, stress: -10, money: -50, eventType: 'life' }
                    },
                    {
                        text: '🛒 买运动装备（技能+2，心情+10，花费150元）',
                        next: 'checkRandomEvent',
                        requirement: { money: 150 },
                        effect: { serve: 2, spike: 2, block: 2, dig: 1, set: 1, mood: 10, money: -150, eventType: 'life' }
                    },
                    {
                        text: '💼 兼职打工（金钱+150，体力-20，压力+8）',
                        next: 'checkRandomEvent',
                        requirement: { energy: 20 },
                        effect: { money: 150, energy: -20, stress: 8, mood: -5, eventType: 'life' }
                    },
                    {
                        text: '🍔 吃大餐（心情+25，体力+10，花费100元）',
                        next: 'checkRandomEvent',
                        requirement: { money: 100 },
                        effect: { mood: 25, energy: 10, stress: -8, money: -100, eventType: 'life' }
                    },
                    {
                        text: '🎁 给队友买礼物（关系+15，声望+5，花费80元）',
                        next: 'checkRandomEvent',
                        requirement: { money: 80 },
                        effect: { relationship: 15, reputation: 5, mood: 8, money: -80, eventType: 'life' }
                    },
                    {
                        text: '📱 买新手机（心情+20，压力-5，花费800元）',
                        next: 'checkRandomEvent',
                        requirement: { money: 800 },
                        effect: { mood: 20, stress: -5, money: -800, eventType: 'life' }
                    }
                ]
            },
            
            casualMatch: {
                text: '',
                choices: []
            },
            
            matchResult: {
                text: '',
                choices: []
            },
            
            checkRandomEvent: {
                text: '',
                choices: []
            },
            
            randomEvent: {
                text: '',
                choices: []
            },

            
            basicTraining: {
                text: `<h2>📈 基础训练阶段</h2>
                <p>经过几周的训练，你已经掌握了基本的排球技术。教练说你很有天赋。</p>
                <p>现在你可以选择重点训练某项技能，或者参加院队的选拔。</p>`,
                choices: [
                    {
                        text: '继续训练',
                        next: 'weeklyHub'
                    }
                ]
            },
            
            weekEnd: {
                text: `<h2>📊 本周总结</h2>
                <p>第 ${this.player ? this.player.week : 1} 周结束了！</p>
                <p>本周训练了 ${this.player ? this.player.trainingCount : 0} 次</p>
                <p>获得零花钱 +500元</p>
                <p>体力、心情自然恢复，压力减轻</p>`,
                choices: [
                    {
                        text: '开始新的一周',
                        next: 'weeklyHub',
                        effect: { nextWeek: true }
                    }
                ]
            },
            
            eventResult: {
                text: '',
                choices: [
                    {
                        text: '继续',
                        next: 'weeklyHub'
                    }
                ]
            },

            
            rest: {
                text: `<h2>💤 休息恢复</h2>
                <p>你好好休息了一段时间，体力恢复了。</p>
                <p>明天继续加油！</p>`,
                choices: [
                    { text: '继续训练', next: 'basicTraining' }
                ]
            },
            
            collegeTryout: {
                text: `<h2>🎯 院队选拔</h2>
                <p>院队的选拔赛开始了！你需要在教练和学长面前展示你的技术。</p>
                <p>发球、接球、扣球...你全力以赴地完成了每一个动作。</p>
                <p>教练满意地点了点头："不错，欢迎加入院队！"</p>
                <p><strong>成就达成：加入院队！</strong></p>
                <p><strong>声望 +20</strong></p>`,
                choices: [
                    {
                        text: '🎉 太好了！选择场上位置',
                        next: 'positionSelection',
                        effect: { reputation: 20, team: 'college' }
                    }
                ]
            },
            
            positionSelection: {
                text: `<h2>🏐 选择你的场上位置</h2>
                <p>教练："你已经掌握了基本技能，现在需要选择一个专精的位置。"</p>
                <p>"每个位置都有不同的职责和要求，选择适合你的位置吧！"</p>
                <div id="position-cards"></div>`,
                choices: [] // 动态生成
            },
            
            collegeTeam: {
                text: `<h2>🏫 院队训练</h2>
                <p>作为院队的一员，训练强度明显提升了。你和队友们一起训练，技术进步很快。</p>
                <p>教练说下个月有院际比赛，你需要继续提升实力。</p>`,
                choices: [
                    // 专项训练
                    {
                        text: '🎯 强化发球训练（发球+12，体力-25）',
                        next: 'collegeTeam',
                        requirement: { energy: 25 },
                        effect: { serve: 12, energy: -25, trained: true }
                    },
                    {
                        text: '⚡ 强化扣球训练（扣球+12，体力-25）',
                        next: 'collegeTeam',
                        requirement: { energy: 25 },
                        effect: { spike: 12, energy: -25, trained: true }
                    },
                    {
                        text: '🛡️ 强化拦网训练（拦网+12，体力-25）',
                        next: 'collegeTeam',
                        requirement: { energy: 25 },
                        effect: { block: 12, energy: -25, trained: true }
                    },
                    {
                        text: '🏃 强化防守训练（垫球+6 托球+6，体力-25）',
                        next: 'collegeTeam',
                        requirement: { energy: 25 },
                        effect: { dig: 6, set: 6, energy: -25, trained: true }
                    },
                    // 复合训练
                    {
                        text: '🔥 进攻组合训练（扣球+7 发球+5，体力-30）',
                        next: 'collegeTeam',
                        requirement: { energy: 30 },
                        effect: { spike: 7, serve: 5, energy: -30, trained: true }
                    },
                    {
                        text: '🛡️ 防守组合训练（拦网+7 垫球+5，体力-30）',
                        next: 'collegeTeam',
                        requirement: { energy: 30 },
                        effect: { block: 7, dig: 5, energy: -30, trained: true }
                    },
                    {
                        text: '🎯 组织组合训练（托球+7 垫球+5，体力-30）',
                        next: 'collegeTeam',
                        requirement: { energy: 30 },
                        effect: { set: 7, dig: 5, energy: -30, trained: true }
                    },
                    {
                        text: '⭐ 全面发展训练（全技能+3，体力-35）',
                        next: 'collegeTeam',
                        requirement: { energy: 35 },
                        effect: { serve: 3, spike: 3, block: 3, dig: 3, set: 3, energy: -35, trained: true }
                    },
                    {
                        text: '💪 体能强化训练（全技能+2 体力上限+2，体力-40）',
                        next: 'collegeTeam',
                        requirement: { energy: 40 },
                        effect: { serve: 2, spike: 2, block: 2, dig: 2, set: 2, maxEnergyBonus: 2, energy: -40, trained: true }
                    },
                    // 其他选项
                    {
                        text: '😴 休息恢复',
                        next: 'rest2',
                        effect: { energy: 50 }
                    },
                    {
                        text: '🏆 参加院际比赛',
                        next: 'collegeMatch',
                        requirement: { serve: 45, spike: 40, block: 35, dig: 35, set: 35 }
                    },
                    {
                        text: '⭐ 申请校队选拔',
                        next: 'universityTryout',
                        requirement: { reputation: 50, serve: 60, spike: 60, block: 50, dig: 50, set: 50 }
                    }
                ]
            },
            
            rest2: {
                text: `<h2>💤 休息恢复</h2>
                <p>你好好休息了一段时间，体力恢复了。</p>
                <p>继续为比赛做准备！</p>`,
                choices: [
                    { text: '继续训练', next: 'collegeTeam' }
                ]
            },

            
            collegeMatch: {
                text: `<h2>🏐 院际比赛</h2>
                <p>比赛日到了！体育馆里挤满了为各自学院加油的同学。</p>
                <p>第一局，你的发球直接得分！观众席传来欢呼声。</p>
                <p>第二局，你成功拦下了对方的扣球，为队伍赢得了关键分数。</p>
                <p>最终，你们学院以3:1获胜！</p>
                <p><strong>声望 +30，全技能 +5</strong></p>`,
                choices: [
                    {
                        text: '🎉 太棒了！继续努力',
                        next: 'collegeTeam',
                        effect: { reputation: 30, serve: 5, spike: 5, block: 5, dig: 3, set: 3 }
                    }
                ]
            },
            
            universityTryout: {
                text: `<h2>⭐ 校队选拔</h2>
                <p>校队的选拔非常严格，来自各个学院的高手齐聚一堂。</p>
                <p>你展示了精准的发球、强力的扣球、稳固的拦网和灵活的防守。</p>
                <p>主教练仔细观察着每一个人的表现...</p>
                <p>"恭喜你，欢迎加入校队！"</p>
                <p><strong>成就达成：加入校队！</strong></p>
                <p><strong>声望 +50</strong></p>`,
                choices: [
                    {
                        text: '🌟 开始校队训练',
                        next: 'universityTeam',
                        effect: { reputation: 50, team: 'university' }
                    }
                ]
            },

            
            universityTeam: {
                text: `<h2>🌟 校队训练</h2>
                <p>校队的训练更加专业和系统。你和全校最优秀的排球选手一起训练。</p>
                <p>教练说市级联赛即将开始，这是证明自己的最好机会！</p>`,
                choices: [
                    {
                        text: '🎯 精英发球训练（体力-30）',
                        next: 'universityTeam',
                        requirement: { energy: 30 },
                        effect: { serve: 8, energy: -30, trained: true }
                    },
                    {
                        text: '⚡ 精英扣球训练（体力-30）',
                        next: 'universityTeam',
                        requirement: { energy: 30 },
                        effect: { spike: 8, energy: -30, trained: true }
                    },
                    {
                        text: '🛡️ 精英拦网训练（体力-30）',
                        next: 'universityTeam',
                        requirement: { energy: 30 },
                        effect: { block: 8, energy: -30, trained: true }
                    },
                    {
                        text: '🏃 精英防守训练（体力-30）',
                        next: 'universityTeam',
                        requirement: { energy: 30 },
                        effect: { dig: 4, set: 4, energy: -30, trained: true }
                    },
                    {
                        text: '⚔️ 进攻组合训练（体力-35）',
                        next: 'universityTeam',
                        requirement: { energy: 35 },
                        effect: { serve: 4, spike: 5, energy: -35, trained: true }
                    },
                    {
                        text: '🛡️ 防守组合训练（体力-35）',
                        next: 'universityTeam',
                        requirement: { energy: 35 },
                        effect: { block: 5, dig: 4, energy: -35, trained: true }
                    },
                    {
                        text: '🎯 组织组合训练（体力-35）',
                        next: 'universityTeam',
                        requirement: { energy: 35 },
                        effect: { set: 5, dig: 4, energy: -35, trained: true }
                    },
                    {
                        text: '🌟 全面发展训练（体力-40）',
                        next: 'universityTeam',
                        requirement: { energy: 40 },
                        effect: { serve: 3, spike: 3, block: 3, dig: 3, set: 3, energy: -40, trained: true }
                    },
                    {
                        text: '💪 体能强化训练（体力-25）',
                        next: 'universityTeam',
                        requirement: { energy: 25 },
                        effect: { energy: -25, maxEnergyBonus: 2, trained: true }
                    },
                    {
                        text: '😴 休息恢复',
                        next: 'rest3',
                        effect: { energy: 50 }
                    },
                    {
                        text: '🏆 参加市级联赛',
                        next: 'cityLeague',
                        requirement: { reputation: 100, serve: 75, spike: 75, block: 70, dig: 70, set: 70 }
                    }
                ]
            },

            
            rest3: {
                text: `<h2>💤 休息恢复</h2>
                <p>你好好休息了一段时间，体力恢复了。</p>
                <p>为市级联赛做好准备！</p>`,
                choices: [
                    { text: '继续训练', next: 'universityTeam' }
                ]
            },
            
            cityLeague: {
                text: `<h2>🏆 市级联赛 - 小组赛</h2>
                <p>市级联赛在全市最大的体育馆举行，观众席座无虚席。</p>
                <p>你们的对手是来自其他高校的强队。</p>
                <p>第一场比赛，你的表现非常出色，帮助球队以3:0获胜！</p>
                <p>第二场比赛更加激烈，但你们还是以3:2险胜。</p>
                <p>小组赛全胜出线！</p>
                <p><strong>声望 +40</strong></p>`,
                choices: [
                    {
                        text: '💪 进入淘汰赛',
                        next: 'cityLeagueSemiFinal',
                        effect: { reputation: 40 }
                    }
                ]
            },
            
            cityLeagueSemiFinal: {
                text: `<h2>🔥 市级联赛 - 半决赛</h2>
                <p>半决赛的对手是卫冕冠军，实力非常强大。</p>
                <p>前两局你们1:1战平。</p>
                <p>第三局关键时刻，你跳起来完成了一记漂亮的扣球，直接得分！</p>
                <p>第四局，你的发球连续得分，帮助球队拉开比分。</p>
                <p>最终3:1获胜，晋级决赛！</p>
                <p><strong>声望 +50</strong></p>`,
                choices: [
                    {
                        text: '🏆 准备决赛',
                        next: 'cityLeagueFinal',
                        effect: { reputation: 50 }
                    }
                ]
            },

            
            cityLeagueFinal: {
                text: `<h2>👑 市级联赛 - 决赛</h2>
                <p>决赛日，整个体育馆爆满，气氛热烈到了极点。</p>
                <p>对手是本市最强的大学队伍，每一分都要拼尽全力。</p>
                <p>比分交替上升，2:2平！</p>
                <p>决胜局，14:14！</p>
                <p>你深吸一口气，准备发球...</p>
                <p>球高高飞起，你用尽全力扣杀！</p>
                <p>球重重地砸在对方场地上——得分！</p>
                <p>15:14，冠军！</p>
                <p><strong>🎉🎉🎉 恭喜你！从一个排球菜鸟成长为市级冠军！🎉🎉🎉</strong></p>`,
                choices: [
                    {
                        text: '🏆 查看最终成就',
                        next: 'ending',
                        effect: { reputation: 100 }
                    }
                ]
            },
            
            ending: {
                text: `<h2>🌟 排球之星的诞生</h2>
                <p>从一个对排球一无所知的大一新生，到市级联赛的冠军...</p>
                <p>你的排球之路充满了汗水、努力和荣耀。</p>
                <br>
                <p>这只是开始，更大的舞台在等着你...</p>
                <p>省级联赛、全国联赛、甚至国际赛场！</p>
                <p><strong>感谢游玩！</strong></p>`,
                choices: [
                    {
                        text: '🔄 重新开始',
                        next: 'start',
                        effect: { reset: true }
                    }
                ]
            }
        };


        class VolleyballGame {
            constructor() {
                this.player = {
                    name: '新生',
                    week: 1,
                    trainingCount: 0,
                    maxTrainingPerWeek: 3,
                    energy: 100,
                    maxEnergy: 100,
                    mood: 80,
                    stress: 20,
                    reputation: 10,
                    money: 500,
                    team: 'none',
                    position: 'none',  // 职业位置
                    positionLevel: 0,  // 职业等级
                    adaptationWeeks: 0, // 转职适应期剩余周数
                    skills: {
                        serve: 0,
                        spike: 0,
                        block: 0,
                        dig: 0,      // 垫球
                        set: 0       // 托球
                    },
                    weekStartStats: {  // 每周开始时的数据快照
                        serve: 0,
                        spike: 0,
                        block: 0,
                        dig: 0,
                        set: 0,
                        maxEnergy: 100
                    },
                    attributes: {
                        strength: 0,    // 力量
                        agility: 0,     // 敏捷
                        stamina: 0,     // 耐力
                        coordination: 0 // 协调性
                    },
                    relationships: {
                        coach: 50,
                        teammates: 50
                    },
                    achievements: []  // 成就列表
                };
                
                // 职业配置
                this.positions = {
                    outsideHitter: {
                        id: 'outsideHitter',
                        name: '主攻手',
                        icon: '🔥',
                        description: '得分主力，承担大量进攻任务',
                        coreSkills: ['spike', 'serve'],
                        secondarySkills: ['dig'],
                        baseRequirements: { spike: 25, serve: 20, dig: 20 },
                        trainingBonus: { core: 0.5, secondary: 0.25, other: -0.25 },
                        matchWeights: { spike: 40, serve: 20, dig: 20, block: 10, set: 10 },
                        specialDescriptions: {
                            spike: ['强力跳发直接得分！', '后排进攻，大力扣杀得分！', '关键球，主攻手挺身而出！'],
                            serve: ['跳发球直接得分！', '发球破坏对方一传！', '连续发球施压！'],
                            dig: ['主攻手后排防守成功！', '及时补位，救起关键球！']
                        }
                    },
                    middleBlocker: {
                        id: 'middleBlocker',
                        name: '副攻手',
                        icon: '🛡️',
                        description: '拦网专家，快攻手',
                        coreSkills: ['block', 'spike'],
                        secondarySkills: ['set'],
                        baseRequirements: { block: 25, spike: 20, set: 15 },
                        trainingBonus: { core: 0.5, secondary: 0.25, other: -0.25 },
                        matchWeights: { block: 40, spike: 30, set: 10, serve: 10, dig: 10 },
                        specialDescriptions: {
                            block: ['单人拦网直接得分！', '双人拦网，严密防守！', '拦网判断精准！'],
                            spike: ['快速短平快，对方来不及反应！', '时间差进攻得分！', '背快突破防线！'],
                            set: ['副攻手调整传球！', '网前假动作，助攻得分！']
                        }
                    },
                    setter: {
                        id: 'setter',
                        name: '二传手',
                        icon: '🎯',
                        description: '组织核心，战术大脑',
                        coreSkills: ['set', 'serve'],
                        secondarySkills: ['dig'],
                        baseRequirements: { set: 30, serve: 20, dig: 20 },
                        trainingBonus: { core: 0.5, secondary: 0.25, other: -0.25 },
                        matchWeights: { set: 50, serve: 20, dig: 15, spike: 10, block: 5 },
                        specialDescriptions: {
                            set: ['精准二传，助攻队友得分！', '背传出其不意，队友轻松得分！', '跳传调整，化解困境！'],
                            serve: ['二传手发球直接得分！', '发球破坏对方进攻节奏！'],
                            dig: ['二传手防守到位！', '一传稳定，组织反击！']
                        }
                    },
                    oppositeHitter: {
                        id: 'oppositeHitter',
                        name: '接应二传',
                        icon: '⚡',
                        description: '全能战士，后排进攻核心',
                        coreSkills: ['spike', 'set'],
                        secondarySkills: ['serve'],
                        baseRequirements: { spike: 22, set: 22, serve: 20 },
                        trainingBonus: { core: 0.5, secondary: 0.25, other: -0.25 },
                        matchWeights: { spike: 35, set: 25, serve: 20, block: 10, dig: 10 },
                        specialDescriptions: {
                            spike: ['后排强攻，突破对方防线！', '调整球二次进攻得分！', '关键时刻接应站出来！'],
                            set: ['接应二传组织进攻！', '替补二传位置，传球到位！'],
                            serve: ['接应发球施压！', '跳飘球破坏对方！']
                        }
                    },
                    libero: {
                        id: 'libero',
                        name: '自由人',
                        icon: '🏃',
                        description: '防守专家，一传保障',
                        coreSkills: ['dig', 'set'],
                        secondarySkills: [],
                        baseRequirements: { dig: 30, set: 25 },
                        trainingBonus: { core: 0.5, secondary: 0.25, other: -0.25 },
                        matchWeights: { dig: 60, set: 30, spike: 0, block: 0, serve: 0 },
                        specialDescriptions: {
                            dig: ['鱼跃救球，精彩防守！', '完美一传，组织反击！', '连续防守，化解对方攻势！'],
                            set: ['自由人二传到位！', '后排传球组织！', '防守反击的起点！']
                        },
                        restrictions: ['不能扣球', '不能拦网', '不能发球']
                    }
                };
                
                this.rerollsRemaining = 5;
                this.currentScene = 'nameInput';
                this.justTrained = false;
                this.lastEventType = null;
                this.currentEvent = null;
                this.currentEventType = null;
                this.currentGoal = 'collegeTryout'; // 当前目标
                this.init();
            }
            
            init() {
                console.log('init() called');
                console.log('currentScene:', this.currentScene);
                this.updateUI();
                this.updateGoalDisplay();
                this.showScene(this.currentScene);
                // 初始化时设置一个随机名字和技能
                setTimeout(() => {
                    console.log('Setting random name and skills...');
                    this.randomName();
                    this.rollAttributes();
                    this.updateInitialSkillsDisplay();
                }, 100);
            }
            
            getGoalInfo() {
                const goals = {
                    collegeTryout: {
                        id: 'collegeTryout',
                        title: '🎯 阶段一：加入院队',
                        description: '第4周将举行院队选拔',
                        deadline: 4,
                        requirements: {
                            serve: 30,
                            spike: 25,
                            dig: 25,
                            set: 20
                        },
                        tips: '建议：均衡训练各项技能，重点提升发球和垫球。这是你排球之路的第一步！',
                        nextGoal: 'collegeMatch'
                    },
                    collegeMatch: {
                        id: 'collegeMatch',
                        title: '🏆 阶段二：院际比赛',
                        description: '第8周将举行院际比赛',
                        deadline: 8,
                        requirements: {
                            serve: 45,
                            spike: 40,
                            block: 35,
                            dig: 40,
                            set: 35
                        },
                        tips: '建议：继续强化训练，保持良好状态。赢得比赛将引起校队教练的注意！',
                        nextGoal: 'universityTryout'
                    },
                    universityTryout: {
                        id: 'universityTryout',
                        title: '⭐ 阶段三：加入校队',
                        description: '第12周将举行校队选拔',
                        deadline: 12,
                        requirements: {
                            serve: 60,
                            spike: 60,
                            block: 55,
                            dig: 55,
                            set: 50,
                            reputation: 60
                        },
                        tips: '建议：全面提升技能，积累声望。校队是学校最高水平的队伍！',
                        nextGoal: 'universityLeague'
                    },
                    universityLeague: {
                        id: 'universityLeague',
                        title: '🏅 阶段四：校际联赛',
                        description: '第16周将举行校际联赛',
                        deadline: 16,
                        requirements: {
                            serve: 72,
                            spike: 72,
                            block: 68,
                            dig: 68,
                            set: 65,
                            reputation: 100
                        },
                        tips: '建议：冲刺训练，争取最佳状态。这是展示实力的舞台！',
                        nextGoal: 'cityTryout'
                    },
                    cityTryout: {
                        id: 'cityTryout',
                        title: '🌟 阶段五：市队选拔',
                        description: '第20周将举行市队选拔',
                        deadline: 20,
                        requirements: {
                            serve: 82,
                            spike: 82,
                            block: 78,
                            dig: 78,
                            set: 75,
                            reputation: 150
                        },
                        tips: '建议：这是半职业水平，需要更专业的训练。加油！',
                        nextGoal: 'cityLeague'
                    },
                    cityLeague: {
                        id: 'cityLeague',
                        title: '🏆 阶段六：市级联赛',
                        description: '第25周将举行市级联赛',
                        deadline: 25,
                        requirements: {
                            serve: 88,
                            spike: 88,
                            block: 85,
                            dig: 85,
                            set: 82,
                            reputation: 200
                        },
                        tips: '建议：职业级比赛，全力以赴！这是通往职业道路的关键！',
                        nextGoal: 'finalChampionship'
                    },
                    finalChampionship: {
                        id: 'finalChampionship',
                        title: '👑 终极目标：全市冠军',
                        description: '第30周将举行全市大学生联赛总决赛',
                        deadline: 30,
                        requirements: {
                            serve: 95,
                            spike: 95,
                            block: 92,
                            dig: 92,
                            set: 90,
                            reputation: 250
                        },
                        tips: '全力以赴，创造奇迹！这是你的巅峰时刻！',
                        nextGoal: 'champion'
                    },
                    champion: {
                        id: 'champion',
                        title: '🎉 冠军之路',
                        description: '你已经达到巅峰！',
                        deadline: null,
                        requirements: {},
                        tips: '恭喜你完成了从菜鸟到冠军的蜕变！',
                        nextGoal: null
                    }
                };
                
                return goals[this.currentGoal] || goals.collegeTryout;
            }
            
            getAllGoals() {
                // 返回所有目标的有序列表
                return [
                    'collegeTryout',
                    'collegeMatch', 
                    'universityTryout',
                    'universityLeague',
                    'cityTryout',
                    'cityLeague',
                    'finalChampionship',
                    'champion'
                ];
            }
            
            getGoalStatus(goalId) {
                const allGoals = this.getAllGoals();
                const currentIndex = allGoals.indexOf(this.currentGoal);
                const goalIndex = allGoals.indexOf(goalId);
                
                if (goalIndex < currentIndex) {
                    return 'completed';
                } else if (goalIndex === currentIndex) {
                    return 'current';
                } else if (goalIndex === currentIndex + 1) {
                    return 'next';
                } else {
                    return 'future';
                }
            }
            
            updateGoalDisplay() {
                const goalInfo = this.getGoalInfo();
                const goalText = document.getElementById('goal-text');
                
                if (!goalText) return;
                
                let html = `<strong>${goalInfo.title}</strong><br>`;
                
                if (goalInfo.deadline) {
                    const weeksLeft = goalInfo.deadline - this.player.week;
                    if (weeksLeft > 0) {
                        html += `⏰ ${goalInfo.description}（还有${weeksLeft}周）<br>`;
                    } else {
                        html += `⏰ ${goalInfo.description}<br>`;
                    }
                }
                
                html += `<br><span style="font-size: 13px;">📋 要求：</span><br>`;
                
                let allMet = true;
                for (let skill in goalInfo.requirements) {
                    const required = goalInfo.requirements[skill];
                    let current = 0;
                    
                    if (skill === 'reputation') {
                        current = this.player.reputation;
                    } else {
                        current = this.player.skills[skill] || 0;
                    }
                    
                    const met = current >= required;
                    if (!met) allMet = false;
                    
                    const statusClass = met ? 'goal-met' : 'goal-not-met';
                    const statusIcon = met ? '✓' : '○';
                    
                    let skillName = skill;
                    if (skill === 'serve') skillName = '发球';
                    else if (skill === 'spike') skillName = '扣球';
                    else if (skill === 'block') skillName = '拦网';
                    else if (skill === 'dig') skillName = '垫球';
                    else if (skill === 'set') skillName = '托球';
                    else if (skill === 'reputation') skillName = '声望';
                    
                    html += `<span class="${statusClass}">${statusIcon} ${skillName}: ${current}/${required}</span> `;
                }
                
                html += `<br><br><span style="font-size: 12px; color: #ddd;">💡 ${goalInfo.tips}</span>`;
                
                goalText.innerHTML = html;
            }
            
            toggleGoalsPanel() {
                const panel = document.getElementById('goals-panel');
                if (panel.classList.contains('show')) {
                    panel.classList.remove('show');
                } else {
                    this.renderGoalsPanel();
                    panel.classList.add('show');
                }
            }
            
            renderGoalsPanel() {
                const goalsList = document.getElementById('goals-list');
                const allGoalIds = this.getAllGoals();
                
                let html = '';
                
                allGoalIds.forEach(goalId => {
                    const goalInfo = this.getGoalInfo.call({ currentGoal: goalId }, goalId);
                    // 重新获取目标信息
                    const goals = {
                        collegeTryout: {
                            id: 'collegeTryout',
                            title: '🎯 阶段一：加入院队',
                            description: '第4周将举行院队选拔',
                            deadline: 4,
                            requirements: { serve: 30, spike: 25, block: 20, dig: 20, set: 20 },
                            tips: '建议：均衡训练各项技能，重点提升发球。这是你排球之路的第一步！'
                        },
                        collegeMatch: {
                            id: 'collegeMatch',
                            title: '🏆 阶段二：院际比赛',
                            description: '第8周将举行院际比赛',
                            deadline: 8,
                            requirements: { serve: 45, spike: 40, block: 35, dig: 35, set: 35 },
                            tips: '建议：继续强化训练，保持良好状态。赢得比赛将引起校队教练的注意！'
                        },
                        universityTryout: {
                            id: 'universityTryout',
                            title: '⭐ 阶段三：加入校队',
                            description: '第12周将举行校队选拔',
                            deadline: 12,
                            requirements: { serve: 60, spike: 60, block: 50, dig: 50, set: 50, reputation: 60 },
                            tips: '建议：全面提升技能，积累声望。校队是学校最高水平的队伍！'
                        },
                        universityLeague: {
                            id: 'universityLeague',
                            title: '🏅 阶段四：校际联赛',
                            description: '第16周将举行校际联赛',
                            deadline: 16,
                            requirements: { serve: 75, spike: 75, block: 70, dig: 70, set: 70, reputation: 100 },
                            tips: '建议：冲刺训练，争取最佳状态。这是展示实力的舞台！'
                        },
                        cityTryout: {
                            id: 'cityTryout',
                            title: '🌟 阶段五：市队选拔',
                            description: '第20周将举行市队选拔',
                            deadline: 20,
                            requirements: { serve: 85, spike: 85, block: 80, dig: 80, set: 80, reputation: 150 },
                            tips: '建议：这是半职业水平，需要更专业的训练。加油！'
                        },
                        cityLeague: {
                            id: 'cityLeague',
                            title: '🏆 阶段六：市级联赛',
                            description: '第25周将举行市级联赛',
                            deadline: 25,
                            requirements: { serve: 90, spike: 90, block: 85, dig: 85, set: 85, reputation: 200 },
                            tips: '建议：职业级比赛，全力以赴！这是通往职业道路的关键！'
                        },
                        finalChampionship: {
                            id: 'finalChampionship',
                            title: '👑 终极目标：全市冠军',
                            description: '第30周将举行全市大学生联赛总决赛',
                            deadline: 30,
                            requirements: { serve: 95, spike: 95, block: 90, dig: 90, set: 90, reputation: 250 },
                            tips: '全力以赴，创造奇迹！这是你的巅峰时刻！'
                        },
                        champion: {
                            id: 'champion',
                            title: '🎉 冠军之路',
                            description: '你已经达到巅峰！',
                            deadline: null,
                            requirements: {},
                            tips: '恭喜你完成了从菜鸟到冠军的蜕变！'
                        }
                    };
                    
                    const goal = goals[goalId];
                    const status = this.getGoalStatus(goalId);
                    
                    let badgeText = '';
                    let badgeClass = '';
                    if (status === 'current') {
                        badgeText = '进行中';
                        badgeClass = 'current';
                    } else if (status === 'next') {
                        badgeText = '下一个';
                        badgeClass = 'next';
                    } else if (status === 'completed') {
                        badgeText = '已完成';
                        badgeClass = 'completed';
                    } else {
                        badgeText = '未解锁';
                        badgeClass = 'future';
                    }
                    
                    html += `<div class="goal-card ${status}">
                        <div class="goal-header">
                            <div class="goal-title">${goal.title}</div>
                            <div class="goal-badge ${badgeClass}">${badgeText}</div>
                        </div>
                        <div class="goal-description">${goal.description}</div>`;
                    
                    if (Object.keys(goal.requirements).length > 0) {
                        html += `<div class="goal-requirements">
                            <h4>📋 要求：</h4>`;
                        
                        for (let skill in goal.requirements) {
                            const required = goal.requirements[skill];
                            let current = 0;
                            
                            if (skill === 'reputation') {
                                current = this.player.reputation;
                            } else {
                                current = this.player.skills[skill] || 0;
                            }
                            
                            const met = current >= required;
                            const statusClass = met ? 'requirement-met' : 'requirement-not-met';
                            const statusIcon = met ? '✓' : '○';
                            
                            let skillName = skill;
                            if (skill === 'serve') skillName = '发球';
                            else if (skill === 'spike') skillName = '扣球';
                            else if (skill === 'block') skillName = '拦网';
                            else if (skill === 'dig') skillName = '垫球';
                            else if (skill === 'set') skillName = '托球';
                            else if (skill === 'reputation') skillName = '声望';
                            
                            html += `<div class="requirement-item ${statusClass}">
                                <span>${statusIcon} ${skillName}</span>
                                <span>${current} / ${required}</span>
                            </div>`;
                        }
                        
                        html += `</div>`;
                    }
                    
                    html += `<div class="goal-tips">💡 ${goal.tips}</div>
                    </div>`;
                });
                
                goalsList.innerHTML = html;
            }
            
            renderLifeChoice() {
                const storyText = document.getElementById('story-text');
                const choicesDiv = document.getElementById('choices');
                
                storyText.innerHTML = `<h2>🌟 课余生活</h2>
                    <p>训练结束了，你想做些什么来放松一下？</p>`;
                
                // 定义分类
                const categories = {
                    sports: {
                        title: '🏐 运动娱乐',
                        color: '#ff6b6b',
                        choices: [
                            {
                                icon: '🏐',
                                title: '打野球',
                                effects: '25分制比赛 体力-20',
                                next: 'casualMatch',
                                requirement: { energy: 20 },
                                effect: { matchType: 'casual', energy: -20 }
                            }
                        ]
                    },
                    rest: {
                        title: '😴 休息恢复',
                        color: '#4ecdc4',
                        choices: [
                            {
                                icon: '😴',
                                title: '早点休息',
                                effects: '体力+20 心情+8 压力-5',
                                next: 'checkRandomEvent',
                                effect: { energy: 20, mood: 8, stress: -5, eventType: 'life' }
                            },
                            {
                                icon: '🎮',
                                title: '打游戏',
                                effects: '心情+10 压力-8 体力-3',
                                next: 'checkRandomEvent',
                                effect: { mood: 10, stress: -8, energy: -3, eventType: 'life' }
                            },
                            {
                                icon: '📚',
                                title: '去图书馆',
                                effects: '心情+5 压力+3 声望+2',
                                next: 'checkRandomEvent',
                                effect: { mood: 5, stress: 3, reputation: 2, eventType: 'life' }
                            }
                        ]
                    },
                    social: {
                        title: '👥 社交活动',
                        color: '#95e1d3',
                        choices: [
                            {
                                icon: '👥',
                                title: '和队友聊天',
                                effects: '心情+12 压力-6 关系+5',
                                next: 'checkRandomEvent',
                                effect: { mood: 12, stress: -6, relationship: 5, eventType: 'life' }
                            },
                            {
                                icon: '🍿',
                                title: '看电影',
                                effects: '心情+18 压力-10 💰50',
                                next: 'checkRandomEvent',
                                requirement: { money: 50 },
                                effect: { mood: 18, stress: -10, money: -50, eventType: 'life' }
                            },
                            {
                                icon: '🎁',
                                title: '给队友买礼物',
                                effects: '关系+15 声望+5 💰80',
                                next: 'checkRandomEvent',
                                requirement: { money: 80 },
                                effect: { relationship: 15, reputation: 5, mood: 8, money: -80, eventType: 'life' }
                            }
                        ]
                    },
                    food: {
                        title: '🍔 美食享受',
                        color: '#ffd93d',
                        choices: [
                            {
                                icon: '🍜',
                                title: '吃夜宵',
                                effects: '心情+15 体力-5 压力-5 💰20',
                                next: 'checkRandomEvent',
                                requirement: { money: 20 },
                                effect: { mood: 15, energy: -5, stress: -5, money: -20, eventType: 'life' }
                            },
                            {
                                icon: '🍔',
                                title: '吃大餐',
                                effects: '心情+25 体力+10 压力-8 💰100',
                                next: 'checkRandomEvent',
                                requirement: { money: 100 },
                                effect: { mood: 25, energy: 10, stress: -8, money: -100, eventType: 'life' }
                            }
                        ]
                    },
                    shopping: {
                        title: '🛒 购物消费',
                        color: '#a29bfe',
                        choices: [
                            {
                                icon: '🛒',
                                title: '买运动装备',
                                effects: '全技能+2 心情+10 💰150',
                                next: 'checkRandomEvent',
                                requirement: { money: 150 },
                                effect: { serve: 2, spike: 2, block: 2, dig: 1, set: 1, mood: 10, money: -150, eventType: 'life' }
                            },
                            {
                                icon: '📱',
                                title: '买新手机',
                                effects: '心情+20 压力-5 💰800',
                                next: 'checkRandomEvent',
                                requirement: { money: 800 },
                                effect: { mood: 20, stress: -5, money: -800, eventType: 'life' }
                            }
                        ]
                    },
                    work: {
                        title: '💼 兼职赚钱',
                        color: '#6c5ce7',
                        choices: [
                            {
                                icon: '💼',
                                title: '兼职打工',
                                effects: '💰+150 体力-20 压力+8',
                                next: 'checkRandomEvent',
                                requirement: { energy: 20 },
                                effect: { money: 150, energy: -20, stress: 8, mood: -5, eventType: 'life' }
                            }
                        ]
                    }
                };
                
                let html = '<div class="life-categories">';
                
                for (let catKey in categories) {
                    const category = categories[catKey];
                    html += `<div class="life-category ${catKey}">
                        <div class="category-title">${category.title}</div>
                        <div class="category-choices">`;
                    
                    category.choices.forEach(choice => {
                        const meetsRequirement = choice.requirement ? this.checkRequirement(choice.requirement) : true;
                        const disabledClass = meetsRequirement ? '' : 'disabled';
                        const disabledAttr = meetsRequirement ? '' : 'disabled';
                        
                        html += `<button class="life-choice-card ${disabledClass}" ${disabledAttr} 
                            onclick="game.handleLifeChoice('${choice.next}', ${JSON.stringify(choice.effect || {}).replace(/"/g, '&quot;')})">
                            <div class="life-choice-icon">${choice.icon}</div>
                            <div class="life-choice-title">${choice.title}</div>
                            <div class="life-choice-effects">${choice.effects}</div>
                            ${!meetsRequirement ? '<div style="color: #ffeb3b; font-size: 10px; margin-top: 3px;">条件不足</div>' : ''}
                        </button>`;
                    });
                    
                    html += `</div></div>`;
                }
                
                html += '</div>';
                
                choicesDiv.innerHTML = html;
            }
            
            handleLifeChoice(nextScene, effect) {
                if (effect && Object.keys(effect).length > 0) {
                    this.applyEffect(effect);
                    
                    // 检查是否需要触发随机事件
                    if (effect.eventType) {
                        const event = this.triggerRandomEvent(effect.eventType);
                        if (event) {
                            this.showRandomEvent(event);
                            return;
                        }
                    }
                }
                
                if (nextScene) {
                    this.currentScene = nextScene;
                    this.showScene(nextScene);
                }
            }
            
            // 职业系统方法
            renderPositionSelection() {
                const storyText = document.getElementById('story-text');
                const choicesDiv = document.getElementById('choices');
                
                storyText.innerHTML = `<h2>🏐 选择你的场上位置</h2>
                    <p>教练："你已经掌握了基本技能，现在需要选择一个专精的位置。"</p>
                    <p>"每个位置都有不同的职责和要求，选择适合你的位置吧！"</p>`;
                
                let html = '<div class="position-cards">';
                
                for (let posKey in this.positions) {
                    const pos = this.positions[posKey];
                    const meetsRequirement = this.checkPositionRequirement(pos);
                    const disabledClass = meetsRequirement ? '' : 'disabled';
                    
                    // 获取核心技能要求
                    const reqText = Object.entries(pos.baseRequirements)
                        .map(([skill, value]) => {
                            const skillNames = { serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球' };
                            const currentValue = this.player.skills[skill];
                            const met = currentValue >= value;
                            return `${skillNames[skill]} ${currentValue}/${value} ${met ? '✓' : '✗'}`;
                        }).join(' ');
                    
                    html += `<div class="position-card ${disabledClass}" onclick="game.selectPosition('${pos.id}', ${meetsRequirement})">
                        <div class="position-icon">${pos.icon}</div>
                        <div class="position-name">${pos.name}</div>
                        <div class="position-desc">${pos.description}</div>
                        <div class="position-skills">
                            <strong>核心技能：</strong>${pos.coreSkills.map(s => {
                                const names = { serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球' };
                                return names[s];
                            }).join('、')}
                        </div>
                        <div class="position-requirements">${reqText}</div>
                        ${pos.restrictions ? `<div class="position-restrictions">限制：${pos.restrictions.join('、')}</div>` : ''}
                        ${!meetsRequirement ? '<div class="position-locked">🔒 条件不足</div>' : ''}
                    </div>`;
                }
                
                html += '</div>';
                choicesDiv.innerHTML = html;
            }
            
            checkPositionRequirement(position) {
                const req = position.baseRequirements;
                for (let skill in req) {
                    if (this.player.skills[skill] < req[skill]) {
                        return false;
                    }
                }
                return true;
            }
            
            selectPosition(positionId, meetsRequirement) {
                if (!meetsRequirement) {
                    alert('你的技能还不满足这个位置的要求！');
                    return;
                }
                
                const position = this.positions[positionId];
                this.player.position = positionId;
                this.player.positionLevel = 1;
                
                alert(`你选择了 ${position.icon} ${position.name}！\n\n${position.description}\n\n核心技能训练将获得额外加成！`);
                
                // 更新目标并进入周选择
                this.currentGoal = 'collegeMatch';
                this.currentScene = 'weeklyHub';
                this.showScene('weeklyHub');
                this.updateUI();
            }
            
            getPositionInfo() {
                if (this.player.position === 'none') {
                    return null;
                }
                return this.positions[this.player.position];
            }
            
            getTrainingBonus(skill) {
                const posInfo = this.getPositionInfo();
                if (!posInfo) return 0;
                
                // 适应期惩罚
                if (this.player.adaptationWeeks > 0) {
                    return -0.2;
                }
                
                if (posInfo.coreSkills.includes(skill)) {
                    return posInfo.trainingBonus.core;
                }
                if (posInfo.secondarySkills.includes(skill)) {
                    return posInfo.trainingBonus.secondary;
                }
                return posInfo.trainingBonus.other;
            }
            
            getMatchWeight(skill) {
                const posInfo = this.getPositionInfo();
                if (!posInfo) {
                    // 没有职业时平均权重
                    return 20;
                }
                return posInfo.matchWeights[skill] || 0;
            }
            
            getPositionDescription(skill, success) {
                const posInfo = this.getPositionInfo();
                if (!posInfo || !posInfo.specialDescriptions[skill]) {
                    return null;
                }
                
                const descriptions = posInfo.specialDescriptions[skill];
                return descriptions[Math.floor(Math.random() * descriptions.length)];
            }
            
            // 比赛系统
            startMatch(matchType) {
                // 初始化比赛数据
                this.currentMatch = {
                    type: matchType, // 'casual' 野球, 'formal' 正式比赛
                    targetScore: matchType === 'casual' ? 25 : 25,
                    myScore: 0,
                    opponentScore: 0,
                    scoreLog: [],
                    mySkills: {
                        serve: this.player.skills.serve,
                        spike: this.player.skills.spike,
                        block: this.player.skills.block,
                        dig: this.player.skills.dig,
                        set: this.player.skills.set
                    }
                };
                
                // 模拟比赛过程
                this.simulateMatch();
            }
            
            simulateMatch() {
                const match = this.currentMatch;
                const mySkills = match.mySkills;
                
                // 计算对手实力（根据玩家技能调整）
                const avgSkill = (mySkills.serve + mySkills.spike + mySkills.block + mySkills.dig + mySkills.set) / 5;
                const opponentSkill = match.type === 'casual' ? 
                    Math.max(20, Math.min(70, avgSkill + (Math.random() * 20 - 10))) : // 野球对手实力接近
                    Math.max(30, Math.min(80, avgSkill + (Math.random() * 30 - 5))); // 正式比赛对手稍强
                
                // 模拟每一分
                while (match.myScore < match.targetScore && match.opponentScore < match.targetScore) {
                    const point = this.simulatePoint(mySkills, opponentSkill);
                    
                    if (point.scorer === 'my') {
                        match.myScore++;
                    } else {
                        match.opponentScore++;
                    }
                    
                    match.scoreLog.push({
                        myScore: match.myScore,
                        opponentScore: match.opponentScore,
                        description: point.description,
                        scorer: point.scorer
                    });
                }
                
                // 显示比赛结果
                this.showMatchResult();
            }
            
            simulatePoint(mySkills, opponentSkill) {
                // 随机决定哪方发球
                const myServe = Math.random() > 0.5;
                
                // 得分方式权重（基于职业和技能）
                const scoreTypes = [
                    { type: 'serve', weight: this.getMatchWeight('serve') * (mySkills.serve / 100), name: '发球' },
                    { type: 'spike', weight: this.getMatchWeight('spike') * (mySkills.spike / 100), name: '扣球' },
                    { type: 'block', weight: this.getMatchWeight('block') * (mySkills.block / 100), name: '拦网' },
                    { type: 'dig', weight: this.getMatchWeight('dig') * (mySkills.dig / 100), name: '垫球' },
                    { type: 'set', weight: this.getMatchWeight('set') * (mySkills.set / 100), name: '托球' }
                ];
                
                // 选择得分方式
                const totalWeight = scoreTypes.reduce((sum, st) => sum + st.weight, 0);
                let random = Math.random() * totalWeight;
                let selectedType = scoreTypes[0];
                
                for (let st of scoreTypes) {
                    random -= st.weight;
                    if (random <= 0) {
                        selectedType = st;
                        break;
                    }
                }
                
                // 计算得分概率（职业加成）
                const posInfo = this.getPositionInfo();
                let skillBonus = 1.0;
                if (posInfo && posInfo.coreSkills.includes(selectedType.type)) {
                    skillBonus = 1.2; // 核心技能成功率+20%
                }
                
                const myChance = (mySkills[selectedType.type] * skillBonus) / (mySkills[selectedType.type] * skillBonus + opponentSkill);
                const iWin = Math.random() < myChance;
                
                // 生成得分描述（优先使用职业专属描述）
                let description = '';
                if (iWin) {
                    const posDesc = this.getPositionDescription(selectedType.type, true);
                    if (posDesc) {
                        description = posDesc;
                    } else {
                        const descriptions = {
                            serve: [
                                '你发出一记强力跳发球，对方接发失误！',
                                '精准的发球直接得分，对方措手不及！',
                                '你的发球落在对方空档，直接得分！'
                            ],
                            spike: [
                                '你高高跃起，大力扣球得分！',
                                '漂亮的扣球，对方防守失误！',
                                '你抓住机会，一记重扣拿下这分！',
                                '完美的扣球角度，对方无法防守！'
                            ],
                            block: [
                                '你成功拦网，直接得分！',
                                '精准的拦网判断，球直接弹回对方场地！',
                                '你的拦网让对方的扣球无功而返！'
                            ],
                            dig: [
                                '你成功垫起对方的扣球，队友反击得分！',
                                '精彩的垫球，化解对方攻势并反击成功！',
                                '你的垫球到位，队友完成反击！'
                            ],
                            set: [
                                '你的二传精准到位，队友扣球得分！',
                                '完美的托球，助攻队友得分！',
                                '你的传球组织进攻，队友完成得分！'
                            ]
                        };
                        description = descriptions[selectedType.type][Math.floor(Math.random() * descriptions[selectedType.type].length)];
                    }
                } else {
                    const descriptions = {
                        serve: [
                            '你的发球出界了，对方得分。',
                            '发球失误，对方拿下这分。',
                            '发球下网，对方得分。'
                        ],
                        spike: [
                            '扣球被对方拦网，对方得分。',
                            '你的扣球出界了，对方得分。',
                            '对方防守成功并反击得分。'
                        ],
                        block: [
                            '拦网判断失误，对方扣球得分。',
                            '对方的扣球突破了你的拦网。',
                            '拦网没有成功，对方得分。'
                        ],
                        dig: [
                            '垫球失误，对方扣球得分。',
                            '你没能垫起对方的进攻。',
                            '垫球不到位，对方得分。'
                        ],
                        set: [
                            '托球失误，对方反击得分。',
                            '二传不到位，进攻失败。',
                            '传球被对方拦截，对方得分。'
                        ]
                    };
                    description = descriptions[selectedType.type][Math.floor(Math.random() * descriptions[selectedType.type].length)];
                }
                
                return {
                    scorer: iWin ? 'my' : 'opponent',
                    description: description,
                    type: selectedType.type
                };
            }
            
            showMatchResult() {
                const match = this.currentMatch;
                
                // 显示比赛弹窗
                const modal = document.getElementById('match-modal');
                const title = document.getElementById('match-modal-title');
                const myScoreEl = document.getElementById('my-score');
                const opponentScoreEl = document.getElementById('opponent-score');
                const matchLog = document.getElementById('match-log');
                const choicesDiv = document.getElementById('match-modal-choices');
                const skipBtn = document.getElementById('skip-match-btn');
                
                title.textContent = '🏐 比赛进行中';
                myScoreEl.textContent = '0';
                opponentScoreEl.textContent = '0';
                matchLog.innerHTML = '';
                choicesDiv.innerHTML = '';
                skipBtn.style.display = 'block';
                skipBtn.disabled = false;
                
                modal.classList.add('show');
                
                // 逐行显示得分记录
                let currentIndex = 0;
                this.matchDisplayInterval = setInterval(() => {
                    if (currentIndex >= match.scoreLog.length) {
                        clearInterval(this.matchDisplayInterval);
                        this.matchDisplayInterval = null;
                        // 所有得分显示完毕，显示最终结果
                        this.showFinalMatchResult();
                        return;
                    }
                    
                    const log = match.scoreLog[currentIndex];
                    
                    // 更新比分显示
                    myScoreEl.textContent = log.myScore;
                    opponentScoreEl.textContent = log.opponentScore;
                    
                    // 添加得分记录
                    const logItem = document.createElement('div');
                    logItem.className = `match-log-item ${log.scorer === 'my' ? 'my-point' : 'opponent-point'}`;
                    
                    const scoreColor = log.scorer === 'my' ? '#2ecc71' : '#e74c3c';
                    logItem.innerHTML = `
                        <div class="match-log-score" style="color: ${scoreColor};">
                            ${log.myScore} : ${log.opponentScore}
                        </div>
                        <div class="match-log-description">${log.description}</div>
                    `;
                    
                    matchLog.appendChild(logItem);
                    
                    // 自动滚动到底部
                    matchLog.scrollTop = matchLog.scrollHeight;
                    
                    currentIndex++;
                }, 500); // 每0.5秒显示一条
            }
            
            skipMatch() {
                // 清除动画定时器
                if (this.matchDisplayInterval) {
                    clearInterval(this.matchDisplayInterval);
                    this.matchDisplayInterval = null;
                }
                
                const match = this.currentMatch;
                const myScoreEl = document.getElementById('my-score');
                const opponentScoreEl = document.getElementById('opponent-score');
                const matchLog = document.getElementById('match-log');
                const skipBtn = document.getElementById('skip-match-btn');
                
                // 隐藏跳过按钮
                skipBtn.style.display = 'none';
                
                // 直接显示最终比分
                const finalLog = match.scoreLog[match.scoreLog.length - 1];
                myScoreEl.textContent = finalLog.myScore;
                opponentScoreEl.textContent = finalLog.opponentScore;
                
                // 清空并显示简化的比赛记录
                matchLog.innerHTML = '<div style="text-align: center; padding: 20px; color: #ddd;">已跳过比赛过程</div>';
                
                // 直接显示最终结果
                this.showFinalMatchResult();
            }
            
            showFinalMatchResult() {
                const match = this.currentMatch;
                const won = match.myScore >= match.targetScore;
                
                const title = document.getElementById('match-modal-title');
                const choicesDiv = document.getElementById('match-modal-choices');
                const skipBtn = document.getElementById('skip-match-btn');
                
                // 隐藏跳过按钮
                skipBtn.style.display = 'none';
                
                // 更新标题
                title.textContent = won ? '🎉 胜利！' : '😔 失败';
                
                // 计算奖励
                const rewards = this.calculateMatchRewards(won);
                
                // 显示结果按钮
                choicesDiv.innerHTML = '';
                
                // 添加结果说明
                const resultDiv = document.createElement('div');
                resultDiv.style.cssText = 'margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; text-align: center;';
                resultDiv.innerHTML = `
                    <h3 style="margin-bottom: 10px;">${won ? '恭喜获胜！' : '虽败犹荣！'}</h3>
                    <p style="margin-bottom: 15px;">${rewards.message}</p>
                    <div style="text-align: left; font-size: 14px;">
                        <strong>💫 比赛收获：</strong><br>
                        ${rewards.serve ? `🎯 发球 +${rewards.serve}<br>` : ''}
                        ${rewards.spike ? `⚡ 扣球 +${rewards.spike}<br>` : ''}
                        ${rewards.block ? `🛡️ 拦网 +${rewards.block}<br>` : ''}
                        ${rewards.dig ? `🤸 垫球 +${rewards.dig}<br>` : ''}
                        ${rewards.set ? `🙌 托球 +${rewards.set}<br>` : ''}
                        ${rewards.energy ? `💪 体力 ${rewards.energy}<br>` : ''}
                        ${rewards.mood ? `😊 心情 ${rewards.mood > 0 ? '+' : ''}${rewards.mood}<br>` : ''}
                        ${rewards.stress ? `😰 压力 ${rewards.stress > 0 ? '+' : ''}${rewards.stress}<br>` : ''}
                        ${rewards.reputation ? `⭐ 声望 +${rewards.reputation}<br>` : ''}
                    </div>
                `;
                choicesDiv.appendChild(resultDiv);
                
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = '确定';
                button.onclick = () => {
                    // 应用奖励
                    this.applyEffect(rewards);
                    
                    // 关闭弹窗
                    const modal = document.getElementById('match-modal');
                    modal.classList.remove('show');
                    
                    // 返回周选择
                    this.currentScene = 'weeklyHub';
                    this.showScene('weeklyHub');
                };
                
                choicesDiv.appendChild(button);
            }
            
            calculateMatchRewards(won) {
                const match = this.currentMatch;
                const isCasual = match.type === 'casual';
                
                if (won) {
                    return {
                        message: isCasual ? 
                            '通过实战，你的技能得到了提升！' :
                            '赢得比赛让你信心大增，技能和声望都有提升！',
                        serve: isCasual ? 2 : 4,
                        spike: isCasual ? 2 : 4,
                        block: isCasual ? 2 : 3,
                        dig: isCasual ? 2 : 4,
                        set: isCasual ? 2 : 3,
                        energy: isCasual ? 0 : -15,  // 野球不额外消耗体力，正式比赛消耗
                        mood: isCasual ? 12 : 20,
                        stress: isCasual ? -8 : -12,
                        reputation: isCasual ? 2 : 6
                    };
                } else {
                    return {
                        message: isCasual ?
                            '虽然输了，但你从比赛中学到了很多。' :
                            '失败是成功之母，你从这场比赛中吸取了经验。',
                        serve: isCasual ? 1 : 2,
                        spike: isCasual ? 1 : 2,
                        block: isCasual ? 1 : 1,
                        dig: isCasual ? 1 : 2,
                        set: isCasual ? 1 : 1,
                        energy: isCasual ? 0 : -12,  // 野球不额外消耗体力，正式比赛消耗
                        mood: isCasual ? -5 : -10,
                        stress: isCasual ? 5 : 8,
                        reputation: isCasual ? 0 : -2
                    };
                }
            }
            
            randomName() {
                const randomName = generateRandomName();
                const nameInput = document.getElementById('player-name-input');
                if (nameInput) {
                    nameInput.value = randomName;
                    // 添加一个小动画效果
                    nameInput.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        nameInput.style.transform = 'scale(1)';
                    }, 200);
                }
            }
            
            rerollAttributes() {
                if (this.rerollsRemaining <= 0) {
                    return;
                }
                
                this.rerollsRemaining--;
                this.rollAttributes();
                this.updateInitialSkillsDisplay();
                
                // 更新周开始数据快照（因为重新随机了初始值）
                this.player.weekStartStats = {
                    serve: this.player.skills.serve,
                    spike: this.player.skills.spike,
                    block: this.player.skills.block,
                    dig: this.player.skills.dig,
                    set: this.player.skills.set,
                    maxEnergy: this.player.maxEnergy
                };
                
                // 更新剩余次数显示
                const rerollCount = document.getElementById('reroll-count');
                const rerollBtn = document.getElementById('reroll-btn');
                if (rerollCount) {
                    rerollCount.textContent = `剩余次数：${this.rerollsRemaining}/5`;
                }
                if (rerollBtn && this.rerollsRemaining <= 0) {
                    rerollBtn.disabled = true;
                    rerollBtn.textContent = '已用完';
                }
            }
            
            updateInitialSkillsDisplay() {
                document.getElementById('init-serve').textContent = this.player.skills.serve;
                document.getElementById('init-spike').textContent = this.player.skills.spike;
                document.getElementById('init-block').textContent = this.player.skills.block;
                document.getElementById('init-dig').textContent = this.player.skills.dig;
                document.getElementById('init-set').textContent = this.player.skills.set;
                document.getElementById('init-energy').textContent = this.player.maxEnergy;
                
                const total = this.player.skills.serve + 
                             this.player.skills.spike + 
                             this.player.skills.block +
                             this.player.skills.dig +
                             this.player.skills.set;
                const average = Math.floor(total / 5);
                
                let rating = '普通';
                let ratingColor = '#f39c12';
                if (average >= 6) {
                    rating = '优秀';
                    ratingColor = '#27ae60';
                } else if (average >= 5) {
                    rating = '良好';
                    ratingColor = '#2ecc71';
                } else if (average >= 3) {
                    rating = '中等';
                    ratingColor = '#f39c12';
                } else {
                    rating = '较差';
                    ratingColor = '#e74c3c';
                }
                
                const ratingElement = document.getElementById('init-rating');
                if (ratingElement) {
                    ratingElement.textContent = `综合评价：${rating}（总分${total}）`;
                    ratingElement.style.color = ratingColor;
                }
            }
            
            submitName() {
                const nameInput = document.getElementById('player-name-input');
                const name = nameInput.value.trim();
                
                if (name === '') {
                    alert('请输入你的名字！');
                    return;
                }
                
                this.player.name = name;
                this.rollAttributes();
                
                // 初始化周开始数据快照
                this.player.weekStartStats = {
                    serve: this.player.skills.serve,
                    spike: this.player.skills.spike,
                    block: this.player.skills.block,
                    dig: this.player.skills.dig,
                    set: this.player.skills.set,
                    maxEnergy: this.player.maxEnergy
                };
                
                // 显示能力面板和游戏头部
                document.getElementById('character-panel').classList.add('show');
                document.getElementById('game-header').classList.add('show');
                
                // 直接进入游戏开始场景
                this.currentScene = 'start';
                this.showScene('start');
            }
            
            rollAttributes() {
                // 直接随机生成初始技能，范围在0-7之间
                this.player.skills.serve = Math.floor(Math.random() * 8);
                this.player.skills.spike = Math.floor(Math.random() * 8);
                this.player.skills.block = Math.floor(Math.random() * 8);
                this.player.skills.dig = Math.floor(Math.random() * 8);
                this.player.skills.set = Math.floor(Math.random() * 8);
                
                // 随机生成体力上限，范围在80-110之间
                this.player.maxEnergy = Math.floor(Math.random() * 31) + 80;
                this.player.energy = this.player.maxEnergy;
                
                this.updateUI();
                this.updateInitialSkillsDisplay();
            }
            
            updateWeeklyHub() {
                const canTrain = this.player.trainingCount < this.player.maxTrainingPerWeek;
                const trainingText = canTrain ? 
                    `本周还可以训练 ${this.player.maxTrainingPerWeek - this.player.trainingCount} 次` :
                    `本周训练次数已用完`;
                
                let statusText = '';
                if (this.player.energy < 30) statusText += '<p style="color: #e74c3c;">⚠️ 体力不足，需要休息！</p>';
                if (this.player.mood < 40) statusText += '<p style="color: #e67e22;">⚠️ 心情低落，建议放松一下</p>';
                if (this.player.stress > 70) statusText += '<p style="color: #e74c3c;">⚠️ 压力过大，小心影响表现！</p>';
                
                // 检查是否到达目标周
                const goalInfo = this.getGoalInfo();
                let goalNotice = '';
                
                if (goalInfo.deadline && this.player.week >= goalInfo.deadline) {
                    goalNotice = '<p style="color: #2ecc71; font-weight: bold;">✨ 选拔/比赛时间已到！</p>';
                }
                
                SCENES.weeklyHub.text = `<h2>📅 第 ${this.player.week} 周</h2>
                <p>${trainingText}</p>
                ${statusText}
                ${goalNotice}
                <p style="margin-top: 15px;">你想做什么？</p>`;
                
                SCENES.weeklyHub.choices = [
                    {
                        text: '🏋️ 进行训练',
                        next: 'trainingChoice',
                        requirement: { trainingCount: this.player.maxTrainingPerWeek - 1, maxCheck: true }
                    },
                    {
                        text: '⏭️ 结束本周',
                        next: 'weekEnd'
                    }
                ];
                
                // 如果有足够的技能，添加选拔选项
                // 根据当前目标和周数添加选拔/比赛选项
                if (this.currentGoal === 'collegeTryout' && this.player.week >= 4 && this.player.team === 'none') {
                    SCENES.weeklyHub.choices.splice(SCENES.weeklyHub.choices.length - 1, 0, {
                        text: '🏆 参加院队选拔',
                        next: 'collegeTryout',
                        requirement: { serve: 30, spike: 25, block: 20, dig: 20, set: 20 }
                    });
                } else if (this.currentGoal === 'collegeMatch' && this.player.week >= 8 && this.player.team === 'college') {
                    SCENES.weeklyHub.choices.splice(SCENES.weeklyHub.choices.length - 1, 0, {
                        text: '🏆 参加院际比赛',
                        next: 'collegeMatch',
                        requirement: { serve: 45, spike: 40, block: 35, dig: 35, set: 35 }
                    });
                } else if (this.currentGoal === 'universityTryout' && this.player.week >= 12 && this.player.team === 'college') {
                    SCENES.weeklyHub.choices.splice(SCENES.weeklyHub.choices.length - 1, 0, {
                        text: '⭐ 申请校队选拔',
                        next: 'universityTryout',
                        requirement: { serve: 60, spike: 60, block: 50, dig: 50, set: 50, reputation: 60 }
                    });
                } else if (this.currentGoal === 'cityLeague' && this.player.week >= 16 && this.player.team === 'university') {
                    SCENES.weeklyHub.choices.splice(SCENES.weeklyHub.choices.length - 1, 0, {
                        text: '🏆 参加市级联赛',
                        next: 'cityLeague',
                        requirement: { serve: 80, spike: 80, block: 75, dig: 75, set: 75, reputation: 120 }
                    });
                }
            }
            
            triggerRandomEvent(eventType) {
                // 30% 概率触发事件
                if (Math.random() > 0.3) {
                    return null;
                }
                
                // 筛选符合类型的事件
                let availableEvents = RANDOM_EVENTS.filter(e => e.type === eventType);
                if (availableEvents.length === 0) return null;
                
                // 根据条件和权重计算每个事件的触发概率
                const weightedEvents = [];
                availableEvents.forEach(event => {
                    let weight = 1; // 默认权重
                    
                    // 检查是否满足条件
                    if (event.condition) {
                        const { operator } = event.condition;
                        let conditionMet = false;
                        
                        // 支持多属性条件检查
                        if (operator === '<') {
                            // 小于条件（如体力<30）
                            for (let key in event.condition) {
                                if (key !== 'operator' && this.player[key] !== undefined) {
                                    if (this.player[key] < event.condition[key]) {
                                        conditionMet = true;
                                        break;
                                    }
                                }
                            }
                        } else if (operator === '>') {
                            // 大于条件（如声望>50）
                            let allMet = true;
                            for (let key in event.condition) {
                                if (key !== 'operator' && this.player[key] !== undefined) {
                                    if (this.player[key] <= event.condition[key]) {
                                        allMet = false;
                                        break;
                                    }
                                }
                                // 检查技能
                                if (key !== 'operator' && this.player.skills && this.player.skills[key] !== undefined) {
                                    if (this.player.skills[key] <= event.condition[key]) {
                                        allMet = false;
                                        break;
                                    }
                                }
                            }
                            conditionMet = allMet;
                        }
                        
                        // 如果条件满足，应用权重加成
                        if (conditionMet && event.weight) {
                            weight = event.weight;
                        } else if (!conditionMet && event.weight) {
                            // 条件不满足但有条件限制的事件，降低权重
                            weight = 0.3;
                        }
                    }
                    
                    // 将事件按权重添加到列表中
                    for (let i = 0; i < weight; i++) {
                        weightedEvents.push(event);
                    }
                });
                
                if (weightedEvents.length === 0) return null;
                
                // 从加权列表中随机选择一个事件
                const event = weightedEvents[Math.floor(Math.random() * weightedEvents.length)];
                return event;
            }
            
            showRandomEvent(event) {
                this.currentEvent = event;
                this.currentEventType = event.type; // 记录事件类型
                
                // 使用弹窗显示事件
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                title.textContent = event.title;
                text.textContent = event.text;
                choicesDiv.innerHTML = '';
                
                event.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    
                    if (choice.requirement) {
                        const meetsRequirement = this.checkRequirement(choice.requirement);
                        if (!meetsRequirement) {
                            button.disabled = true;
                            button.textContent += ' (条件不足)';
                        }
                    }
                    
                    button.onclick = () => {
                        // 应用效果
                        if (choice.effect) {
                            this.applyEffect(choice.effect);
                        }
                        
                        // 在弹窗中显示结果
                        title.textContent = '✨ 结果';
                        text.innerHTML = this.formatEventResult(choice.result, choice.effect);
                        choicesDiv.innerHTML = '';
                        
                        const continueBtn = document.createElement('button');
                        continueBtn.className = 'choice-btn';
                        continueBtn.textContent = '继续';
                        continueBtn.onclick = () => {
                            modal.classList.remove('show');
                            
                            // 根据事件类型决定下一步
                            if (this.currentEventType === 'training') {
                                // 训练事件后进入课余生活
                                this.currentScene = 'lifeChoice';
                                this.showScene('lifeChoice');
                            } else {
                                // 生活事件后返回周选择
                                this.currentScene = 'weeklyHub';
                                this.showScene('weeklyHub');
                            }
                        };
                        choicesDiv.appendChild(continueBtn);
                    };
                    
                    choicesDiv.appendChild(button);
                });
                
                // 显示弹窗
                modal.classList.add('show');
            }
            
            formatEventResult(result, effect) {
                let html = `<p>${result}</p>`;
                
                // 构建属性变化显示
                let changesText = '<br><strong>属性变化：</strong><br>';
                let hasChanges = false;
                
                if (effect.serve) {
                    changesText += `🎯 发球 ${effect.serve > 0 ? '+' : ''}${effect.serve}<br>`;
                    hasChanges = true;
                }
                if (effect.spike) {
                    changesText += `⚡ 扣球 ${effect.spike > 0 ? '+' : ''}${effect.spike}<br>`;
                    hasChanges = true;
                }
                if (effect.block) {
                    changesText += `🛡️ 拦网 ${effect.block > 0 ? '+' : ''}${effect.block}<br>`;
                    hasChanges = true;
                }
                if (effect.dig) {
                    changesText += `🤸 垫球 ${effect.dig > 0 ? '+' : ''}${effect.dig}<br>`;
                    hasChanges = true;
                }
                if (effect.set) {
                    changesText += `🙌 托球 ${effect.set > 0 ? '+' : ''}${effect.set}<br>`;
                    hasChanges = true;
                }
                if (effect.energy) {
                    changesText += `💪 体力 ${effect.energy > 0 ? '+' : ''}${effect.energy}<br>`;
                    hasChanges = true;
                }
                if (effect.mood) {
                    changesText += `😊 心情 ${effect.mood > 0 ? '+' : ''}${effect.mood}<br>`;
                    hasChanges = true;
                }
                if (effect.stress) {
                    changesText += `😰 压力 ${effect.stress > 0 ? '+' : ''}${effect.stress}<br>`;
                    hasChanges = true;
                }
                if (effect.reputation) {
                    changesText += `⭐ 声望 ${effect.reputation > 0 ? '+' : ''}${effect.reputation}<br>`;
                    hasChanges = true;
                }
                if (effect.money) {
                    changesText += `💰 金钱 ${effect.money > 0 ? '+' : ''}${effect.money}<br>`;
                    hasChanges = true;
                }
                if (effect.relationship) {
                    changesText += `👥 队友关系 ${effect.relationship > 0 ? '+' : ''}${effect.relationship}<br>`;
                    hasChanges = true;
                }
                
                if (hasChanges) {
                    html += changesText;
                }
                
                return html;
            }
            
            nextWeek() {
                // 保存本周开始时的数据快照
                this.player.weekStartStats = {
                    serve: this.player.skills.serve,
                    spike: this.player.skills.spike,
                    block: this.player.skills.block,
                    dig: this.player.skills.dig,
                    set: this.player.skills.set,
                    maxEnergy: this.player.maxEnergy
                };
                
                this.player.week++;
                this.player.trainingCount = 0;
                this.player.money += 500; // 每周零花钱
                
                // 自然恢复
                this.player.energy = Math.min(this.player.maxEnergy, this.player.energy + 30);
                this.player.mood = Math.min(100, this.player.mood + 10);
                this.player.stress = Math.max(0, this.player.stress - 10);
                
                this.updateUI();
            }
            
            generateWeeklySummary() {
                const scene = SCENES.weekEnd;
                
                // 计算技能变化
                const changes = {
                    serve: this.player.skills.serve - this.player.weekStartStats.serve,
                    spike: this.player.skills.spike - this.player.weekStartStats.spike,
                    block: this.player.skills.block - this.player.weekStartStats.block,
                    dig: this.player.skills.dig - this.player.weekStartStats.dig,
                    set: this.player.skills.set - this.player.weekStartStats.set,
                    maxEnergy: this.player.maxEnergy - this.player.weekStartStats.maxEnergy
                };
                
                // 获取当前阶段
                const teamNames = {
                    'none': '基础训练',
                    'college': '院队',
                    'university': '校队'
                };
                const currentStage = teamNames[this.player.team];
                
                // 生成技能变化HTML（紧凑版）
                let skillChangesHTML = '<div style="background: #f8fafc; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 14px;">';
                skillChangesHTML += '<strong>本周成长</strong><br>';
                
                const skillIcons = {
                    serve: '🎯',
                    spike: '⚡',
                    block: '🛡️',
                    dig: '🏐',
                    set: '🤲'
                };
                
                const skillNames = {
                    serve: '发球',
                    spike: '扣球',
                    block: '拦网',
                    dig: '垫球',
                    set: '托球'
                };
                
                for (let skill in skillIcons) {
                    const change = changes[skill];
                    const icon = skillIcons[skill];
                    const name = skillNames[skill];
                    const newVal = this.player.skills[skill];
                    
                    if (change > 0) {
                        skillChangesHTML += `<span style="color: #22c55e;">${icon}${name} ${newVal}(+${change})</span> `;
                    } else if (change === 0) {
                        skillChangesHTML += `<span style="color: #9ca3af;">${icon}${name} ${newVal}</span> `;
                    } else {
                        skillChangesHTML += `<span style="color: #ef4444;">${icon}${name} ${newVal}(${change})</span> `;
                    }
                }
                
                if (changes.maxEnergy > 0) {
                    skillChangesHTML += `<br><span style="color: #22c55e;">💪体力上限+${changes.maxEnergy}</span>`;
                }
                
                skillChangesHTML += '</div>';
                
                // 生成目标进度HTML（紧凑版）
                const goalProgressHTML = this.generateGoalProgress();
                
                // 生成智能建议HTML（紧凑版）
                const suggestionsHTML = this.generateWeeklySuggestions(changes);
                
                // 组合完整的总结文本（紧凑版）
                scene.text = `<h2>📊 第${this.player.week}周·${currentStage}</h2>
                
                ${skillChangesHTML}
                
                ${goalProgressHTML}
                
                ${suggestionsHTML}
                
                <div style="background: #fef3c7; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 13px; color: #92400e;">
                    下周：训练0/3 | 零花钱+500 | 状态恢复
                </div>`;
            }
            
            generateGoalProgress() {
                const goalInfo = this.getGoalInfo();
                const req = goalInfo.requirements;
                
                let metCount = 0;
                let totalCount = 0;
                let progressHTML = '<div style="background: #f0fdf4; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 14px;">';
                
                // 简化标题
                const goalTitle = goalInfo.title.replace(/.*：/, '');
                progressHTML += `<strong>🎯 ${goalTitle}</strong>`;
                
                if (goalInfo.deadline) {
                    const weeksLeft = goalInfo.deadline - this.player.week;
                    if (weeksLeft > 0) {
                        progressHTML += ` <span style="color: #6b7280; font-size: 12px;">(剩${weeksLeft}周)</span>`;
                    } else {
                        progressHTML += ` <span style="color: #ef4444; font-size: 12px;">(超时)</span>`;
                    }
                }
                progressHTML += '<br>';
                
                const skillIcons = {
                    serve: '🎯',
                    spike: '⚡',
                    block: '🛡️',
                    dig: '🏐',
                    set: '🤲',
                    reputation: '⭐'
                };
                
                // 只显示未达标的项目，达标的用简单标记
                let unmetItems = [];
                for (let key in req) {
                    totalCount++;
                    const required = req[key];
                    const current = key === 'reputation' ? this.player.reputation : this.player.skills[key];
                    const met = current >= required;
                    
                    if (met) {
                        metCount++;
                    } else {
                        const diff = required - current;
                        unmetItems.push({ key, required, current, diff });
                    }
                }
                
                const progressPercent = Math.round((metCount / totalCount) * 100);
                
                // 显示进度
                if (progressPercent === 100) {
                    progressHTML += `<span style="color: #22c55e; font-weight: bold;">✅ 全部达标！</span>`;
                } else {
                    progressHTML += `<span style="color: #6b7280;">进度 ${metCount}/${totalCount} (${progressPercent}%)</span><br>`;
                    // 只显示未达标项
                    unmetItems.forEach(item => {
                        const icon = skillIcons[item.key] || '';
                        progressHTML += `<span style="color: #ef4444;">${icon}${item.required}(差${item.diff})</span> `;
                    });
                }
                
                progressHTML += '</div>';
                
                return progressHTML;
            }
            
            generateWeeklySuggestions(changes) {
                const suggestions = [];
                const goalInfo = this.getGoalInfo();
                const req = goalInfo.requirements;
                
                // 1. 检查紧急状态
                if (this.player.energy < 20) {
                    suggestions.push({ priority: 1, text: '⚠️ 体力严重不足，建议优先休息恢复' });
                }
                if (this.player.stress > 80) {
                    suggestions.push({ priority: 1, text: '⚠️ 压力过大，必须进行放松活动' });
                }
                if (this.player.money < 100) {
                    suggestions.push({ priority: 1, text: '💰 金钱不足，考虑兼职赚钱' });
                }
                if (this.player.mood < 30) {
                    suggestions.push({ priority: 1, text: '😔 心情低落，建议休闲娱乐提升心情' });
                }
                
                // 2. 检查目标进度
                let metCount = 0;
                let totalCount = 0;
                let shortfalls = [];
                
                for (let key in req) {
                    totalCount++;
                    const required = req[key];
                    const current = key === 'reputation' ? this.player.reputation : this.player.skills[key];
                    
                    if (current >= required) {
                        metCount++;
                    } else {
                        const diff = required - current;
                        const skillNames = { serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球', reputation: '声望' };
                        shortfalls.push({ skill: skillNames[key], diff: diff, key: key });
                    }
                }
                
                const progressPercent = (metCount / totalCount) * 100;
                
                if (progressPercent >= 100) {
                    suggestions.push({ 
                        priority: 2, 
                        text: `🎉 已达标！可以挑战目标了` 
                    });
                } else if (progressPercent >= 80) {
                    const topShortfall = shortfalls.sort((a, b) => b.diff - a.diff)[0];
                    suggestions.push({ 
                        priority: 2, 
                        text: `💡 接近目标！重点提升${topShortfall.skill}(差${topShortfall.diff})` 
                    });
                } else if (progressPercent >= 50) {
                    const top2Shortfalls = shortfalls.sort((a, b) => b.diff - a.diff).slice(0, 2);
                    suggestions.push({ 
                        priority: 2, 
                        text: `💪 稳步前进！短板：${top2Shortfalls.map(s => `${s.skill}(${s.diff})`).join('、')}` 
                    });
                } else {
                    suggestions.push({ 
                        priority: 2, 
                        text: `⚡ 加快节奏！建议每周训练满3次` 
                    });
                }
                
                // 3. 职业相关建议（简化）
                if (this.player.position !== 'none') {
                    const posInfo = this.getPositionInfo();
                    const coreSkillsMet = posInfo.coreSkills.every(skill => {
                        const baseReq = posInfo.baseRequirements[skill] || 0;
                        return this.player.skills[skill] >= baseReq;
                    });
                    
                    if (!coreSkillsMet) {
                        const skillNames = { serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球' };
                        const coreNames = posInfo.coreSkills.map(s => skillNames[s]).join('、');
                        suggestions.push({ 
                            priority: 3, 
                            text: `${posInfo.icon} ${posInfo.name}核心技能：${coreNames}(+50%加成)` 
                        });
                    }
                }
                
                // 4. 训练效率建议（简化）
                if (this.player.trainingCount < 2) {
                    suggestions.push({ 
                        priority: 4, 
                        text: `📈 本周训练较少(${this.player.trainingCount}/3)，建议增加训练` 
                    });
                }
                
                // 计算总提升
                const totalGrowth = Math.abs(changes.serve) + Math.abs(changes.spike) + Math.abs(changes.block) + Math.abs(changes.dig) + Math.abs(changes.set);
                
                if (totalGrowth === 0 && this.player.trainingCount > 0) {
                    suggestions.push({ 
                        priority: 4, 
                        text: `🤔 训练了但无提升，注意保持良好状态` 
                    });
                } else if (totalGrowth >= 20) {
                    suggestions.push({ 
                        priority: 5, 
                        text: `🌟 本周表现出色！提升${totalGrowth}点` 
                    });
                }
                
                // 按优先级排序，取前2条（手机版只显示2条）
                const topSuggestions = suggestions.sort((a, b) => a.priority - b.priority).slice(0, 2);
                
                let html = '<div style="background: #dbeafe; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 14px;">';
                html += '<strong>💡 建议</strong><br>';
                topSuggestions.forEach(s => {
                    html += `<div style="margin: 4px 0; color: #1e40af;">• ${s.text}</div>`;
                });
                html += '</div>';
                
                return html;
            }
            
            updateUI() {
                document.getElementById('week').textContent = this.player.week;
                document.getElementById('training-count').textContent = `${this.player.trainingCount}/${this.player.maxTrainingPerWeek}`;
                document.getElementById('energy').textContent = this.player.energy;
                document.getElementById('mood').textContent = this.player.mood;
                document.getElementById('stress').textContent = this.player.stress;
                document.getElementById('reputation').textContent = this.player.reputation;
                document.getElementById('money').textContent = this.player.money;
                
                const teamNames = {
                    'none': '无',
                    'college': '院队',
                    'university': '校队'
                };
                document.getElementById('team').textContent = teamNames[this.player.team];
                
                // 显示职业信息
                const positionStat = document.getElementById('position-stat');
                const positionElement = document.getElementById('position');
                if (this.player.position !== 'none') {
                    const posInfo = this.getPositionInfo();
                    positionStat.style.display = 'block';
                    positionElement.textContent = `${posInfo.icon} ${posInfo.name}`;
                } else {
                    positionStat.style.display = 'none';
                }
                
                for (let skill in this.player.skills) {
                    const value = this.player.skills[skill];
                    document.getElementById(`${skill}-value`).textContent = value;
                    const bar = document.getElementById(`${skill}-bar`);
                    bar.style.width = `${value}%`;
                    bar.textContent = value;
                }
                
                this.drawRadarChart();
                this.updateGoalDisplay();
            }
            
            drawRadarChart() {
                const canvas = document.getElementById('skills-radar');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = 75;
                
                // 清空画布
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 技能数据（五边形，从正上方开始，顺时针）
                const skills = [
                    { name: '发球', value: this.player.skills.serve, angle: -Math.PI / 2 },
                    { name: '扣球', value: this.player.skills.spike, angle: -Math.PI / 2 + Math.PI * 2 / 5 },
                    { name: '拦网', value: this.player.skills.block, angle: -Math.PI / 2 + Math.PI * 4 / 5 },
                    { name: '垫球', value: this.player.skills.dig, angle: -Math.PI / 2 + Math.PI * 6 / 5 },
                    { name: '托球', value: this.player.skills.set, angle: -Math.PI / 2 + Math.PI * 8 / 5 }
                ];
                
                // 绘制背景网格
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                for (let i = 1; i <= 5; i++) {
                    ctx.beginPath();
                    const r = (radius / 5) * i;
                    skills.forEach((skill, index) => {
                        const x = centerX + r * Math.cos(skill.angle);
                        const y = centerY + r * Math.sin(skill.angle);
                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    ctx.closePath();
                    ctx.stroke();
                }
                
                // 绘制轴线
                ctx.strokeStyle = '#ccc';
                ctx.lineWidth = 1;
                skills.forEach(skill => {
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    const x = centerX + radius * Math.cos(skill.angle);
                    const y = centerY + radius * Math.sin(skill.angle);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                });
                
                // 绘制数据区域
                ctx.fillStyle = 'rgba(102, 126, 234, 0.3)';
                ctx.strokeStyle = 'rgba(102, 126, 234, 0.8)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                skills.forEach((skill, index) => {
                    const value = Math.min(skill.value, 100);
                    const r = (radius / 100) * value;
                    const x = centerX + r * Math.cos(skill.angle);
                    const y = centerY + r * Math.sin(skill.angle);
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                
                // 绘制数据点
                ctx.fillStyle = '#667eea';
                skills.forEach(skill => {
                    const value = Math.min(skill.value, 100);
                    const r = (radius / 100) * value;
                    const x = centerX + r * Math.cos(skill.angle);
                    const y = centerY + r * Math.sin(skill.angle);
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // 绘制标签
                ctx.fillStyle = '#333';
                ctx.font = 'bold 13px "Microsoft YaHei", Arial, sans-serif';
                
                skills.forEach((skill, index) => {
                    const labelRadius = radius + 30;
                    const x = centerX + labelRadius * Math.cos(skill.angle);
                    const y = centerY + labelRadius * Math.sin(skill.angle);
                    
                    // 根据索引精确设置每个标签的对齐方式
                    switch(index) {
                        case 0: // 发球 - 正上方
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            break;
                        case 1: // 扣球 - 右上
                            ctx.textAlign = 'left';
                            ctx.textBaseline = 'middle';
                            break;
                        case 2: // 拦网 - 右下
                            ctx.textAlign = 'left';
                            ctx.textBaseline = 'middle';
                            break;
                        case 3: // 垫球 - 左下
                            ctx.textAlign = 'right';
                            ctx.textBaseline = 'middle';
                            break;
                        case 4: // 托球 - 左上
                            ctx.textAlign = 'right';
                            ctx.textBaseline = 'middle';
                            break;
                    }
                    
                    ctx.fillText(skill.name, x, y);
                });
            }

            
            applyEffect(effect) {
                if (effect.reset) {
                    this.player = {
                        name: '新生',
                        week: 1,
                        trainingCount: 0,
                        maxTrainingPerWeek: 3,
                        energy: 100,
                        maxEnergy: 100,
                        mood: 80,
                        stress: 20,
                        reputation: 10,
                        money: 100,
                        team: 'none',
                        position: 'none',
                        positionLevel: 0,
                        adaptationWeeks: 0,
                        skills: {
                            serve: 0,
                            spike: 0,
                            block: 0,
                            dig: 0,
                            set: 0
                        },
                        attributes: {
                            strength: 0,
                            agility: 0,
                            stamina: 0,
                            coordination: 0
                        },
                        relationships: {
                            coach: 50,
                            teammates: 50
                        },
                        achievements: []
                    };
                    this.rerollsRemaining = 5;
                    this.currentScene = 'nameInput';
                    document.getElementById('character-panel').classList.remove('show');
                    document.getElementById('game-header').classList.remove('show');
                    this.updateUI();
                    return;
                }
                
                if (effect.nextWeek) {
                    this.nextWeek();
                    return;
                }
                
                if (effect.eventResult) {
                    // 构建属性变化显示
                    let changesText = '<br><br><strong>属性变化：</strong><br>';
                    let hasChanges = false;
                    
                    if (effect.serve) {
                        changesText += `🎯 发球 ${effect.serve > 0 ? '+' : ''}${effect.serve}<br>`;
                        hasChanges = true;
                    }
                    if (effect.spike) {
                        changesText += `⚡ 扣球 ${effect.spike > 0 ? '+' : ''}${effect.spike}<br>`;
                        hasChanges = true;
                    }
                    if (effect.block) {
                        changesText += `🛡️ 拦网 ${effect.block > 0 ? '+' : ''}${effect.block}<br>`;
                        hasChanges = true;
                    }
                    if (effect.dig) {
                        changesText += `🏐 垫球 ${effect.dig > 0 ? '+' : ''}${effect.dig}<br>`;
                        hasChanges = true;
                    }
                    if (effect.set) {
                        changesText += `🤲 托球 ${effect.set > 0 ? '+' : ''}${effect.set}<br>`;
                        hasChanges = true;
                    }
                    if (effect.energy) {
                        changesText += `💪 体力 ${effect.energy > 0 ? '+' : ''}${effect.energy}<br>`;
                        hasChanges = true;
                    }
                    if (effect.mood) {
                        changesText += `😊 心情 ${effect.mood > 0 ? '+' : ''}${effect.mood}<br>`;
                        hasChanges = true;
                    }
                    if (effect.stress) {
                        changesText += `😰 压力 ${effect.stress > 0 ? '+' : ''}${effect.stress}<br>`;
                        hasChanges = true;
                    }
                    if (effect.reputation) {
                        changesText += `⭐ 声望 ${effect.reputation > 0 ? '+' : ''}${effect.reputation}<br>`;
                        hasChanges = true;
                    }
                    if (effect.money) {
                        changesText += `💰 金钱 ${effect.money > 0 ? '+' : ''}${effect.money}<br>`;
                        hasChanges = true;
                    }
                    if (effect.relationship) {
                        changesText += `👥 队友关系 ${effect.relationship > 0 ? '+' : ''}${effect.relationship}<br>`;
                        hasChanges = true;
                    }
                    
                    SCENES.eventResult.text = `<h2>✨ 结果</h2>
                    <p>${effect.eventResult}</p>
                    ${hasChanges ? changesText : ''}`;
                }
                
                if (effect.goalUpdate) {
                    this.currentGoal = effect.goalUpdate;
                }
                
                if (effect.eventType) {
                    this.lastEventType = effect.eventType;
                }
                
                if (effect.trained) {
                    this.player.trainingCount++;
                }
                
                // 应用职业训练加成
                const skillEffects = ['serve', 'spike', 'block', 'dig', 'set'];
                skillEffects.forEach(skill => {
                    if (effect[skill]) {
                        const bonus = this.getTrainingBonus(skill);
                        const finalValue = Math.round(effect[skill] * (1 + bonus));
                        this.player.skills[skill] = Math.min(100, this.player.skills[skill] + finalValue);
                        
                        // 如果有加成，显示提示
                        if (bonus > 0 && effect.trained) {
                            console.log(`${skill} 训练获得职业加成: ${bonus * 100}%`);
                        }
                    }
                });
                if (effect.energy) this.player.energy = Math.max(0, Math.min(this.player.maxEnergy, this.player.energy + effect.energy));
                if (effect.maxEnergyBonus) this.player.maxEnergy = Math.min(150, this.player.maxEnergy + effect.maxEnergyBonus);
                if (effect.mood) this.player.mood = Math.max(0, Math.min(100, this.player.mood + effect.mood));
                if (effect.stress) this.player.stress = Math.max(0, Math.min(100, this.player.stress + effect.stress));
                if (effect.reputation) this.player.reputation += effect.reputation;
                if (effect.money) this.player.money += effect.money;
                if (effect.team) this.player.team = effect.team;
                if (effect.relationship) {
                    this.player.relationships.teammates = Math.min(100, this.player.relationships.teammates + effect.relationship);
                }
                
                this.updateUI();
            }
            
            checkRequirement(req) {
                if (req.energy && this.player.energy < req.energy) return false;
                if (req.mood && this.player.mood < req.mood) return false;
                if (req.money && this.player.money < req.money) return false;
                if (req.team && this.player.team !== req.team) return false;
                if (req.reputation && this.player.reputation < req.reputation) return false;
                if (req.serve && this.player.skills.serve < req.serve) return false;
                if (req.spike && this.player.skills.spike < req.spike) return false;
                if (req.block && this.player.skills.block < req.block) return false;
                if (req.dig && this.player.skills.dig < req.dig) return false;
                if (req.set && this.player.skills.set < req.set) return false;
                if (req.maxCheck && req.trainingCount !== undefined) {
                    if (this.player.trainingCount > req.trainingCount) return false;
                }
                return true;
            }

            
            showScene(sceneId) {
                console.log('showScene called with:', sceneId);
                const scene = SCENES[sceneId];
                if (!scene) {
                    console.error('Scene not found:', sceneId);
                    alert('场景未找到: ' + sceneId);
                    return;
                }
                
                // 动态更新特定场景
                if (sceneId === 'start' && this.player.name !== '新生') {
                    scene.text = `<h2>🎓 大学新生活</h2>
                    <p><strong>${this.player.name}</strong>，你是一名刚入学的大一新生，从未接触过排球。</p>
                    <p>开学第一周，你路过体育馆，看到排球社团正在招新。阳光透过窗户洒在球场上，学长学姐们矫健的身影让你心生向往。</p>
                    <p>"想试试吗？"一位学姐笑着向你招手。</p>`;
                }
                
                if (sceneId === 'weeklyHub') {
                    this.updateWeeklyHub();
                }
                
                if (sceneId === 'weekEnd') {
                    this.generateWeeklySummary();
                }
                
                // 课余生活场景特殊渲染
                if (sceneId === 'lifeChoice') {
                    this.renderLifeChoice();
                    return;
                }
                
                // 职业选择场景特殊渲染
                if (sceneId === 'positionSelection') {
                    this.renderPositionSelection();
                    return;
                }
                
                // 比赛场景
                if (sceneId === 'casualMatch') {
                    this.startMatch('casual');
                    return;
                }
                
                if (sceneId === 'matchResult') {
                    this.showMatchResult();
                    return;
                }
                
                // 检查是否触发随机事件
                if (sceneId === 'checkRandomEvent' && this.lastEventType) {
                    const event = this.triggerRandomEvent(this.lastEventType);
                    this.lastEventType = null;
                    
                    if (event) {
                        this.showRandomEvent(event);
                        return;
                    } else {
                        // 没有触发事件，根据之前的类型决定下一步
                        this.currentScene = 'weeklyHub';
                        this.showScene('weeklyHub');
                        return;
                    }
                }
                
                const storyText = document.getElementById('story-text');
                const choicesDiv = document.getElementById('choices');
                
                storyText.innerHTML = scene.text;
                choicesDiv.innerHTML = '';
                
                scene.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    
                    if (choice.requirement) {
                        const meetsRequirement = this.checkRequirement(choice.requirement);
                        if (!meetsRequirement) {
                            button.disabled = true;
                            button.textContent += ' (条件不足)';
                        }
                    }
                    
                    button.onclick = () => {
                        if (choice.effect) {
                            this.applyEffect(choice.effect);
                            
                            // 检查是否需要触发随机事件
                            if (choice.effect.eventType) {
                                const event = this.triggerRandomEvent(choice.effect.eventType);
                                if (event) {
                                    // 触发事件，暂不跳转场景
                                    this.showRandomEvent(event);
                                    return;
                                }
                            }
                        }
                        if (choice.next) {
                            this.currentScene = choice.next;
                            this.showScene(choice.next);
                        }
                    };
                    
                    choicesDiv.appendChild(button);
                });
            }
        }
        
        // 启动游戏
        let game;
        
        // 分享功能
        function shareGame() {
            const shareData = {
                title: '排球之星 - 从菜鸟到冠军',
                text: '我在玩排球之星，从菜鸟到冠军的成长之路！快来一起玩吧！',
                url: window.location.href
            };
            
            // 检查是否支持原生分享API（移动端）
            if (navigator.share) {
                navigator.share(shareData)
                    .then(() => {
                        console.log('分享成功');
                    })
                    .catch((error) => {
                        if (error.name !== 'AbortError') {
                            console.log('分享失败', error);
                            fallbackShare();
                        }
                    });
            } else {
                // 桌面端或不支持的浏览器，复制链接
                fallbackShare();
            }
        }
        
        function fallbackShare() {
            const url = window.location.href;
            
            // 尝试使用剪贴板API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url)
                    .then(() => {
                        showShareMessage('✅ 链接已复制到剪贴板！\n快去分享给朋友吧！');
                    })
                    .catch(() => {
                        showShareMessage('📋 请复制链接：\n' + url);
                    });
            } else {
                // 降级方案：显示链接让用户手动复制
                showShareMessage('📋 请复制链接：\n' + url);
            }
        }
        
        function showShareMessage(message) {
            // 创建临时提示框
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.85);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                font-size: 14px;
                z-index: 10000;
                text-align: center;
                white-space: pre-line;
                max-width: 80%;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 3秒后自动消失
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired');
            try {
                console.log('Creating game instance...');
                game = new VolleyballGame();
                console.log('Game instance created:', game);
            } catch (e) {
                console.error('Error creating game:', e);
                alert('游戏初始化失败: ' + e.message);
            }
        });
    </script>
</body>
</html>

