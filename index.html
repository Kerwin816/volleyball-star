<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>排球之星 - 从菜鸟到冠军</title>
    <!-- Version: 2.2.0 - Skill Growth Rebalance -->
    
    <!-- SEO优化 -->
    <meta name="description" content="体验从大一新生到市级冠军的排球之旅！训练、比赛、成长，书写你的排球传奇！">
    <meta name="keywords" content="排球游戏,文字冒险,体育游戏,成长游戏,排球之星">
    <meta name="author" content="小水">
    
    <!-- 微信分享优化 -->
    <meta property="og:title" content="排球之星 - 从菜鸟到冠军的成长之路" />
    <meta property="og:description" content="体验从大一新生到市级冠军的排球之旅！训练、比赛、成长，书写你的排球传奇！" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://via.placeholder.com/1200x630/667eea/ffffff?text=排球之星" />
    
    <!-- 移动端优化 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="排球之星">
    <meta name="theme-color" content="#667eea">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }
        }
        
        #game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #game-container {
                border-radius: 10px;
                max-width: 100%;
                margin: 0;
            }
        }
        
        #game-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            text-align: center;
            display: none;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #game-header {
                padding: 15px 10px;
            }
        }
        
        #game-header.show {
            display: block;
        }
        
        #game-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            white-space: nowrap;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #game-header h1 {
                font-size: 16px;
                margin-bottom: 8px;
            }
        }
        
        #current-goal {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        #current-goal h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        
        #current-goal p {
            margin: 3px 0;
        }
        
        .goal-requirement {
            color: #fff;
            font-weight: bold;
        }
        
        .goal-met {
            color: #2ecc71;
        }
        
        .goal-not-met {
            color: #ffeb3b;
        }
        
        #event-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        #event-modal.show {
            display: flex;
        }
        
        #event-modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #event-modal-content {
                padding: 20px;
                width: 95%;
                max-height: 85vh;
                border-radius: 10px;
            }
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        #event-modal-content h2 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        #event-modal-content p {
            line-height: 1.8;
            margin-bottom: 20px;
        }
        
        #event-modal-choices {
            display: grid;
            gap: 10px;
        }
        
        /* 比赛弹窗样式 */
        #match-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        #match-modal.show {
            display: flex;
        }
        
        #match-modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #match-modal-content {
                padding: 20px 15px;
                width: 95%;
                max-height: 85vh;
                border-radius: 10px;
            }
        }
        
        #match-modal-content h2 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #match-score-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        #match-log {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        .match-log-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            animation: slideIn 0.3s ease-out;
            opacity: 0;
            animation-fill-mode: forwards;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .match-log-item.my-point {
            border-left: 4px solid #2ecc71;
            background: rgba(46, 204, 113, 0.2);
        }
        
        .match-log-item.opponent-point {
            border-left: 4px solid #e74c3c;
            background: rgba(231, 76, 60, 0.2);
        }
        
        /* 技能触发特殊样式 - 金色边框和背景 */
        .match-log-item.skill-triggered {
            border: 3px solid #ffd700 !important;
            border-left: 4px solid #ffd700 !important;
            background: rgba(255, 215, 0, 0.25) !important;
        }
        
        .match-log-score {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .match-log-description {
            color: #ddd;
            font-size: 14px;
        }
        
        #match-modal-choices {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* 目标面板样式 */
        #goals-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        
        #goals-panel.show {
            display: flex;
        }
        
        #goals-panel-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        #goals-panel-content h2 {
            color: white;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .goal-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid;
        }
        
        .goal-card.current {
            border-left-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }
        
        .goal-card.next {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.15);
        }
        
        .goal-card.future {
            border-left-color: #9E9E9E;
            background: rgba(158, 158, 158, 0.1);
        }
        
        .goal-card.completed {
            border-left-color: #2196F3;
            background: rgba(33, 150, 243, 0.15);
            opacity: 0.7;
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .goal-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .goal-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .goal-badge.current {
            background: #ffd700;
            color: #333;
        }
        
        .goal-badge.next {
            background: #4CAF50;
            color: white;
        }
        
        .goal-badge.completed {
            background: #2196F3;
            color: white;
        }
        
        .goal-description {
            margin: 10px 0;
            font-size: 14px;
            color: #ddd;
        }
        
        .goal-requirements {
            margin: 15px 0;
        }
        
        .goal-requirements h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .requirement-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 13px;
        }
        
        .requirement-met {
            color: #4CAF50;
        }
        
        .requirement-not-met {
            color: #ff6b6b;
        }
        
        .goal-tips {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            font-size: 12px;
            color: #ddd;
        }
        
        .tab-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .tab-btn {
                padding: 6px 10px;
                font-size: 12px;
                border-radius: 15px;
            }
        }
        
        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* 目标按钮 - 金黄色强调 */
        .tab-btn-primary {
            background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
            color: #333;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.4);
        }
        
        .tab-btn-primary:hover {
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.6);
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .tab-btn-primary {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
        
        #stats-bar {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #stats-bar {
                font-size: 12px;
                gap: 8px;
            }
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
        }

        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }
        
        #game-content {
            padding: 30px;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #game-content {
                padding: 15px;
            }
        }
        
        #story-text {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 150px;
            line-height: 1.8;
            font-size: 16px;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #story-text {
                padding: 15px;
                font-size: 15px;
                line-height: 1.6;
                min-height: 100px;
            }
        }
        
        #choices {
            display: grid;
            gap: 10px;
        }
        
        /* 课余生活分类布局 - 紧凑型 */
        .life-categories {
            display: grid;
            gap: 15px;
        }
        
        .life-category {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            border-left: 4px solid;
        }
        
        .life-category.sports {
            border-left-color: #ff6b6b;
        }
        
        .life-category.rest {
            border-left-color: #4ecdc4;
        }
        
        .life-category.social {
            border-left-color: #95e1d3;
        }
        
        .life-category.food {
            border-left-color: #ffd93d;
        }
        
        .life-category.work {
            border-left-color: #6c5ce7;
        }
        
        .category-title {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .category-choices {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .life-choice-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .life-choice-card:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .life-choice-card:disabled {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .life-choice-icon {
            font-size: 28px;
            margin-bottom: 4px;
        }
        
        .life-choice-title {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 13px;
        }
        
        .life-choice-effects {
            font-size: 10px;
            opacity: 0.9;
            line-height: 1.3;
        }
        
        @media (max-width: 768px) {
            .category-choices {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .life-choice-icon {
                font-size: 24px;
            }
            
            .life-choice-title {
                font-size: 12px;
            }
            
            .life-choice-effects {
                font-size: 9px;
            }
        }
        
        @media (min-width: 769px) {
            .category-choices {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* 反馈弹窗样式 */
        .feedback-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        
        .feedback-modal.show {
            display: flex;
        }
        
        .feedback-modal-content {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        .feedback-modal-content h2 {
            color: white;
            margin-bottom: 20px;
        }
        
        .feedback-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
        }
        
        .contact-section {
            margin: 20px 0;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            font-size: 16px;
        }
        
        .contact-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .contact-label {
            color: rgba(255, 255, 255, 0.8);
            margin-right: 5px;
        }
        
        .contact-value {
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        .qr-code-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .qr-code-placeholder {
            text-align: center;
        }
        
        /* 商店系统样式 - 紧凑型一级入口 */
        .shop-category-section {
            margin-bottom: 25px;
        }
        
        .shop-category-header {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }
        
        .shop-items-compact {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }
        
        .shop-item-compact {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .shop-item-compact:hover:not(.disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }
        
        .shop-item-compact.disabled {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .item-compact-name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 6px;
            line-height: 1.3;
        }
        
        .item-compact-desc {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 6px;
            line-height: 1.3;
            min-height: 32px;
        }
        
        .item-compact-price {
            font-size: 13px;
            font-weight: bold;
            padding: 4px 8px;
            background: rgba(255,255,255,0.25);
            border-radius: 6px;
            display: inline-block;
        }
        
        .item-compact-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .item-compact-badge.owned {
            background: rgba(46, 204, 113, 0.9);
        }
        
        .item-compact-badge.locked {
            background: rgba(231, 76, 60, 0.9);
        }
        
        @media (max-width: 768px) {
            .shop-items-compact {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .item-compact-name {
                font-size: 13px;
            }
            
            .item-compact-price {
                font-size: 12px;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .shop-items-compact {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 1025px) {
            .shop-items-compact {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* 旧的商店样式（保留以防需要） */
        .shop-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .shop-category-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .shop-category-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .shop-cat-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .shop-cat-name {
            font-size: 16px;
            font-weight: bold;
        }
        
        .shop-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .shop-item-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            transition: all 0.3s;
        }
        
        .shop-item-card:hover:not(.disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .shop-item-card.disabled {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            opacity: 0.7;
        }
        
        .item-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .item-description {
            font-size: 13px;
            margin-bottom: 10px;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .item-price {
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
            padding: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            text-align: center;
        }
        
        .item-owned {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .item-locked {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .shop-item-card button {
            width: 100%;
            background: rgba(255,255,255,0.3);
            color: white;
            border: 2px solid white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .shop-item-card button:hover:not(:disabled) {
            background: white;
            color: #667eea;
        }
        
        .shop-item-card button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .shop-categories {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .shop-items-grid {
                grid-template-columns: 1fr;
            }
            
            .shop-cat-icon {
                font-size: 36px;
            }
        }
        
        .choice-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            text-align: left;
        }
        
        /* 重要按钮样式（金黄色） */
        .choice-btn-important {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 50%, #ffd700 100%);
            color: white;
            border: 2px solid #ffd700;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            text-align: left;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .choice-btn {
                padding: 12px 15px;
                font-size: 15px;
                border-radius: 8px;
            }
            
            .choice-btn-important {
                padding: 12px 15px;
                font-size: 15px;
                border-radius: 8px;
            }
        }
        
        .choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .choice-btn-important:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
        }
        
        .choice-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* 职业选择卡片样式 */
        .position-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .position-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }
        
        .position-card:hover:not(.disabled) {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .position-card.disabled {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .position-card.recommended {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 0 20px rgba(245, 87, 108, 0.5);
        }
        
        .position-recommended {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 215, 0, 0.9);
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .position-match {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            padding: 5px;
            background: rgba(255,255,255,0.25);
            border-radius: 8px;
        }
        
        .position-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .position-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .position-desc {
            font-size: 13px;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .position-skills {
            font-size: 12px;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        
        .position-requirements {
            font-size: 11px;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            line-height: 1.6;
        }
        
        .position-restrictions {
            font-size: 10px;
            margin-top: 8px;
            padding: 5px;
            background: rgba(255,100,100,0.3);
            border-radius: 5px;
            color: #ffeb3b;
        }
        
        .position-locked {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .position-cards {
                grid-template-columns: 1fr;
            }
        }

        
        #character-panel {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #character-panel {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .skills-container {
                gap: 12px;
            }
            
            .status-section {
                padding: 10px;
                gap: 6px;
            }
            
            .status-item {
                padding: 6px 3px;
            }
            
            .status-label {
                font-size: 11px;
            }
            
            .status-value {
                font-size: 16px;
            }
            
            .volleyball-skills {
                gap: 6px;
            }
            
            .skill-name {
                font-size: 13px;
                margin-bottom: 4px;
            }
            
            .progress-bar {
                height: 22px;
            }
            
            .progress-fill {
                font-size: 11px;
                padding-right: 6px;
            }
        }
        
        #character-panel.show {
            display: block;
        }
        
        .skills-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .skills-left {
            width: 100%;
        }
        
        .skills-right {
            width: 100%;
        }
        
        /* 状态值区域样式 - 横向布局 */
        .status-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px 15px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 5px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
        }
        
        .status-label {
            font-size: 13px;
            font-weight: 500;
            color: #666;
            margin-bottom: 4px;
        }
        
        .status-value {
            font-size: 18px;
            font-weight: bold;
            color: #f093fb;
        }
        
        /* 排球技能区域样式 */
        .volleyball-skills {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .volleyball-skills .skill-bar {
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin: 0;
        }
        
        #name-input-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #name-input-panel {
                padding: 20px 15px;
                border-radius: 10px;
            }
        }
        
        #name-input-panel h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        #name-input-panel input {
            width: calc(100% - 60px);
            padding: 15px;
            font-size: 18px;
            border: 2px solid #667eea;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s;
            display: inline-block;
        }
        
        #name-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #random-name-btn {
            background: #e9ecef;
            color: #666;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 10px;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.3s;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        #random-name-btn:hover {
            transform: rotate(360deg) scale(1.05);
        }
        
        #random-name-btn:active {
            transform: rotate(360deg) scale(0.95);
        }
        
        #initial-attributes {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        #initial-attributes h3 {
            text-align: center;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .init-attr-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .init-attr-item:last-child {
            border-bottom: none;
        }
        
        .init-attr-value {
            font-weight: bold;
            color: #667eea;
        }
        
        .init-attr-rating {
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #667eea;
            font-weight: bold;
            color: #f5576c;
        }
        
        #reroll-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: nowrap;
        }
        
        #reroll-btn {
            background: #e9ecef;
            color: #666;
            border: 1px solid #dee2e6;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        #reroll-btn:hover:not(:disabled) {
            transform: scale(1.02);
        }
        
        #reroll-btn:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        #reroll-btn:disabled {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
            border-color: #e9ecef;
        }
        
        #reroll-count {
            color: #999;
            font-size: 11px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            #reroll-container {
                gap: 6px;
                margin-top: 10px;
            }
            
            #reroll-btn {
                padding: 3px 8px;
                font-size: 11px;
                border-radius: 4px;
            }
            
            #reroll-count {
                font-size: 10px;
            }
        }
        
        #name-input-panel button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #name-input-panel button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* 开始游戏按钮特殊样式 */
        #name-input-panel button.start-game-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
            font-weight: bold;
        }
        
        #name-input-panel button.start-game-btn:hover {
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }
        
        .hidden {
            display: none;
        }
        
        .attribute-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .attribute-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .attribute-item:last-child {
            border-bottom: none;
        }
        
        .attribute-value {
            font-weight: bold;
            color: #667eea;
        }
        
        .skill-bar {
            margin: 10px 0;
        }
        
        .skill-name {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .skill-value {
            font-weight: bold;
            color: #667eea;
        }
        
        .progress-bar {
            background: #dee2e6;
            height: 24px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            height: 100%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            border-radius: 10px;
        }
        
        /* 队友平均能力进度条 - 使用不同颜色 */
        .team-average-fill {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        }
        
        /* 开发者署名 */
        .developer-credit {
            text-align: center;
            padding: 15px;
            font-size: 11px;
            color: #999;
            opacity: 0.6;
            margin-top: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .version-number {
            color: #667eea;
            font-weight: 500;
            opacity: 0.8;
        }
        
        
        /* 跳过按钮 */
        .skip-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .skip-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .skip-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }
        
        /* 刮刮乐样式 */
        .scratch-card-result {
            text-align: center;
            padding: 40px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-width: 350px;
            animation: scratchCardFadeIn 0.3s ease-out;
        }
        
        .scratch-card-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: iconBounce 0.6s ease-out;
        }
        
        .scratch-card-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 25px;
        }
        
        .scratch-card-rewards {
            font-size: 20px;
            line-height: 1.8;
            margin-bottom: 25px;
        }
        
        .scratch-card-close {
            padding: 12px 40px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            transition: all 0.3s;
        }
        
        .scratch-card-close:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        /* 特等奖 - 金色闪耀 */
        .scratch-grand-prize {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #8B0000;
            animation: prizeShine 1.5s infinite;
        }
        
        .scratch-grand-prize .scratch-card-title {
            color: #8B0000;
        }
        
        .scratch-grand-prize .scratch-card-rewards {
            color: #8B0000;
        }
        
        /* 一等奖 - 橙色 */
        .scratch-first-prize {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
            color: white;
        }
        
        .scratch-first-prize .scratch-card-title {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .scratch-first-prize .scratch-card-rewards {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        /* 二等奖 - 银色 */
        .scratch-second-prize {
            background: linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%);
            color: #333;
        }
        
        .scratch-second-prize .scratch-card-title {
            color: #1a1a1a;
        }
        
        .scratch-second-prize .scratch-card-rewards {
            color: #1a1a1a;
        }
        
        /* 三等奖 - 铜色 */
        .scratch-third-prize {
            background: linear-gradient(135deg, #CD7F32 0%, #B87333 100%);
            color: white;
        }
        
        .scratch-third-prize .scratch-card-title {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .scratch-third-prize .scratch-card-rewards {
            color: #FFF8DC;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
            font-weight: bold;
        }
        
        /* 安慰奖 - 浅蓝 */
        .scratch-consolation-prize {
            background: #87CEEB;
            color: #1E3A8A;
        }
        
        .scratch-consolation-prize .scratch-card-title {
            color: #1E3A8A;
        }
        
        .scratch-consolation-prize .scratch-card-rewards {
            color: #1E3A8A;
        }
        
        /* 谢谢惠顾 - 灰色 */
        .scratch-nothing-prize {
            background: #F0F0F0;
            color: #666;
        }
        
        .scratch-nothing-prize .scratch-card-title {
            color: #666;
        }
        
        .scratch-nothing-prize .scratch-card-rewards {
            color: #666;
        }
        
        /* 图标弹跳动画 */
        @keyframes iconBounce {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        /* 特等奖闪耀动画 */
        @keyframes prizeShine {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 1); }
        }
        
        /* 弹窗淡入动画 */
        @keyframes scratchCardFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* 排球点击小游戏样式 */
        .volleyball-game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .volleyball-game-modal {
            background: #ffffff;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        /* 倒计时样式 */
        .volleyball-game-countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10001;
            pointer-events: none;
        }
        
        .countdown-number {
            font-size: 120px;
            font-weight: bold;
            color: #f093fb;
            text-shadow: 0 0 20px rgba(240, 147, 251, 0.5);
            animation: countdownPulse 1s ease-out;
        }
        
        @keyframes countdownPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .volleyball-game-header {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            transition: opacity 0.3s;
        }
        
        .volleyball-game-skip {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10002;
        }
        
        .volleyball-game-skip:hover {
            background: rgba(255, 107, 107, 1);
            transform: scale(1.05);
        }
        
        .volleyball-game-skip:active {
            transform: scale(0.95);
        }
        
        .volleyball-game-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1;
            padding: 20px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 15px;
            transition: opacity 0.3s;
        }
        
        .volleyball-game-cell {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .volleyball-game-cell:active {
            transform: scale(0.95);
        }
        
        .volleyball-game-item {
            animation: itemAppear 0.3s ease-out;
        }
        
        @keyframes itemAppear {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .volleyball-game-hint {
            text-align: center;
            font-size: 24px;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .hint-time {
            color: #ff6b6b;
            font-size: 32px;
            font-weight: 900;
            text-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
        }
        
        .volleyball-game-combo {
            color: #ff6b6b;
            font-size: 24px;
            font-weight: bold;
            animation: comboFlash 0.5s ease-in-out;
        }
        
        @keyframes comboFlash {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .volleyball-game-feedback {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            pointer-events: none;
            animation: feedbackFloat 1s ease-out forwards;
        }
        
        @keyframes feedbackFloat {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(-50px);
                opacity: 0;
            }
        }
        
        .feedback-positive {
            color: #4CAF50;
        }
        
        .feedback-negative {
            color: #ff6b6b;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .volleyball-game-modal {
                padding: 20px;
                max-width: 95%;
                border-radius: 15px;
            }
            
            .countdown-number {
                font-size: 80px;
            }
            
            .volleyball-game-header {
                font-size: 14px;
                padding: 10px;
            }
            
            .volleyball-game-cell {
                font-size: 45px;
            }
            
            .volleyball-game-hint {
                font-size: 18px;
            }
            
            .hint-time {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-header">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                <h1>🏐 排球之星</h1>
                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                    <button id="goals-tab-btn" class="tab-btn tab-btn-primary" onclick="game.toggleGoalsPanel()">🎯 目标</button>
                    <button id="feedback-btn" class="tab-btn" onclick="game.toggleFeedbackModal()">� 反馈</button>
                    <button id="share-btn" class="tab-btn" onclick="shareGame()">📤 分享</button>
                </div>
            </div>
            <div id="current-goal">
                <h3>📍 当前目标</h3>
                <p id="goal-text">加载中...</p>
            </div>
            <div id="stats-bar">
                <div class="stat">
                    <span class="stat-label">周次</span>
                    <span class="stat-value" id="week">1</span>
                </div>
                <div class="stat">
                    <span class="stat-label">训练</span>
                    <span class="stat-value" id="training-count">0/3</span>
                </div>
                <div class="stat">
                    <span class="stat-label">队伍</span>
                    <span class="stat-value" id="team">无</span>
                </div>
                <div class="stat" id="position-stat" style="display: none;">
                    <span class="stat-label">职业</span>
                    <span class="stat-value" id="position">未选择</span>
                </div>
            </div>
        </div>
        
        <div id="game-content">
            <div id="character-panel">
                <h3>📊 能力值</h3>
                <div class="skills-container">
                    <div class="skills-left">
                        <!-- 状态值区域 -->
                        <div class="status-section">
                            <div class="status-item">
                                <span class="status-label">体力</span>
                                <span class="status-value" id="energy">100</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">心情</span>
                                <span class="status-value" id="mood">80</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">压力</span>
                                <span class="status-value" id="stress">20</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">声望</span>
                                <span class="status-value" id="reputation">10</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">金钱</span>
                                <span class="status-value" id="money">100</span>
                            </div>
                        </div>
                    </div>
                    <div class="skills-right">
                        <!-- 排球技能区域 -->
                        <div class="volleyball-skills">
                            <div class="skill-bar">
                                <div class="skill-name">
                                    <span>发球</span>
                                    <span id="serve-value">0</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="serve-bar" style="width: 0%">0</div>
                                </div>
                            </div>
                            <div class="skill-bar">
                                <div class="skill-name">
                                    <span>扣球</span>
                                    <span id="spike-value">0</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="spike-bar" style="width: 0%">0</div>
                                </div>
                            </div>
                            <div class="skill-bar">
                                <div class="skill-name">
                                    <span>拦网</span>
                                    <span id="block-value">0</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="block-bar" style="width: 0%">0</div>
                                </div>
                            </div>
                            <div class="skill-bar">
                                <div class="skill-name">
                                    <span>垫球</span>
                                    <span id="dig-value">0</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="dig-bar" style="width: 0%">0</div>
                                </div>
                            </div>
                            <div class="skill-bar">
                                <div class="skill-name">
                                    <span>托球</span>
                                    <span id="set-value">0</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="set-bar" style="width: 0%">0</div>
                                </div>
                            </div>
                            <!-- 队友平均能力 -->
                            <div class="skill-bar" id="team-average-skill-bar" style="display: none;">
                                <div class="skill-name">
                                    <span>队友平均能力</span>
                                    <span id="team-average-value">0</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill team-average-fill" id="team-average-bar" style="width: 0%">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="story-text"></div>
            <div id="choices"></div>
        </div>
        
        <!-- 开发者署名和版本号 -->
        <div class="developer-credit">
            <span>开发者：小水</span>
            <span class="version-number" id="game-version">v2.2.0</span>
        </div>
    </div>
    
    
    <!-- 事件弹窗 -->
    <div id="event-modal">
        <div id="event-modal-content">
            <h2 id="event-modal-title">事件</h2>
            <p id="event-modal-text"></p>
            <div id="event-modal-choices"></div>
        </div>
    </div>
    
    <!-- 比赛弹窗 -->
    <div id="match-modal">
        <div id="match-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="match-modal-title" style="margin: 0;">🏐 比赛进行中</h2>
                <button id="skip-match-btn" class="skip-btn" onclick="game.skipMatch()">⏭️ 跳过</button>
            </div>
            <div id="match-score-display">
                <span id="my-score">0</span>
                <span style="margin: 0 20px;">:</span>
                <span id="opponent-score">0</span>
            </div>
            <div id="match-log"></div>
            <div id="match-modal-choices"></div>
        </div>
    </div>
    
    <!-- 目标面板 -->
    <div id="goals-panel">
        <div id="goals-panel-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>🎯 成长目标</h2>
                <button class="close-btn" onclick="game.toggleGoalsPanel()">✕</button>
            </div>
            <div id="goals-list"></div>
        </div>
    </div>

    <!-- 更新日志弹窗 -->
    <div id="changelog-modal" class="feedback-modal">
        <div class="feedback-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>📋 版本更新日志</h2>
                <button class="close-btn" onclick="game.toggleChangelogModal()">✕</button>
            </div>
            <div class="feedback-info" style="max-height: 60vh; overflow-y: auto;">
                <!-- 
                    ==================== 更新日志配置区域 ====================
                    在这里编写你的更新日志内容
                    支持HTML格式，可以使用以下标签：
                    - <h3>版本号</h3>
                    - <p>更新内容</p>
                    - <ul><li>列表项</li></ul>
                    - <strong>加粗</strong>
                    - <br> 换行
                -->
                <h3 style="color: #a78bfa; margin-top: 0;">v2.5.1 (2024-02-20)</h3>
                <ul style="color: rgba(255,255,255,0.85); line-height: 1.8;">
                    <li>修复存档问题</li>
                    <li>修复决赛无法进行问题</li>
                </ul>
                <h3 style="color: #a78bfa; margin-top: 0;">v2.5.0 (2024-02-20)</h3>
                <ul style="color: rgba(255,255,255,0.85); line-height: 1.8;">
                    <li>新增队友系统</li>
                    <li>调整若干数值</li>
                    <li>修复一系列Bug</li>
                </ul>
                <h3 style="color: #a78bfa; margin-top: 0;">v2.4.0 (2024-02-18)</h3>
                <ul style="color: rgba(255,255,255,0.85); line-height: 1.8;">
                    <li>新增"看小排球"娱乐活动，点开有内容哦</li>
                    <li>重新设计心情系统：训练消耗增加，自然恢复降低，娱乐恢复提升</li>
                    <li>修复自由人比赛强度计算，现在只计算垫球和托球能力</li>
                    <li>重新平衡锦标赛难度，基于新的胜率计算系统</li>
                    <li>优化比赛胜率系统，改为直接计算整场胜率而非单分胜率</li>
                    <li>修复娱乐活动二次弹窗覆盖问题</li>
                    <li>修复隐藏结局后重新开始时目标未重置的问题</li>
                </ul>
                
                <!-- <h3 style="color: #a78bfa; margin-top: 20px;">v2.3.5 (2024-02-17)</h3>
                <ul style="color: rgba(255,255,255,0.85); line-height: 1.8;">
                    <li>🎨 优化了手机端界面显示</li>
                    <li>⚖️ 调整了锦标赛难度平衡</li>
                    <li>📊 改进了能力值进度条显示</li>
                    <li>🎯 增加了校队选拔声望要求</li>
                    <li>🐛 修复了随机事件弹窗显示问题</li>
                </ul> -->
                    
                    <!-- 常用emoji：
                    🎨 界面优化  ⚖️ 平衡调整  🐛 Bug修复
                    ✨ 新功能    📊 数据调整  🎯 目标系统
                    🏐 核心玩法  💼 职业系统  🛍️ 商店系统
                    📱 移动端    🎮 小游戏    🏆 比赛系统 --> 
            </div>
        </div>
    </div>

    <!-- 反馈弹窗 -->
    <div id="feedback-modal" class="feedback-modal">
        <div class="feedback-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>💬 问题反馈</h2>
                <button class="close-btn" onclick="game.toggleFeedbackModal()">✕</button>
            </div>
            <div class="feedback-info">
                <p style="text-align: center; color: rgba(255, 255, 255, 0.9); margin-bottom: 20px;">
                    遇到Bug或有建议？欢迎联系我！
                </p>
                <div class="contact-section">
                    <div class="contact-item">
                        <span class="contact-icon">📱</span>
                        <span class="contact-label">小红书号：</span>
                        <span class="contact-value">269540383</span>
                    </div>
                    <div class="contact-item">
                        <span class="contact-icon">👤</span>
                        <span class="contact-label">昵称：</span>
                        <span class="contact-value">💧</span>
                    </div>
                </div>
                <div class="qr-code-section">
                    <p style="text-align: center; color: rgba(255, 255, 255, 0.85); font-size: 14px; margin-bottom: 10px;">
                        扫描二维码在小红书找到我
                    </p>
                    <div class="qr-code-placeholder">
                        <img src="https://s41.ax1x.com/2026/02/17/pZOyIeO.jpg" 
                             alt="小红书二维码" 
                             style="width: 200px; height: 200px; border-radius: 10px; background: #f5f5f5; display: block; margin: 0 auto;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== 游戏配置 ====================
        // 版本号配置（统一管理）
        const GAME_VERSION = '2.5.1';
        
        // 姓氏库
        const SURNAMES = [
            // 常见单姓
            '张', '王', '李', '刘', '陈', '杨', '黄', '赵', '吴', '周',
            '徐', '孙', '马', '朱', '夏', '郭', '何', '林', '高', '罗',
            '郑', '梁', '谢', '宋', '唐', '许', '韩', '冯', '邓', '曹',
            '彭', '曾', '肖', '田', '董', '袁', '潘', '于', '蒋', '蔡',
            '余', '杜', '叶', '程', '苏', '魏', '吕', '丁', '任', '沈',
            '姚', '卢', '姜', '崔', '钟', '谭', '陆', '汪', '范', '金',
            // 复姓
            '欧阳', '司马', '上官', '诸葛', '东方', '独孤', '南宫', '西门',
            '慕容', '轩辕', '令狐', '皇甫', '公孙', '澹台',
            // 排球少年角色姓氏
            '日向', '影山', '月岛', '山口', '田中', '西谷', '东峰', '泽村', '菅原', '缘下',
            '及川', '岩泉', '松川', '花卷', '金田一', '国见',
            '牛岛', '天童', '五色', '白布', '大平', '川西',
            '黑尾', '孤爪', '夜久', '山本', '海信', '犬冈', '福永',
            // '宫', '角名', '北', '大耳', '尾白',
            // '木兔', '赤苇', '黑川', '京谷', '佐久早',
        ];
        
        // 名字库（排球/运动相关）
        const GIVEN_NAMES = [
            // 排球技术相关
            '发球', '扣杀', '拦网', '防守', '传球', '垫球', '飘球', '跳发',
            '暴扣', '轻吊', '快攻', '强攻', '后攻', '跳飘', '救球', '一传',
            '二传', '三米线', '标志杆', '中线', '边线', '底线', '发球区',
            '进攻线', '自由区', '换人区', '暂停', '轮转', '换位', '掩护',
            
            // 排球术语
            '25分', '局点', '赛点', '触网', '连击', '持球',
            '界内', '界外', '擦网', '探头球',
            
            // 运动特质相关
            '如风', '似电', '破空', '凌云', '冲天', '惊雷', '闪电', '疾风',
            '翱翔', '腾跃', '飞扬', '奔雷', '追风', '逐日', '破浪', '凌空',
            '弹跳', '滞空', '起跳', '落地', '助跑', '摆臂', '转体', '扣腕',
            
            // 励志相关
            '必胜', '争先', '超越', '拼搏', '奋进', '向前', '冲锋', '突破',
            '登峰', '夺冠', '称霸', '无敌', '制霸', '王者', '霸主', '至尊',
            '冠军', '金牌', '银牌', '铜牌', '第一', '第二', '第三', '第四',
            
            // 品质相关
            '坚韧', '刚毅', '勇猛', '果敢', '无畏', '英勇', '威武', '神勇',
            '灵动', '敏捷', '迅捷', '矫健', '强健', '雄壮', '威猛', '刚强',
            '精准', '稳定', '爆发', '持久', '协调', '平衡', '节奏', '时机',
            
            // 谐音梗（更像名字）
            '球胜', '网罗', '排云', '跃进', '高飞', '远志', '凌峰', '震天',
            '惊鸿', '绝尘', '无双', '独秀', '出众', '超群', '卓越', '非凡',
            '得分', '失分', '零封', '逆转', '绝杀', '制胜', '关键', '决胜',
            
            // 搞笑排球梗
            '吃发球', '被拦死', '下网', '出界', '失误', '送分', '漏人',
            '站位', '补位', '跟进', '保护', '串联', '组织', '调整',
            '高点', '低点', '平拉开', '背飞', '背快', '短平快', '时间差',
            '空中接力', '鱼跃救球', '滚翻救球', '倒地救球', '单手救球',
            
            // 单字名
            '跃', '飞', '翔', '腾', '冲', '闯', '拼', '搏', '扛', '顶',
            '强', '刚', '勇', '威', '猛', '锐', '峰', '杰', '霸', '尊',
            '灵', '敏', '捷', '快', '迅', '疾', '速', '风', '雷', '电',
            '扣', '拦', '垫', '托', '传', '发', '攻', '守', '防', '救',
            '网', '球', '场', '赛', '冠', '王', '霸', '神', '仙', '圣',

            // 作者指定
            '建军','企鹅','摩卡',
        ];
        
        // 生成随机名字
        function generateRandomName() {
            const surname = SURNAMES[Math.floor(Math.random() * SURNAMES.length)];
            const givenName = GIVEN_NAMES[Math.floor(Math.random() * GIVEN_NAMES.length)];
            return surname + givenName;
        }
        
        // 随机事件库（扩展版）
        const RANDOM_EVENTS = [
            // 训练相关事件
            {
                id: 'senior_guidance',
                type: 'training',
                title: '🎓 学长指导',
                text: '训练时，一位学长注意到了你，主动过来指导你的动作。',
                choices: [
                    {
                        text: '虚心请教，认真学习',
                        effect: { serve: 2, spike: 2, mood: 5, reputation: 2 },
                        result: '学长很高兴，教了你一些技巧，你的技能有所提升！'
                    },
                    {
                        text: '礼貌感谢，自己琢磨',
                        effect: { mood: 2, stress: -2 },
                        result: '你保持了自己的训练节奏。'
                    }
                ]
            },
            {
                id: 'injury_risk',
                type: 'training',
                title: '⚠️ 训练意外',
                text: '训练强度有点大，你感觉身体有些不适...',
                condition: { energy: 30, operator: '<' },
                weight: 3,
                choices: [
                    {
                        text: '坚持完成训练',
                        effect: { serve: 2, spike: 2, energy: -10, stress: 5 },
                        result: '你咬牙坚持了下来，技能有所提升，但很疲惫。'
                    },
                    {
                        text: '适当休息，保护身体',
                        effect: { energy: 5, mood: 3, stress: -3 },
                        result: '你明智地选择了休息，身体恢复了一些。'
                    }
                ]
            },
            {
                id: 'coach_praise',
                type: 'training',
                title: '👍 教练表扬',
                text: '教练注意到你最近的进步，当众表扬了你！',
                choices: [
                    {
                        text: '谦虚回应，继续努力',
                        effect: { mood: 8, reputation: 3, stress: -3 },
                        result: '你的谦虚赢得了大家的好感。'
                    },
                    {
                        text: '信心大增，加练一会',
                        effect: { serve: 2, spike: 2, energy: -8, mood: 10 },
                        result: '你趁热打铁，又练了一会儿，收获满满！'
                    }
                ]
            },

            
            // 生活相关事件
            {
                id: 'meet_friend',
                type: 'life',
                title: '👋 偶遇朋友',
                text: '在食堂遇到了老朋友，他邀请你一起吃饭聊天。',
                choices: [
                    {
                        text: '愉快聊天，分享近况',
                        effect: { mood: 10, stress: -5, money: -15 },
                        result: '你们聊得很开心，心情舒畅了许多！'
                    },
                    {
                        text: '简单寒暄，各自离开',
                        effect: { mood: 2 },
                        result: '你们简单聊了几句就分开了。'
                    }
                ]
            },
            {
                id: 'study_pressure',
                type: 'life',
                title: '📝 课业压力',
                text: '突然想起明天有个作业要交，还没开始做...',
                choices: [
                    {
                        text: '熬夜赶作业',
                        effect: { energy: -15, mood: -5, stress: 8, reputation: 2 },
                        result: '你熬夜完成了作业，但很疲惫。'
                    },
                    {
                        text: '先休息，明早早起做',
                        effect: { energy: 10, stress: 3 },
                        result: '你选择了先休息，明天再说。'
                    },
                    {
                        text: '找同学借鉴一下',
                        effect: { mood: 5, stress: -5, relationship: -2 },
                        result: '同学帮了你，但你有点不好意思。'
                    }
                ]
            },
            {
                id: 'lucky_money',
                type: 'life',
                title: '💰 意外之财',
                text: '在路上捡到了一些钱！',
                choices: [
                    {
                        text: '交给失物招领处',
                        effect: { mood: 5, reputation: 5 },
                        result: '你做了正确的事，心里很踏实。'
                    },
                    {
                        text: '自己留着用',
                        effect: { money: 30, mood: 8, stress: 2 },
                        result: '你把钱留下了，但心里有点不安。'
                    }
                ]
            },
            {
                id: 'club_activity',
                type: 'life',
                title: '🎉 社团活动',
                text: '学校社团组织活动，邀请你参加。',
                choices: [
                    {
                        text: '积极参加',
                        effect: { mood: 15, stress: -8, money: -30, reputation: 5 },
                        result: '活动很愉快，你认识了一些新朋友！'
                    },
                    {
                        text: '婉拒邀请',
                        effect: { energy: 10, money: 10 },
                        result: '你选择了休息，省下了一笔开销。'
                    }
                ]
            },
            {
                id: 'equipment_sale',
                type: 'life',
                title: '🛍️ 装备促销',
                text: '体育用品店在打折，有一双很不错的排球鞋。',
                choices: [
                    {
                        text: '买下来（花费80元）',
                        effect: { money: -80, mood: 12, serve: 2, spike: 2 },
                        requirement: { money: 80 },
                        result: '新鞋很舒适，训练效果更好了！'
                    },
                    {
                        text: '不买，省钱',
                        effect: { mood: -3 },
                        result: '你忍住了购买的冲动。'
                    }
                ]
            },
            {
                id: 'weather_good',
                type: 'life',
                title: '☀️ 好天气',
                text: '今天天气特别好，阳光明媚，心情舒畅。',
                choices: [
                    {
                        text: '出去散散步',
                        effect: { mood: 10, stress: -5, energy: 5 },
                        result: '你享受了美好的天气，神清气爽！'
                    },
                    {
                        text: '在宿舍休息',
                        effect: { energy: 8, mood: 3 },
                        result: '你在宿舍好好休息了一下。'
                    }
                ]
            },
            
            // 新增事件 - 基于属性触发
            {
                id: 'serious_injury',
                type: 'training',
                title: '🚑 运动损伤',
                text: '糟糕！训练时你不小心扭伤了脚踝，疼痛难忍...',
                condition: { energy: 20, operator: '<' },
                weight: 5,
                choices: [
                    {
                        text: '立即去医务室（花费50元）',
                        effect: { energy: -5, mood: -10, stress: 5, money: -50 },
                        requirement: { money: 50 },
                        result: '医生给你做了处理，需要休息几天。'
                    },
                    {
                        text: '忍一忍，自己处理',
                        effect: { energy: -15, mood: -15, stress: 10, serve: -2, spike: -2 },
                        result: '伤势加重了，影响了你的状态和技能...'
                    }
                ]
            },
            {
                id: 'perfect_state',
                type: 'training',
                title: '✨ 完美状态',
                text: '今天状态特别好，感觉浑身充满力量！',
                condition: { energy: 80, mood: 70, operator: '>' },
                weight: 4,
                choices: [
                    {
                        text: '抓住机会，强化训练',
                        effect: { serve: 3, spike: 3, block: 3, energy: -20, mood: 10 },
                        result: '你充分利用了这个状态，技能大幅提升！'
                    },
                    {
                        text: '正常训练即可',
                        effect: { serve: 3, spike: 3, energy: -10, mood: 5 },
                        result: '你完成了正常的训练。'
                    }
                ]
            },
            {
                id: 'technique_breakthrough',
                type: 'training',
                title: '💡 技术突破',
                text: '训练中你突然领悟了一个新技巧！',
                choices: [
                    {
                        text: '反复练习，巩固技巧',
                        effect: { serve: 3, spike: 3, energy: -15, mood: 12 },
                        result: '你把新技巧练得很熟练了！'
                    },
                    {
                        text: '记在心里，下次再练',
                        effect: { serve: 2, spike: 2, mood: 5 },
                        result: '你记住了这个技巧。'
                    }
                ]
            },
            {
                id: 'equipment_broken',
                type: 'training',
                title: '💔 装备损坏',
                text: '训练时你的球鞋开胶了，影响了训练效果。',
                choices: [
                    {
                        text: '马上去买新的（花费100元）',
                        effect: { money: -100, mood: -5, serve: 2, spike: 2 },
                        requirement: { money: 100 },
                        result: '新鞋很合脚，训练效果更好了！'
                    },
                    {
                        text: '凑合着用',
                        effect: { mood: -8, serve: -2, spike: -2 },
                        result: '破鞋影响了你的发挥...'
                    }
                ]
            },
            {
                id: 'depression',
                type: 'life',
                title: '😔 情绪低落',
                text: '最近心情一直不太好，感觉有些抑郁...',
                condition: { mood: 30, operator: '<' },
                weight: 4,
                choices: [
                    {
                        text: '找朋友倾诉',
                        effect: { mood: 15, stress: -10, teammateChemistry: { random: 5 } },
                        result: '朋友的安慰让你感觉好多了。'
                    },
                    {
                        text: '自己调节，出去走走',
                        effect: { mood: 8, stress: -5, energy: -5 },
                        result: '散步让你的心情稍微好了一些。'
                    },
                    {
                        text: '一个人待着',
                        effect: { mood: -5, stress: 5 },
                        result: '你独自待了一会儿，但心情没有好转。'
                    }
                ]
            },
            {
                id: 'stress_overload',
                type: 'life',
                title: '😰 压力爆表',
                text: '压力太大了，你感觉快要崩溃了...',
                condition: { stress: 80, operator: '>' },
                weight: 5,
                choices: [
                    {
                        text: '放下一切，好好休息',
                        effect: { stress: -20, mood: 10, energy: 15 },
                        result: '你给自己放了个假，感觉轻松多了。'
                    },
                    {
                        text: '找心理咨询（花费50元）',
                        effect: { stress: -25, mood: 8, money: -50 },
                        requirement: { money: 50 },
                        result: '专业的帮助让你释放了压力。'
                    },
                    {
                        text: '继续硬撑',
                        effect: { stress: 5, mood: -10, energy: -10 },
                        result: '你的状态越来越差...'
                    }
                ]
            },
            {
                id: 'broke',
                type: 'life',
                title: '💸 手头紧张',
                text: '钱快花光了，这周的生活费不够用了...',
                condition: { money: 50, operator: '<' },
                weight: 4,
                choices: [
                    {
                        text: '找兼职打工',
                        effect: { money: 100, energy: -20, stress: 5, mood: -5 },
                        result: '你辛苦打工赚了些钱。'
                    },
                    {
                        text: '向家里要钱',
                        effect: { money: 200, mood: -5, stress: 3 },
                        result: '家里给你打了钱，但你有些愧疚。'
                    },
                    {
                        text: '节衣缩食',
                        effect: { mood: -8, energy: -5 },
                        result: '你开始省吃俭用。'
                    }
                ]
            },
            {
                id: 'scholarship',
                type: 'life',
                title: '🎓 奖学金通知',
                text: '你获得了学校的奖学金！',
                condition: { reputation: 50, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '开心接受',
                        effect: { money: 300, mood: 20, reputation: 5 },
                        result: '这是对你努力的认可！'
                    }
                ]
            },
            {
                id: 'love_confession',
                type: 'life',
                title: '💕 有人表白',
                text: '一位同学向你表白了！',
                condition: { reputation: 60, operator: '>' },
                weight: 1,
                choices: [
                    {
                        text: '接受，开始恋爱',
                        effect: { mood: 25, stress: -15, energy: -5, money: -50 },
                        result: '你们在一起了，感觉很幸福！'
                    },
                    {
                        text: '婉拒，专注排球',
                        effect: { mood: -5, stress: 5, serve: 3, spike: 3 },
                        result: '你选择了专注于排球事业。'
                    }
                ]
            },
            {
                id: 'family_call',
                type: 'life',
                title: '📞 家人来电',
                text: '家里打来电话，关心你的近况。',
                choices: [
                    {
                        text: '聊聊近况',
                        effect: { mood: 12, stress: -8 },
                        result: '和家人聊天让你感到温暖。'
                    },
                    {
                        text: '简单报平安',
                        effect: { mood: 3 },
                        result: '你简单说了几句就挂了电话。'
                    }
                ]
            },
            {
                id: 'roommate_conflict',
                type: 'life',
                title: '😤 室友矛盾',
                text: '和室友因为一些小事发生了争执。',
                choices: [
                    {
                        text: '主动道歉和解',
                        effect: { mood: 5, stress: -5, teammateChemistry: { random: 3 } },
                        result: '你们和好了，默契反而更好了。'
                    },
                    {
                        text: '冷战处理',
                        effect: { mood: -10, stress: 8 },
                        result: '宿舍气氛变得很尴尬...'
                    }
                ]
            },
            {
                id: 'game_addiction',
                type: 'life',
                title: '🎮 游戏诱惑',
                text: '新游戏上线了，朋友们都在玩，你也很想试试...',
                choices: [
                    {
                        text: '玩一整天',
                        effect: { mood: 20, stress: -15, energy: -15, serve: -2, spike: -2 },
                        result: '游戏很好玩，但荒废了训练...'
                    },
                    {
                        text: '玩一会就停',
                        effect: { mood: 10, stress: -5, energy: -5 },
                        result: '你适度娱乐，保持了平衡。'
                    },
                    {
                        text: '拒绝诱惑',
                        effect: { mood: -3, serve: 3, spike: 3 },
                        result: '你坚持训练，技能有所提升。'
                    }
                ]
            },
            {
                id: 'food_poisoning',
                type: 'life',
                title: '🤢 食物中毒',
                text: '吃了不干净的东西，肚子很不舒服...',
                choices: [
                    {
                        text: '去医院看病（花费80元）',
                        effect: { energy: -5, mood: -5, money: -80 },
                        requirement: { money: 80 },
                        result: '医生给你开了药，休息几天就好了。'
                    },
                    {
                        text: '自己宿舍找药吃',
                        effect: { energy: -20, mood: -8, },
                        result: '吃了药，但还是很难受。'
                    }
                ]
            },
            {
                id: 'volunteer_activity',
                type: 'life',
                title: '🤝 志愿者活动',
                text: '学校组织志愿者活动，邀请你参加。',
                choices: [
                    {
                        text: '积极参与',
                        effect: { mood: 15, stress: -5, energy: -10, reputation: 8 },
                        result: '帮助他人让你感到很充实！'
                    },
                    {
                        text: '婉拒邀请',
                        effect: { energy: 5 },
                        result: '你选择了休息。'
                    }
                ]
            },
            {
                id: 'talent_show',
                type: 'life',
                title: '🎤 才艺表演',
                text: '学校举办才艺表演，有人建议你展示排球技巧。',
                condition: { serve: 40, spike: 40, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '上台表演',
                        effect: { mood: 18, stress: 5, reputation: 15 },
                        result: '你的表演赢得了热烈掌声！'
                    },
                    {
                        text: '害羞拒绝',
                        effect: { mood: -3, stress: -2 },
                        result: '你不好意思上台。'
                    }
                ]
            },
            {
                id: 'exam_week',
                type: 'life',
                title: '📚 考试周',
                text: '期末考试周到了，需要平衡学习和训练。',
                choices: [
                    {
                        text: '专心复习，暂停训练',
                        effect: { stress: 10, energy: -10, serve: -3, spike: -3, reputation: 5 },
                        result: '你通过了考试，但技能有所退步。'
                    },
                    {
                        text: '两者兼顾',
                        effect: { stress: 15, energy: -20, mood: -10 },
                        result: '你很累，但都坚持了下来。'
                    },
                    {
                        text: '优先训练',
                        effect: { serve: 3, spike: 3, stress: 10, reputation: -5 },
                        result: '训练效果不错，但成绩不太理想。'
                    }
                ]
            },
            {
                id: 'birthday',
                type: 'life',
                title: '🎂 生日快乐',
                text: '今天是你的生日，朋友们给你准备了惊喜！',
                choices: [
                    {
                        text: '开心庆祝',
                        effect: { mood: 25, stress: -15, money: -30, reputation: 5 },
                        result: '这是难忘的一天！'
                    }
                ]
            },
            {
                id: 'rainy_day',
                type: 'life',
                title: '🌧️ 阴雨天',
                text: '连续下了好几天雨，心情有些低落。',
                choices: [
                    {
                        text: '室内训练',
                        effect: { serve: 3, spike: 3, energy: -10, mood: -3 },
                        result: '虽然天气不好，但你坚持了训练。'
                    },
                    {
                        text: '休息放松',
                        effect: { energy: 10, mood: 5, stress: -5 },
                        result: '你好好休息了一下。'
                    }
                ]
            },
            {
                id: 'inspiration',
                type: 'life',
                title: '💫 观赛启发',
                text: '看了一场精彩的排球比赛，深受启发！',
                choices: [
                    {
                        text: '马上去训练',
                        effect: { serve: 2, spike: 2, block: 2, energy: -15, mood: 15 },
                        result: '你充满动力，训练效果很好！'
                    },
                    {
                        text: '记在心里',
                        effect: { mood: 8, serve: 2, spike: 2 },
                        result: '你学到了一些新东西。'
                    }
                ]
            },
            {
                id: 'senior_retire',
                type: 'life',
                title: '👋 学长毕业',
                text: '一直指导你的学长要毕业了，他送给你一些训练心得。',
                condition: { reputation: 40, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '认真学习心得',
                        effect: { serve: 2, spike: 2, block: 2, mood: 10, reputation: 5 },
                        result: '学长的经验让你受益匪浅！'
                    },
                    {
                        text: '感谢并道别',
                        effect: { mood: 5, reputation: 2 },
                        result: '你们互相祝福。'
                    }
                ]
            },
            {
                id: 'media_interview',
                type: 'life',
                title: '📰 媒体采访',
                text: '校报记者想采访你这位排球新星。',
                condition: { reputation: 80, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '接受采访',
                        effect: { mood: 12, stress: 5, reputation: 10 },
                        result: '你的故事登上了校报！'
                    },
                    {
                        text: '低调拒绝',
                        effect: { mood: 3, stress: -3 },
                        result: '你选择保持低调。'
                    }
                ]
            },
            {
                id: 'lucky_day',
                type: 'life',
                title: '🍀 幸运日',
                text: '今天运气特别好，好事连连！',
                choices: [
                    {
                        text: '享受这一天',
                        effect: { mood: 15, stress: -10, money: 50, reputation: 3 },
                        result: '真是美好的一天！'
                    }
                ]
            },
            {
                id: 'part_time_offer',
                type: 'life',
                title: '💼 兼职机会',
                text: '体育用品店老板看中了你，邀请你来店里做兼职。',
                choices: [
                    {
                        text: '接受兼职（金钱+200，体力-15，压力+5）',
                        effect: { money: 200, energy: -15, stress: 5, mood: 5 },
                        result: '你在店里工作了一段时间，赚了不少钱。'
                    },
                    {
                        text: '婉拒，专注训练',
                        effect: { serve: 3, spike: 3, mood: 3 },
                        result: '你选择把时间用在训练上。'
                    }
                ]
            },
            {
                id: 'shopping_temptation',
                type: 'life',
                title: '🛍️ 购物诱惑',
                text: '路过商场，看到很多想买的东西...',
                condition: { money: 200, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '疯狂购物（心情+30，花费300元）',
                        effect: { mood: 30, stress: -15, money: -300 },
                        requirement: { money: 300 },
                        result: '买买买！心情大好！'
                    },
                    {
                        text: '理性消费（心情+10，花费50元）',
                        effect: { mood: 10, money: -50 },
                        requirement: { money: 50 },
                        result: '你只买了必需品。'
                    },
                    {
                        text: '忍住不买',
                        effect: { mood: -5, stress: 3 },
                        result: '你忍住了购物的冲动，但有点不开心。'
                    }
                ]
            },
            {
                id: 'sponsor_offer',
                type: 'life',
                title: '🤝 赞助邀约',
                text: '一家运动品牌看中了你的潜力，愿意提供赞助！',
                condition: { reputation: 70, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '接受赞助',
                        effect: { money: 500, mood: 20, reputation: 10, serve: 3, spike: 3 },
                        result: '你获得了品牌赞助，还得到了专业装备！'
                    },
                    {
                        text: '暂时拒绝',
                        effect: { mood: 5 },
                        result: '你觉得时机还不成熟。'
                    }
                ]
            },
            {
                id: 'lottery_win',
                type: 'life',
                title: '🎰 中奖了',
                text: '你买的彩票中了小奖！',
                choices: [
                    {
                        text: '开心收钱',
                        effect: { money: 100, mood: 15 },
                        result: '意外之财，真开心！'
                    }
                ]
            },
            {
                id: 'friend_borrow',
                type: 'life',
                title: '💸 朋友借钱',
                text: '一位朋友遇到困难，向你借200元。',
                condition: { money: 200, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '借给他',
                        effect: { money: -200, mood: 5, teammateChemistry: { random: 10 }, reputation: 5 },
                        result: '朋友很感激你的帮助。'
                    },
                    {
                        text: '婉拒',
                        effect: { mood: -5, teammateChemistry: { random: -5 } },
                        result: '你拒绝了，但心里有些不安。'
                    }
                ]
            },
            {
                id: 'expensive_equipment',
                type: 'life',
                title: '⭐ 顶级装备',
                text: '发现一套顶级排球装备，但价格昂贵（500元）。',
                condition: { money: 500, operator: '>' },
                weight: 2,
                choices: [
                    {
                        text: '买下来',
                        effect: { money: -500, mood: 25, serve: 5, spike: 5, block: 5, dig: 3, set: 3 },
                        requirement: { money: 500 },
                        result: '顶级装备让你的训练效果大幅提升！'
                    },
                    {
                        text: '太贵了，不买',
                        effect: { mood: -8 },
                        result: '你忍痛放弃了。'
                    }
                ]
            },
            {
                id: 'treat_teammates',
                type: 'life',
                title: '🍕 请客吃饭',
                text: '朋友们提议聚餐，大家都看着你...',
                choices: [
                    {
                        text: '我请客！（花费150元）',
                        effect: { money: -150, mood: 15, reputation: 10 },
                        requirement: { money: 150 },
                        result: '你的慷慨赢得了大家的好感！'
                    },
                    {
                        text: 'AA制吧（花费30元）',
                        effect: { money: -30, mood: 8, reputation: 3 },
                        requirement: { money: 30 },
                        result: '大家AA制，气氛也不错。'
                    },
                    {
                        text: '我没钱，不去了',
                        effect: { mood: -10, reputation: -3 },
                        result: '你错过了这次聚餐。'
                    }
                ]
            },
            {
                id: 'coach_conflict',
                type: 'training',
                title: '😠 与教练争执',
                text: '训练中你和教练因为技术动作产生了分歧，争执起来...',
                condition: { stress: 60, operator: '>' },
                weight: 3,
                choices: [
                    {
                        text: '坚持己见，拒绝改正',
                        effect: { spike: -3, block: -2, mood: -10, stress: 5, reputation: -8 },
                        result: '教练很生气，你的技术也因为错误动作而退步了...'
                    },
                    {
                        text: '冷静下来，虚心接受',
                        effect: { mood: -5, stress: -5, reputation: 3, spike: 2 },
                        result: '你意识到了自己的错误，教练的指导让你进步了。'
                    },
                    {
                        text: '暂时离开，冷静一下',
                        effect: { mood: -3, stress: -3, energy: 5 },
                        result: '你们都需要时间冷静。'
                    }
                ]
            },
            {
                id: 'training_burnout',
                type: 'training',
                title: '😫 训练倦怠',
                text: '连续高强度训练让你感到疲惫和厌倦，动作开始变形...',
                condition: { energy: 25, stress: 70, operator: '<' },
                weight: 4,
                choices: [
                    {
                        text: '强迫自己继续',
                        effect: { serve: -2, spike: -2, energy: -15, mood: -10, stress: 10 },
                        result: '过度训练导致技术退步，身心俱疲...'
                    },
                    {
                        text: '休息一周',
                        effect: { energy: 30, mood: 15, stress: -20, serve: -1, spike: -1 },
                        result: '充分休息后状态恢复了，但技能有些生疏。'
                    },
                    {
                        text: '降低训练强度',
                        effect: { energy: 10, mood: 5, stress: -10 },
                        result: '你调整了训练计划，找回了平衡。'
                    }
                ]
            },
            {
                id: 'wrong_technique',
                type: 'training',
                title: '❌ 动作错误',
                text: '你发现自己一直在用错误的动作训练，养成了坏习惯...',
                weight: 3,
                choices: [
                    {
                        text: '立即纠正（需要时间）',
                        effect: { serve: -3, spike: -3, energy: -15, mood: -8 },
                        result: '纠正错误动作很痛苦，技能暂时下降了...'
                    },
                    {
                        text: '请私教指导（花费150元）',
                        effect: { serve: 2, spike: 2, money: -150, mood: 5 },
                        requirement: { money: 150 },
                        result: '私教帮你纠正了动作，还有额外收获！'
                    },
                    {
                        text: '继续用错误动作',
                        effect: { serve: -1, spike: -1, block: -1 },
                        result: '错误的动作限制了你的进步...'
                    }
                ]
            },
            {
                id: 'team_competition_pressure',
                type: 'training',
                title: '😰 竞争压力',
                text: '队内竞争激烈，你担心自己会被替补，压力很大...',
                condition: { stress: 50, operator: '>' },
                weight: 3,
                choices: [
                    {
                        text: '加倍训练证明自己',
                        effect: { serve: 3, spike: 3, energy: -25, mood: -10, stress: 15 },
                        result: '你拼命训练，技能提升了但身心俱疲。'
                    },
                    {
                        text: '找教练沟通',
                        effect: { mood: 5, stress: -10, reputation: 3 },
                        result: '教练的鼓励让你放下了包袱。'
                    },
                    {
                        text: '自暴自弃',
                        effect: { serve: -2, spike: -2, mood: -15, stress: 5, reputation: -5 },
                        result: '消极的态度让你的状态越来越差...'
                    }
                ]
            },
            {
                id: 'match_mistake_shadow',
                type: 'life',
                title: '😔 失误阴影',
                text: '上次比赛的失误一直困扰着你，你开始怀疑自己的能力...',
                condition: { mood: 40, operator: '<' },
                weight: 3,
                choices: [
                    {
                        text: '逃避训练',
                        effect: { serve: -3, spike: -3, mood: -10, stress: 10 },
                        result: '逃避让问题更严重了...'
                    },
                    {
                        text: '针对性训练',
                        effect: { serve: 3, spike: 3, energy: -20, mood: 10, stress: -10 },
                        result: '你克服了心理障碍，技术也提升了！'
                    },
                    {
                        text: '寻求心理辅导（花费80元）',
                        effect: { mood: 15, stress: -15, money: -80 },
                        requirement: { money: 80 },
                        result: '专业的帮助让你走出了阴影。'
                    }
                ]
            },
            {
                id: 'injury_relapse',
                type: 'training',
                title: '🤕 旧伤复发',
                text: '之前的伤还没完全好，训练时又感到疼痛...',
                weight: 2,
                choices: [
                    {
                        text: '忍痛继续训练',
                        effect: { serve: -4, spike: -4, energy: -20, mood: -15 },
                        result: '伤势加重，严重影响了你的状态...'
                    },
                    {
                        text: '停止训练，好好休养',
                        effect: { energy: 20, mood: -5, serve: -1, spike: -1 },
                        result: '休息让伤势好转，但技能有些生疏。'
                    },
                    {
                        text: '去医院治疗（花费200元）',
                        effect: { energy: 10, mood: 5, money: -200 },
                        requirement: { money: 200 },
                        result: '专业治疗让你恢复了健康。'
                    }
                ]
            },
            {
                id: 'teammate_conflict',
                type: 'life',
                title: '💔 人际矛盾',
                text: '你和一位同学发生了严重冲突，气氛很紧张...',
                condition: { reputation: 30, operator: '<' },
                weight: 3,
                choices: [
                    {
                        text: '主动道歉和解',
                        effect: { mood: 5, stress: -10, reputation: 8 },
                        result: '你的大度赢得了尊重。'
                    },
                    {
                        text: '继续冷战',
                        effect: { mood: -15, stress: 15, reputation: -5, serve: -2, spike: -2 },
                        result: '糟糕的人际关系影响了你的训练和发挥...'
                    },
                    {
                        text: '请朋友调解',
                        effect: { mood: -5, stress: -5, reputation: 2 },
                        result: '朋友帮你们调解了矛盾。'
                    }
                ]
            }
        ];
        
        const SCENES = {
            nameInput: {
                text: `<div id="name-input-panel">
                    <h2>🏐 欢迎来到排球之星</h2>
                    <p style="margin-bottom: 20px; color: #666;">你即将开始一段从菜鸟到冠军的排球之旅</p>
                    <div id="name-input-container">
                        <input type="text" id="player-name-input" placeholder="请输入你的名字" maxlength="10" />
                        <button id="random-name-btn" onclick="game.randomName()" title="随机名字">🎲</button>
                    </div>
                    <div id="initial-attributes">
                        <h3>🎲 初始能力</h3>
                        <div class="init-attr-item">
                            <span>🎯 发球</span>
                            <span class="init-attr-value" id="init-serve">0</span>
                        </div>
                        <div class="init-attr-item">
                            <span>⚡ 扣球</span>
                            <span class="init-attr-value" id="init-spike">0</span>
                        </div>
                        <div class="init-attr-item">
                            <span>🛡️ 拦网</span>
                            <span class="init-attr-value" id="init-block">0</span>
                        </div>
                        <div class="init-attr-item">
                            <span>🏐 垫球</span>
                            <span class="init-attr-value" id="init-dig">0</span>
                        </div>
                        <div class="init-attr-item">
                            <span>🤲 托球</span>
                            <span class="init-attr-value" id="init-set">0</span>
                        </div>
                        <div class="init-attr-item">
                            <span>💪 体力上限</span>
                            <span class="init-attr-value" id="init-energy">100</span>
                        </div>
                        <div class="init-attr-item">
                            <span>💰 初始金钱</span>
                            <span class="init-attr-value" id="init-money">500</span>
                        </div>
                        <div id="reroll-container">
                            <button id="reroll-btn" onclick="game.rerollAttributes()">🎲 重新随机</button>
                            <span id="reroll-count">剩余次数：5/5</span>
                        </div>
                    </div>
                    <button class="start-game-btn" onclick="game.submitName()">开始游戏</button>
                    <div style="position: absolute; bottom: 15px; right: 15px;">
                        <button class="tab-btn" onclick="game.toggleChangelogModal()" style="font-size: 12px; padding: 6px 12px; opacity: 0.7;">📋 更新日志</button>
                    </div>
                </div>`,
                choices: []
            },
            
            start: {
                text: `<h2>🎓 大学新生活</h2>
                <p>你是一名刚入学的大一新生，从未接触过排球。</p>
                <p>开学第一周，你路过体育馆，看到排球社团正在招新。阳光透过窗户洒在球场上，学长学姐们矫健的身影让你心生向往。</p>
                <p>"想试试吗？"一位学姐笑着向你招手。</p>`,
                choices: [
                    {
                        text: '🏐 加入排球社团，开始训练！',
                        next: 'weeklyHub'
                    },
                    {
                        text: '📚 先观察一下，了解更多信息',
                        next: 'observe'
                    }
                ]
            },

            
            observe: {
                text: `<h2>👀 观察学习</h2>
                <p>你在场边观察了一会儿，看到学长学姐们在练习各种技术：</p>
                <p>• 发球：将球高高抛起，用力击打过网<br>
                • 扣球：跳起来用力将球砸向对方场地<br>
                • 拦网：在网前跳起阻挡对方的进攻<br>
                • 防守：快速移动接起对方的攻击</p>
                <p>看起来很有趣！你决定...</p>`,
                choices: [
                    {
                        text: '💪 现在就加入，开始训练！',
                        next: 'weeklyHub'
                    }
                ]
            },
            
            weeklyHub: {
                text: '',
                choices: []
            },
            
            shopMain: {
                text: '',
                choices: []
            },
            
            lifeChoice: {
                text: '',
                choices: []
            },
            
            trainingChoice: {
                text: `<h2>🏋️ 选择训练项目</h2>
                <p>今天你想重点训练哪个技能？</p>
                <p style="color: #999; font-size: 14px;">训练会消耗体力和心情，增加压力</p>
                <p style="color: #f093fb; font-size: 16px; font-weight: bold; margin-top: 10px;">⚡ 当前体力：<span id="current-energy-display">0</span></p>`,
                choices: [
                    {
                        text: '🎯 发球训练（体力-15，心情-12，压力+10）',
                        next: 'lifeChoice',
                        requirement: { energy: 15 },
                        effect: { serve: 3, energy: -15, mood: -12, stress: 10, trained: true, eventType: 'training', lastTraining: 'serve' }
                    },
                    {
                        text: '⚡ 扣球训练（体力-20，心情-15，压力+12）',
                        next: 'lifeChoice',
                        requirement: { energy: 20 },
                        effect: { spike: 3, energy: -20, mood: -15, stress: 12, trained: true, eventType: 'training', lastTraining: 'spike' }
                    },
                    {
                        text: '🛡️ 拦网训练（体力-18，心情-13，压力+11）',
                        next: 'lifeChoice',
                        requirement: { energy: 18 },
                        effect: { block: 3, energy: -18, mood: -13, stress: 11, trained: true, eventType: 'training', lastTraining: 'block' }
                    },
                    {
                        text: '🤸 垫球训练（体力-15，心情-12，压力+10）',
                        next: 'lifeChoice',
                        requirement: { energy: 15 },
                        effect: { dig: 3, energy: -15, mood: -12, stress: 10, trained: true, eventType: 'training', lastTraining: 'dig' }
                    },
                    {
                        text: '🙌 托球训练（体力-15，心情-12，压力+10）',
                        next: 'lifeChoice',
                        requirement: { energy: 15 },
                        effect: { set: 3, energy: -15, mood: -12, stress: 10, trained: true, eventType: 'training', lastTraining: 'set' }
                    },
                    {
                        text: '⏭️ 跳过训练，直接课余生活',
                        next: 'lifeChoice',
                        effect: { trained: true }
                    },
                    {
                        text: '🔙 返回',
                        next: 'weeklyHub'
                    }
                ]
            },
            
            // lifeChoice: {
            //     text: `<h2>🌟 课余生活</h2>
            //     <p>训练结束了，你想做些什么来放松一下？</p>`,
            //     choices: [
            //         {
            //             text: '🍜 吃夜宵（心情+15，体力-5，压力-5，花费20元）',
            //             next: 'checkRandomEvent',
            //             requirement: { money: 20 },
            //             effect: { mood: 15, energy: -5, stress: -5, money: -20, eventType: 'life' }
            //         },
            //         {
            //             text: '🏐 打野球（25分制比赛，体力-20）',
            //             next: 'casualMatch',
            //             requirement: { energy: 20 },
            //             effect: { matchType: 'casual', energy: -20 }
            //         },
            //         {
            //             text: '🎮 打游戏（心情+10，压力-8，体力-3）',
            //             next: 'volleyballClickGame',
            //             requirement: { energy: 3 }
            //         },
            //         {
            //             text: '� 去图书馆（心情+5，压力+3，声望+2）',
            //             next: 'checkRandomEvent',
            //             effect: { mood: 5, stress: 3, reputation: 2, eventType: 'life' }
            //         },
            //         {
            //             text: '� 早点休息（体力+20，心情+8，压力-5）',
            //             next: 'checkRandomEvent',
            //             effect: { energy: 20, mood: 8, stress: -5, eventType: 'life' }
            //         },
            //         {
            //             text: '👥 和队友聊天（心情+12，压力-6，关系+5）',
            //             next: 'checkRandomEvent',
            //             effect: { mood: 12, stress: -6, relationship: 5, eventType: 'life' }
            //         },
            //         {
            //             text: '🍿 看小排球（心情+18，压力-10，花费50元）',
            //             next: 'checkRandomEvent',
            //             requirement: { money: 50 },
            //             effect: { mood: 18, stress: -10, money: -50, eventType: 'life' }
            //         },
            //         {
            //             text: '🛒 买运动装备（技能+2，心情+10，花费250元）',
            //             next: 'checkRandomEvent',
            //             requirement: { money: 250 },
            //             effect: { serve: 2, spike: 2, block: 2, dig: 1, set: 1, mood: 10, money: -250, eventType: 'life' }
            //         },
            //         {
            //             text: '💼 兼职打工（金钱+150，体力-20，压力+8）',
            //             next: 'checkRandomEvent',
            //             requirement: { energy: 20 },
            //             effect: { money: 150, energy: -20, stress: 8, mood: -5, eventType: 'life' }
            //         },
            //         {
            //             text: '🍔 吃大餐（心情+25，体力+10，花费100元）',
            //             next: 'checkRandomEvent',
            //             requirement: { money: 100 },
            //             effect: { mood: 25, energy: 10, stress: -8, money: -100, eventType: 'life' }
            //         },
            //         {
            //             text: '🎁 给队友买礼物（关系+15，声望+5，花费80元）',
            //             next: 'checkRandomEvent',
            //             requirement: { money: 80 },
            //             effect: { relationship: 15, reputation: 5, mood: 8, money: -80, eventType: 'life' }
            //         },
            //         {
            //             text: '📱 买新手机（心情+20，压力-5，花费800元）',
            //             next: 'checkRandomEvent',
            //             requirement: { money: 800 },
            //             effect: { mood: 20, stress: -5, money: -800, eventType: 'life' }
            //         }
            //     ]
            // },
            
            casualMatch: {
                text: '',
                choices: []
            },
            
            matchResult: {
                text: '',
                choices: []
            },
            
            checkRandomEvent: {
                text: '',
                choices: []
            },
            
            haikyuuEpisode: {
                text: '',
                choices: []
            },
            
            randomEvent: {
                text: '',
                choices: []
            },

            
            basicTraining: {
                text: `<h2>📈 基础训练阶段</h2>
                <p>经过几周的训练，你已经掌握了基本的排球技术。教练说你很有天赋。</p>
                <p>现在你可以选择重点训练某项技能，或者参加院队的选拔。</p>`,
                choices: [
                    {
                        text: '继续训练',
                        next: 'weeklyHub'
                    }
                ]
            },
            
            weekEnd: {
                text: `<h2>📊 本周总结</h2>
                <p>第 ${this.player ? this.player.week : 1} 周结束了！</p>
                <p>本周训练了 ${this.player ? this.player.trainingCount : 0} 次</p>
                <p>获得零花钱 +120元</p>
                <p>体力、心情自然恢复，压力减轻</p>`,
                choices: [
                    {
                        text: '开始新的一周',
                        next: 'weeklyHub',
                        effect: { nextWeek: true }
                    }
                ]
            },
            
            eventResult: {
                text: '',
                choices: [
                    {
                        text: '继续',
                        next: 'weeklyHub'
                    }
                ]
            },

            
            rest: {
                text: `<h2>💤 休息恢复</h2>
                <p>你好好休息了一段时间，体力恢复了。</p>
                <p>明天继续加油！</p>`,
                choices: [
                    { text: '继续训练', next: 'basicTraining' }
                ]
            },
            
            collegeTryout: {
                text: `<h2>🎯 院队选拔</h2>
                <p>院队的选拔赛开始了！你需要在教练和学长面前展示你的技术。</p>
                <p>发球、接球、扣球...你全力以赴地完成了每一个动作。</p>
                <p>教练满意地点了点头："不错，欢迎加入院队！"</p>
                <p><strong>成就达成：加入院队！</strong></p>
                <p><strong>声望 +20</strong></p>`,
                choices: [
                    {
                        text: '🎉 太好了！选择场上位置',
                        next: 'positionSelection',
                        effect: { reputation: 20, team: 'college', weeklyAllowance: 150, goalUpdate: 'collegeMatch' }
                    }
                ]
            },
            
            positionSelection: {
                text: `<h2>🏐 选择你的场上位置</h2>
                <p>教练："你已经掌握了基本技能，现在需要选择一个专精的位置。"</p>
                <p>"每个位置都有不同的职责和要求，选择适合你的位置吧！"</p>
                <div id="position-cards"></div>`,
                choices: [] // 动态生成
            },
            
            collegeTeam: {
                text: `<h2>🏫 院队训练</h2>
                <p>作为院队的一员，训练强度明显提升了。你和队友们一起训练，技术进步很快。</p>`,
                choices: [
                    // 基础训练分类标题
                    {
                        text: '',
                        separator: true,
                        separatorText: '<h3>📋 基础训练（体力-30）</h3>'
                    },
                    // 基础训练（降低：6→4）
                    {
                        text: '🎯 发球训练',
                        next: 'lifeChoice',
                        requirement: { energy: 30 },
                        effect: { serve: 4, energy: -30, mood: -15, stress: 12, trained: true, eventType: 'training' }
                    },
                    {
                        text: '⚡ 扣球训练',
                        next: 'lifeChoice',
                        requirement: { energy: 30 },
                        effect: { spike: 4, energy: -30, mood: -15, stress: 12, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🛡️ 拦网训练',
                        next: 'lifeChoice',
                        requirement: { energy: 30 },
                        effect: { block: 4, energy: -30, mood: -15, stress: 12, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🤸 垫球训练',
                        next: 'lifeChoice',
                        requirement: { energy: 30 },
                        effect: { dig: 4, energy: -30, mood: -15, stress: 12, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🙌 托球训练',
                        next: 'lifeChoice',
                        requirement: { energy: 30 },
                        effect: { set: 4, energy: -30, mood: -15, stress: 12, trained: true, eventType: 'training' }
                    },
                    // 组合训练分类标题
                    {
                        text: '',
                        separator: true,
                        separatorText: '<h3>🔥 组合训练（体力-35）</h3>'
                    },
                    // 组合训练
                    {
                        text: '� 进攻组合',
                        next: 'lifeChoice',
                        requirement: { energy: 35 },
                        effect: { spike: 4, serve: 3, energy: -35, mood: -18, stress: 15, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🛡️ 防守组合',
                        next: 'lifeChoice',
                        requirement: { energy: 35 },
                        effect: { block: 4, dig: 3, energy: -35, mood: -18, stress: 15, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🎯 组织组合',
                        next: 'lifeChoice',
                        requirement: { energy: 35 },
                        effect: { set: 4, dig: 3, energy: -35, mood: -18, stress: 15, trained: true, eventType: 'training' }
                    },
                    // 其他选项分隔
                    {
                        text: '',
                        separator: true,
                        separatorText: '<div style="margin-top: 15px;"></div>'
                    },
                    // 其他选项
                    {
                        text: '⏭️ 跳过训练',
                        next: 'lifeChoice',
                        effect: { trained: true }
                    },
                    {
                        text: '🔙 返回',
                        next: 'weeklyHub'
                    }
                ]
            },
            
            rest2: {
                text: `<h2>💤 休息恢复</h2>
                <p>你好好休息了一段时间，体力恢复了。</p>
                <p>继续为比赛做准备！</p>`,
                choices: [
                    { text: '继续训练', next: 'collegeTeam' }
                ]
            },

            
            collegeMatch: {
                text: `<h2>🏐 院际比赛</h2>
                <p>比赛日到了！体育馆里挤满了为各自学院加油的同学。</p>
                <p>第一局，你的发球直接得分！观众席传来欢呼声。</p>
                <p>第二局，你成功拦下了对方的扣球，为队伍赢得了关键分数。</p>
                <p>最终，你们学院以3:1获胜！</p>
                <p><strong>声望 +30，全技能 +5</strong></p>`,
                choices: [
                    {
                        text: '🎉 太棒了！继续努力',
                        next: 'weeklyHub',
                        effect: { reputation: 30, serve: 5, spike: 5, block: 5, dig: 3, set: 3 }
                    }
                ]
            },
            
            universityTryout: {
                text: `<h2>⭐ 校队选拔</h2>
                <p>校队的选拔非常严格，来自各个学院的高手齐聚一堂。</p>
                <p>你展示了精准的发球、强力的扣球、稳固的拦网和灵活的防守。</p>
                <p>主教练仔细观察着每一个人的表现...</p>
                <p>"恭喜你，欢迎加入校队！"</p>
                <p><strong>成就达成：加入校队！</strong></p>
                <p><strong>声望 +50</strong></p>`,
                choices: [
                    {
                        text: '🌟 开始校队训练',
                        next: 'weeklyHub',
                        effect: { reputation: 50, team: 'university', weeklyAllowance: 200, goalUpdate: 'universityLeague' }
                    }
                ]
            },
            
            universityLeague: {
                text: `<h2>🏅 校际联赛</h2>
                <p>校际联赛汇聚了全市各大高校的精英队伍。</p>
                <p>这是你大学排球生涯的最后一战！</p>
                <p>你准备好了吗？</p>`,
                choices: [
                    {
                        text: '🏐 开始比赛',
                        next: 'weeklyHub',
                        effect: { startFormalMatch: { matchType: 'universityLeague', matchName: '校际联赛' } }
                    }
                ]
            },

            
            universityTeam: {
                text: `<h2>🌟 校队训练</h2>
                <p>校队的训练更加专业和系统。你和全校最优秀的排球选手一起训练。</p>`,
                choices: [
                    // 基础训练分类标题
                    {
                        text: '',
                        separator: true,
                        separatorText: '<h3>📋 基础训练（体力-35）</h3>'
                    },
                    // 基础训练 - 保持5个独立技能（降低：8→5）
                    {
                        text: '🎯 发球训练',
                        next: 'lifeChoice',
                        requirement: { energy: 35 },
                        effect: { serve: 5, energy: -35, mood: -18, stress: 15, trained: true, eventType: 'training' }
                    },
                    {
                        text: '⚡ 扣球训练',
                        next: 'lifeChoice',
                        requirement: { energy: 35 },
                        effect: { spike: 5, energy: -35, mood: -18, stress: 15, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🛡️ 拦网训练',
                        next: 'lifeChoice',
                        requirement: { energy: 35 },
                        effect: { block: 5, energy: -35, mood: -18, stress: 15, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🤸 垫球训练',
                        next: 'lifeChoice',
                        requirement: { energy: 35 },
                        effect: { dig: 5, energy: -35, mood: -18, stress: 15, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🙌 托球训练',
                        next: 'lifeChoice',
                        requirement: { energy: 35 },
                        effect: { set: 5, energy: -35, mood: -18, stress: 15, trained: true, eventType: 'training' }
                    },
                    // 组合训练分类标题
                    {
                        text: '',
                        separator: true,
                        separatorText: '<h3>🔥 组合训练（体力-35）</h3>'
                    },
                    // 组合训练
                    {
                        text: '� 进攻组合',
                        next: 'lifeChoice',
                        requirement: { energy: 35 },
                        effect: { spike: 4, serve: 3, energy: -35, mood: -18, stress: 15, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🛡️ 防守组合',
                        next: 'lifeChoice',
                        requirement: { energy: 35 },
                        effect: { block: 4, dig: 3, energy: -35, mood: -18, stress: 15, trained: true, eventType: 'training' }
                    },
                    {
                        text: '🎯 组织组合',
                        next: 'lifeChoice',
                        requirement: { energy: 35 },
                        effect: { set: 4, dig: 3, energy: -35, mood: -18, stress: 15, trained: true, eventType: 'training' }
                    },
                    // 高级训练分类标题
                    {
                        text: '',
                        separator: true,
                        separatorText: '<h3>⭐ 高级训练（体力-50）</h3>'
                    },
                    // 高级训练（仅校队）
                    {
                        text: '⭐ 全面发展',
                        next: 'lifeChoice',
                        requirement: { energy: 50 },
                        effect: { serve: 2, spike: 2, block: 2, dig: 2, set: 2, energy: -50, mood: -25, stress: 20, trained: true, eventType: 'training' }
                    },
                    // 其他选项分隔
                    {
                        text: '',
                        separator: true,
                        separatorText: '<div style="margin-top: 15px;"></div>'
                    },
                    // 其他选项
                    {
                        text: '⏭️ 跳过训练',
                        next: 'lifeChoice',
                        effect: { trained: true }
                    },
                    {
                        text: '🔙 返回',
                        next: 'weeklyHub'
                    }
                ]
            },

            
            // ==================== 结局场景 ====================
            // 根据校际联赛表现触发不同结局
            
            // 锦标赛开幕场景
            tournamentStart: {
                text: function() {
                    return `<h2>🏆 校际排球联赛 - 淘汰赛开始！</h2>
                    <div style="margin: 20px 0; padding: 20px; background: rgba(255,215,0,0.1); border: 2px solid #ffd700; border-radius: 10px;">
                        <p>经过漫长的准备，你终于站在了校际联赛的赛场上！</p>
                        <br>
                        <p><strong>📋 赛制说明：</strong></p>
                        <ul style="text-align: left; margin-left: 20px;">
                            <li>单败淘汰制，输一场即淘汰</li>
                            <li>从16强开始，逐轮晋级</li>
                            <li>每轮比赛采用五局三胜制</li>
                        </ul>
                        <br>
                        <p><strong>🎯 你的目标：</strong></p>
                        <p>尽可能走得更远，争取冠军！</p>
                    </div>
                    <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <p><strong>当前状态：</strong></p>
                        <p>🎯 发球: ${game.player.skills.serve}  ⚡ 扣球: ${game.player.skills.spike}</p>
                        <p>🛡️ 拦网: ${game.player.skills.block}  🤸 垫球: ${game.player.skills.dig}</p>
                        <p>🙌 托球: ${game.player.skills.set}</p>
                    </div>`;
                },
                choices: [
                    {
                        text: '开始首轮比赛',
                        next: null,  // 不跳转场景
                        effect: () => {
                            // 直接开始第一轮
                            game.startTournamentRound('round16');
                        }
                    }
                ]
            },
            
            champion: {
                text: function() {
                    return game.generateEndingText('champion');
                },
                choices: [
                    {
                        text: '🔄 重新开始',
                        next: 'nameInput',
                        effect: { reset: true }
                    }
                ]
            },
            
            runner_up: {
                text: function() {
                    return game.generateEndingText('runner_up');
                },
                choices: [
                    {
                        text: '🔄 重新开始',
                        next: 'nameInput',
                        effect: { reset: true }
                    }
                ]
            },
            
            participant: {
                text: function() {
                    return game.generateEndingText('participant');
                },
                choices: [
                    {
                        text: '🔄 重新开始',
                        next: 'nameInput',
                        effect: { reset: true }
                    }
                ]
            },
            
            early_exit: {
                text: function() {
                    return game.generateEndingText('early_exit');
                },
                choices: [
                    {
                        text: '🔄 重新开始',
                        next: 'nameInput',
                        effect: { reset: true }
                    }
                ]
            },
            
            // 隐藏结局1：旁观者
            bystander: {
                text: function() {
                    return game.generateBystanderEndingText();
                },
                choices: [
                    {
                        text: '🔄 重新开始',
                        next: 'nameInput',
                        effect: { reset: true }
                    }
                ]
            },
            
            // 隐藏结局2：独行者
            loner: {
                text: function() {
                    return game.generateLonerEndingText();
                },
                choices: [
                    {
                        text: '🔄 重新开始',
                        next: 'nameInput',
                        effect: { reset: true }
                    }
                ]
            },
            
            // 隐藏结局3：替补席
            benchwarmer: {
                text: function() {
                    return game.generateBenchwarmerEndingText();
                },
                choices: [
                    {
                        text: '🔄 重新开始',
                        next: 'nameInput',
                        effect: { reset: true }
                    }
                ]
            }
        };

        // ==================== 测试模式配置 ====================
        // 设置 TEST_MODE = true 来启用测试模式
        // 测试模式会给予高初始属性，方便快速测试游戏功能
        const TEST_MODE = false;  // 改为 true 启用测试模式
        
        const TEST_CONFIG = {
            initialSkills: 70,      // 初始技能值（正常是0）
            initialMoney: 10000,    // 初始金钱（正常是500）
            initialEnergy: 100,     // 初始体力（正常是100）
            initialMood: 100,       // 初始心情（正常是80）
            initialStress: 0,       // 初始压力（正常是20）
            initialReputation: 100, // 初始声望（正常是10）
            maxTrainingPerWeek: 3, // 每周最大训练次数（正常是3）
            skipToWeek: 1           // 跳转到指定周（1=不跳转）
        };
        // ====================================================

        class VolleyballGame {
            constructor() {
                // 位置配合技能定义
                this.COMBO_SKILLS = {
                    'setter_middleBlocker': {
                        id: 'monster_quick',
                        name: '怪物快攻',
                        emoji: '⚡',
                        description: '超高速的快攻配合，对方来不及反应',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.005, 0.008, 0.012],  // 0.5%/0.8%/1.2%
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{setter}精准传球，{middle}闪电般扣杀！怪物快攻！',
                            '{setter}和{middle}的配合天衣无缝！怪物快攻升级版！',
                            '{setter}和{middle}展现完美默契！究极怪物快攻！'
                        ]
                    },
                    'setter_outsideHitter': {
                        id: 'time_lag_attack',
                        name: '时间差攻击',
                        emoji: '🎯',
                        description: '二传假装传给副攻，实际传给主攻，打乱对方拦网节奏',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.004, 0.007, 0.010],
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{setter}佯装传球，{outside}突然跃起！时间差攻击得手！',
                            '{setter}和{outside}心有灵犀！完美时间差！',
                            '{setter}和{outside}的时间差已臻化境！'
                        ]
                    },
                    'setter_oppositeHitter': {
                        id: 'back_attack',
                        name: '背飞战术',
                        emoji: '🔄',
                        description: '二传背后传球，接应后排进攻',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.005, 0.008, 0.011],
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{setter}背后传球，{opposite}高高跃起！背飞得分！',
                            '{setter}和{opposite}背飞配合愈发默契！',
                            '{setter}和{opposite}的背飞战术已成绝技！'
                        ]
                    },
                    'setter_libero': {
                        id: 'perfect_pass',
                        name: '完美一传',
                        emoji: '🎪',
                        description: '自由人精准垫球，二传组织流畅进攻',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.003, 0.005, 0.008],
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{libero}完美垫球，{setter}从容组织进攻得分！',
                            '{libero}和{setter}一传配合日益精进！',
                            '{libero}和{setter}的一传体系无懈可击！'
                        ]
                    },
                    'outsideHitter_middleBlocker': {
                        id: 'double_block',
                        name: '双人拦网',
                        emoji: '🛡️',
                        description: '两人配合拦网，形成铜墙铁壁',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.004, 0.007, 0.010],
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{outside}和{middle}双人拦网！铜墙铁壁！',
                            '{outside}和{middle}拦网配合更加严密！',
                            '{outside}和{middle}的拦网已成移动长城！'
                        ]
                    },
                    'outsideHitter_oppositeHitter': {
                        id: 'dual_wings',
                        name: '两翼齐飞',
                        emoji: '🦅',
                        description: '左右两侧同时进攻，对方防不胜防',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.005, 0.008, 0.012],
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{outside}和{opposite}两翼齐飞，对方防守崩溃！',
                            '{outside}和{opposite}左右开弓，势不可挡！',
                            '{outside}和{opposite}的两翼进攻已成王牌战术！'
                        ]
                    },
                    'outsideHitter_libero': {
                        id: 'counter_attack',
                        name: '防反一体',
                        emoji: '🔁',
                        description: '自由人防守到位，主攻反击犀利',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.004, 0.007, 0.010],
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{libero}防起重扣，{outside}反击得手！',
                            '{libero}和{outside}防反配合日臻完美！',
                            '{libero}和{outside}的防反体系天衣无缝！'
                        ]
                    },
                    'middleBlocker_middleBlocker': {
                        id: 'moving_wall',
                        name: '移动长城',
                        emoji: '🏰',
                        description: '两名副攻形成移动拦网墙',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.006, 0.010, 0.015],
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{middle1}和{middle2}移动长城！对方扣球被拦死！',
                            '{middle1}和{middle2}的拦网密不透风！',
                            '{middle1}和{middle2}已成真正的铁壁防线！'
                        ]
                    },
                    'middleBlocker_oppositeHitter': {
                        id: 'front_back_attack',
                        name: '前后夹击',
                        emoji: '⚔️',
                        description: '副攻前排快攻，接应后排进攻，立体进攻',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.005, 0.008, 0.011],
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{middle}前排佯攻，{opposite}后排暴扣得分！',
                            '{middle}和{opposite}前后夹击，对方顾此失彼！',
                            '{middle}和{opposite}的立体进攻已成体系！'
                        ]
                    },
                    'middleBlocker_libero': {
                        id: 'mind_reading_defense',
                        name: '读心防守',
                        emoji: '🧠',
                        description: '副攻拦网，自由人补位，天衣无缝',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.004, 0.007, 0.010],
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{middle}拦网逼迫，{libero}补位防守，反击得分！',
                            '{middle}和{libero}防守配合愈发默契！',
                            '{middle}和{libero}的防守体系滴水不漏！'
                        ]
                    },
                    'oppositeHitter_libero': {
                        id: 'back_row_cannon',
                        name: '后排炮台',
                        emoji: '💥',
                        description: '自由人保障一传，接应后排强攻',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.004, 0.007, 0.010],
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{libero}稳定一传，{opposite}后排重炮轰炸！',
                            '{libero}和{opposite}后排进攻体系日益成熟！',
                            '{libero}和{opposite}的后排炮台火力全开！'
                        ]
                    },
                    'libero_libero': {
                        id: 'iron_defense',
                        name: '铁壁防线',
                        emoji: '🛡️',
                        description: '双自由人体系，防守滴水不漏',
                        unlockChemistry: 70,
                        upgradeChemistry: [85, 95],
                        effects: {
                            winRateBonus: [0.005, 0.009, 0.013],
                            triggerRate: [0.15, 0.25, 0.35]
                        },
                        scoreTexts: [
                            '{libero1}和{libero2}铁壁防线！任何球都防得起来！',
                            '{libero1}和{libero2}的防守密不透风！',
                            '{libero1}和{libero2}已成传说中的双自由人体系！'
                        ]
                    }
                };
                
                this.player = {
                    name: '新生',
                    week: TEST_MODE ? TEST_CONFIG.skipToWeek : 1,
                    trainingCount: 0,
                    maxTrainingPerWeek: TEST_MODE ? TEST_CONFIG.maxTrainingPerWeek : 3,
                    energy: TEST_MODE ? TEST_CONFIG.initialEnergy : 100,
                    maxEnergy: TEST_MODE ? TEST_CONFIG.initialEnergy : 100,
                    mood: TEST_MODE ? TEST_CONFIG.initialMood : 80,
                    stress: TEST_MODE ? TEST_CONFIG.initialStress : 20,
                    reputation: TEST_MODE ? TEST_CONFIG.initialReputation : 10,
                    money: TEST_MODE ? TEST_CONFIG.initialMoney : 800,
                    weeklyAllowance: 120,  // 每周零花钱
                    team: 'none',
                    position: 'none',  // 职业位置
                    positionLevel: 0,  // 职业等级
                    adaptationWeeks: 0, // 转职适应期剩余周数
                    skills: {
                        serve: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        spike: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        block: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        dig: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        set: TEST_MODE ? TEST_CONFIG.initialSkills : 0
                    },
                    weekStartStats: {  // 每周开始时的数据快照
                        serve: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        spike: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        block: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        dig: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        set: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        maxEnergy: TEST_MODE ? TEST_CONFIG.initialEnergy : 100
                    },
                    attributes: {
                        strength: 0,    // 力量
                        agility: 0,     // 敏捷
                        stamina: 0,     // 耐力
                        coordination: 0 // 协调性
                    },
                    relationships: {
                        coach: 50
                        // teammates 已移除，改用队友个人默契度
                    },
                    achievements: [],  // 成就列表
                    // 新增：进度追踪
                    performanceHistory: [],  // 比赛表现历史
                    averagePerformance: 0,  // 平均表现
                    matchesPlayed: 0,  // 比赛场次
                    matchesWon: 0,  // 胜场
                    completedStoryEvents: [],  // 完成的故事事件
                    storyChoices: {},  // 故事选择记录
                    trainingHistory: [],  // 训练历史（用于递减收益）
                    goalProgress: {},  // 目标进度
                    // 位置配合技能系统
                    unlockedSkills: []  // 已解锁的配合技能
                };
                
                // 新增：玩家行为统计（用于结局生成）
                this.playerStats = {
                    // 训练相关
                    totalTrainings: 0,
                    trainingByType: {
                        serve: 0,
                        spike: 0,
                        block: 0,
                        dig: 0,
                        set: 0,
                        composite: 0
                    },
                    
                    // 比赛相关
                    casualMatchesPlayed: 0,
                    casualMatchesWon: 0,
                    formalMatchesPlayed: 0,
                    formalMatchesWon: 0,
                    tournamentRoundsWon: 0,
                    
                    // 消费相关
                    totalMoneySpent: 0,
                    equipmentPurchased: 0,
                    coachingPurchased: 0,
                    entertainmentSpent: 0,
                    
                    // 生活相关
                    gamesPlayed: 0,
                    moviesWatched: 0,
                    socialEvents: 0,
                    restTaken: 0,
                    
                    // 课余活动追踪（用于奇遇事件）
                    lifeActivities: {
                        scratchCard: 0,      // 买刮刮乐次数
                        movie: 0,            // 看电影次数
                        game: 0,             // 打游戏次数
                        social: 0,           // 社交活动次数（聊天）
                        gift: 0,             // 买礼物次数
                        rest: 0,             // 休息次数（早点休息+按摩）
                        massage: 0,          // 按摩次数
                        library: 0,          // 去图书馆次数
                        casualMatch: 0,      // 打野球次数
                        friendlyMatch: 0,    // 打友谊赛次数
                        work: 0,             // 打工次数
                        food: 0              // 吃美食次数（夜宵+大餐）
                    },
                    
                    // 奇遇事件追踪
                    triggeredEvents: [],     // 已触发的一次性事件ID
                    scratchCardJackpots: 0,  // 中特等奖次数
                    hasLoveInterest: false,  // 是否开启恋爱线
                    weeklyDateCount: 0,      // 本周约会次数
                    permanentBuffs: {        // 永久buff
                        scratchCardDiscount: false,  // 刮刮乐打折
                        movieMembership: false,      // 电影会员
                        foodDiscount: false,         // 美食打折
                        workBonus: false,            // 打工加成
                        trainingBonus: 0,            // 训练效果加成%
                        stressReduction: 0,          // 压力上限降低
                        energyRecovery: 0,           // 每周体力恢复加成
                        moodRecovery: 0,             // 每周心情恢复加成
                        reputationGrowth: 0,         // 每周声望增长
                        injuryReduction: 0           // 受伤概率降低%
                    },
                    titles: [],              // 获得的称号列表
                    
                    // 特殊行为
                    positionChanges: 0,
                    perfectWeeks: 0,
                    burnoutWeeks: 0,
                    richestWeek: 0,
                    brokestWeek: Infinity,
                    
                    // 技能发展
                    initialSkills: {
                        serve: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        spike: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        block: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        dig: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                        set: TEST_MODE ? TEST_CONFIG.initialSkills : 0
                    }
                };
                
                // 职业配置
                this.positions = {
                    outsideHitter: {
                        id: 'outsideHitter',
                        name: '主攻手',
                        icon: '🔥',
                        description: '得分主力，承担大量进攻和防守任务',
                        coreSkills: ['spike', 'dig'],
                        secondarySkills: ['serve'],
                        baseRequirements: { spike: 15, dig: 12 },  // 修改：spike 15, dig 12
                        trainingBonus: { core: 0.4, secondary: 0.2, other: -0.25 },
                        matchWeights: { spike: 40, dig: 25, serve: 15, block: 10, set: 10 },
                        specialDescriptions: {
                            spike: ['强力跳发直接得分！', '后排进攻，大力扣杀得分！', '关键球，主攻手挺身而出！'],
                            dig: ['主攻手后排防守成功！', '及时补位，救起关键球！', '精准垫球，组织反击！'],
                            serve: ['跳发球直接得分！', '发球破坏对方一传！', '连续发球施压！']
                        }
                    },
                    middleBlocker: {
                        id: 'middleBlocker',
                        name: '副攻手',
                        icon: '🛡️',
                        description: '拦网专家，快攻手',
                        coreSkills: ['block', 'spike'],
                        secondarySkills: ['set'],
                        baseRequirements: { block: 15, spike: 12 },  // 降低：block 25→15, spike 20→12
                        trainingBonus: { core: 0.4, secondary: 0.2, other: -0.25 },
                        matchWeights: { block: 40, spike: 30, set: 10, serve: 10, dig: 10 },
                        specialDescriptions: {
                            block: ['单人拦网直接得分！', '双人拦网，严密防守！', '拦网判断精准！'],
                            spike: ['快速短平快，对方来不及反应！', '时间差进攻得分！', '背快突破防线！'],
                            set: ['副攻手调整传球！', '网前假动作，助攻得分！']
                        }
                    },
                    setter: {
                        id: 'setter',
                        name: '二传手',
                        icon: '🎯',
                        description: '组织核心，战术大脑',
                        coreSkills: ['set', 'serve'],
                        secondarySkills: ['dig'],
                        baseRequirements: { set: 18, serve: 12 },  // 降低：set 30→18, serve 20→12
                        trainingBonus: { core: 0.4, secondary: 0.2, other: -0.25 },
                        matchWeights: { set: 50, serve: 20, dig: 15, spike: 10, block: 5 },
                        specialDescriptions: {
                            set: ['精准二传，助攻队友得分！', '背传出其不意，队友轻松得分！', '跳传调整，化解困境！'],
                            serve: ['二传手发球直接得分！', '发球破坏对方进攻节奏！'],
                            dig: ['二传手防守到位！', '一传稳定，组织反击！']
                        }
                    },
                    oppositeHitter: {
                        id: 'oppositeHitter',
                        name: '接应二传',
                        icon: '⚡',
                        description: '全能战士，后排进攻核心',
                        coreSkills: ['spike', 'set'],
                        secondarySkills: ['serve'],
                        baseRequirements: { spike: 15, set: 15 },  // 降低：spike 22→15, set 22→15
                        trainingBonus: { core: 0.4, secondary: 0.2, other: -0.25 },
                        matchWeights: { spike: 35, set: 25, serve: 20, block: 10, dig: 10 },
                        specialDescriptions: {
                            spike: ['后排强攻，突破对方防线！', '调整球二次进攻得分！', '关键时刻接应站出来！'],
                            set: ['接应二传组织进攻！', '替补二传位置，传球到位！'],
                            serve: ['接应发球施压！', '跳飘球破坏对方！']
                        }
                    },
                    libero: {
                        id: 'libero',
                        name: '自由人',
                        icon: '🏃',
                        description: '防守专家，一传保障',
                        coreSkills: ['dig', 'set'],
                        secondarySkills: [],
                        baseRequirements: { dig: 18, set: 15 },  // 降低：dig 30→18, set 25→15
                        trainingBonus: { core: 0.4, secondary: 0.2, other: -0.25 },
                        matchWeights: { dig: 60, set: 30, spike: 0, block: 0, serve: 0 },
                        specialDescriptions: {
                            dig: ['鱼跃救球，精彩防守！', '完美一传，组织反击！', '连续防守，化解对方攻势！'],
                            set: ['自由人二传到位！', '后排传球组织！', '防守反击的起点！']
                        },
                        restrictions: ['不能扣球', '不能拦网', '不能发球']
                    }
                };
                
                this.rerollsRemaining = 5;
                this.currentScene = 'nameInput';
                this.justTrained = false;
                this.lastEventType = null;
                this.currentEvent = null;
                this.currentEventType = null;
                this.currentGoal = 'collegeTryout'; // 当前目标
                
                // 队友系统
                this.teammates = []; // 队友列表（7人）
                this.teamStats = {
                    averageChemistry: 0,  // 队伍平均默契
                    averageSkill: 0,      // 队伍平均能力
                    atmosphere: 0         // 队伍氛围值
                };
                
                // 锦标赛系统
                this.tournament = {
                    active: false,
                    type: null,
                    currentRound: null,
                    roundsCompleted: [],
                    matchesWon: 0,
                    matchesLost: 0,
                    eliminated: false,
                    finalRank: null
                };
                
                // 锦标赛轮次定义
                this.TOURNAMENT_ROUNDS = {
                    round16: {
                        id: 'round16',
                        name: '1/8决赛（16强）',
                        shortName: '16强赛',
                        emoji: '🏐',
                        nextRound: 'round8',
                        eliminationRank: 'top16',
                        opponentStrength: 80
                    },
                    round8: {
                        id: 'round8',
                        name: '1/4决赛（8强）',
                        shortName: '8强赛',
                        emoji: '⚡',
                        nextRound: 'round4',
                        eliminationRank: 'top8',
                        opponentStrength: 90
                    },
                    round4: {
                        id: 'round4',
                        name: '半决赛（4强）',
                        shortName: '半决赛',
                        emoji: '🔥',
                        nextRound: 'final',
                        eliminationRank: 'top4',
                        opponentStrength: 110
                    },
                    final: {
                        id: 'final',
                        name: '决赛',
                        shortName: '决赛',
                        emoji: '🏆',
                        nextRound: null,
                        eliminationRank: 'runner_up',
                        opponentStrength: 140
                    }
                };
                
                // 商店系统数据
                this.shopItems = this.initShopItems();
                this.player.ownedItems = {
                    shoes: 'basic',  // 鞋子等级
                    protection: false,  // 护具
                    jersey: false,  // 球衣
                    trainingEquipment: [],  // 训练器材
                    electronics: [],  // 电子产品
                    books: []  // 书籍
                };
                this.player.activeBuffs = [];  // 激活的buff
                this.player.purchaseCount = {};  // 物品购买次数追踪
                
                // 奇遇事件系统数据
                this.adventureEvents = this.initAdventureEvents();
                
                this.init();
            }
            
            init() {
                console.log('init() called');
                console.log('currentScene:', this.currentScene);
                
                // 检查是否有存档
                if (this.hasSaveData()) {
                    console.log('发现存档，尝试加载...');
                    const loaded = this.loadGame();
                    if (loaded === 'gameOver') {
                        // 游戏已结束，显示存档弹窗，继续后直接跳结局
                        this.showContinueGamePrompt();
                        return;
                    } else if (loaded) {
                        console.log('存档加载成功');
                        // 显示继续游戏的提示
                        this.showContinueGamePrompt();
                        return;
                    } else {
                        console.log('存档加载失败，开始新游戏');
                    }
                }
                
                // 没有存档或加载失败，开始新游戏
                this.updateUI();
                this.updateGoalDisplay();
                this.showScene(this.currentScene);
                // 初始化时设置一个随机名字和技能
                setTimeout(() => {
                    console.log('Setting random name and skills...');
                    this.randomName();
                    this.rollAttributes();
                    this.updateInitialSkillsDisplay();
                }, 100);
            }
            
            // 显示继续游戏提示
            showContinueGamePrompt() {
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                // 检查是否在比赛中
                let statusWarning = '';
                if (this.player.gameOver === true) {
                    statusWarning = `<div style="margin: 15px 0; padding: 15px; background: rgba(255, 215, 0, 0.2); border-radius: 8px; border-left: 4px solid #ffd700;">
                        <p style="color: #ffd700; font-weight: bold;">🏆 游戏已结束</p>
                        <p style="color: #ffd700;">继续将直接查看结局</p>
                    </div>`;
                } else if (this.inMatch && this.matchCheckpoint) {
                    statusWarning = `<div style="margin: 15px 0; padding: 15px; background: rgba(255, 193, 7, 0.2); border-radius: 8px; border-left: 4px solid #ffc107;">
                        <p style="color: #ff9800; font-weight: bold;">⚠️ 检测到比赛进行中</p>
                        <p style="color: #ff9800;">继续游戏将重新开始比赛：${this.matchCheckpoint.matchName}</p>
                    </div>`;
                } else if (this.needRestartTournamentRound && this.tournament && this.tournament.active) {
                    const roundNames = {
                        'round16': '16强赛',
                        'round8': '8强赛',
                        'round4': '半决赛',
                        'final': '决赛'
                    };
                    const roundName = roundNames[this.tournament.currentRound] || this.tournament.currentRound;
                    statusWarning = `<div style="margin: 15px 0; padding: 15px; background: rgba(255, 193, 7, 0.2); border-radius: 8px; border-left: 4px solid #ffc107;">
                        <p style="color: #ff9800; font-weight: bold;">⚠️ 检测到锦标赛进行中</p>
                        <p style="color: #ff9800;">继续游戏将重新开始：${roundName}</p>
                    </div>`;
                }
                
                title.textContent = '💾 发现存档';
                text.innerHTML = `
                    <p>检测到上次的游戏记录：</p>
                    <div style="margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <p><strong>玩家：</strong>${this.player.name}</p>
                        <p><strong>周次：</strong>第${this.player.week}周</p>
                        <p><strong>队伍：</strong>${this.player.team === 'none' ? '无' : this.player.team === 'college' ? '院队' : '校队'}</p>
                        <p><strong>平均技能：</strong>${Math.round((this.player.skills.serve + this.player.skills.spike + this.player.skills.block + this.player.skills.dig + this.player.skills.set) / 5)}</p>
                    </div>
                    ${statusWarning}
                    <p>是否继续上次的游戏？</p>
                `;
                
                choicesDiv.innerHTML = '';
                
                // 继续游戏按钮
                const continueBtn = document.createElement('button');
                continueBtn.className = 'choice-btn';
                continueBtn.textContent = '继续游戏';
                continueBtn.onclick = () => {
                    modal.classList.remove('show');
                    // 显示角色面板和游戏头部
                    document.getElementById('character-panel').classList.add('show');
                    document.getElementById('game-header').classList.add('show');
                    
                    // 如果游戏已结束，直接跳结局
                    if (this.player.gameOver === true) {
                        this.updateUI();
                        this.showScene(this.player.endingType || 'ending');
                        return;
                    }
                    
                    // 检查是否在比赛进行中刷新了页面
                    if (this.inMatch && this.matchCheckpoint) {
                        console.log('检测到比赛进行中刷新，将重新开始比赛');
                        // 清除比赛标记
                        this.inMatch = false;
                        const checkpoint = this.matchCheckpoint;
                        this.matchCheckpoint = null;
                        
                        // 更新UI
                        this.updateUI();
                        this.updateGoalDisplay();
                        
                        // 延迟重新开始比赛，确保UI已加载
                        setTimeout(() => {
                            this.startFormalMatch(checkpoint.matchType, checkpoint.matchName);
                        }, 500);
                    } else if (this.needRestartTournamentRound && this.tournament && this.tournament.active) {
                        // 检查是否需要重新开始锦标赛轮次
                        console.log('检测到锦标赛轮次场景刷新，将重新开始轮次');
                        this.needRestartTournamentRound = false;
                        const currentRound = this.tournament.currentRound;
                        
                        // 更新UI
                        this.updateUI();
                        this.updateGoalDisplay();
                        
                        // 延迟重新开始轮次
                        setTimeout(() => {
                            this.startTournamentRound(currentRound);
                        }, 500);
                    } else {
                        // 正常继续游戏
                        this.updateUI();
                        this.updateGoalDisplay();
                        
                        // 如果场景是weeklyHub且第12周锦标赛进行中，恢复到当前轮次
                        if (this.currentScene === 'weeklyHub' && this.tournament && this.tournament.active && 
                            !this.tournament.eliminated && this.tournament.currentRound) {
                            setTimeout(() => {
                                this.startTournamentRound(this.tournament.currentRound);
                            }, 500);
                            return;
                        }
                        
                        // 如果场景是weeklyHub，检查是否有应触发的比赛
                        if (this.currentScene === 'weeklyHub') {
                            const matchEvent = this.checkScheduledMatch();
                            if (matchEvent) {
                                if (matchEvent.type === 'match') {
                                    this.showMatchPreview(matchEvent.matchType, matchEvent.matchName);
                                } else if (matchEvent.type === 'tournament') {
                                    this.startTournament(matchEvent.tournamentType);
                                } else if (matchEvent.type === 'hiddenEnding') {
                                    this.player.gameOver = true;
                                    this.player.endingType = matchEvent.endingId;
                                    this.saveGame();
                                    this.showScene(matchEvent.endingId);
                                } else {
                                    this.showScene(this.currentScene);
                                }
                                return;
                            }
                        }
                        
                        this.showScene(this.currentScene);
                    }
                };
                choicesDiv.appendChild(continueBtn);
                
                // 新游戏按钮
                const newGameBtn = document.createElement('button');
                newGameBtn.className = 'choice-btn';
                newGameBtn.textContent = '开始新游戏';
                newGameBtn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                newGameBtn.onclick = () => {
                    modal.classList.remove('show');
                    // 删除存档并重置游戏
                    this.deleteSave();
                    this.applyEffect({ reset: true });
                };
                choicesDiv.appendChild(newGameBtn);
                
                // 显示弹窗
                modal.classList.add('show');
            }
            
            // 初始化商店物品
            initShopItems() {
                return {
                    training: {
                        name: '训练服务',
                        icon: '🎓',
                        items: [
                            { id: 'coach_serve', name: '发球私教', price: 300, effect: { serve: 5 }, description: '发球+5', maxPurchases: 3 },
                            { id: 'coach_spike', name: '扣球私教', price: 300, effect: { spike: 5 }, description: '扣球+5', maxPurchases: 3 },
                            { id: 'coach_block', name: '拦网私教', price: 300, effect: { block: 5 }, description: '拦网+5', maxPurchases: 3 },
                            { id: 'coach_dig', name: '垫球私教', price: 300, effect: { dig: 5 }, description: '垫球+5', maxPurchases: 3 },
                            { id: 'coach_set', name: '托球私教', price: 300, effect: { set: 5 }, description: '托球+5', maxPurchases: 3 },
                            { id: 'weekend_camp', name: '周末训练营', price: 600, effect: { serve: 3, spike: 3, block: 3, dig: 3, set: 3, energy: -20 }, description: '全技能+3，体力-20', maxPurchases: 3 }
                        ]
                    },
                    equipment: {
                        name: '装备商店',
                        icon: '👟',
                        items: [
                            { id: 'pro_shoes', name: '专业球鞋', price: 600, type: 'permanent', effect: { trainingBonus: 20 }, description: '训练效果+20%（永久）' },
                            { id: 'protection', name: '护膝护腕套装', price: 250, type: 'permanent', effect: { injuryResist: 70 }, description: '减少受伤概率70%（永久）' },
                            { id: 'jersey', name: '专业球衣', price: 350, type: 'permanent', effect: { mood: 15, reputation: 10, trainingBonus: 10 }, description: '心情+15，声望+10，训练效果+10%（永久）' },
                            { id: 'training_ball', name: '专业训练球', price: 900, type: 'permanent', effect: { trainingBonus: 25 }, description: '训练效果+25%（永久）' }
                        ]
                    },
                    recovery: {
                        name: '恢复中心',
                        icon: '💊',
                        items: [
                            { id: 'energy_drink', name: '运动饮料', price: 50, effect: { energy: 10 }, description: '体力+10' },
                            { id: 'massage', name: '运动按摩', price: 150, effect: { energy: 40, mood: 15, stress: -10 }, description: '体力+40，心情+15，压力-10' },
                            { id: 'therapy', name: '深度理疗', price: 250, effect: { energy: 60, mood: 25, stress: -20 }, description: '体力+60，心情+25，压力-20' },
                            { id: 'nutrition_plan', name: '营养餐计划', price: 400, type: 'buff', effect: { maxEnergyBonus: 50 }, duration: 6, description: '体力上限+50（持续6周）' }
                        ]
                    },
                    daily: {
                        name: '生活用品',
                        icon: '📱',
                        items: [
                            { id: 'sports_watch', name: '运动手环', price: 400, type: 'permanent', effect: { mood: 15, weeklyStressReduction: 5 }, description: '心情+15，每周自动恢复压力-5（永久）' },
                            { id: 'new_phone', name: '新手机', price: 1200, type: 'permanent', effect: { mood: 30, stress: -20, reputation: 50, weeklyMoodBonus: 10 }, description: '心情+30，压力-20，声望+50，每周心情+10（永久）' },
                            { id: 'volleyball_book', name: '排球教学书', price: 200, effect: { randomSkill: 4 }, description: '随机技能+4', maxPurchases: 5 },
                            { id: 'health_supplement', name: '冥想教材', price: 888, type: 'permanent', effect: { energy: 20, maxEnergy: 20}, description: '体力+20，体力上限+20', maxPurchases: 1 }
                        ]
                    }
                };
            }
            
            // 初始化奇遇事件系统
            initAdventureEvents() {
                return [
                    // 1. 刮刮乐相关事件
                    {
                        id: 'lucky_customer',
                        name: '幸运常客',
                        condition: { activities: { scratchCard: 3 } },
                        probability: 0.4,
                        once: true,
                        content: {
                            title: '🎫 幸运常客',
                            text: '店老板认出了你："小伙子，你是我们的常客啊！这样吧，以后你来买刮刮乐，我给你打7折！"\n\n你获得了"VIP顾客"身份！',
                            choices: [
                                { text: '太好了，谢谢老板！', effect: { reputation: 5, buff: 'scratchCardDiscount' } },
                                { text: '不用了，我只是偶尔玩玩', effect: { mood: 10 } }
                            ]
                        }
                    },
                    {
                        id: 'mysterious_elder',
                        name: '神秘老人',
                        condition: { activities: { scratchCard: 6 } },
                        probability: 0.3,
                        once: true,
                        content: {
                            title: '🧙 神秘老人',
                            text: '一位白发老人在你旁边买刮刮乐。他看了你一眼："年轻人，我看你运气不错。这张刮刮乐，我送给你。"\n\n他递给你一张刮刮乐就离开了...',
                            choices: [
                                { text: '谢谢老人家！', effect: { special: 'freeScratchCard' } }
                            ]
                        }
                    },
                    {
                        id: 'jackpot_celebrity',
                        name: '中奖锦鲤',
                        condition: { scratchCardJackpots: 1 },
                        probability: 1.0,
                        once: true,
                        content: {
                            title: '📰 校园新闻',
                            text: '你中特等奖的消息在校园里传开了！同学们都叫你"锦鲤"，纷纷来找你沾沾喜气。\n\n你的人气暴涨！',
                            choices: [
                                { text: '哈哈，只是运气好', effect: { reputation: 20, teamChemistry: 15, mood: 25, title: '幸运锦鲤' } }
                            ]
                        }
                    },
                    
                    // 2. 电影相关事件
                    {
                        id: 'movie_membership',
                        name: '动漫达人',
                        condition: { activities: { movie: 2 } },
                        probability: 0.4,
                        once: true,
                        content: {
                            title: '🎬 动漫达人',
                            text: '平台会员要不要办一下？免费加更！"',
                            choices: [
                                { text: '办理会员卡（-30元）', effect: { money: -30, buff: 'movieMembership' }, requirement: { money: 30 } },
                                { text: '还是算了吧', effect: {} }
                            ]
                        }
                    },
                    {
                        id: 'romantic_encounter',
                        name: '这就是羁绊啊',
                        condition: { activities: { movie: 3 }, mood: 40 },
                        probability: 0.35,
                        once: true,
                        content: {
                            title: '👊 这就是羁绊啊',
                            text: '在弹幕区，你遇到了一个很同频的人，发现有很多共同话题。\n\n"下次一起去漫展吧？"对方说。',
                            choices: [
                                { text: '好啊，交换联系方式', effect: { mood: 30, stress: -20, special: 'startLove' } },
                                { text: '抱歉，我要专注排球', effect: { randomSkill: 5 } }
                            ]
                        }
                    },
                    {
                        id: 'movie_inspiration',
                        name: '动漫灵感',
                        condition: { activities: { movie: 5, library: 2 } },
                        probability: 0.3,
                        once: true,
                        content: {
                            title: '💡 动漫灵感',
                            text: '看完动漫后，你突然想到了一个训练方法。结合动漫里的动作和图书馆看到的理论...\n\n你领悟了新的技巧！',
                            choices: [
                                { text: '太棒了！', effect: { randomSkill: 10, mood: 15, title: '学霸运动员' } }
                            ]
                        }
                    },
                    
                    // 3. 社交相关事件
                    {
                        id: 'teammates_trust',
                        name: '队友的信任',
                        condition: { activities: { social: 3, gift: 2 } },
                        probability: 0.5,
                        once: true,
                        content: {
                            title: '🤝 队友的信任',
                            text: '队友们把你拉到一边："兄弟，我们商量了一下，想推荐你当副队长！你平时对大家这么好，大家都很信任你。"',
                            choices: [
                                { text: '谢谢大家的信任！', effect: { reputation: 25, teamChemistry: 20, title: '副队长', buff: 'teamBonus' } },
                                { text: '我还需要提升自己', effect: { randomSkill: 5 } }
                            ]
                        }
                    },
                    {
                        id: 'birthday_surprise',
                        name: '生日惊喜',
                        condition: { activities: { social: 5, gift: 3 }, relationship: 70 },
                        probability: 0.4,
                        once: true,
                        content: {
                            title: '🎂 生日惊喜',
                            text: '队友们为你准备了一个惊喜生日派对！"虽然不是你真正的生日，但我们想感谢你一直以来对大家的照顾！"\n\n蛋糕、礼物、欢笑...这一刻真美好。',
                            choices: [
                                { text: '太感动了！', effect: { mood: 40, stress: -25, teamChemistry: 15, special: 'mysteryGift' } }
                            ]
                        }
                    },
                    {
                        id: 'captain_invitation',
                        name: '队长的邀请',
                        condition: { activities: { social: 6 }, relationship: 80, totalSkills: 200 },
                        probability: 0.35,
                        once: true,
                        content: {
                            title: '⭐ 队长的邀请',
                            text: '队长找到你："我看你实力不错，人缘也好。下学期我就毕业了，我想推荐你接任队长。你愿意吗？"',
                            choices: [
                                { text: '我会努力的！', effect: { reputation: 50, title: '未来队长', buff: 'captainBonus', stress: 5 } }
                            ]
                        }
                    },
                    
                    // 4. 游戏相关事件
                    {
                        id: 'game_master',
                        name: '游戏高手',
                        condition: { activities: { game: 8 } },
                        probability: 0.4,
                        once: true,
                        content: {
                            title: '🎮 游戏高手',
                            text: '你在游戏里遇到了一个高手。对方："你反应速度不错啊，打排球的？我是职业电竞选手，要不要切磋一下？"\n\n你们成为了游戏好友。',
                            choices: [
                                { text: '好啊！', effect: { mood: 15, special: 'gameFriend' } }
                            ]
                        }
                    },
                    {
                        id: 'esports_tournament',
                        name: '电竞比赛',
                        condition: { activities: { game: 12 } },
                        probability: 0.25,
                        once: true,
                        content: {
                            title: '🏆 电竞比赛',
                            text: '游戏好友邀请你参加校园电竞比赛。"奖金1000元，而且不耽误多少时间。你反应这么快，肯定能拿名次！"',
                            choices: [
                                { text: '参加比赛', effect: { special: 'esportsTournament' } },
                                { text: '算了，我要专注排球', effect: {} }
                            ]
                        }
                    },
                    
                    // 5. 图书馆相关事件
                    {
                        id: 'psychology_book',
                        name: '学霸的秘籍',
                        condition: { activities: { library: 5 } },
                        probability: 0.4,
                        once: true,
                        content: {
                            title: '📖 学霸的秘籍',
                            text: '在图书馆，你发现了一本《运动心理学》。里面有很多关于如何保持最佳状态的方法。\n\n你认真学习了这本书。',
                            choices: [
                                { text: '受益匪浅！', effect: { mood: 15, buff: 'stressReduction', title: '心理大师' } }
                            ]
                        }
                    },
                    {
                        id: 'senior_guidance',
                        name: '学姐的指导',
                        condition: { activities: { library: 8 }, reputation: 50 },
                        probability: 0.35,
                        once: true,
                        content: {
                            title: '👩‍🎓 学姐的指导',
                            text: '一位体育系的学姐注意到你在看排球书籍。"你是排球社的吧？我以前也打排球。这些资料给你，希望对你有帮助。"\n\n她给了你一些珍贵的训练资料。',
                            choices: [
                                { text: '太感谢了！', effect: { serve: 3, spike: 3, block: 3, dig: 3, set: 3, teammateChemistry: { random: 10 }, special: 'seniorNotes' } }
                            ]
                        }
                    },
                    
                    // 6. 美食相关事件
                    {
                        id: 'food_regular',
                        name: '美食家',
                        condition: { activities: { food: 6 } },
                        probability: 0.4,
                        once: true,
                        content: {
                            title: '🍜 美食家',
                            text: '餐厅老板认出了你："小伙子，你是我们的常客！看你是学生，以后来吃饭给你打9折。而且我看你是运动员，给你加量不加价！"',
                            choices: [
                                { text: '太好了，谢谢老板！', effect: { mood: 15, buff: 'foodDiscount', title: '美食家' } }
                            ]
                        }
                    },
                    {
                        id: 'nutritionist_advice',
                        name: '营养师的建议',
                        condition: { activities: { food: 8 }, maxEnergy: 95 },
                        probability: 0.3,
                        once: true,
                        content: {
                            title: '🥗 营养师的建议',
                            text: '一位营养师注意到你的饮食习惯。"同学，你是运动员吧？我可以给你制定一份专业的营养计划，免费的！"\n\n你获得了科学的营养指导。',
                            choices: [
                                { text: '太感谢了！', effect: { maxEnergy: 10, buff: 'nutritionPlan', title: '科学饮食' } }
                            ]
                        }
                    },
                    
                    // 7. 打工相关事件
                    {
                        id: 'boss_appreciation',
                        name: '老板的赏识',
                        condition: { activities: { work: 8 } },
                        probability: 0.4,
                        once: true,
                        content: {
                            title: '💼 老板的赏识',
                            text: '老板把你叫到一边："小伙子，你工作很认真。以后你来打工，工资给你涨20%！而且如果你需要，随时可以来。"',
                            choices: [
                                { text: '谢谢老板！', effect: { mood: 15, buff: 'workBonus' } }
                            ]
                        }
                    },
                    {
                        id: 'sports_store_job',
                        name: '工作机会',
                        condition: { activities: { work: 12 }, reputation: 60 },
                        probability: 0.3,
                        once: true,
                        content: {
                            title: '💰 工作机会',
                            text: '老板介绍你去一家体育用品店做兼职。"他们需要懂排球的人，工资更高，而且你还能学到很多专业知识。"',
                            choices: [
                                { text: '太好了！', effect: { mood: 20, reputation: 10, special: 'sportsStoreJob' } }
                            ]
                        }
                    },
                    
                    // 8. 按摩/休息相关事件
                    {
                        id: 'therapist_recognition',
                        name: '理疗师的认可',
                        condition: { activities: { massage: 6 } },
                        probability: 0.4,
                        once: true,
                        content: {
                            title: '💆 理疗师的认可',
                            text: '理疗师："你很注重身体恢复，这很好。我教你一些自我按摩的方法，以后你自己也能做简单的放松。"',
                            choices: [
                                { text: '太感谢了！', effect: { buff: 'selfTherapy', title: '自我理疗' } }
                            ]
                        }
                    },
                    {
                        id: 'perfect_routine',
                        name: '完美作息',
                        condition: { activities: { rest: 10 }, avgEnergy: 80 },
                        probability: 0.35,
                        once: true,
                        content: {
                            title: '😴 完美作息',
                            text: '你养成了良好的作息习惯。身体状态越来越好，训练效果也提升了。\n\n教练都夸你是"自律典范"！',
                            choices: [
                                { text: '继续保持！', effect: { maxEnergy: 10, buff: 'perfectRoutine', title: '自律典范' } }
                            ]
                        }
                    },
                    
                    // 9. 复合事件
                    {
                        id: 'well_rounded',
                        name: '全面发展',
                        condition: { diverseActivities: 5 },
                        probability: 0.3,
                        once: true,
                        content: {
                            title: '🌟 全面发展',
                            text: '辅导员找到你："我注意到你不仅训练刻苦，生活也很丰富。学习、社交、娱乐都很平衡。学校想推荐你参加\'优秀大学生\'评选。"',
                            choices: [
                                { text: '太荣幸了！', effect: { reputation: 30, money: 500, mood: 20, title: '优秀大学生' } }
                            ]
                        }
                    },
                    {
                        id: 'campus_celebrity',
                        name: '校园名人',
                        condition: { reputation: 80, diverseActivities: 6 },
                        probability: 0.25,
                        once: true,
                        content: {
                            title: '📸 校园名人',
                            text: '校园记者想采访你："你在排球队表现出色，生活也很精彩，能分享一下你的经验吗？"\n\n采访发布后，你成了校园名人！',
                            choices: [
                                { text: '很高兴分享', effect: { reputation: 40, teamChemistry: 20, title: '校园明星', buff: 'campusStar' } }
                            ]
                        }
                    },
                    {
                        id: 'life_mentor',
                        name: '生活导师',
                        condition: { activities: { gift: 4, social: 6 }, diverseActivities: 4 },
                        probability: 0.3,
                        once: true,
                        content: {
                            title: '🎓 生活导师',
                            text: '学弟学妹们经常来找你请教。不仅是排球技术，还有如何平衡学习、训练和生活。\n\n你成了大家的"生活导师"！',
                            choices: [
                                { text: '很乐意帮助大家', effect: { reputation: 25, teamChemistry: 15, title: '生活导师', buff: 'mentor' } }
                            ]
                        }
                    },
                    
                    // 10. 特殊连锁事件
                    {
                        id: 'lucky_day',
                        name: '幸运日',
                        condition: { scratchCardJackpots: 1, mood: 80 },
                        probability: 0.2,
                        once: false,
                        content: {
                            title: '🍀 幸运日',
                            text: '今天似乎特别幸运！走在路上捡到了钱，食堂阿姨多打了菜，训练时状态特别好...\n\n这是你的幸运日！',
                            choices: [
                                { text: '太棒了！', effect: { money: 100, mood: 15, special: 'luckyWeek' } }
                            ]
                        }
                    },
                    {
                        id: 'burnout_warning',
                        name: '疲惫期',
                        condition: { activities: { work: 10 }, maxRest: 2 },
                        probability: 0.4,
                        once: false,
                        content: {
                            title: '😰 疲惫期',
                            text: '你最近太累了...队友担心地说："你是不是打工太多了？身体要紧啊，别把自己累坏了。"',
                            choices: [
                                { text: '你说得对，我要多休息', effect: { energy: -20, mood: -15, stress: 15, special: 'restBuff' } },
                                { text: '没事，我能坚持', effect: { energy: -20, mood: -15, stress: 15, special: 'burnoutPenalty' } }
                            ]
                        }
                    },
                    {
                        id: 'love_trouble',
                        name: '恋爱的烦恼',
                        condition: { hasLoveInterest: true, weeklyTraining: 3, weeklyDate: 0 },
                        probability: 0.3,
                        once: false,
                        content: {
                            title: '💔 恋爱的烦恼',
                            text: '对象发来消息："你最近都在训练，都没时间陪我...你是不是不在乎我了？"\n\n你需要平衡恋爱和训练。',
                            choices: [
                                { text: '抱歉，这周末陪你', effect: { mood: -10, stress: 10, special: 'planDate' } },
                                { text: '对不起，比赛快到了', effect: { teamChemistry: -10, buff: 'focusBonus' } },
                                { text: '我们还是分手吧', effect: { mood: -20, special: 'breakup', buff: 'dedicationBonus' } }
                            ]
                        }
                    },
                    
                    // 专精训练请教事件（技能≥60时触发）
                    {
                        id: 'teach_serve',
                        name: '请教发球',
                        condition: { skills: { serve: 60 }, lastTraining: 'serve' },
                        probability: 0.35,
                        once: true,
                        content: {
                            title: '🎯 学弟的请教',
                            text: '训练结束后，一个学弟跑过来："学长，你的发球好厉害！能教教我吗？"\n\n他眼神里充满期待。',
                            choices: [
                                { 
                                    text: '当然，我来示范给你看', 
                                    effect: { serve: 2, reputation: 8, mood: 10, teammateChemistry: { random: 5 } },
                                    result: '你耐心地教学弟发球技巧，他学得很认真。\n\n"谢谢学长！我明白了！"他开心地说。'
                                },
                                { 
                                    text: '抱歉，我还要继续练', 
                                    effect: { serve: 1, mood: -5 },
                                    result: '学弟有些失望地离开了。\n\n你继续自己的训练，但心里有些不舒服。'
                                }
                            ]
                        }
                    },
                    {
                        id: 'teach_spike',
                        name: '请教扣球',
                        condition: { skills: { spike: 60 }, lastTraining: 'spike' },
                        probability: 0.35,
                        once: true,
                        content: {
                            title: '⚡ 学妹的请教',
                            text: '一个学妹拿着排球走过来："学长，你的扣球力量好大！能教我怎么发力吗？"\n\n她看起来很认真。',
                            choices: [
                                { 
                                    text: '好啊，我教你技巧', 
                                    effect: { spike: 2, reputation: 8, mood: 12, teammateChemistry: { random: 5 } },
                                    result: '你详细讲解了扣球的发力技巧，学妹认真练习。\n\n"原来是这样！谢谢学长！"她兴奋地说。'
                                },
                                { 
                                    text: '我也还在摸索中', 
                                    effect: { spike: 1, mood: -3 },
                                    result: '学妹点点头离开了。\n\n你继续训练，但感觉错过了什么。'
                                }
                            ]
                        }
                    },
                    {
                        id: 'teach_block',
                        name: '请教拦网',
                        condition: { skills: { block: 60 }, lastTraining: 'block' },
                        probability: 0.35,
                        once: true,
                        content: {
                            title: '🛡️ 学弟的请教',
                            text: '一个高个子学弟问你："学长，拦网时怎么判断对方的扣球路线？你总能拦到球！"\n\n他拿着笔记本准备记录。',
                            choices: [
                                { 
                                    text: '我分享一下经验', 
                                    effect: { block: 2, reputation: 8, mood: 10, teammateChemistry: { random: 5 } },
                                    result: '你分享了拦网的判断技巧，学弟认真记录。\n\n"太有用了！谢谢学长！"他感激地说。'
                                },
                                { 
                                    text: '这个要靠实战积累', 
                                    effect: { block: 1, mood: -4 },
                                    result: '学弟有些失望地收起笔记本。\n\n你继续训练，但感觉有些愧疚。'
                                }
                            ]
                        }
                    },
                    {
                        id: 'teach_dig',
                        name: '请教垫球',
                        condition: { skills: { dig: 60 }, lastTraining: 'dig' },
                        probability: 0.35,
                        once: true,
                        content: {
                            title: '🏐 学妹的请教',
                            text: '一个学妹羡慕地说："学长，你的垫球好稳啊！我总是控制不好方向，能教教我吗？"\n\n她看起来有些沮丧。',
                            choices: [
                                { 
                                    text: '没问题，我示范给你', 
                                    effect: { dig: 2, reputation: 8, mood: 10, teammateChemistry: { random: 5 } },
                                    result: '你耐心示范垫球的手型和发力，学妹渐渐找到感觉。\n\n"我会了！谢谢学长！"她开心地笑了。'
                                },
                                { 
                                    text: '多练就好了', 
                                    effect: { dig: 1, mood: -3 },
                                    result: '学妹失望地点点头离开。\n\n你继续训练，但心里有些不安。'
                                }
                            ]
                        }
                    },
                    {
                        id: 'teach_set',
                        name: '请教托球',
                        condition: { skills: { set: 60 }, lastTraining: 'set' },
                        probability: 0.35,
                        once: true,
                        content: {
                            title: '🤲 学弟的请教',
                            text: '一个学弟问你："学长，你的托球好精准！怎么才能像你一样把球传到最佳位置？"\n\n他看起来很好学。',
                            choices: [
                                { 
                                    text: '我教你手型和发力', 
                                    effect: { set: 2, reputation: 8, mood: 10, teammateChemistry: { random: 5 } },
                                    result: '你详细讲解托球的手型和发力技巧，学弟认真学习。\n\n"明白了！谢谢学长指导！"他高兴地说。'
                                },
                                { 
                                    text: '这需要长期练习', 
                                    effect: { set: 1, mood: -4 },
                                    result: '学弟有些失望地离开了。\n\n你继续训练，但感觉错过了帮助别人的机会。'
                                }
                            ]
                        }
                    },
                    
                    // ====================================================
                    // 队友专属奇遇事件（仅训练后触发）
                    // ====================================================
                    
                    // 1. 同位置竞争：发球对决
                    {
                        id: 'teammate_serve_challenge',
                        name: '发球对决',
                        condition: { 
                            hasTeammates: true,
                            week: { min: 3, max: 12 },
                            teammateCondition: {
                                position: 'same',
                                chemistry: { min: 30, max: 60 },
                                skillDiff: { skill: 'serve', playerHigher: 5 }
                            },
                            trainingOnly: true
                        },
                        probability: 0.2,
                        once: true,
                        content: {
                            title: '🎯 {teammate}的发球对决',
                            text: '{teammate}走过来，眼神中带着不服气：\n"听说你发球挺厉害的？不如我们比比看，谁的发球成功率更高！"\n看来他想证明自己的实力。',
                            choices: [
                                { 
                                    text: '"好啊，来吧！"（接受挑战）', 
                                    effect: { 
                                        energy: -8,
                                        serve: { success: 3, fail: 1 },
                                        teammateChemistry: { success: 8, fail: 3 },
                                        mood: { success: 10, fail: 0 },
                                        stress: { success: 0, fail: 5 },
                                        successRate: 0.7
                                    },
                                    result: {
                                        success: '你们进行了激烈的发球比拼，最终你略胜一筹。\n\n{teammate}心服口服："厉害！我还要继续努力！"',
                                        fail: '比赛很激烈，{teammate}发挥得更好。\n\n"下次再来！"你们约定继续切磋。'
                                    }
                                },
                                { 
                                    text: '"不如我们互相学习？"（温和应对）', 
                                    effect: { 
                                        energy: -5,
                                        serve: 2,
                                        teammateServe: 2,
                                        teammateChemistry: 12,
                                        mood: 5
                                    },
                                    result: '你们一起练习发球，互相指出对方的优点和不足。\n\n{teammate}笑着说："和你一起练习真好！"'
                                },
                                { 
                                    text: '"我没兴趣比这个"（拒绝）', 
                                    effect: { 
                                        teammateChemistry: -5,
                                        mood: -3
                                    },
                                    result: '{teammate}有些失望地离开了。\n\n你继续自己的训练，但气氛有些尴尬。'
                                }
                            ]
                        }
                    },
                    
                    // 2. 二传与攻手：战术配合训练
                    {
                        id: 'teammate_tactic_training',
                        name: '战术配合训练',
                        condition: { 
                            hasTeammates: true,
                            week: { min: 4, max: 12 },
                            teammateCondition: {
                                positionPair: ['setter', 'outsideHitter', 'middleBlocker', 'oppositeHitter'],
                                chemistry: { min: 40, max: 70 }
                            },
                            trainingOnly: true
                        },
                        probability: 0.2,
                        once: true,
                        content: {
                            title: '🤝 与{teammate}的战术配合',
                            text: '{teammate}拿着排球走过来：\n"我一直想和你练练快攻配合，你的{skill}很有潜力，\n我们一起研究一下新战术怎么样？"',
                            choices: [
                                { 
                                    text: '"太好了！我也想提升配合"（积极训练）', 
                                    effect: { 
                                        energy: -10,
                                        set: 2,
                                        spike: 2,
                                        teammateChemistry: 15,
                                        skillProgress: 5
                                    },
                                    result: '你们花了很长时间研究战术配合，尝试了各种快攻变化。\n\n{teammate}满意地说："我们的配合越来越好了！"'
                                },
                                { 
                                    text: '"可以，但别练太久"（适度训练）', 
                                    effect: { 
                                        energy: -5,
                                        set: 1,
                                        spike: 1,
                                        teammateChemistry: 8
                                    },
                                    result: '你们练习了一会儿基本配合。\n\n{teammate}说："下次我们继续！"'
                                },
                                { 
                                    text: '"今天太累了，改天吧"（拒绝）', 
                                    effect: { 
                                        energy: 5,
                                        teammateChemistry: -3
                                    },
                                    result: '{teammate}有些失望："好吧，那改天。"\n\n你回去休息了。'
                                }
                            ]
                        }
                    },
                    
                    // 3. 自由人的防守指导
                    {
                        id: 'teammate_libero_guidance',
                        name: '防守指导',
                        condition: { 
                            hasTeammates: true,
                            week: { min: 5, max: 12 },
                            teammateCondition: {
                                position: 'libero',
                                chemistry: { min: 50, max: 100 }
                            },
                            playerSkill: { dig: { max: 70 } },
                            trainingOnly: true
                        },
                        probability: 0.25,
                        once: true,
                        content: {
                            title: '🛡️ {teammate}的防守指导',
                            text: '{teammate}（自由人）看着你训练，走过来说：\n"你的垫球姿势还有改进空间，我注意到你在低球处理上有些问题。\n要不要我教你一些技巧？我可是专业的！"',
                            choices: [
                                { 
                                    text: '"太感谢了！请多指教"（虚心学习）', 
                                    effect: { 
                                        energy: -6,
                                        dig: 4,
                                        teammateChemistry: 10,
                                        mood: 8
                                    },
                                    result: '{teammate}耐心地教你防守技巧，你的垫球水平明显提升。\n\n"你学得很快！继续保持！"他鼓励道。'
                                },
                                { 
                                    text: '"我自己的风格就好"（婉拒）', 
                                    effect: { 
                                        teammateChemistry: 2,
                                        mood: -2
                                    },
                                    result: '{teammate}点点头："也对，每个人都有自己的风格。"\n\n但你感觉错过了提升的机会。'
                                },
                                { 
                                    text: '"那你示范给我看看"（半信半疑）', 
                                    effect: { 
                                        energy: -3,
                                        dig: 2,
                                        teammateChemistry: 5
                                    },
                                    result: '{teammate}示范了几个动作，你学到了一些技巧。\n\n"看到了吧？试试看！"'
                                }
                            ]
                        }
                    },
                    
                    // 4. 副攻的拦网切磋
                    {
                        id: 'teammate_block_practice',
                        name: '拦网切磋',
                        condition: { 
                            hasTeammates: true,
                            week: { min: 4, max: 12 },
                            teammateCondition: {
                                position: 'middleBlocker',
                                chemistry: { min: 35, max: 65 },
                                skillDiff: { skill: 'block', diff: 10 }
                            },
                            trainingOnly: true
                        },
                        probability: 0.2,
                        once: true,
                        content: {
                            title: '🛡️ 与{teammate}的拦网切磋',
                            text: '{teammate}在网前练习拦网，看到你后喊道：\n"嘿！来帮我练练拦网吧，我们互相当对手，\n看看谁能拦住对方的扣球！"',
                            choices: [
                                { 
                                    text: '"来吧！看我的移动拦网"（全力以赴）', 
                                    effect: { 
                                        energy: -8,
                                        block: 3,
                                        teammateBlock: 2,
                                        teammateChemistry: 10,
                                        mood: 12
                                    },
                                    result: '你们进行了激烈的拦网对抗，互相学习对方的技巧。\n\n{teammate}兴奋地说："和你练习进步真快！"'
                                },
                                { 
                                    text: '"好，但我只能练一会儿"（适度练习）', 
                                    effect: { 
                                        energy: -5,
                                        block: 2,
                                        teammateChemistry: 6
                                    },
                                    result: '你们练习了基本的拦网动作。\n\n{teammate}说："下次多练一会儿！"'
                                },
                                { 
                                    text: '"我想练其他的"（拒绝）', 
                                    effect: { 
                                        teammateChemistry: -4
                                    },
                                    result: '{teammate}有些失望地继续自己练习。\n\n气氛有些尴尬。'
                                }
                            ]
                        }
                    },
                    
                    // 5. 深夜的心事倾诉
                    {
                        id: 'teammate_late_talk',
                        name: '深夜倾诉',
                        condition: { 
                            hasTeammates: true,
                            week: { min: 8, max: 12 },
                            teammateCondition: {
                                chemistry: { min: 70, max: 100 },
                                personality: ['内向型', '严肃型']
                            },
                            trainingOnly: true
                        },
                        probability: 0.15,
                        once: true,
                        content: {
                            title: '🌙 {teammate}的深夜倾诉',
                            text: '训练结束后，{teammate}走过来，看起来有些犹豫：\n"不好意思...最近训练压力有点大，有些迷茫，\n能和你聊聊吗？"',
                            choices: [
                                { 
                                    text: '"当然可以，我们找个地方坐下聊"（耐心倾听）', 
                                    effect: { 
                                        energy: -3,
                                        teammateChemistry: 18,
                                        mood: 15,
                                        teammateSkill: 2
                                    },
                                    result: '你们聊了很久，你的鼓励让{teammate}重拾信心。\n\n"谢谢你，和你聊完我好多了！"他感激地说。'
                                },
                                { 
                                    text: '"我也有压力，我们互相鼓励"（共同面对）', 
                                    effect: { 
                                        energy: -3,
                                        teammateChemistry: 15,
                                        mood: 10,
                                        stress: -8
                                    },
                                    result: '你们分享了各自的压力和困惑，互相鼓励。\n\n"我们一起加油！"{teammate}说。'
                                },
                                { 
                                    text: '"明天再说吧，我要休息了"（拒绝）', 
                                    effect: { 
                                        energy: 5,
                                        teammateChemistry: -8,
                                        mood: -5
                                    },
                                    result: '{teammate}失望地离开了。\n\n你感觉自己可能伤害了他。'
                                }
                            ]
                        }
                    },
                    
                    // 6. 热血的加练邀请
                    {
                        id: 'teammate_extra_training',
                        name: '加练邀请',
                        condition: { 
                            hasTeammates: true,
                            week: { min: 6, max: 12 },
                            teammateCondition: {
                                chemistry: { min: 60, max: 100 },
                                personality: ['热血型']
                            },
                            playerEnergy: { min: 30 },
                            trainingOnly: true
                        },
                        probability: 0.2,
                        once: true,
                        content: {
                            title: '🔥 {teammate}的加练邀请',
                            text: '{teammate}兴冲冲地跑过来：\n"我发现了一个超棒的训练方法！虽然有点累，\n但效果肯定很好！要不要一起加练？燃起来吧！"',
                            choices: [
                                { 
                                    text: '"好！一起燃烧吧！"（热血响应）', 
                                    effect: { 
                                        energy: -20,
                                        coreSkill: 4,
                                        teammateChemistry: 20,
                                        mood: 20
                                    },
                                    result: '你们进行了高强度的加练，虽然很累但收获满满！\n\n{teammate}激动地说："这就是青春啊！"'
                                },
                                { 
                                    text: '"可以，但要注意休息"（理性训练）', 
                                    effect: { 
                                        energy: -12,
                                        randomSkill: 2,
                                        teammateChemistry: 10,
                                        mood: 8
                                    },
                                    result: '你们进行了适度的加练，效果不错。\n\n{teammate}说："你说得对，要劳逸结合！"'
                                },
                                { 
                                    text: '"太累了，你自己去吧"（拒绝）', 
                                    effect: { 
                                        teammateChemistry: -6
                                    },
                                    result: '{teammate}有些失望："好吧，那我自己练。"\n\n你感觉辜负了他的热情。'
                                }
                            ]
                        }
                    },
                    
                    // 7. 技术流的战术讨论
                    {
                        id: 'teammate_tactic_discussion',
                        name: '战术讨论',
                        condition: { 
                            hasTeammates: true,
                            week: { min: 7, max: 12 },
                            teammateCondition: {
                                chemistry: { min: 55, max: 100 },
                                personality: ['冷静型']
                            },
                            trainingOnly: true
                        },
                        probability: 0.2,
                        once: true,
                        content: {
                            title: '📊 与{teammate}的战术讨论',
                            text: '{teammate}拿着笔记本走过来：\n"我分析了最近几场比赛的录像，发现了一些可以改进的地方。\n你有兴趣一起研究一下战术吗？"',
                            choices: [
                                { 
                                    text: '"太好了！我也想提升战术理解"（深入研究）', 
                                    effect: { 
                                        energy: -5,
                                        randomSkill: 2,
                                        set: 2,
                                        teammateChemistry: 15,
                                        reputation: 3
                                    },
                                    result: '你们深入讨论战术，分析了很多细节。\n\n{teammate}满意地说："和你讨论很有收获！"'
                                },
                                { 
                                    text: '"简单说说就好"（简单了解）', 
                                    effect: { 
                                        energy: -2,
                                        randomSkill: 1,
                                        teammateChemistry: 8
                                    },
                                    result: '{teammate}简单讲解了一些要点。\n\n"有空再详细聊！"他说。'
                                },
                                { 
                                    text: '"我更喜欢实战"（拒绝）', 
                                    effect: { 
                                        teammateChemistry: -3
                                    },
                                    result: '{teammate}有些失望："好吧，每个人风格不同。"\n\n但你感觉错过了学习机会。'
                                }
                            ]
                        }
                    },
                    
                    // 8. 能力差距的请教
                    {
                        id: 'teammate_ask_advice',
                        name: '队友请教',
                        condition: { 
                            hasTeammates: true,
                            week: { min: 5, max: 12 },
                            teammateCondition: {
                                chemistry: { min: 45, max: 100 },
                                skillDiff: { playerHigher: 15 }
                            },
                            trainingOnly: true
                        },
                        probability: 0.2,
                        once: true,
                        content: {
                            title: '🙏 {teammate}的请教',
                            text: '{teammate}有些不好意思地说：\n"我注意到你的{skill}特别厉害...能教教我吗？\n我一直想提升这方面，但总是找不到窍门。"',
                            choices: [
                                { 
                                    text: '"没问题！我把经验都告诉你"（倾囊相授）', 
                                    effect: { 
                                        energy: -8,
                                        targetSkill: 1,
                                        teammateTargetSkill: 4,
                                        teammateChemistry: 20,
                                        mood: 12
                                    },
                                    result: '你详细教授了技巧和经验，{teammate}学得很认真。\n\n"太感谢了！你真是个好队友！"他感激地说。'
                                },
                                { 
                                    text: '"我们一起练练看"（共同进步）', 
                                    effect: { 
                                        energy: -5,
                                        targetSkill: 2,
                                        teammateTargetSkill: 2,
                                        teammateChemistry: 12
                                    },
                                    result: '你们一起练习，互相指点。\n\n{teammate}说："和你一起练习真好！"'
                                },
                                { 
                                    text: '"这个要靠自己领悟"（敷衍）', 
                                    effect: { 
                                        teammateChemistry: -5,
                                        mood: -3
                                    },
                                    result: '{teammate}失望地离开了。\n\n你感觉自己可能太冷漠了。'
                                }
                            ]
                        }
                    }
                ];
            }
            
            getGoalInfo() {
                const goals = {
                    collegeTryout: {
                        id: 'collegeTryout',
                        type: 'tryout',  // 选拔类
                        title: '🎯 加入院队',
                        icon: '🎯',
                        timeWindow: '第2-4周',
                        nextEvent: '第5周院际比赛',
                        // 简化要求：只看技能，任意2项技能≥15即可
                        criteria: {
                            skillCount: {
                                minSkills: 2,  // 至少2项技能达标
                                threshold: 15  // 每项技能的门槛
                            }
                        },
                        requirements: {  // 保留用于显示
                            anyTwo: 15  // 任意2项≥15
                        },
                        tips: '建议第4周前完成选拔，为比赛做准备',
                        nextGoal: 'collegeMatch'
                    },
                    collegeMatch: {
                        id: 'collegeMatch',
                        type: 'match',  // 比赛类
                        title: '🏐 院际比赛',
                        icon: '🏐',
                        triggerWeek: 5,
                        description: '第5周参加院际比赛（需加入院队并选择场上位置）',
                        tips: '⚠️ 重要：必须在第5周前加入院队并选择场上位置，否则无法参赛',  // 添加tips字段作为后备
                        preparation: [
                            '提升主要技能到20+',
                            '保持良好状态（心情、体力）',
                            '选择合适的场上位置'
                        ],
                        performanceLevels: [
                            '优秀：全面发挥，主导比赛',
                            '良好：稳定发挥，帮助球队',
                            '一般：中规中矩',
                            '不佳：发挥失常'
                        ],
                        nextGoal: 'universityTryout'
                    },
                    universityTryout: {
                        id: 'universityTryout',
                        type: 'tryout',  // 选拔类
                        title: '🎯 加入校队',
                        icon: '🎯',
                        timeWindow: '第8-11周',
                        nextEvent: '第12周校际联赛',
                        // 修改要求：任意3项技能≥50，总和≥180，声望≥100
                        criteria: {
                            skillCount: {
                                minSkills: 3,
                                threshold: 50
                            },
                            skillSum: {
                                min: 180
                            },
                            stats: {
                                reputation: { min: 100 }
                            }
                        },
                        requirements: {
                            anyThree: 50,
                            totalSum: 180,
                            reputation: 100
                        },
                        tips: '建议第11周前完成选拔，为联赛做准备。院际比赛表现好可获得大量声望，多参与社交活动提升声望',
                        nextGoal: 'universityLeague'
                    },
                    universityLeague: {
                        id: 'universityLeague',
                        type: 'match',  // 比赛类
                        title: '🏆 校际联赛',
                        icon: '🏆',
                        triggerWeek: 12,
                        description: '这是最后的比赛！你的表现将决定最终结局',
                        tips: '全力以赴，创造奇迹！',  // 添加tips字段作为后备
                        preparation: [
                            '全面提升技能到50+',
                            '购买装备提升训练效率',
                            '保持最佳状态参赛'
                        ],
                        endings: [
                            '🏆 冠军：完美表现，横扫对手',
                            '🥈 亚军：出色发挥，惜败决赛',
                            '🏐 四强：稳定表现，止步半决赛',
                            '📖 出局：首轮淘汰，继续努力'
                        ],
                        nextGoal: null  // 比赛后进入结局
                    }
                };
                
                return goals[this.currentGoal] || goals.collegeTryout;
            }
            
            getAllGoals() {
                // 返回所有目标的有序列表（包括选拔和比赛）
                return [
                    'collegeTryout',      // 阶段一：加入院队（第1-4周选拔）
                    'collegeMatch',       // 阶段二：院际比赛（第5周自动）
                    'universityTryout',   // 阶段三：加入校队（第8-11周选拔）
                    'universityLeague'    // 阶段四：校际联赛（第12周自动，决定结局）
                ];
            }
            
            getGoalStatus(goalId) {
                const allGoals = this.getAllGoals();
                const currentIndex = allGoals.indexOf(this.currentGoal);
                const goalIndex = allGoals.indexOf(goalId);
                
                if (goalIndex < currentIndex) {
                    return 'completed';
                } else if (goalIndex === currentIndex) {
                    return 'current';
                } else if (goalIndex === currentIndex + 1) {
                    return 'next';
                } else {
                    return 'future';
                }
            }
            
            // 新增：多维度目标评估
            evaluateGoal(goal) {
                if (!goal || !goal.criteria) {
                    return { passed: false, score: 0, breakdown: {} };
                }
                
                let totalScore = 0;
                let maxScore = 0;
                let breakdown = {
                    skillCount: { score: 0, max: 0, details: {} },
                    skillSum: { score: 0, max: 0, details: {} },
                    stats: { score: 0, max: 0, details: {} },
                    performance: { score: 0, max: 0, details: {} }
                };
                
                // 评估技能数量标准（新增）
                if (goal.criteria.skillCount) {
                    const sc = goal.criteria.skillCount;
                    const weight = sc.weight || 1.0;  // 默认权重1.0
                    maxScore += weight;
                    breakdown.skillCount.max += weight;
                    
                    // 统计达标的技能数量
                    const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                    let qualifiedSkills = [];
                    
                    skills.forEach(skill => {
                        if (this.player.skills[skill] >= sc.threshold) {
                            qualifiedSkills.push({
                                name: skill,
                                value: this.player.skills[skill]
                            });
                        }
                    });
                    
                    // 计算得分：达标技能数 / 要求技能数
                    const progress = Math.min(qualifiedSkills.length / sc.minSkills, 1.0);
                    const score = progress * weight;
                    
                    totalScore += score;
                    breakdown.skillCount.score += score;
                    breakdown.skillCount.details = {
                        qualified: qualifiedSkills.length,
                        required: sc.minSkills,
                        threshold: sc.threshold,
                        qualifiedSkills: qualifiedSkills,
                        progress: progress,
                        score: score,
                        weight: weight
                    };
                }
                
                // 评估技能总和标准（新增）
                if (goal.criteria.skillSum) {
                    const ss = goal.criteria.skillSum;
                    const weight = ss.weight || 1.0;
                    maxScore += weight;
                    breakdown.skillSum.max += weight;
                    
                    // 计算当前技能总和
                    const currentSum = this.player.skills.serve + this.player.skills.spike + 
                                     this.player.skills.block + this.player.skills.dig + this.player.skills.set;
                    
                    // 计算得分：当前总和 / 要求总和
                    const progress = Math.min(currentSum / ss.min, 1.0);
                    const score = progress * weight;
                    
                    totalScore += score;
                    breakdown.skillSum.score += score;
                    breakdown.skillSum.details = {
                        current: currentSum,
                        required: ss.min,
                        progress: progress,
                        score: score,
                        weight: weight
                    };
                }
                
                // 评估属性标准（声望等）
                if (goal.criteria.stats) {
                    for (let [stat, requirement] of Object.entries(goal.criteria.stats)) {
                        const weight = requirement.weight || 1.0;  // 默认权重1.0
                        maxScore += weight;
                        breakdown.stats.max += weight;
                        
                        let statValue = stat === 'reputation' ? this.player.reputation : this.player.skills[stat];
                        let progress = Math.min(statValue / requirement.min, 1.0);
                        let score = progress * weight;
                        
                        totalScore += score;
                        breakdown.stats.score += score;
                        breakdown.stats.details[stat] = {
                            current: statValue,
                            required: requirement.min,
                            progress: progress,
                            score: score,
                            weight: weight
                        };
                    }
                }
                
                // 评估表现标准
                if (goal.criteria.performance) {
                    for (let [metric, requirement] of Object.entries(goal.criteria.performance)) {
                        const weight = requirement.weight || 1.0;  // 默认权重1.0
                        maxScore += weight;
                        breakdown.performance.max += weight;
                        
                        let metricValue = this.player[metric] || 0;
                        let progress = Math.min(metricValue / requirement.min, 1.0);
                        let score = progress * weight;
                        
                        totalScore += score;
                        breakdown.performance.score += score;
                        breakdown.performance.details[metric] = {
                            current: metricValue,
                            required: requirement.min,
                            progress: progress,
                            score: score,
                            weight: weight
                        };
                    }
                }
                
                // 计算最终得分
                let finalScore = maxScore > 0 ? totalScore / maxScore : 0;
                let passed = finalScore >= (goal.passingScore || 1.0);  // 默认要求100%达标
                
                return {
                    passed,
                    score: finalScore,
                    breakdown
                };
            }
            
            // 检查目标是否达成（使用新的评估系统）
            checkGoalCompletion() {
                const goal = this.getGoalInfo();
                
                // 只检查选拔类目标，比赛类目标自动触发
                if (!goal || goal.type !== 'tryout') return false;
                
                // 使用新的评估系统
                const evaluation = this.evaluateGoal(goal);
                
                if (evaluation.passed) {
                    // 构建详细信息
                    let detailsText = `综合评分：${(evaluation.score * 100).toFixed(1)}%\n\n`;
                    
                    // 技能数量得分
                    if (evaluation.breakdown.skillCount && evaluation.breakdown.skillCount.max > 0) {
                        const sc = evaluation.breakdown.skillCount.details;
                        detailsText += `✅ 技能达标：${sc.qualified}/${sc.required}项（门槛${sc.threshold}）\n`;
                        if (sc.qualifiedSkills.length > 0) {
                            detailsText += `   达标技能：${sc.qualifiedSkills.map(s => {
                                const names = {serve:'发球',spike:'扣球',block:'拦网',dig:'垫球',set:'托球'};
                                return names[s.name] + s.value;
                            }).join('、')}\n`;
                        }
                        detailsText += '\n';
                    }
                    
                    // 属性得分
                    if (evaluation.breakdown.stats && evaluation.breakdown.stats.max > 0) {
                        detailsText += `📊 属性评分：${(evaluation.breakdown.stats.score / evaluation.breakdown.stats.max * 100).toFixed(1)}%\n`;
                    }
                    
                    // 表现得分
                    if (evaluation.breakdown.performance && evaluation.breakdown.performance.max > 0) {
                        detailsText += `🏐 表现评分：${(evaluation.breakdown.performance.score / evaluation.breakdown.performance.max * 100).toFixed(1)}%\n`;
                    }
                    
                    // 目标达成 - 使用场景系统显示
                    
                    // 创建目标达成场景
                    SCENES.goalAchieved = {
                        text: `<h2>🎉 目标达成！</h2><p>恭喜你完成了${goal.title}！</p><pre>${detailsText}</pre>`,
                        choices: [{
                            text: '继续',
                            next: goal.nextGoal ? 'weeklyHub' : 'ending',
                            effect: goal.nextGoal ? { goalUpdate: goal.nextGoal } : {}
                        }]
                    };
                    
                    this.showScene('goalAchieved');
                    return true;
                } else {
                    // 构建未达成详细信息
                    const scorePercent = (evaluation.score * 100).toFixed(1);
                    const neededPercent = ((goal.passingScore || 0.7) * 100).toFixed(0);
                    
                    let detailsText = `你的综合评分：${scorePercent}%\n需要达到：${neededPercent}%\n\n`;
                    
                    // 显示差距
                    if (evaluation.breakdown.skillCount && evaluation.breakdown.skillCount.max > 0) {
                        const sc = evaluation.breakdown.skillCount.details;
                        detailsText += `❌ 技能达标：${sc.qualified}/${sc.required}项（还差${sc.required - sc.qualified}项）\n`;
                    }
                    
                    // 目标未达成 - 使用场景系统显示
                    SCENES.goalFailed = {
                        text: `<h2>😢 目标未达成</h2><p>很遗憾，你未能完成${goal.title}。</p><pre>${detailsText}</pre><p>不要气馁，继续努力！游戏将继续。</p>`,
                        choices: [{
                            text: '继续',
                            next: 'weeklyHub'
                        }]
                    };
                    
                    this.showScene('goalFailed');
                    return false;
                }
            }
            
            updateGoalDisplay() {
                const goalInfo = this.getGoalInfo();
                const goalText = document.getElementById('goal-text');
                
                if (!goalText) return;
                
                let html = `<strong>${goalInfo.title}</strong><br>`;
                
                // 根据目标类型显示不同内容
                if (goalInfo.type === 'tryout') {
                    // 选拔类目标：显示要求和达标情况
                    const evaluation = this.evaluateGoal(goalInfo);
                    
                    html += `<span style="font-size: 12px; color: #374151; font-weight: 600;">⏰ ${goalInfo.timeWindow}可选拔</span><br><br>`;
                    
                    // 显示技能数量要求
                    if (goalInfo.criteria && goalInfo.criteria.skillCount) {
                        const sc = goalInfo.criteria.skillCount;
                        const details = evaluation.breakdown.skillCount.details;
                        
                        html += `<span style="font-size: 13px;">📋 选拔要求：</span><br>`;
                        
                        const statusClass = details.qualified >= sc.minSkills ? 'goal-met' : 'goal-not-met';
                        const statusIcon = details.qualified >= sc.minSkills ? '✓' : '○';
                        
                        let reqText = '';
                        if (goalInfo.requirements.anyTwo) {
                            reqText = `任意2项≥${goalInfo.requirements.anyTwo}`;
                        } else if (goalInfo.requirements.anyThree) {
                            reqText = `任意3项≥${goalInfo.requirements.anyThree}`;
                        }
                        
                        html += `<span class="${statusClass}">${statusIcon} ${reqText}（已达标${details.qualified}项）</span><br>`;
                        
                        // 显示总和要求（如果有）
                        if (goalInfo.requirements.totalSum) {
                            const currentSum = this.player.skills.serve + this.player.skills.spike + 
                                             this.player.skills.block + this.player.skills.dig + this.player.skills.set;
                            const requiredSum = goalInfo.requirements.totalSum;
                            const sumMet = currentSum >= requiredSum;
                            const sumStatusClass = sumMet ? 'goal-met' : 'goal-not-met';
                            const sumStatusIcon = sumMet ? '✓' : '○';
                            html += `<span class="${sumStatusClass}">${sumStatusIcon} 总和≥${requiredSum}（当前${currentSum}）</span><br>`;
                        }
                        
                        // 显示当前技能值
                        html += `<div style="font-size: 12px; margin-top: 5px; color: #374151;">`;
                        const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                        const skillNames = {serve:'发球',spike:'扣球',block:'拦网',dig:'垫球',set:'托球'};
                        skills.forEach(skill => {
                            const value = this.player.skills[skill];
                            const qualified = value >= sc.threshold;
                            const color = qualified ? '#059669' : '#6b7280';
                            html += `<span style="color: ${color};">${skillNames[skill]}${value}</span> `;
                        });
                        html += `</div>`;
                    }
                    
                    // 显示声望要求
                    if (goalInfo.requirements.reputation) {
                        html += `<br><span style="font-size: 13px;">⭐ 声望要求：</span><br>`;
                        const current = this.player.reputation;
                        const required = goalInfo.requirements.reputation;
                        const met = current >= required;
                        const statusClass = met ? 'goal-met' : 'goal-not-met';
                        const statusIcon = met ? '✓' : '○';
                        html += `<span class="${statusClass}">${statusIcon} 声望: ${current}/${required}</span><br>`;
                    }
                    
                    html += `<br><span style="font-size: 11px; color: #374151; font-weight: 600;">⏰ ${goalInfo.nextEvent}</span><br>`;
                    html += `<span style="font-size: 11px; color: #6b7280;">💡 ${goalInfo.tips}</span>`;
                    
                } else if (goalInfo.type === 'match') {
                    // 比赛类目标：显示比赛信息和准备建议
                    const weeksUntil = goalInfo.triggerWeek - this.player.week;
                    
                    if (weeksUntil > 1) {
                        html += `<span style="font-size: 12px; color: #6b7280;">📅 第${goalInfo.triggerWeek}周自动开始（还有${weeksUntil}周）</span><br><br>`;
                    } else if (weeksUntil === 1) {
                        html += `<span style="font-size: 12px; color: #f39c12;">⚡ 下周开始比赛！</span><br><br>`;
                    } else if (weeksUntil === 0) {
                        html += `<span style="font-size: 12px; color: #f39c12;">� 本周将进行比赛！</span><br><br>`;
                    } else {
                        html += `<span style="font-size: 12px; color: #059669;">📅 比赛已完成</span><br><br>`;
                    }
                    
                    html += `<span style="font-size: 13px;">🎯 比赛目标：</span><br>`;
                    html += `<span style="font-size: 12px; color: #6b7280;">${goalInfo.description}</span><br><br>`;
                    
                    html += `<span style="font-size: 13px;">💪 准备建议：</span><br>`;
                    html += `<div style="font-size: 11px; color: #6b7280; line-height: 1.6;">`;
                    goalInfo.preparation.forEach(tip => {
                        html += `• ${tip}<br>`;
                    });
                    html += `</div>`;
                    
                    // 如果是校际联赛，显示可能的结局
                    if (goalInfo.endings) {
                        html += `<br><span style="font-size: 13px;">🏅 可能的结局：</span><br>`;
                        html += `<div style="font-size: 11px; color: #6b7280; line-height: 1.6;">`;
                        goalInfo.endings.forEach(ending => {
                            html += `${ending}<br>`;
                        });
                        html += `</div>`;
                    } else if (goalInfo.performanceLevels) {
                        // 其他比赛显示表现评级
                        html += `<br><span style="font-size: 13px;">📊 表现评级：</span><br>`;
                        html += `<div style="font-size: 11px; color: #6b7280; line-height: 1.6;">`;
                        goalInfo.performanceLevels.forEach(level => {
                            html += `${level}<br>`;
                        });
                        html += `</div>`;
                    }
                }
                
                goalText.innerHTML = html;
            }
            
            toggleGoalsPanel() {
                const panel = document.getElementById('goals-panel');
                if (panel.classList.contains('show')) {
                    panel.classList.remove('show');
                } else {
                    this.renderGoalsPanel();
                    panel.classList.add('show');
                }
            }
            
            toggleFeedbackModal() {
                const modal = document.getElementById('feedback-modal');
                if (modal.classList.contains('show')) {
                    modal.classList.remove('show');
                } else {
                    modal.classList.add('show');
                }
            }
            
            toggleChangelogModal() {
                const modal = document.getElementById('changelog-modal');
                if (modal.classList.contains('show')) {
                    modal.classList.remove('show');
                } else {
                    modal.classList.add('show');
                }
            }
            
            renderGoalsPanel() {
                const goalsList = document.getElementById('goals-list');
                const allGoalIds = this.getAllGoals();
                
                let html = '';
                
                allGoalIds.forEach(goalId => {
                    // 使用getGoalInfo获取正确的目标信息
                    const tempGame = { currentGoal: goalId, player: this.player };
                    const goal = this.getGoalInfo.call(tempGame);
                    
                    const status = this.getGoalStatus(goalId);
                    
                    let badgeText = '';
                    let badgeClass = '';
                    if (status === 'current') {
                        badgeText = '进行中';
                        badgeClass = 'current';
                    } else if (status === 'next') {
                        badgeText = '下一个';
                        badgeClass = 'next';
                    } else if (status === 'completed') {
                        badgeText = '已完成';
                        badgeClass = 'completed';
                    } else {
                        badgeText = '未解锁';
                        badgeClass = 'future';
                    }
                    
                    html += `<div class="goal-card ${status}">
                        <div class="goal-header">
                            <div class="goal-title">${goal.title}</div>
                            <div class="goal-badge ${badgeClass}">${badgeText}</div>
                        </div>`;
                    
                    // 根据目标类型显示不同内容
                    if (goal.type === 'tryout') {
                        // 选拔类目标：显示时间窗口和要求
                        html += `<div class="goal-description">${goal.timeWindow}可选拔</div>`;
                        
                        // 显示要求
                        if (goal.requirements) {
                            html += `<div class="goal-requirements">
                                <h4>📋 要求：</h4>`;
                            
                            // 显示技能数量要求
                            if (goal.requirements.anyTwo) {
                                html += `<div class="requirement-item">
                                    <span>🎯 任意2项技能</span>
                                    <span>≥ ${goal.requirements.anyTwo}</span>
                                </div>`;
                            } else if (goal.requirements.anyThree) {
                                html += `<div class="requirement-item">
                                    <span>🎯 任意3项技能</span>
                                    <span>≥ ${goal.requirements.anyThree}</span>
                                </div>`;
                            }
                            
                            // 显示技能总和要求
                            if (goal.requirements.totalSum) {
                                const currentSum = Object.values(this.player.skills).reduce((a, b) => a + b, 0);
                                const required = goal.requirements.totalSum;
                                const met = currentSum >= required;
                                const statusClass = met ? 'requirement-met' : 'requirement-not-met';
                                const statusIcon = met ? '✓' : '○';
                                
                                html += `<div class="requirement-item ${statusClass}">
                                    <span>${statusIcon} 技能总和</span>
                                    <span>${currentSum} / ${required}</span>
                                </div>`;
                            }
                            
                            // 显示声望要求
                            if (goal.requirements.reputation) {
                                const current = this.player.reputation;
                                const required = goal.requirements.reputation;
                                const met = current >= required;
                                const statusClass = met ? 'requirement-met' : 'requirement-not-met';
                                const statusIcon = met ? '✓' : '○';
                                
                                html += `<div class="requirement-item ${statusClass}">
                                    <span>${statusIcon} 声望</span>
                                    <span>${current} / ${required}</span>
                                </div>`;
                            }
                            
                            html += `</div>`;
                        }
                        
                        html += `<div class="goal-tips">💡 ${goal.tips}</div>`;
                        
                    } else if (goal.type === 'match') {
                        // 比赛类目标：显示比赛时间和准备建议
                        html += `<div class="goal-description">第${goal.triggerWeek}周自动开始</div>`;
                        html += `<div class="goal-requirements">
                            <h4>🎯 比赛目标：</h4>
                            <p style="margin: 5px 0; color: #333; font-size: 14px;">${goal.description}</p>
                        </div>`;
                        
                        if (goal.preparation && goal.preparation.length > 0) {
                            html += `<div class="goal-requirements">
                                <h4>💪 准备建议：</h4>`;
                            goal.preparation.forEach(tip => {
                                html += `<p style="margin: 5px 0; color: #333; font-size: 13px;">• ${tip}</p>`;
                            });
                            html += `</div>`;
                        }
                    }
                    
                    html += `</div>`;
                });
                
                goalsList.innerHTML = html;
            }
            
            renderLifeChoice() {
                const storyText = document.getElementById('story-text');
                const choicesDiv = document.getElementById('choices');
                
                storyText.innerHTML = `<h2>🌟 课余生活</h2>
                    <p>训练结束了，你想做些什么来放松一下？</p>
                    <p style="color: #f093fb; font-size: 16px; font-weight: bold; margin-top: 10px;">
                        ⚡ 当前体力：${this.player.energy} &nbsp;&nbsp;&nbsp; 💰 当前金钱：${this.player.money}
                    </p>`;
                
                // 定义分类
                const categories = {
                    sports: {
                        title: '🏐 运动娱乐',
                        color: '#ff6b6b',
                        choices: []
                    },
                    rest: {
                        title: '🎮 休闲娱乐',
                        color: '#4ecdc4',
                        choices: [
                            {
                                icon: '😴',
                                title: '早点休息',
                                effects: '体力+30 心情+10 压力-15',
                                next: 'checkRandomEvent',
                                effect: { energy: 30, mood: 10, stress: -15, eventType: 'life', lifeActivity: 'rest' }
                            },
                            {
                                icon: '💆',
                                title: '马杀鸡（按摩）',
                                effects: '体力+60 心情+25 压力-30 💰120',
                                next: 'checkRandomEvent',
                                requirement: { money: 120 },
                                effect: { energy: 60, mood: 25, stress: -30, money: -120, eventType: 'life', lifeActivity: 'massage' }
                            },
                            {
                                icon: '🎮',
                                title: '打游戏',
                                effects: '体力-3 心情+15 压力-10',
                                next: 'volleyballClickGame',
                                requirement: { energy: 3 },
                                effect: { lifeActivity: 'game' }
                            },
                            {
                                icon: '🎫',
                                title: '买刮刮乐',
                                effects: this.playerStats.permanentBuffs.scratchCardDiscount ? '💰20 试试手气！(VIP 7折)' : '💰30 试试手气！',
                                next: 'scratchCard',
                                requirement: { money: this.playerStats.permanentBuffs.scratchCardDiscount ? 20 : 30 },
                                effect: { special: 'scratchCard', lifeActivity: 'scratchCard' }
                            },
                            {
                                icon: '🍿',
                                title: '看小排球',
                                effects: '体力+10 心情+40 压力-15',
                                next: 'haikyuuEpisode',
                                requirement: { money: 50 },
                                effect: { energy: 10, mood: 40, stress: -15, eventType: 'life', lifeActivity: 'movie' }
                            },
                            {
                                icon: '📚',
                                title: '去图书馆',
                                effects: '体力+5 心情+8 压力-3 声望+3',
                                next: 'checkRandomEvent',
                                effect: { energy: 5, mood: 8, stress: -3, reputation: 10, eventType: 'life', lifeActivity: 'library' }
                            }
                        ]
                    },
                    social: {
                        title: '👥 社交活动',
                        color: '#95e1d3',
                        choices: [
                            // 队友互动已移至"我的队友"界面
                            // 队伍活动将动态添加
                        ]
                    },
                    food: {
                        title: '🍔 美食享受',
                        color: '#ffd93d',
                        choices: [
                            {
                                icon: '🍜',
                                title: '吃夜宵',
                                effects: '体力+8 心情+18 压力-8 💰20',
                                next: 'checkRandomEvent',
                                requirement: { money: 20 },
                                effect: { energy: 8, mood: 18, stress: -8, money: -20, eventType: 'life', lifeActivity: 'food' }
                            },
                            {
                                icon: '🍔',
                                title: '吃大餐',
                                effects: '体力+15 心情+28 压力-12 💰100',
                                next: 'checkRandomEvent',
                                requirement: { money: 100 },
                                effect: { energy: 15, mood: 28, stress: -12, money: -100, eventType: 'life', lifeActivity: 'food' }
                            }
                        ]
                    },
                    work: {
                        title: '💼 兼职赚钱',
                        color: '#6c5ce7',
                        choices: [
                            {
                                icon: '📦',
                                title: '轻松兼职',
                                effects: '💰+100 体力-10 压力+3',
                                next: 'checkRandomEvent',
                                requirement: { energy: 10 },
                                effect: { money: 120, energy: -10, stress: 3, mood: -1, eventType: 'life', lifeActivity: 'work' }
                            },
                            {
                                icon: '💼',
                                title: '高强度打工',
                                effects: '💰+250 体力-25 压力+12',
                                next: 'checkRandomEvent',
                                requirement: { energy: 25 },
                                effect: { money: 250, energy: -25, stress: 12, mood: -5, eventType: 'life', lifeActivity: 'work' }
                            }
                        ]
                    }
                };
                
                // 动态添加运动娱乐选项
                categories.sports.choices.push({
                    icon: '🏐',
                    title: '打野球',
                    effects: '25分制比赛 体力-20',
                    next: 'casualMatch',
                    requirement: { energy: 20 },
                    effect: { matchType: 'casual', energy: -20, lifeActivity: 'casualMatch' }
                });
                
                // 如果已加入院队或校队，添加友谊赛选项
                if (this.player.team === 'college' || this.player.team === 'university') {
                    categories.sports.choices.push({
                        icon: '🤝',
                        title: '打友谊赛',
                        effects: '25分制团队比赛 体力-20',
                        next: 'friendlyMatch',
                        requirement: { energy: 20 },
                        effect: { matchType: 'friendly', energy: -20, lifeActivity: 'friendlyMatch' }
                    });
                }
                
                // 始终添加队伍社交活动（没有队友时会置灰）
                const hasTeammates = this.teammates && this.teammates.length > 0;
                categories.social.choices.push({
                    icon: '🍕',
                    title: '队伍聚餐',
                    effects: hasTeammates ? '全队默契+1~2 心情+10 压力-5 💰80 体力-5' : '需要先加入院队或校队',
                    next: 'teamDinner',
                    requirement: hasTeammates ? { money: 80, energy: 5 } : { teammates: 1 },
                    effect: { special: 'teamDinner', lifeActivity: 'teamDinner' }
                });
                categories.social.choices.push({
                    icon: '🎉',
                    title: '团队建设活动',
                    effects: hasTeammates ? '全队默契+3~5 部分队友能力提升 心情+20 压力-15 声望+5 💰200 体力-15' : '需要先加入院队或校队',
                    next: 'teamBuilding',
                    requirement: hasTeammates ? { money: 200, energy: 15 } : { teammates: 1 },
                    effect: { special: 'teamBuilding', lifeActivity: 'teamBuilding' }
                });
                
                let html = '<div class="life-categories">';
                
                for (let catKey in categories) {
                    const category = categories[catKey];
                    html += `<div class="life-category ${catKey}">
                        <div class="category-title">${category.title}</div>
                        <div class="category-choices">`;
                    
                    category.choices.forEach(choice => {
                        const meetsRequirement = choice.requirement ? this.checkRequirement(choice.requirement) : true;
                        const disabledClass = meetsRequirement ? '' : 'disabled';
                        const disabledAttr = meetsRequirement ? '' : 'disabled';
                        
                        // 动态生成效果文本
                        const effectText = this.getEffectPreview(choice.effect);
                        
                        html += `<button class="life-choice-card ${disabledClass}" ${disabledAttr} 
                            onclick="game.handleLifeChoice('${choice.next}', ${JSON.stringify(choice.effect || {}).replace(/"/g, '&quot;')})">
                            <div class="life-choice-icon">${choice.icon}</div>
                            <div class="life-choice-title">${choice.title}</div>
                            <div class="life-choice-effects">${effectText || choice.effects}</div>
                            ${!meetsRequirement ? '<div style="color: #ffeb3b; font-size: 10px; margin-top: 3px;">条件不足</div>' : ''}
                        </button>`;
                    });
                    
                    html += `</div></div>`;
                }
                
                html += '</div>';
                
                choicesDiv.innerHTML = html;
            }
            
            handleLifeChoice(nextScene, effect) {
                if (effect && Object.keys(effect).length > 0) {
                    // 特殊处理：队伍聚餐
                    if (effect.special === 'teamDinner') {
                        this.handleTeamDinner();
                        return;
                    }
                    
                    // 特殊处理：团队建设活动
                    if (effect.special === 'teamBuilding') {
                        this.handleTeamBuilding();
                        return;
                    }
                    
                    // 特殊处理：刮刮乐
                    if (effect.special === 'scratchCard') {
                        // 计算实际价格（考虑VIP折扣）
                        const price = this.playerStats.permanentBuffs.scratchCardDiscount ? 20 : 30;
                        
                        // 检查金钱是否足够
                        if (this.player.money < price) {
                            alert(`金钱不足！需要${price}元购买刮刮乐。`);
                            return;
                        }
                        
                        // 确保modal处于干净状态
                        const modal = document.getElementById('event-modal');
                        if (modal) {
                            modal.style.display = '';
                            modal.classList.remove('show');
                        }
                        
                        // 扣除金钱
                        this.player.money -= price;
                        this.updateUI();
                        
                        // 执行刮刮乐抽奖（传入参数表示需要检查奇遇事件）
                        this.buyScratchCard(true);
                        
                        return;
                    }
                    
                    // 特殊处理：排球点击小游戏（不在这里应用effect，在游戏结束后应用）
                    if (nextScene === 'volleyballClickGame') {
                        // 检查体力是否足够
                        if (this.player.energy < 3) {
                            alert('体力不足！需要至少3点体力。');
                            return;
                        }
                        
                        // 追踪课余活动
                        if (effect.lifeActivity) {
                            this.trackLifeActivity(effect.lifeActivity);
                        }
                        
                        // 直接进入小游戏，不应用effect
                        this.currentScene = nextScene;
                        this.showScene(nextScene);
                        return;
                    }
                    
                    // 特殊处理：比赛（野球和友谊赛）- 比赛结束后再触发奇遇事件
                    if (nextScene === 'casualMatch' || nextScene === 'friendlyMatch') {
                        // 追踪课余活动
                        if (effect.lifeActivity) {
                            this.trackLifeActivity(effect.lifeActivity);
                        }
                        
                        // 直接进入比赛，不在这里触发奇遇事件
                        this.currentScene = nextScene;
                        this.showScene(nextScene);
                        return;
                    }
                    
                    this.applyEffect(effect);
                    
                    // 追踪课余活动（用于奇遇事件）
                    if (effect.lifeActivity) {
                        this.trackLifeActivity(effect.lifeActivity);
                    }
                    
                    // 检查是否需要触发随机事件
                    if (effect.eventType) {
                        const event = this.triggerRandomEvent(effect.eventType);
                        if (event) {
                            this.showRandomEvent(event);
                            return;
                        }
                    }
                    
                    // 检查是否触发奇遇事件
                    // 训练后检查训练类型事件，其他情况检查一般事件
                    const adventureType = (effect.eventType === 'training') ? 'training' : 'general';
                    const adventureTriggered = this.checkAdventureEvents(adventureType);
                    if (adventureTriggered) {
                        // 如果触发了奇遇事件，不再执行后续的showScene
                        return;
                    }
                }
                
                if (nextScene) {
                    this.currentScene = nextScene;
                    this.showScene(nextScene);
                }
            }
            
            // 商店系统方法
            renderShopMain() {
                const storyText = document.getElementById('story-text');
                const choicesDiv = document.getElementById('choices');
                
                storyText.innerHTML = `<h2>🛒 商店</h2>
                    <p>💰 当前金钱：<strong>${this.player.money}元</strong></p>`;
                
                let html = '';
                
                // 遍历所有分类，直接显示商品
                for (let catKey in this.shopItems) {
                    const category = this.shopItems[catKey];
                    
                    html += `<div class="shop-category-section">
                        <div class="shop-category-header">${category.icon} ${category.name}</div>
                        <div class="shop-items-compact">`;
                    
                    category.items.forEach(item => {
                        const canAfford = this.player.money >= item.price;
                        const owned = this.checkItemOwned(item);
                        
                        // 检查购买次数限制
                        let reachedLimit = false;
                        let purchaseInfo = '';
                        if (item.maxPurchases) {
                            const currentCount = this.player.purchaseCount[item.id] || 0;
                            reachedLimit = currentCount >= item.maxPurchases;
                            purchaseInfo = `(${currentCount}/${item.maxPurchases})`;
                        }
                        
                        const disabledClass = (!canAfford || owned || reachedLimit) ? 'disabled' : '';
                        
                        html += `<div class="shop-item-compact ${disabledClass}" onclick="game.buyItem('${catKey}', '${item.id}')">
                            <div class="item-compact-name">${item.name}</div>
                            <div class="item-compact-desc">${item.description} ${purchaseInfo}</div>
                            <div class="item-compact-price">💰${item.price}</div>
                            ${owned ? '<div class="item-compact-badge owned">✓</div>' : ''}
                            ${reachedLimit ? '<div class="item-compact-badge locked">🚫</div>' : ''}
                            ${!canAfford && !owned && !reachedLimit ? '<div class="item-compact-badge locked">🔒</div>' : ''}
                        </div>`;
                    });
                    
                    html += `</div></div>`;
                }
                
                html += '<div class="choices"><button class="choice-btn" onclick="game.showScene(\'weeklyHub\')">🔙 返回</button></div>';
                
                choicesDiv.innerHTML = html;
            }
            
            renderShopCategory(categoryKey) {
                const storyText = document.getElementById('story-text');
                const choicesDiv = document.getElementById('choices');
                const category = this.shopItems[categoryKey];
                
                console.log('=== renderShopCategory Debug ===');
                console.log('categoryKey:', categoryKey);
                console.log('purchaseCount:', this.player.purchaseCount);
                
                if (!category) {
                    alert('商品分类不存在');
                    this.showScene('shopMain');
                    return;
                }
                
                storyText.innerHTML = `<h2>${category.icon} ${category.name}</h2>
                    <p>💰 当前金钱：<strong>${this.player.money}元</strong></p>`;
                
                let html = '<div class="shop-items-grid">';
                
                category.items.forEach(item => {
                    const canAfford = this.player.money >= item.price;
                    const owned = this.checkItemOwned(item);
                    
                    // 检查购买次数限制
                    let reachedLimit = false;
                    let purchaseInfo = '';
                    if (item.maxPurchases) {
                        const currentCount = this.player.purchaseCount[item.id] || 0;
                        reachedLimit = currentCount >= item.maxPurchases;
                        purchaseInfo = `<div class="item-purchase-count" style="font-size: 12px; color: ${reachedLimit ? '#e74c3c' : '#3b82f6'}; margin: 8px 0;">已购买：${currentCount}/${item.maxPurchases}</div>`;
                        console.log(`Item ${item.id}: currentCount=${currentCount}, maxPurchases=${item.maxPurchases}, reachedLimit=${reachedLimit}`);
                    }
                    
                    const disabledClass = (!canAfford || owned || reachedLimit) ? 'disabled' : '';
                    
                    html += `<div class="shop-item-card ${disabledClass}">
                        <div class="item-name">${item.name}</div>
                        <div class="item-description">${item.description}</div>
                        ${purchaseInfo}
                        <div class="item-price">💰 ${item.price}元</div>
                        ${owned ? '<div class="item-owned">✓ 已拥有</div>' : ''}
                        ${reachedLimit ? '<div class="item-locked">🚫 已达购买上限</div>' : ''}
                        ${!canAfford && !owned && !reachedLimit ? '<div class="item-locked">💰 金钱不足</div>' : ''}
                        <button onclick="game.buyItem('${categoryKey}', '${item.id}')" ${!canAfford || owned || reachedLimit ? 'disabled' : ''}>
                            购买
                        </button>
                    </div>`;
                });
                
                html += '</div>';
                html += '<div class="choices">';
                html += '<button class="choice-btn" onclick="game.showScene(\'shopMain\')">🔙 返回商店</button>';
                html += '<button class="choice-btn" onclick="game.showScene(\'weeklyHub\')">🏠 返回周选择</button>';
                html += '</div>';
                
                choicesDiv.innerHTML = html;
            }
            
            checkItemOwned(item) {
                if (item.type !== 'permanent') return false;
                
                // 检查各类永久物品是否已拥有
                if (item.id === 'pro_shoes') return this.player.ownedItems.shoes === 'pro';
                if (item.id === 'protection') return this.player.ownedItems.protection;
                if (item.id === 'jersey') return this.player.ownedItems.jersey;
                if (item.id === 'training_ball') return this.player.ownedItems.trainingEquipment.includes('ball');
                if (item.id === 'sports_watch') return this.player.ownedItems.electronics.includes('watch');
                if (item.id === 'new_phone') return this.player.ownedItems.electronics.includes('phone');
                if (item.id === 'health_supplement') return this.player.ownedItems.electronics.includes('supplement');
                
                return false;
            }
            
            buyItem(categoryKey, itemId) {
                const category = this.shopItems[categoryKey];
                const item = category.items.find(i => i.id === itemId);
                
                console.log('=== buyItem Debug ===');
                console.log('categoryKey:', categoryKey);
                console.log('itemId:', itemId);
                console.log('item:', item);
                console.log('Before purchase - purchaseCount:', this.player.purchaseCount);
                
                if (!item) {
                    alert('商品不存在');
                    return;
                }
                
                if (this.player.money < item.price) {
                    alert('金钱不足！');
                    return;
                }
                
                if (this.checkItemOwned(item)) {
                    alert('你已经拥有这个物品了！');
                    return;
                }
                
                // 检查购买次数限制
                if (item.maxPurchases) {
                    const currentCount = this.player.purchaseCount[item.id] || 0;
                    console.log(`Purchase limit check: currentCount=${currentCount}, maxPurchases=${item.maxPurchases}`);
                    if (currentCount >= item.maxPurchases) {
                        alert(`${item.name}已达到购买上限（${item.maxPurchases}次）！`);
                        return;
                    }
                }
                
                // 扣除金钱
                this.player.money -= item.price;
                
                // 更新购买次数
                if (item.maxPurchases) {
                    if (!this.player.purchaseCount) this.player.purchaseCount = {};
                    this.player.purchaseCount[item.id] = (this.player.purchaseCount[item.id] || 0) + 1;
                    console.log(`After purchase - purchaseCount[${item.id}]:`, this.player.purchaseCount[item.id]);
                }
                
                // 统计消费
                this.playerStats.totalMoneySpent += item.price;
                
                // 根据类别统计
                if (categoryKey === 'training') {
                    this.playerStats.coachingPurchased++;
                } else if (categoryKey === 'equipment') {
                    this.playerStats.equipmentPurchased++;
                } else if (categoryKey === 'daily') {
                    this.playerStats.entertainmentSpent += item.price;
                }
                
                // 处理特殊效果
                let resultMessage = `购买成功！\n\n${item.name}\n\n`;
                
                // 护膝护腕特殊提示
                if (item.id === 'protection') {
                    resultMessage = `购买成功！\n\n你装备上了专业的护膝护腕套装。\n柔软的护垫紧贴关节，提供了可靠的保护。\n现在你可以更放心地进行高强度训练了！\n\n✓ 受伤概率降低70%`;
                }
                
                // 处理随机技能书
                else if (item.effect && item.effect.randomSkill) {
                    const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                    const randomSkill = skills[Math.floor(Math.random() * skills.length)];
                    this.player.skills[randomSkill] = Math.min(100, this.player.skills[randomSkill] + item.effect.randomSkill);
                    resultMessage += `你的${this.getSkillName(randomSkill)}提升了${item.effect.randomSkill}点！`;
                } else {
                    // 应用普通效果
                    if (item.effect) {
                        // 处理即时效果
                        if (item.effect.serve) this.player.skills.serve = Math.min(100, this.player.skills.serve + item.effect.serve);
                        if (item.effect.spike) this.player.skills.spike = Math.min(100, this.player.skills.spike + item.effect.spike);
                        if (item.effect.block) this.player.skills.block = Math.min(100, this.player.skills.block + item.effect.block);
                        if (item.effect.dig) this.player.skills.dig = Math.min(100, this.player.skills.dig + item.effect.dig);
                        if (item.effect.set) this.player.skills.set = Math.min(100, this.player.skills.set + item.effect.set);
                        if (item.effect.energy) this.player.energy = Math.max(0, Math.min(this.player.maxEnergy, this.player.energy + item.effect.energy));
                        if (item.effect.mood) this.player.mood = Math.max(0, Math.min(100, this.player.mood + item.effect.mood));
                        if (item.effect.stress) this.player.stress = Math.max(0, Math.min(100, this.player.stress + item.effect.stress));
                        if (item.effect.reputation) this.player.reputation += item.effect.reputation;
                        
                        // 新的默契度系统
                        if (item.effect.teamChemistry && this.teammates && this.teammates.length > 0) {
                            for (let teammate of this.teammates) {
                                teammate.chemistry = Math.max(0, Math.min(100, teammate.chemistry + item.effect.teamChemistry));
                            }
                            this.updateTeamStats();
                            // 检查是否解锁新技能
                            if (this.checkAndUnlockSkills) {
                                this.checkAndUnlockSkills();
                            }
                        }
                        
                        if (item.effect.teammateChemistry && this.teammates && this.teammates.length > 0) {
                            if (item.effect.teammateChemistry.random !== undefined) {
                                const randomTeammate = this.teammates[Math.floor(Math.random() * this.teammates.length)];
                                randomTeammate.chemistry = Math.max(0, Math.min(100, randomTeammate.chemistry + item.effect.teammateChemistry.random));
                                this.updateTeamStats();
                                // 检查是否解锁新技能
                                if (this.checkAndUnlockSkills) {
                                    this.checkAndUnlockSkills();
                                }
                            }
                        }
                        
                        // 向后兼容：旧的 relationship 自动转换为 teamChemistry
                        if (item.effect.relationship && this.teammates && this.teammates.length > 0) {
                            for (let teammate of this.teammates) {
                                teammate.chemistry = Math.max(0, Math.min(100, teammate.chemistry + item.effect.relationship));
                            }
                            this.updateTeamStats();
                        }
                    }
                    resultMessage += item.description;
                }
                
                // 处理永久物品
                if (item.type === 'permanent') {
                    if (!this.player.ownedItems) {
                        this.player.ownedItems = { shoes: 'none', protection: null, jersey: false, trainingEquipment: [], electronics: [] };
                    }
                    
                    if (item.id === 'pro_shoes') this.player.ownedItems.shoes = 'pro';
                    if (item.id === 'protection') this.player.ownedItems.protection = item.effect;
                    if (item.id === 'jersey') this.player.ownedItems.jersey = true;
                    if (item.id === 'training_ball') {
                        if (!this.player.ownedItems.trainingEquipment) this.player.ownedItems.trainingEquipment = [];
                        this.player.ownedItems.trainingEquipment.push('ball');
                    }
                    if (item.id === 'sports_watch') {
                        if (!this.player.ownedItems.electronics) this.player.ownedItems.electronics = [];
                        this.player.ownedItems.electronics.push('watch');
                    }
                    if (item.id === 'new_phone') {
                        if (!this.player.ownedItems.electronics) this.player.ownedItems.electronics = [];
                        this.player.ownedItems.electronics.push('phone');
                    }
                    if (item.id === 'health_supplement') {
                        if (!this.player.ownedItems.electronics) this.player.ownedItems.electronics = [];
                        this.player.ownedItems.electronics.push('supplement');
                    }
                }
                
                // 处理buff类物品
                if (item.type === 'buff') {
                    if (!this.player.activeBuffs) this.player.activeBuffs = [];
                    this.player.activeBuffs.push({
                        id: item.id,
                        name: item.name,
                        effect: item.effect,
                        remainingWeeks: item.duration || 1
                    });
                    
                    // 营养餐计划：立即增加体力上限
                    if (item.id === 'nutrition_plan' && item.effect.maxEnergyBonus) {
                        this.player.maxEnergy += item.effect.maxEnergyBonus;
                    }
                }
                
                alert(resultMessage);
                this.updateUI();
                // 刷新商店主界面，显示更新后的购买次数
                this.showScene('shopMain');
            }
            
            getSkillName(skill) {
                const names = { serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球' };
                return names[skill] || skill;
            }
            
            // ====================================================
            // 奇遇事件系统方法
            // ====================================================
            
            // 追踪课余活动
            trackLifeActivity(activityType) {
                if (!this.playerStats.lifeActivities) {
                    this.playerStats.lifeActivities = {};
                }
                
                // 更新活动计数
                this.playerStats.lifeActivities[activityType] = 
                    (this.playerStats.lifeActivities[activityType] || 0) + 1;
                
                // 更新旧的统计（保持兼容性）
                if (activityType === 'game') this.playerStats.gamesPlayed++;
                if (activityType === 'movie') this.playerStats.moviesWatched++;
                if (activityType === 'social') this.playerStats.socialEvents++;
                if (activityType === 'rest') this.playerStats.restTaken++;
                // 新增：队伍活动也算作社交活动
                if (activityType === 'teamDinner' || activityType === 'teamBuilding') {
                    this.playerStats.socialEvents = (this.playerStats.socialEvents || 0) + 1;
                }
            }
            
            // 检查是否触发奇遇事件
            checkAdventureEvents(type = 'general') {
                const eligibleEvents = this.adventureEvents.filter(event => {
                    // 检查是否已触发过（一次性事件）
                    if (event.once && this.playerStats.triggeredEvents.includes(event.id)) {
                        return false;
                    }
                    
                    // 如果是一般检查，排除刮刮乐相关事件
                    if (type === 'general' && ['lucky_customer', 'mysterious_elder'].includes(event.id)) {
                        return false;
                    }
                    
                    // 队友事件只在训练后触发
                    if (event.condition && event.condition.trainingOnly) {
                        if (type !== 'training') {
                            return false;
                        }
                    }
                    
                    // 检查触发条件
                    if (!this.checkEventCondition(event.condition)) {
                        return false;
                    }
                    
                    // 检查概率
                    if (Math.random() > event.probability) {
                        return false;
                    }
                    
                    return true;
                });
                
                // 如果有符合条件的事件，随机选择一个触发
                if (eligibleEvents.length > 0) {
                    const event = eligibleEvents[Math.floor(Math.random() * eligibleEvents.length)];
                    this.triggerAdventureEvent(event);
                    return true;  // 返回true表示触发了事件
                }
                
                return false;  // 返回false表示没有触发事件
            }
            
            // 检查特定类型的奇遇事件（用于刮刮乐等特殊场景）
            checkSpecificAdventureEvent(activityType) {
                let eventIds = [];
                
                // 根据活动类型确定要检查的事件
                if (activityType === 'scratchCard') {
                    eventIds = ['lucky_customer', 'mysterious_elder'];
                }
                
                const eligibleEvents = this.adventureEvents.filter(event => {
                    // 只检查指定的事件
                    if (!eventIds.includes(event.id)) {
                        return false;
                    }
                    
                    // 检查是否已触发过（一次性事件）
                    if (event.once && this.playerStats.triggeredEvents.includes(event.id)) {
                        return false;
                    }
                    
                    // 检查触发条件
                    if (!this.checkEventCondition(event.condition)) {
                        return false;
                    }
                    
                    // 检查概率
                    if (Math.random() > event.probability) {
                        return false;
                    }
                    
                    return true;
                });
                
                // 如果有符合条件的事件，随机选择一个触发
                if (eligibleEvents.length > 0) {
                    const event = eligibleEvents[Math.floor(Math.random() * eligibleEvents.length)];
                    this.triggerAdventureEvent(event);
                    return true;
                }
                
                return false;
            }
            
            // 检查事件触发条件
            checkEventCondition(condition) {
                // 检查活动次数
                if (condition.activities) {
                    for (let activity in condition.activities) {
                        const required = condition.activities[activity];
                        const current = this.playerStats.lifeActivities[activity] || 0;
                        if (current < required) {
                            return false;
                        }
                    }
                }
                
                // 检查技能条件
                if (condition.skills) {
                    for (let skill in condition.skills) {
                        const required = condition.skills[skill];
                        const current = this.player.skills[skill] || 0;
                        if (current < required) {
                            return false;
                        }
                    }
                }
                
                // 检查最后训练的技能类型
                if (condition.lastTraining) {
                    if (this.lastTrainingSkill !== condition.lastTraining) {
                        return false;
                    }
                }
                
                // 检查属性
                if (condition.mood && this.player.mood < condition.mood) return false;
                if (condition.reputation && this.player.reputation < condition.reputation) return false;
                
                // relationship 改为检查队伍平均默契
                if (condition.relationship) {
                    const avgChemistry = this.teamStats ? this.teamStats.averageChemistry : 0;
                    if (avgChemistry < condition.relationship) return false;
                }
                
                if (condition.maxEnergy && this.player.maxEnergy < condition.maxEnergy) return false;
                
                // 检查技能总和
                if (condition.totalSkills) {
                    const total = Object.values(this.player.skills).reduce((a, b) => a + b, 0);
                    if (total < condition.totalSkills) return false;
                }
                
                // 检查刮刮乐中奖次数
                if (condition.scratchCardJackpots && 
                    this.playerStats.scratchCardJackpots < condition.scratchCardJackpots) {
                    return false;
                }
                
                // 检查恋爱状态
                if (condition.hasLoveInterest && !this.playerStats.hasLoveInterest) {
                    return false;
                }
                
                // 检查多样化活动（至少N种活动各做过3次）
                if (condition.diverseActivities) {
                    const diverseCount = Object.values(this.playerStats.lifeActivities)
                        .filter(count => count >= 3).length;
                    if (diverseCount < condition.diverseActivities) {
                        return false;
                    }
                }
                
                // 检查最大休息次数（用于疲惫期事件）
                if (condition.maxRest) {
                    const restCount = this.playerStats.lifeActivities.rest || 0;
                    if (restCount > condition.maxRest) {
                        return false;
                    }
                }
                
                // 检查本周训练次数
                if (condition.weeklyTraining && this.player.trainingCount < condition.weeklyTraining) {
                    return false;
                }
                
                // 检查本周约会次数
                if (condition.weeklyDate !== undefined && 
                    this.playerStats.weeklyDateCount !== condition.weeklyDate) {
                    return false;
                }
                
                // 检查平均体力
                if (condition.avgEnergy) {
                    // 简化：直接用当前体力作为平均值
                    if (this.player.energy < condition.avgEnergy) {
                        return false;
                    }
                }
                
                // ====== 队友相关条件检查 ======
                
                // 检查是否有队友
                if (condition.hasTeammates) {
                    if (!this.teammates || this.teammates.length === 0) {
                        return false;
                    }
                }
                
                // 检查周数范围
                if (condition.week) {
                    if (condition.week.min && this.player.week < condition.week.min) return false;
                    if (condition.week.max && this.player.week > condition.week.max) return false;
                }
                
                // 检查玩家技能条件
                if (condition.playerSkill) {
                    for (let skill in condition.playerSkill) {
                        const req = condition.playerSkill[skill];
                        const playerValue = this.player.skills[skill] || 0;
                        if (req.min && playerValue < req.min) return false;
                        if (req.max && playerValue > req.max) return false;
                    }
                }
                
                // 检查玩家体力条件
                if (condition.playerEnergy) {
                    if (condition.playerEnergy.min && this.player.energy < condition.playerEnergy.min) return false;
                    if (condition.playerEnergy.max && this.player.energy > condition.playerEnergy.max) return false;
                }
                
                // 检查队友条件（需要找到符合条件的队友）
                if (condition.teammateCondition) {
                    const eligibleTeammate = this.findEligibleTeammate(condition.teammateCondition);
                    if (!eligibleTeammate) {
                        return false;
                    }
                }
                
                return true;
            }
            
            // 查找符合条件的队友
            findEligibleTeammate(teammateCondition) {
                if (!this.teammates || this.teammates.length === 0) {
                    return null;
                }
                
                const eligible = this.teammates.filter(teammate => {
                    // 检查位置关系
                    if (teammateCondition.position) {
                        if (teammateCondition.position === 'same') {
                            if (teammate.position !== this.player.position) return false;
                        } else if (teammateCondition.position === 'different') {
                            if (teammate.position === this.player.position) return false;
                        } else if (teammateCondition.position === 'libero') {
                            if (teammate.position !== 'libero') return false;
                        } else if (teammateCondition.position === 'middleBlocker') {
                            if (teammate.position !== 'middleBlocker') return false;
                        }
                    }
                    
                    // 检查位置配对（二传+攻手）
                    if (teammateCondition.positionPair) {
                        const playerPos = this.player.position;
                        const teammatePos = teammate.position;
                        const validPairs = teammateCondition.positionPair;
                        
                        // 检查是否是有效的配对
                        const isValidPair = (
                            (playerPos === 'setter' && validPairs.includes(teammatePos)) ||
                            (teammatePos === 'setter' && validPairs.includes(playerPos))
                        );
                        
                        if (!isValidPair) return false;
                    }
                    
                    // 检查默契范围
                    if (teammateCondition.chemistry) {
                        if (teammateCondition.chemistry.min && teammate.chemistry < teammateCondition.chemistry.min) return false;
                        if (teammateCondition.chemistry.max && teammate.chemistry > teammateCondition.chemistry.max) return false;
                    }
                    
                    // 检查性格
                    if (teammateCondition.personality) {
                        if (!teammateCondition.personality.includes(teammate.personality)) return false;
                    }
                    
                    // 检查技能差距
                    if (teammateCondition.skillDiff) {
                        const skill = teammateCondition.skillDiff.skill;
                        const playerSkill = this.player.skills[skill] || 0;
                        const teammateSkill = teammate.skills[skill] || 0;
                        
                        if (teammateCondition.skillDiff.playerHigher) {
                            // 玩家技能必须高于队友
                            if (playerSkill - teammateSkill < teammateCondition.skillDiff.playerHigher) return false;
                        } else if (teammateCondition.skillDiff.diff !== undefined) {
                            // 技能差距在指定范围内
                            if (Math.abs(playerSkill - teammateSkill) > teammateCondition.skillDiff.diff) return false;
                        }
                    }
                    
                    return true;
                });
                
                // 随机返回一个符合条件的队友
                if (eligible.length > 0) {
                    return eligible[Math.floor(Math.random() * eligible.length)];
                }
                
                return null;
            }
            
            // 触发奇遇事件
            triggerAdventureEvent(event) {
                // 如果是队友事件，找到符合条件的队友并保存
                if (event.condition && event.condition.teammateCondition) {
                    const teammate = this.findEligibleTeammate(event.condition.teammateCondition);
                    if (!teammate) {
                        console.log('未找到符合条件的队友');
                        return;
                    }
                    // 保存当前事件的队友信息
                    this.currentEventTeammate = teammate;
                }
                
                // 标记为已触发（一次性事件）
                if (event.once) {
                    this.playerStats.triggeredEvents.push(event.id);
                }
                
                // 显示事件内容
                this.showAdventureEvent(event);
            }
            
            // 显示奇遇事件
            showAdventureEvent(event) {
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                if (!modal || !title || !text || !choicesDiv) {
                    console.error('Event modal elements not found');
                    return;
                }
                
                const content = event.content;
                
                // 替换队友相关的占位符
                let titleText = content.title;
                let contentText = content.text;
                
                if (this.currentEventTeammate) {
                    const teammate = this.currentEventTeammate;
                    const posInfo = this.positions[teammate.position];
                    
                    // 替换队友名字
                    titleText = titleText.replace(/{teammate}/g, teammate.name);
                    contentText = contentText.replace(/{teammate}/g, teammate.name);
                    
                    // 替换技能名（根据位置确定核心技能）
                    if (posInfo && posInfo.coreSkills && posInfo.coreSkills.length > 0) {
                        const skillNames = {
                            serve: '发球',
                            spike: '扣球',
                            block: '拦网',
                            dig: '垫球',
                            set: '托球'
                        };
                        const coreSkillName = skillNames[posInfo.coreSkills[0]] || '技能';
                        contentText = contentText.replace(/{skill}/g, coreSkillName);
                    }
                }
                
                // 设置标题和文本
                title.innerHTML = titleText;
                text.innerHTML = `<p style="white-space: pre-line; line-height: 1.6;">${contentText}</p>`;
                
                // 清空并重建选择按钮
                choicesDiv.innerHTML = '';
                
                content.choices.forEach((choice, index) => {
                    const meetsRequirement = choice.requirement ? 
                        this.checkRequirement(choice.requirement) : true;
                    
                    const button = document.createElement('button');
                    button.className = meetsRequirement ? 'choice-btn' : 'choice-btn disabled';
                    button.disabled = !meetsRequirement;
                    
                    let buttonText = choice.text;
                    if (!meetsRequirement) {
                        buttonText += '\n(条件不足)';
                    }
                    button.textContent = buttonText;
                    
                    button.onclick = () => {
                        this.handleAdventureChoice(index, event.id);
                    };
                    
                    choicesDiv.appendChild(button);
                });
                
                // 显示modal
                modal.style.display = '';
                modal.classList.add('show');
            }
            
            // 处理奇遇事件选择
            handleAdventureChoice(choiceIndex, eventId) {
                const event = this.adventureEvents.find(e => e.id === eventId);
                if (!event) return;
                
                const choice = event.content.choices[choiceIndex];
                const effect = choice.effect;
                
                // 保存当前事件ID（用于applyAdventureEffect中查找事件信息）
                this.currentEventId = eventId;
                
                // 关闭模态框
                const modal = document.getElementById('event-modal');
                if (modal) {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                }
                
                // 应用效果
                this.applyAdventureEffect(effect);
                
                // 如果有结果文本，显示结果
                if (choice.result) {
                    setTimeout(() => {
                        this.showAdventureResult(choice, event);
                    }, 300);  // 增加延迟到300ms，确保modal完全关闭后再打开
                } else {
                    // 更新UI
                    this.updateUI();
                    
                    // 继续游戏流程
                    if (this.currentScene === 'lifeChoice') {
                        this.showScene('weeklyHub');
                    }
                }
            }
            
            // 显示奇遇事件结果
            showAdventureResult(choice, event) {
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                title.textContent = '✨ 结果';
                
                // 获取结果文本
                let resultText = '';
                if (typeof choice.result === 'object' && choice.result.success && choice.result.fail) {
                    // 有成功/失败两种结果
                    resultText = this.lastEventSuccess ? choice.result.success : choice.result.fail;
                } else {
                    resultText = choice.result;
                }
                
                // 替换队友占位符
                if (this.currentEventTeammate) {
                    resultText = resultText.replace(/{teammate}/g, this.currentEventTeammate.name);
                }
                
                // 构建属性变化显示
                let changesText = '<br><br><strong>属性变化：</strong><br>';
                let hasChanges = false;
                
                const effect = choice.effect;
                
                // 处理成功/失败的效果值
                const getEffectValue = (value) => {
                    if (typeof value === 'object' && value.success !== undefined && value.fail !== undefined) {
                        return this.lastEventSuccess ? value.success : value.fail;
                    }
                    return value;
                };
                
                // 技能变化
                if (effect.serve) {
                    const val = getEffectValue(effect.serve);
                    if (val !== 0) {
                        changesText += `🎯 发球 ${val > 0 ? '+' : ''}${val}<br>`;
                        hasChanges = true;
                    }
                }
                if (effect.spike) {
                    const val = getEffectValue(effect.spike);
                    if (val !== 0) {
                        changesText += `⚡ 扣球 ${val > 0 ? '+' : ''}${val}<br>`;
                        hasChanges = true;
                    }
                }
                if (effect.block) {
                    const val = getEffectValue(effect.block);
                    if (val !== 0) {
                        changesText += `🛡️ 拦网 ${val > 0 ? '+' : ''}${val}<br>`;
                        hasChanges = true;
                    }
                }
                if (effect.dig) {
                    const val = getEffectValue(effect.dig);
                    if (val !== 0) {
                        changesText += `🤸 垫球 ${val > 0 ? '+' : ''}${val}<br>`;
                        hasChanges = true;
                    }
                }
                if (effect.set) {
                    const val = getEffectValue(effect.set);
                    if (val !== 0) {
                        changesText += `🙌 托球 ${val > 0 ? '+' : ''}${val}<br>`;
                        hasChanges = true;
                    }
                }
                
                // 基础属性
                if (effect.energy) {
                    const val = getEffectValue(effect.energy);
                    if (val !== 0) {
                        changesText += `💪 体力 ${val > 0 ? '+' : ''}${val}<br>`;
                        hasChanges = true;
                    }
                }
                if (effect.mood) {
                    const val = getEffectValue(effect.mood);
                    if (val !== 0) {
                        changesText += `😊 心情 ${val > 0 ? '+' : ''}${val}<br>`;
                        hasChanges = true;
                    }
                }
                if (effect.stress) {
                    const val = getEffectValue(effect.stress);
                    if (val !== 0) {
                        changesText += `😰 压力 ${val > 0 ? '+' : ''}${val}<br>`;
                        hasChanges = true;
                    }
                }
                if (effect.reputation) {
                    const val = getEffectValue(effect.reputation);
                    if (val !== 0) {
                        changesText += `⭐ 声望 ${val > 0 ? '+' : ''}${val}<br>`;
                        hasChanges = true;
                    }
                }
                if (effect.money) {
                    const val = getEffectValue(effect.money);
                    if (val !== 0) {
                        changesText += `💰 金钱 ${val > 0 ? '+' : ''}${val}<br>`;
                        hasChanges = true;
                    }
                }
                
                // 队友相关
                if (effect.teammateChemistry) {
                    if (typeof effect.teammateChemistry === 'number') {
                        const val = getEffectValue(effect.teammateChemistry);
                        if (val !== 0 && this.currentEventTeammate) {
                            changesText += `💫 与${this.currentEventTeammate.name}的默契 ${val > 0 ? '+' : ''}${val}<br>`;
                            hasChanges = true;
                        }
                    } else if (effect.teammateChemistry.random) {
                        changesText += `💫 随机队友默契 +${effect.teammateChemistry.random}<br>`;
                        hasChanges = true;
                    }
                }
                
                if (effect.teamChemistry) {
                    changesText += `🤝 全队默契 +${effect.teamChemistry}<br>`;
                    hasChanges = true;
                }
                
                // 队友技能提升
                if (this.currentEventTeammate) {
                    if (effect.teammateServe) {
                        changesText += `🎯 ${this.currentEventTeammate.name}的发球 +${effect.teammateServe}<br>`;
                        hasChanges = true;
                    }
                    if (effect.teammateSpike) {
                        changesText += `⚡ ${this.currentEventTeammate.name}的扣球 +${effect.teammateSpike}<br>`;
                        hasChanges = true;
                    }
                    if (effect.teammateBlock) {
                        changesText += `🛡️ ${this.currentEventTeammate.name}的拦网 +${effect.teammateBlock}<br>`;
                        hasChanges = true;
                    }
                    if (effect.teammateDig) {
                        changesText += `🤸 ${this.currentEventTeammate.name}的垫球 +${effect.teammateDig}<br>`;
                        hasChanges = true;
                    }
                    if (effect.teammateSet) {
                        changesText += `🙌 ${this.currentEventTeammate.name}的托球 +${effect.teammateSet}<br>`;
                        hasChanges = true;
                    }
                    if (effect.teammateTargetSkill) {
                        changesText += `✨ ${this.currentEventTeammate.name}的目标技能 +${effect.teammateTargetSkill}<br>`;
                        hasChanges = true;
                    }
                    if (effect.teammateSkill) {
                        changesText += `✨ ${this.currentEventTeammate.name}的随机技能 +${effect.teammateSkill}<br>`;
                        hasChanges = true;
                    }
                }
                
                // 特殊效果
                if (effect.coreSkill) {
                    changesText += `⭐ 核心技能 +${effect.coreSkill}<br>`;
                    hasChanges = true;
                }
                if (effect.randomSkill) {
                    changesText += `🎲 随机技能 +${effect.randomSkill}<br>`;
                    hasChanges = true;
                }
                if (effect.targetSkill) {
                    changesText += `🎯 目标技能 +${effect.targetSkill}<br>`;
                    hasChanges = true;
                }
                if (effect.skillProgress) {
                    changesText += `📈 技能进度 +${effect.skillProgress}<br>`;
                    hasChanges = true;
                }
                
                // 组合显示文本
                let fullText = `<p style="white-space: pre-line; line-height: 1.6;">${resultText}</p>`;
                if (hasChanges) {
                    fullText += changesText;
                }
                
                text.innerHTML = fullText;
                
                choicesDiv.innerHTML = '';
                const continueBtn = document.createElement('button');
                continueBtn.className = 'choice-btn';
                continueBtn.textContent = '继续';
                continueBtn.onclick = () => {
                    modal.classList.remove('show');
                    
                    // 清除队友事件相关的临时数据
                    this.currentEventTeammate = null;
                    this.currentEventId = null;
                    this.lastEventSuccess = null;
                    
                    // 更新UI
                    this.updateUI();
                    
                    // 继续游戏流程
                    if (this.currentScene === 'lifeChoice') {
                        this.showScene('weeklyHub');
                    }
                };
                choicesDiv.appendChild(continueBtn);
                
                // 重置display样式并显示modal
                modal.style.display = '';
                modal.classList.add('show');
            }
            
            // 应用奇遇事件效果
            applyAdventureEffect(effect) {
                // ====== 队友事件特殊处理 ======
                if (this.currentEventTeammate) {
                    const teammate = this.currentEventTeammate;
                    
                    // 处理成功率判定
                    if (effect.successRate !== undefined) {
                        const success = Math.random() < effect.successRate;
                        
                        // 根据成功/失败应用不同的效果
                        for (let key in effect) {
                            if (key === 'successRate' || key === 'result') continue;
                            
                            const value = effect[key];
                            if (typeof value === 'object' && value.success !== undefined && value.fail !== undefined) {
                                // 有成功/失败两种值
                                const actualValue = success ? value.success : value.fail;
                                if (actualValue !== 0) {
                                    if (key === 'teammateChemistry') {
                                        teammate.chemistry = Math.min(100, teammate.chemistry + actualValue);
                                    } else if (['serve', 'spike', 'block', 'dig', 'set'].includes(key)) {
                                        this.player.skills[key] = (this.player.skills[key] || 0) + actualValue;
                                    } else if (key === 'energy') {
                                        this.player.energy += actualValue;
                                    } else if (key === 'mood') {
                                        this.player.mood = Math.min(100, (this.player.mood || 50) + actualValue);
                                    } else if (key === 'stress') {
                                        this.player.stress = Math.max(0, (this.player.stress || 0) + actualValue);
                                    }
                                }
                            }
                        }
                        
                        // 保存成功/失败状态用于显示结果
                        this.lastEventSuccess = success;
                    } else {
                        // 没有成功率判定，直接应用效果
                        
                        // 队友默契
                        if (effect.teammateChemistry !== undefined && typeof effect.teammateChemistry === 'number') {
                            teammate.chemistry = Math.min(100, Math.max(0, teammate.chemistry + effect.teammateChemistry));
                        }
                        
                        // 队友技能提升
                        if (effect.teammateServe) teammate.skills.serve = Math.min(100, teammate.skills.serve + effect.teammateServe);
                        if (effect.teammateSpike) teammate.skills.spike = Math.min(100, teammate.skills.spike + effect.teammateSpike);
                        if (effect.teammateBlock) teammate.skills.block = Math.min(100, teammate.skills.block + effect.teammateBlock);
                        if (effect.teammateDig) teammate.skills.dig = Math.min(100, teammate.skills.dig + effect.teammateDig);
                        if (effect.teammateSet) teammate.skills.set = Math.min(100, teammate.skills.set + effect.teammateSet);
                        
                        // 队友目标技能提升（根据skillDiff条件确定的技能）
                        if (effect.teammateTargetSkill) {
                            const event = this.adventureEvents.find(e => e.id === this.currentEventId);
                            if (event && event.condition && event.condition.teammateCondition && event.condition.teammateCondition.skillDiff) {
                                const targetSkill = event.condition.teammateCondition.skillDiff.skill;
                                if (targetSkill) {
                                    teammate.skills[targetSkill] = Math.min(100, teammate.skills[targetSkill] + effect.teammateTargetSkill);
                                }
                            }
                        }
                        
                        // 队友随机技能提升
                        if (effect.teammateSkill) {
                            const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                            const randomSkill = skills[Math.floor(Math.random() * skills.length)];
                            teammate.skills[randomSkill] = Math.min(100, teammate.skills[randomSkill] + effect.teammateSkill);
                        }
                        
                        // 更新队友平均能力
                        teammate.averageSkill = Math.round(
                            (teammate.skills.serve + teammate.skills.spike + teammate.skills.block + 
                             teammate.skills.dig + teammate.skills.set) / 5
                        );
                    }
                    
                    // 核心技能提升
                    if (effect.coreSkill) {
                        const posInfo = this.positions[this.player.position];
                        if (posInfo && posInfo.coreSkills && posInfo.coreSkills.length > 0) {
                            const coreSkill = posInfo.coreSkills[Math.floor(Math.random() * posInfo.coreSkills.length)];
                            this.player.skills[coreSkill] = (this.player.skills[coreSkill] || 0) + effect.coreSkill;
                        }
                    }
                    
                    // 目标技能提升（玩家的）
                    if (effect.targetSkill) {
                        const event = this.adventureEvents.find(e => e.id === this.currentEventId);
                        if (event && event.condition && event.condition.teammateCondition && event.condition.teammateCondition.skillDiff) {
                            const targetSkill = event.condition.teammateCondition.skillDiff.skill;
                            if (targetSkill) {
                                this.player.skills[targetSkill] = (this.player.skills[targetSkill] || 0) + effect.targetSkill;
                            }
                        }
                    }
                    
                    // 配合技能进度
                    if (effect.skillProgress) {
                        // 这里可以添加技能解锁进度的逻辑
                        // 暂时简化为增加默契
                        teammate.chemistry = Math.min(100, teammate.chemistry + Math.floor(effect.skillProgress / 5));
                    }
                    
                    // 更新队伍统计
                    this.updateTeamStats();
                    
                    // 检查并解锁技能
                    if (this.checkAndUnlockSkills) {
                        this.checkAndUnlockSkills();
                    }
                }
                
                // ====== 基础属性变化 ======
                // 基础属性变化
                if (effect.money) this.player.money += effect.money;
                if (effect.mood) this.player.mood += effect.mood;
                if (effect.stress) this.player.stress += effect.stress;
                if (effect.energy) this.player.energy += effect.energy;
                if (effect.reputation) this.player.reputation += effect.reputation;
                
                // 新的默契度系统
                // 1. 全队默契
                if (effect.teamChemistry && this.teammates && this.teammates.length > 0) {
                    for (let teammate of this.teammates) {
                        teammate.chemistry = Math.max(0, Math.min(100, teammate.chemistry + effect.teamChemistry));
                    }
                    this.updateTeamStats();
                    // 检查是否解锁新技能
                    if (this.checkAndUnlockSkills) {
                        this.checkAndUnlockSkills();
                    }
                }
                
                // 2. 指定队友默契
                if (effect.teammateChemistry && this.teammates && this.teammates.length > 0) {
                    if (effect.teammateChemistry.random !== undefined) {
                        // 随机一个队友
                        const randomTeammate = this.teammates[Math.floor(Math.random() * this.teammates.length)];
                        randomTeammate.chemistry = Math.max(0, Math.min(100, randomTeammate.chemistry + effect.teammateChemistry.random));
                        this.updateTeamStats();
                        // 检查是否解锁新技能
                        if (this.checkAndUnlockSkills) {
                            this.checkAndUnlockSkills();
                        }
                        
                        // 显示提示（可选）
                        console.log(`和${randomTeammate.name}的默契提升了 +${effect.teammateChemistry.random}`);
                    } else if (effect.teammateChemistry.index !== undefined) {
                        // 指定索引的队友
                        const teammate = this.teammates[effect.teammateChemistry.index];
                        if (teammate) {
                            teammate.chemistry = Math.max(0, Math.min(100, teammate.chemistry + effect.teammateChemistry.value));
                            this.updateTeamStats();
                            console.log(`和${teammate.name}的默契提升了 +${effect.teammateChemistry.value}`);
                        }
                    }
                }
                
                // 向后兼容：旧的 relationship 自动转换为 teamChemistry
                if (effect.relationship && this.teammates && this.teammates.length > 0) {
                    for (let teammate of this.teammates) {
                        teammate.chemistry = Math.max(0, Math.min(100, teammate.chemistry + effect.relationship));
                    }
                    this.updateTeamStats();
                }
                
                if (effect.maxEnergy) this.player.maxEnergy += effect.maxEnergy;
                
                // 技能变化
                const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                skills.forEach(skill => {
                    if (effect[skill]) {
                        this.player.skills[skill] += effect[skill];
                    }
                });
                
                // 随机技能提升
                if (effect.randomSkill) {
                    const randomSkill = skills[Math.floor(Math.random() * skills.length)];
                    this.player.skills[randomSkill] += effect.randomSkill;
                }
                
                // 永久buff
                if (effect.buff) {
                    this.applyPermanentBuff(effect.buff);
                }
                
                // 称号
                if (effect.title) {
                    if (!this.playerStats.titles.includes(effect.title)) {
                        this.playerStats.titles.push(effect.title);
                    }
                }
                
                // 特殊效果
                if (effect.special) {
                    this.handleSpecialAdventureEffect(effect.special);
                }
            }
            
            // 应用永久buff
            applyPermanentBuff(buffType) {
                switch (buffType) {
                    case 'scratchCardDiscount':
                        this.playerStats.permanentBuffs.scratchCardDiscount = true;
                        break;
                    case 'movieMembership':
                        this.playerStats.permanentBuffs.movieMembership = true;
                        break;
                    case 'foodDiscount':
                        this.playerStats.permanentBuffs.foodDiscount = true;
                        break;
                    case 'workBonus':
                        this.playerStats.permanentBuffs.workBonus = true;
                        break;
                    case 'teamBonus':
                        this.playerStats.permanentBuffs.trainingBonus += 5;
                        break;
                    case 'captainBonus':
                        this.playerStats.permanentBuffs.trainingBonus += 10;
                        break;
                    case 'stressReduction':
                        this.playerStats.permanentBuffs.stressReduction += 10;
                        break;
                    case 'selfTherapy':
                        this.playerStats.permanentBuffs.energyRecovery += 5;
                        this.playerStats.permanentBuffs.injuryReduction += 20;
                        break;
                    case 'perfectRoutine':
                        this.playerStats.permanentBuffs.energyRecovery += 10;
                        this.playerStats.permanentBuffs.trainingBonus += 5;
                        break;
                    case 'nutritionPlan':
                        this.playerStats.permanentBuffs.energyRecovery += 5;
                        break;
                    case 'campusStar':
                        this.playerStats.permanentBuffs.reputationGrowth += 3;
                        break;
                    case 'mentor':
                        this.playerStats.permanentBuffs.moodRecovery += 5;
                        break;
                    case 'focusBonus':
                        this.playerStats.permanentBuffs.trainingBonus += 10;
                        break;
                    case 'dedicationBonus':
                        this.playerStats.permanentBuffs.trainingBonus += 15;
                        break;
                }
            }
            
            // 处理特殊奇遇效果
            handleSpecialAdventureEffect(specialType) {
                switch (specialType) {
                    case 'freeScratchCard':
                        // 免费刮刮乐，提高中奖概率
                        const result = this.scratchCardDraw(true);
                        // 延迟显示结果，确保modal已经关闭
                        setTimeout(() => {
                            this.showScratchCardResult(result);
                        }, 300);
                        break;
                    case 'startLove':
                        this.playerStats.hasLoveInterest = true;
                        break;
                    case 'mysteryGift':
                        // 随机获得装备或金钱
                        if (Math.random() < 0.5) {
                            this.player.money += 200;
                        } else {
                            // 随机技能+3
                            const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                            const randomSkill = skills[Math.floor(Math.random() * skills.length)];
                            this.player.skills[randomSkill] += 3;
                        }
                        break;
                    case 'gameFriend':
                        // 解锁游戏好友，每次打游戏额外心情+5
                        this.playerStats.permanentBuffs.gameFriend = true;
                        break;
                    case 'esportsTournament':
                        // 参加电竞比赛
                        this.player.energy -= 15;
                        const totalSkills = Object.values(this.player.skills).reduce((a, b) => a + b, 0);
                        const rand = Math.random();
                        if (rand < 0.3) {
                            // 冠军
                            this.player.money += 1000;
                            this.player.reputation += 15;
                            alert('🏆 恭喜！你获得了电竞比赛冠军！\n💰 金钱+1000\n⭐ 声望+15');
                        } else if (rand < 0.7) {
                            // 亚军
                            this.player.money += 500;
                            this.player.reputation += 8;
                            alert('🥈 你获得了电竞比赛亚军！\n💰 金钱+500\n⭐ 声望+8');
                        } else {
                            // 季军
                            this.player.money += 200;
                            this.player.reputation += 3;
                            alert('🥉 你获得了电竞比赛季军！\n💰 金钱+200\n⭐ 声望+3');
                        }
                        break;
                    case 'seniorNotes':
                        // 获得学姐笔记，可重复使用3次
                        this.playerStats.seniorNotesUses = 3;
                        break;
                    case 'sportsStoreJob':
                        // 解锁体育店兼职
                        this.playerStats.permanentBuffs.sportsStoreJob = true;
                        break;
                    case 'luckyWeek':
                        // 本周训练效果+20%
                        this.playerStats.luckyWeekBonus = 0.2;
                        break;
                    case 'restBuff':
                        // 获得休息buff
                        this.playerStats.restBuffWeeks = 2;
                        break;
                    case 'burnoutPenalty':
                        // 下周体力上限-10
                        this.playerStats.burnoutPenalty = true;
                        break;
                    case 'planDate':
                        // 计划约会
                        this.playerStats.plannedDate = true;
                        break;
                    case 'breakup':
                        // 分手
                        this.playerStats.hasLoveInterest = false;
                        break;
                }
            }
            
            // 职业系统方法
            renderPositionSelection() {
                const storyText = document.getElementById('story-text');
                const choicesDiv = document.getElementById('choices');
                
                storyText.innerHTML = `<h2>🏐 选择你的场上位置</h2>
                    <p>教练："你已经掌握了基本技能，现在需要选择一个专精的位置。"</p>
                    <p>"每个位置都有不同的职责和要求，选择适合你的位置吧！"</p>`;
                
                // 计算所有职业的匹配度并排序
                const positionsWithMatch = Object.keys(this.positions).map(posKey => {
                    const pos = this.positions[posKey];
                    const matchScore = this.calculatePositionMatch(pos);
                    const meetsRequirement = this.checkPositionRequirement(pos);
                    return { key: posKey, pos, matchScore, meetsRequirement };
                }).sort((a, b) => b.matchScore - a.matchScore);
                
                let html = '<div class="position-cards">';
                
                for (let item of positionsWithMatch) {
                    const { key: posKey, pos, matchScore, meetsRequirement } = item;
                    const disabledClass = meetsRequirement ? '' : 'disabled';
                    const recommendedClass = matchScore >= 80 && meetsRequirement ? 'recommended' : '';
                    
                    // 获取核心技能要求
                    const reqText = Object.entries(pos.baseRequirements)
                        .map(([skill, value]) => {
                            const skillNames = { serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球' };
                            const currentValue = this.player.skills[skill];
                            const met = currentValue >= value;
                            const gap = met ? 0 : value - currentValue;
                            return `${skillNames[skill]} ${currentValue}/${value} ${met ? '✓' : `✗(还差${gap})`}`;
                        }).join(' ');
                    
                    html += `<div class="position-card ${disabledClass} ${recommendedClass}" onclick="game.selectPosition('${pos.id}', ${meetsRequirement})">
                        <div class="position-icon">${pos.icon}</div>
                        <div class="position-name">${pos.name}</div>
                        ${recommendedClass ? '<div class="position-recommended">⭐ 推荐</div>' : ''}
                        <div class="position-match">匹配度：${matchScore}%</div>
                        <div class="position-desc">${pos.description}</div>
                        <div class="position-skills">
                            <strong>核心技能：</strong>${pos.coreSkills.map(s => {
                                const names = { serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球' };
                                return names[s];
                            }).join('、')}
                        </div>
                        <div class="position-requirements">${reqText}</div>
                        ${pos.restrictions ? `<div class="position-restrictions">限制：${pos.restrictions.join('、')}</div>` : ''}
                        ${!meetsRequirement ? '<div class="position-locked">🔒 条件不足</div>' : ''}
                    </div>`;
                }
                
                html += '</div>';
                
                // 添加"暂不选择"选项
                html += `<div class="choices">
                    <button class="choice-button" onclick="game.skipPositionSelection()">
                        ⏭️ 暂不选择，继续训练
                    </button>
                </div>`;
                
                choicesDiv.innerHTML = html;
            }
            
            calculatePositionMatch(position) {
                let score = 0;
                let maxScore = 0;
                
                for (let [skill, required] of Object.entries(position.baseRequirements)) {
                    maxScore += required;
                    score += Math.min(this.player.skills[skill], required);
                }
                
                return maxScore > 0 ? Math.round(score / maxScore * 100) : 0;
            }
            
            skipPositionSelection() {
                // 如果有待处理的锦标赛，不允许跳过
                if (this.pendingTournamentType) {
                    alert('参加校际联赛必须先选择位置！\n\n请选择一个适合你的位置。');
                    return;
                }
                
                alert('你决定暂时不选择位置，继续提升技能。\n\n你可以随时回到这里选择位置！');
                this.currentScene = 'weeklyHub';
                this.showScene('weeklyHub');
                this.updateUI();
            }
            
            checkPositionRequirement(position) {
                const req = position.baseRequirements;
                for (let skill in req) {
                    if (this.player.skills[skill] < req[skill]) {
                        return false;
                    }
                }
                return true;
            }
            
            selectPosition(positionId, meetsRequirement) {
                if (!meetsRequirement) {
                    alert('你的技能还不满足这个位置的要求！');
                    return;
                }
                
                const position = this.positions[positionId];
                this.player.position = positionId;
                this.player.positionLevel = 1;
                
                // 如果是首次选择位置且已加入队伍，生成队友
                if (this.teammates.length === 0 && (this.player.team === 'college' || this.player.team === 'university')) {
                    this.generateTeammates(this.player.team, positionId);
                    
                    // 如果是院队，显示欢迎弹窗
                    if (this.player.team === 'college') {
                        this.showCollegeTeamWelcomeNotification();
                        return; // 弹窗关闭后会继续流程
                    }
                }
                
                alert(`你选择了 ${position.icon} ${position.name}！\n\n${position.description}\n\n核心技能训练将获得额外加成！`);
                
                // 检查是否有待处理的锦标赛
                if (this.pendingTournamentType) {
                    const tournamentType = this.pendingTournamentType;
                    this.pendingTournamentType = null; // 清除待处理标记
                    
                    // 显示提示后开始锦标赛
                    setTimeout(() => {
                        alert('位置选择完成！现在可以开始锦标赛了。');
                        this.startTournament(tournamentType);
                    }, 100);
                    return;
                }
                
                // 不修改目标，保持之前设置的目标
                this.currentScene = 'weeklyHub';
                this.showScene('weeklyHub');
                this.updateUI();
            }
            
            getPositionInfo() {
                if (this.player.position === 'none') {
                    return null;
                }
                return this.positions[this.player.position];
            }
            
            getTrainingBonus(skill) {
                let totalBonus = 0;
                
                // 职业加成
                const posInfo = this.getPositionInfo();
                if (posInfo) {
                    // 适应期惩罚
                    if (this.player.adaptationWeeks > 0) {
                        totalBonus += -0.2;
                    } else {
                        if (posInfo.coreSkills.includes(skill)) {
                            totalBonus += posInfo.trainingBonus.core;
                        } else if (posInfo.secondarySkills.includes(skill)) {
                            totalBonus += posInfo.trainingBonus.secondary;
                        } else {
                            totalBonus += posInfo.trainingBonus.other;
                        }
                    }
                }
                
                // 装备加成
                if (this.player.ownedItems) {
                    // 专业球鞋 +20%
                    if (this.player.ownedItems.shoes === 'pro') {
                        totalBonus += 0.20;
                    }
                    // 专业球衣 +10%
                    if (this.player.ownedItems.jersey) {
                        totalBonus += 0.10;
                    }
                    // 专业训练球 +25%
                    if (this.player.ownedItems.trainingEquipment && this.player.ownedItems.trainingEquipment.includes('ball')) {
                        totalBonus += 0.25;
                    }
                }
                
                return totalBonus;
            }
            
            // 计算并格式化效果预览（包含装备加成）
            getEffectPreview(effect) {
                if (!effect) return '';
                
                const parts = [];
                const skillIcons = {
                    serve: '🎯',
                    spike: '⚡',
                    block: '🛡️',
                    dig: '🤸',
                    set: '🙌'
                };
                
                // 技能效果（包含职业加成）
                ['serve', 'spike', 'block', 'dig', 'set'].forEach(skill => {
                    if (effect[skill]) {
                        const bonus = this.getTrainingBonus(skill);
                        const baseValue = effect[skill];
                        const finalValue = Math.round(baseValue * (1 + bonus));
                        
                        if (bonus !== 0 && effect.trained) {
                            // 有加成时显示详细信息
                            const bonusText = bonus > 0 ? `+${Math.round(bonus * 100)}%` : `${Math.round(bonus * 100)}%`;
                            parts.push(`${skillIcons[skill]}${this.getSkillName(skill)}+${finalValue}(基础${baseValue}${bonusText})`);
                        } else {
                            parts.push(`${skillIcons[skill]}${this.getSkillName(skill)}${baseValue > 0 ? '+' : ''}${baseValue}`);
                        }
                    }
                });
                
                // 其他效果（训练时不显示体力消耗，因为已在分类标题中显示）
                if (!effect.trained && effect.energy) parts.push(`💪体力${effect.energy > 0 ? '+' : ''}${effect.energy}`);
                if (effect.mood) parts.push(`😊心情${effect.mood > 0 ? '+' : ''}${effect.mood}`);
                if (effect.stress) parts.push(`😰压力${effect.stress > 0 ? '+' : ''}${effect.stress}`);
                if (effect.reputation) parts.push(`⭐声望${effect.reputation > 0 ? '+' : ''}${effect.reputation}`);
                if (effect.money) parts.push(`💰${effect.money > 0 ? '+' : ''}${effect.money}元`);
                
                return parts.length > 0 ? `（${parts.join('，')}）` : '';
            }
            
            getSkillName(skill) {
                const names = {
                    serve: '发球',
                    spike: '扣球',
                    block: '拦网',
                    dig: '垫球',
                    set: '托球'
                };
                return names[skill] || skill;
            }
            
            getMatchWeight(skill) {
                const posInfo = this.getPositionInfo();
                if (!posInfo) {
                    // 没有职业时平均权重
                    return 20;
                }
                return posInfo.matchWeights[skill] || 0;
            }
            
            getPositionDescription(skill, success) {
                const posInfo = this.getPositionInfo();
                if (!posInfo || !posInfo.specialDescriptions[skill]) {
                    return null;
                }
                
                const descriptions = posInfo.specialDescriptions[skill];
                return descriptions[Math.floor(Math.random() * descriptions.length)];
            }
            
            // 新增：计算玩家综合实力（用于比赛胜率）
            calculateMyStrength(includeTeammates = false) {
                const skills = this.player.skills;
                const posInfo = this.getPositionInfo();
                
                // 基础技能值（加权平均）
                let baseStrength = 0;
                let skillWeights = {};
                
                if (posInfo && posInfo.matchWeights) {
                    // 使用职业的matchWeights
                    const totalWeight = Object.values(posInfo.matchWeights).reduce((sum, w) => sum + w, 0);
                    for (let skill in posInfo.matchWeights) {
                        skillWeights[skill] = posInfo.matchWeights[skill] / totalWeight;
                    }
                } else {
                    // 没有职业时使用默认权重
                    skillWeights = {
                        serve: 0.20,   // 发球 20%
                        spike: 0.25,   // 扣球 25%
                        block: 0.20,   // 拦网 20%
                        dig: 0.20,     // 垫球 20%
                        set: 0.15      // 托球 15%
                    };
                }
                
                for (let skill in skillWeights) {
                    baseStrength += skills[skill] * skillWeights[skill];
                }
                
                // 职业加成（核心技能权重提升）
                let positionBonus = 1.0;
                if (posInfo) {
                    let weightedSkills = 0;
                    let totalWeight = 0;
                    
                    for (let skill in skillWeights) {
                        let weight = skillWeights[skill];
                        
                        // 核心技能权重 × 1.5
                        if (posInfo.coreSkills.includes(skill)) {
                            weight *= 1.5;
                        }
                        // 次要技能权重 × 1.2
                        else if (posInfo.secondarySkills.includes(skill)) {
                            weight *= 1.2;
                        }
                        
                        weightedSkills += skills[skill] * weight;
                        totalWeight += weight;
                    }
                    
                    positionBonus = weightedSkills / totalWeight / baseStrength;
                }
                
                // 状态加成
                let stateBonus = 1.0;
                
                // 心情影响 (-20% ~ +20%)
                const moodEffect = (this.player.mood - 50) / 250;
                stateBonus += moodEffect;
                
                // 压力影响 (-15% ~ 0%)
                const stressEffect = -this.player.stress / 667;
                stateBonus += stressEffect;
                
                // 确保状态加成在合理范围
                stateBonus = Math.max(0.7, Math.min(1.3, stateBonus));
                
                let finalStrength = baseStrength * positionBonus * stateBonus;
                
                // 自由人惩罚系数：因为只需要练2个技能，所以实力打折
                if (posInfo && posInfo.id === 'libero') {
                    finalStrength *= 0.8;  // 自由人实力 × 0.8
                }
                
                // 如果需要包含队友（正式比赛）
                if (includeTeammates && this.teammates.length > 0) {
                    const teammateStrength = this.calculateTeammateStrength();
                    // 玩家占60%，队友占40%
                    finalStrength = finalStrength * 0.6 + teammateStrength * 0.4;
                }
                
                return finalStrength;
            }
            
            // 计算队友平均实力
            calculateTeammateStrength() {
                if (this.teammates.length === 0) {
                    return 0;
                }
                
                let totalStrength = 0;
                
                for (let teammate of this.teammates) {
                    const posInfo = this.positions[teammate.position];
                    let baseStrength = 0;
                    
                    // 使用职业权重计算队友实力
                    if (posInfo && posInfo.matchWeights) {
                        const totalWeight = Object.values(posInfo.matchWeights).reduce((sum, w) => sum + w, 0);
                        for (let skill in posInfo.matchWeights) {
                            const weight = posInfo.matchWeights[skill] / totalWeight;
                            baseStrength += teammate.skills[skill] * weight;
                        }
                    } else {
                        // 默认权重
                        baseStrength = (teammate.skills.serve * 0.2 + teammate.skills.spike * 0.25 + 
                                       teammate.skills.block * 0.2 + teammate.skills.dig * 0.2 + 
                                       teammate.skills.set * 0.15);
                    }
                    
                    // 自由人惩罚
                    if (posInfo && posInfo.id === 'libero') {
                        baseStrength *= 0.8;
                    }
                    
                    totalStrength += baseStrength;
                }
                
                // 队伍氛围加成
                const avgStrength = totalStrength / this.teammates.length;
                return avgStrength * this.teamStats.atmosphere;
            }
            
            // 新增：计算对手实力
            calculateOpponentStrength(matchType) {
                const myAvgSkill = (
                    this.player.skills.serve + 
                    this.player.skills.spike + 
                    this.player.skills.block + 
                    this.player.skills.dig + 
                    this.player.skills.set
                ) / 5;
                
                let baseOpponent = 0;
                let randomRange = 0;
                
                switch(matchType) {
                    case 'casual':
                        // 野球：对手实力接近玩家
                        baseOpponent = myAvgSkill;
                        randomRange = myAvgSkill * 0.15;
                        break;
                        
                    case 'collegeMatch':
                        // 院际比赛：固定难度32，适合综合实力35左右的玩家
                        // 玩家需要：个人技能平均约30 + 队友平均约45-50
                        baseOpponent = 32;
                        randomRange = 3;  // ±3的随机波动，让每次比赛略有不同
                        break;
                        
                    case 'tournament':
                        // 锦标赛：使用当前轮次的固定实力
                        if (this.tournament.active && this.tournament.currentRound) {
                            const roundInfo = this.TOURNAMENT_ROUNDS[this.tournament.currentRound];
                            baseOpponent = roundInfo.opponentStrength;
                            randomRange = 5;  // 小范围随机
                        } else {
                            baseOpponent = myAvgSkill;
                            randomRange = myAvgSkill * 0.1;
                        }
                        break;
                        
                    case 'universityLeague':
                        // 校际联赛：对手 = 玩家平均 × 1.0 ± 10%
                        baseOpponent = myAvgSkill * 1.0;
                        randomRange = myAvgSkill * 0.1;
                        break;
                        
                    case 'cityLeague':
                        // 市级联赛：对手 = 玩家平均 × 1.15 ± 10%
                        baseOpponent = myAvgSkill * 1.15;
                        randomRange = myAvgSkill * 0.1;
                        break;
                        
                    default:
                        baseOpponent = myAvgSkill;
                        randomRange = myAvgSkill * 0.15;
                }
                
                // 添加随机波动
                const opponent = baseOpponent + (Math.random() - 0.5) * 2 * randomRange;
                
                // 确保对手实力在合理范围（锦标赛不受上限限制）
                if (matchType === 'tournament') {
                    return Math.max(20, opponent);
                }
                return Math.max(20, Math.min(90, opponent));
            }
            
            // 新增：计算整场比赛胜率（不是单分胜率）
            calculateMatchWinRate(myStrength, opponentStrength) {
                // 计算实力差距
                const diff = myStrength - opponentStrength;
                
                // 使用sigmoid函数计算整场胜率（更平滑的曲线）
                // 除数50：实力差±10时，胜率在40%~60%区间
                let winRate = 1 / (1 + Math.pow(10, -diff / 50));
                
                // 添加随机波动 ±5%（减小波动范围）
                const randomFactor = 0.95 + Math.random() * 0.1;
                winRate = winRate * randomFactor;
                
                // 添加主场优势（正式比赛）
                if (this.currentMatch && this.currentMatch.type === 'formal') {
                    winRate += 0.05;  // +5% 主场优势
                }
                
                // 添加技能加成（正式比赛和友谊赛）
                if (this.currentMatch && (this.currentMatch.type === 'formal' || this.currentMatch.type === 'friendly')) {
                    const skillBonus = this.getTotalWinRateBonus();
                    winRate += skillBonus;
                    if (skillBonus > 0) {
                        console.log(`技能加成: +${(skillBonus * 100).toFixed(1)}%`);
                    }
                }
                
                // 确保胜率在合理范围 10% ~ 90%
                winRate = Math.max(0.1, Math.min(0.9, winRate));
                
                return winRate;
            }
            
            // 预生成比赛结果（包括最终比分和每一分的过程）
            pregenerateMatchResult(myStrength, opponentStrength) {
                // 1. 计算整场胜率并决定胜负
                const winRate = this.calculateMatchWinRate(myStrength, opponentStrength);
                const playerWins = Math.random() < winRate;
                
                // 2. 根据实力差和胜负生成合理的比分
                const diff = Math.abs(myStrength - opponentStrength);
                let finalPlayerScore, finalOpponentScore;
                
                if (playerWins) {
                    finalPlayerScore = 25;
                    if (diff > 30) {
                        // 碾压局：25 vs (10-18)
                        finalOpponentScore = 10 + Math.floor(Math.random() * 9);
                    } else if (diff > 15) {
                        // 优势局：25 vs (15-21)
                        finalOpponentScore = 15 + Math.floor(Math.random() * 7);
                    } else {
                        // 焦灼局：25 vs (20-23)
                        finalOpponentScore = 20 + Math.floor(Math.random() * 4);
                    }
                } else {
                    finalOpponentScore = 25;
                    if (diff > 30) {
                        finalPlayerScore = 10 + Math.floor(Math.random() * 9);
                    } else if (diff > 15) {
                        finalPlayerScore = 15 + Math.floor(Math.random() * 7);
                    } else {
                        finalPlayerScore = 20 + Math.floor(Math.random() * 4);
                    }
                }
                
                // 3. 生成每一分的得分过程
                const scoreLog = [];
                let currentPlayerScore = 0;
                let currentOpponentScore = 0;
                const totalPoints = finalPlayerScore + finalOpponentScore;
                
                // 创建得分序列（哪些分是玩家得的）
                const playerPoints = [];
                for (let i = 0; i < totalPoints; i++) {
                    playerPoints.push(i < finalPlayerScore);
                }
                
                // 打乱得分序列，但确保最后一分是赢家得的
                const lastScorer = playerWins;
                playerPoints.pop(); // 移除最后一个
                
                // Fisher-Yates 洗牌算法
                for (let i = playerPoints.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [playerPoints[i], playerPoints[j]] = [playerPoints[j], playerPoints[i]];
                }
                
                playerPoints.push(lastScorer); // 把最后一分加回去
                
                // 4. 为每一分生成描述
                const mySkills = this.currentMatch.mySkills;
                for (let i = 0; i < totalPoints; i++) {
                    const isPlayerPoint = playerPoints[i];
                    
                    if (isPlayerPoint) {
                        currentPlayerScore++;
                    } else {
                        currentOpponentScore++;
                    }
                    
                    // 生成得分描述
                    const point = this.generatePointDescription(mySkills, isPlayerPoint);
                    
                    scoreLog.push({
                        myScore: currentPlayerScore,
                        opponentScore: currentOpponentScore,
                        description: point.description,
                        scorer: isPlayerPoint ? 'my' : 'opponent',
                        skillTriggered: point.skillTriggered || false,
                        skillDef: point.skillDef,
                        skillLevel: point.skillLevel
                    });
                }
                
                return {
                    finalPlayerScore,
                    finalOpponentScore,
                    scoreLog,
                    playerWins
                };
            }
            
            // 生成单分描述
            generatePointDescription(mySkills, isPlayerPoint) {
                // 判断是否是友谊赛或正式比赛
                const isFriendlyMatch = this.currentMatch && this.currentMatch.type === 'friendly';
                const isFormalMatch = this.currentMatch && this.currentMatch.type === 'formal';
                const showTeammateNames = (isFriendlyMatch || isFormalMatch) && this.teammates && this.teammates.length > 0;
                
                // 检查是否触发技能
                let triggeredSkill = null;
                let skillTeammate = null;
                
                if (isPlayerPoint && showTeammateNames && this.player.unlockedSkills && this.player.unlockedSkills.length > 0) {
                    // 随机选择一个已解锁的技能尝试触发
                    const availableSkills = this.player.unlockedSkills.filter(skill => {
                        const teammate = this.teammates.find(t => t.id === skill.teammateId);
                        return teammate !== undefined;
                    });
                    
                    if (availableSkills.length > 0) {
                        const randomSkill = availableSkills[Math.floor(Math.random() * availableSkills.length)];
                        const skillDef = this.COMBO_SKILLS[randomSkill.skillKey];
                        
                        if (skillDef) {
                            const triggerRate = skillDef.effects.triggerRate[randomSkill.level - 1];
                            if (Math.random() < triggerRate) {
                                triggeredSkill = { def: skillDef, data: randomSkill };
                                skillTeammate = this.teammates.find(t => t.id === randomSkill.teammateId);
                                // 增加触发次数
                                randomSkill.triggerCount++;
                            }
                        }
                    }
                }
                
                // 如果触发了技能，使用技能描述
                if (triggeredSkill && skillTeammate) {
                    const skillDef = triggeredSkill.def;
                    const skillData = triggeredSkill.data;
                    const level = skillData.level;
                    
                    // 获取技能描述文本
                    let description = skillDef.scoreTexts[level - 1];
                    
                    // 智能替换占位符：根据玩家和队友的实际位置
                    const playerPos = this.player.position;
                    const teammatePos = skillTeammate.position;
                    
                    // 创建位置到名字的映射
                    const positionMap = {};
                    
                    // 根据实际位置填充映射
                    if (playerPos === 'setter') positionMap['{setter}'] = this.player.name;
                    else if (playerPos === 'middleBlocker') {
                        positionMap['{middle}'] = this.player.name;
                        positionMap['{middle1}'] = this.player.name;
                    } else if (playerPos === 'outsideHitter') positionMap['{outside}'] = this.player.name;
                    else if (playerPos === 'oppositeHitter') positionMap['{opposite}'] = this.player.name;
                    else if (playerPos === 'libero') {
                        positionMap['{libero}'] = this.player.name;
                        positionMap['{libero1}'] = this.player.name;
                    }
                    
                    if (teammatePos === 'setter') positionMap['{setter}'] = skillTeammate.name;
                    else if (teammatePos === 'middleBlocker') {
                        if (!positionMap['{middle}']) positionMap['{middle}'] = skillTeammate.name;
                        else positionMap['{middle2}'] = skillTeammate.name;
                    } else if (teammatePos === 'outsideHitter') positionMap['{outside}'] = skillTeammate.name;
                    else if (teammatePos === 'oppositeHitter') positionMap['{opposite}'] = skillTeammate.name;
                    else if (teammatePos === 'libero') {
                        if (!positionMap['{libero}']) positionMap['{libero}'] = skillTeammate.name;
                        else positionMap['{libero2}'] = skillTeammate.name;
                    }
                    
                    // 替换所有占位符
                    for (const [placeholder, name] of Object.entries(positionMap)) {
                        description = description.replace(new RegExp(placeholder.replace(/[{}]/g, '\\$&'), 'g'), name);
                    }
                    
                    return { 
                        description, 
                        type: 'skill',
                        skillTriggered: true,
                        skillDef: skillDef,
                        skillLevel: level
                    };
                }
                
                // 得分方式权重（基于职业和技能）
                const scoreTypes = [
                    { type: 'serve', weight: this.getMatchWeight('serve') * (mySkills.serve / 100), name: '发球' },
                    { type: 'spike', weight: this.getMatchWeight('spike') * (mySkills.spike / 100), name: '扣球' },
                    { type: 'block', weight: this.getMatchWeight('block') * (mySkills.block / 100), name: '拦网' },
                    { type: 'dig', weight: this.getMatchWeight('dig') * (mySkills.dig / 100), name: '垫球' },
                    { type: 'set', weight: this.getMatchWeight('set') * (mySkills.set / 100), name: '托球' }
                ];
                
                // 选择得分方式
                const totalWeight = scoreTypes.reduce((sum, st) => sum + st.weight, 0);
                let random = Math.random() * totalWeight;
                let selectedType = scoreTypes[0];
                
                for (let st of scoreTypes) {
                    random -= st.weight;
                    if (random <= 0) {
                        selectedType = st;
                        break;
                    }
                }
                
                // 生成描述
                let description = '';
                if (isPlayerPoint) {
                    const posDesc = this.getPositionDescription(selectedType.type, true);
                    if (posDesc) {
                        // 友谊赛或正式比赛：60%概率是队友得分，需要在特殊描述前加上队友名字
                        if (showTeammateNames && Math.random() < 0.6) {
                            const teammate = this.teammates[Math.floor(Math.random() * this.teammates.length)];
                            description = `${teammate.name}${posDesc}`;
                        } else {
                            description = posDesc;
                        }
                    } else {
                        // 友谊赛或正式比赛：随机选择队友或玩家得分
                        if (showTeammateNames && Math.random() < 0.6) {
                            // 60%概率是队友得分
                            const teammate = this.teammates[Math.floor(Math.random() * this.teammates.length)];
                            const descriptions = {
                                serve: [`${teammate.name}发出一记强力跳发球，对方接发失误！`, `${teammate.name}的精准发球直接得分！`, `${teammate.name}的发球落在对方空档，直接得分！`],
                                spike: [`${teammate.name}高高跃起，大力扣球得分！`, `${teammate.name}漂亮的扣球，对方防守失误！`, `${teammate.name}抓住机会，一记重扣拿下这分！`],
                                block: [`${teammate.name}成功拦网，直接得分！`, `${teammate.name}精准的拦网判断，球直接弹回对方场地！`, `${teammate.name}的拦网让对方的扣球无功而返！`],
                                dig: [`${teammate.name}成功垫起对方的扣球，队友反击得分！`, `${teammate.name}精彩的垫球，化解对方攻势并反击成功！`, `${teammate.name}的垫球到位，队友完成反击！`],
                                set: [`${teammate.name}的二传精准到位，队友扣球得分！`, `${teammate.name}完美的托球，助攻队友得分！`, `${teammate.name}的传球组织进攻，队友完成得分！`]
                            };
                            description = descriptions[selectedType.type][Math.floor(Math.random() * descriptions[selectedType.type].length)];
                        } else {
                            // 玩家得分
                            const descriptions = {
                                serve: ['你发出一记强力跳发球，对方接发失误！', '精准的发球直接得分，对方措手不及！', '你的发球落在对方空档，直接得分！'],
                                spike: ['你高高跃起，大力扣球得分！', '漂亮的扣球，对方防守失误！', '你抓住机会，一记重扣拿下这分！', '完美的扣球角度，对方无法防守！'],
                                block: ['你成功拦网，直接得分！', '精准的拦网判断，球直接弹回对方场地！', '你的拦网让对方的扣球无功而返！'],
                                dig: ['你成功垫起对方的扣球，队友反击得分！', '精彩的垫球，化解对方攻势并反击成功！', '你的垫球到位，队友完成反击！'],
                                set: ['你的二传精准到位，队友扣球得分！', '完美的托球，助攻队友得分！', '你的传球组织进攻，队友完成得分！']
                            };
                            description = descriptions[selectedType.type][Math.floor(Math.random() * descriptions[selectedType.type].length)];
                        }
                    }
                } else {
                    const descriptions = {
                        serve: ['你的发球出界了，对方得分。', '发球失误，对方拿下这分。', '发球下网，对方得分。'],
                        spike: ['你的扣球被对方防起，对方反击得分。', '扣球失误，对方得分。', '对方拦网成功，直接得分！'],
                        block: ['拦网判断失误，对方扣球得分。', '对方的扣球突破了你的拦网。', '拦网时机不对，对方得分。'],
                        dig: ['你的垫球失误，对方得分。', '对方的扣球太强，你没能防起来。', '垫球出界，对方得分。'],
                        set: ['传球失误，对方得分。', '你的传球被对方拦截。', '传球不到位，进攻失败，对方得分。']
                    };
                    description = descriptions[selectedType.type][Math.floor(Math.random() * descriptions[selectedType.type].length)];
                }
                
                return { description, type: selectedType.type };
            }
            
            // 比赛系统
            startMatch(matchType) {
                // 追踪活动
                if (matchType === 'casual') {
                    this.trackLifeActivity('casualMatch');
                } else if (matchType === 'friendly') {
                    this.trackLifeActivity('friendlyMatch');
                }
                
                // 初始化比赛数据
                this.currentMatch = {
                    type: matchType, // 'casual' 野球, 'friendly' 友谊赛, 'formal' 正式比赛
                    targetScore: 25,
                    myScore: 0,
                    opponentScore: 0,
                    scoreLog: [],
                    mySkills: {
                        serve: this.player.skills.serve,
                        spike: this.player.skills.spike,
                        block: this.player.skills.block,
                        dig: this.player.skills.dig,
                        set: this.player.skills.set
                    }
                };
                
                // 模拟比赛过程
                this.simulateMatch();
            }
            
            // 新增：正式比赛系统（五局三胜）
            startFormalMatch(matchType, matchName) {
                console.log('=== 开始正式比赛 ===');
                console.log('比赛类型:', matchType);
                console.log('比赛名称:', matchName);
                
                // 保存比赛前的状态（用于比赛中刷新时恢复）
                this.matchCheckpoint = {
                    matchType: matchType,
                    matchName: matchName,
                    week: this.player.week
                };
                
                // 标记比赛进行中
                this.inMatch = true;
                
                // 保存游戏（包含比赛检查点）
                this.saveGame();
                
                // 先显示对阵页面
                this.showMatchupScreen(matchType, matchName);
            }
            
            // 显示对阵页面
            showMatchupScreen(matchType, matchName) {
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                // 确定我方队伍名称
                let myTeamTitle = '';
                if (matchType === 'collegeMatch') {
                    myTeamTitle = '你的学院';
                } else if (matchType === 'universityLeague' || matchType === 'cityLeague') {
                    myTeamTitle = '你的学校';
                } else if (matchType === 'tournament') {
                    myTeamTitle = '你的学校';
                }
                
                // 生成我方队伍名单
                let myTeamHtml = '<div style="text-align: left;">';
                myTeamHtml += `<div style="font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #667eea;">${myTeamTitle}</div>`;
                myTeamHtml += `<div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #667eea;">👑 ${this.player.name}（你）</div>`;
                if (this.teammates && this.teammates.length > 0) {
                    this.teammates.forEach(teammate => {
                        myTeamHtml += `<div style="font-size: 14px; margin-bottom: 5px;">🏐 ${teammate.name}</div>`;
                    });
                }
                myTeamHtml += '</div>';
                
                // 生成对方队伍名单（随机生成）
                const opponentTeamName = this.getOpponentTeamName(matchType);
                let opponentTeamHtml = '<div style="text-align: right;">';
                opponentTeamHtml += `<div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #e74c3c;">${opponentTeamName}</div>`;
                for (let i = 0; i < 6; i++) {
                    opponentTeamHtml += `<div style="font-size: 14px; margin-bottom: 5px;">${generateRandomName()} 🏐</div>`;
                }
                opponentTeamHtml += '</div>';
                
                title.textContent = `🏐 ${matchName}`;
                text.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin: 10px 0;">对阵双方</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center;">
                        ${myTeamHtml}
                        <div style="font-size: 32px; font-weight: bold; color: #95a5a6;">VS</div>
                        ${opponentTeamHtml}
                    </div>
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px;">
                        <p style="font-size: 14px; color: #667eea; margin: 0;">五局三胜制 · 每局25分</p>
                    </div>
                `;
                
                choicesDiv.innerHTML = '';
                
                modal.classList.add('show');
                
                // 3秒后自动开始比赛
                setTimeout(() => {
                    modal.classList.remove('show');
                    this.startFormalMatchAfterMatchup(matchType, matchName);
                }, 3000);
            }
            
            // 获取对手队伍名称
            getOpponentTeamName(matchType) {
                const collegeNames = ['工学院', '理学院', '文学院', '商学院', '医学院', '法学院'];
                const universityNames = ['北方大学', '东方大学', '西方大学', '南方大学', '中央大学', '海洋大学'];
                const tournamentNames = ['强豪队', '劲旅队', '精英队', '王者队', '霸主队', '冠军队'];
                
                if (matchType === 'collegeMatch') {
                    return collegeNames[Math.floor(Math.random() * collegeNames.length)];
                } else if (matchType === 'universityLeague') {
                    return universityNames[Math.floor(Math.random() * universityNames.length)];
                } else if (matchType === 'tournament') {
                    return tournamentNames[Math.floor(Math.random() * tournamentNames.length)];
                }
                return '对手队伍';
            }
            
            // 对阵页面后开始正式比赛
            startFormalMatchAfterMatchup(matchType, matchName) {
                this.currentMatch = {
                    type: 'formal',
                    matchType: matchType,  // 'collegeMatch', 'universityLeague', 'cityLeague'
                    matchName: matchName,  // 比赛名称
                    
                    // 大局分
                    mySets: 0,
                    opponentSets: 0,
                    targetSets: 3,  // 五局三胜
                    
                    // 当前局
                    currentSet: 1,
                    myScore: 0,
                    opponentScore: 0,
                    targetScore: 25,
                    
                    // 每局详情
                    setResults: [],
                    
                    // 比赛日志
                    scoreLog: [],
                    
                    // 技能数据
                    mySkills: {
                        serve: this.player.skills.serve,
                        spike: this.player.skills.spike,
                        block: this.player.skills.block,
                        dig: this.player.skills.dig,
                        set: this.player.skills.set
                    },
                    
                    // 对手实力
                    opponentStrength: this.calculateOpponentStrength(matchType)
                };
                
                console.log('比赛数据初始化完成，开始模拟比赛...');
                
                // 模拟正式比赛
                this.simulateFormalMatch();
                
                // 显示比赛动画
                this.showFormalMatchAnimation();
            }
            
            // 新增：模拟正式比赛（五局三胜）
            simulateFormalMatch() {
                const match = this.currentMatch;
                
                console.log('开始正式比赛:', match.matchName);
                console.log('目标局数:', match.targetSets, '(需要赢', match.targetSets, '局)');
                
                // 模拟每一局
                while (match.mySets < match.targetSets && match.opponentSets < match.targetSets) {
                    console.log(`\n开始第${match.currentSet}局 (当前大局分: ${match.mySets}:${match.opponentSets})`);
                    
                    this.simulateSet();
                    
                    console.log(`第${match.currentSet}局结束: ${match.myScore}-${match.opponentScore}`);
                    
                    // 记录本局结果
                    match.setResults.push({
                        setNumber: match.currentSet,
                        myScore: match.myScore,
                        opponentScore: match.opponentScore,
                        winner: match.myScore > match.opponentScore ? 'my' : 'opponent'
                    });
                    
                    // 更新大局分
                    if (match.myScore > match.opponentScore) {
                        match.mySets++;
                        console.log('我方赢得本局！大局分:', match.mySets, ':', match.opponentSets);
                    } else {
                        match.opponentSets++;
                        console.log('对方赢得本局！大局分:', match.mySets, ':', match.opponentSets);
                    }
                    
                    // 准备下一局
                    match.currentSet++;
                    match.myScore = 0;
                    match.opponentScore = 0;
                    
                    // 决胜局改为15分制
                    if (match.currentSet === 5) {
                        match.targetScore = 15;
                    } else {
                        match.targetScore = 25;
                    }
                }
                
                console.log('\n比赛结束！最终大局分:', match.mySets, ':', match.opponentSets);
                console.log('共进行了', match.setResults.length, '局');
                
                // 不再立即显示结果，等待动画完成
            }
            
            // 新增：模拟单局比赛
            simulateSet() {
                const match = this.currentMatch;
                
                // 模拟本局每一分
                while (true) {
                    const point = this.simulatePoint(match.mySkills, match.opponentStrength);
                    
                    if (point.scorer === 'my') {
                        match.myScore++;
                    } else {
                        match.opponentScore++;
                    }
                    
                    match.scoreLog.push({
                        set: match.currentSet,
                        myScore: match.myScore,
                        opponentScore: match.opponentScore,
                        description: point.description,
                        scorer: point.scorer,
                        skillTriggered: point.skillTriggered || false,
                        skillDef: point.skillDef,
                        skillLevel: point.skillLevel
                    });
                    
                    // 检查是否有一方达到目标分数
                    if (match.myScore >= match.targetScore || match.opponentScore >= match.targetScore) {
                        // 如果双方都达到或超过目标分-1，需要领先2分才能获胜
                        if (match.myScore >= match.targetScore - 1 && match.opponentScore >= match.targetScore - 1) {
                            if (Math.abs(match.myScore - match.opponentScore) >= 2) {
                                break;
                            }
                        } else {
                            // 否则达到目标分即可获胜
                            break;
                        }
                    }
                }
            }
            
            simulateMatch() {
                const match = this.currentMatch;
                const mySkills = match.mySkills;
                
                // 使用新的对手实力计算方法
                const opponentSkill = this.calculateOpponentStrength(match.type);
                
                // 计算玩家实力（野球不包含队友）
                const myStrength = this.calculateMyStrength(false);
                
                // 预生成完整的比赛结果
                const result = this.pregenerateMatchResult(myStrength, opponentSkill);
                
                // 保存到match对象中
                match.myScore = result.finalPlayerScore;
                match.opponentScore = result.finalOpponentScore;
                match.scoreLog = result.scoreLog;
                match.pregeneratedResult = result; // 保存完整结果供后续使用
                
                // 显示比赛结果
                this.showMatchResult();
            }
            
            simulatePoint(mySkills, opponentSkill) {
                // 计算玩家实力（正式比赛包含队友）
                const includeTeammates = this.currentMatch && 
                                        (this.currentMatch.matchType === 'collegeMatch' || 
                                         this.currentMatch.matchType === 'universityLeague' || 
                                         this.currentMatch.matchType === 'cityLeague' ||
                                         this.currentMatch.matchType === 'tournament');
                const myStrength = this.calculateMyStrength(includeTeammates);
                
                // 使用整场胜率来决定单分胜负（临时方案，正式比赛也应该预生成）
                const winRate = this.calculateMatchWinRate(myStrength, opponentSkill);
                const iWin = Math.random() < winRate;
                
                // 使用generatePointDescription生成描述
                const point = this.generatePointDescription(mySkills, iWin);
                
                return {
                    scorer: iWin ? 'my' : 'opponent',
                    description: point.description,
                    type: point.type,
                    skillTriggered: point.skillTriggered || false,
                    skillDef: point.skillDef,
                    skillLevel: point.skillLevel
                };
            }
            
            showMatchResult() {
                const match = this.currentMatch;
                
                // 显示比赛弹窗
                const modal = document.getElementById('match-modal');
                const title = document.getElementById('match-modal-title');
                const myScoreEl = document.getElementById('my-score');
                const opponentScoreEl = document.getElementById('opponent-score');
                const matchLog = document.getElementById('match-log');
                const choicesDiv = document.getElementById('match-modal-choices');
                const skipBtn = document.getElementById('skip-match-btn');
                
                title.textContent = '🏐 比赛进行中';
                myScoreEl.textContent = '0';
                opponentScoreEl.textContent = '0';
                matchLog.innerHTML = '';
                choicesDiv.innerHTML = '';
                skipBtn.style.display = 'block';
                skipBtn.disabled = false;
                
                modal.classList.add('show');
                
                // 逐行显示得分记录
                let currentIndex = 0;
                this.matchDisplayInterval = setInterval(() => {
                    if (currentIndex >= match.scoreLog.length) {
                        clearInterval(this.matchDisplayInterval);
                        this.matchDisplayInterval = null;
                        // 所有得分显示完毕，显示最终结果
                        this.showFinalMatchResult();
                        return;
                    }
                    
                    const log = match.scoreLog[currentIndex];
                    
                    // 更新比分显示
                    myScoreEl.textContent = log.myScore;
                    opponentScoreEl.textContent = log.opponentScore;
                    
                    // 添加得分记录（使用新的辅助函数）
                    const logItem = this.createScoreLogItem(log);
                    
                    matchLog.appendChild(logItem);
                    
                    // 自动滚动到底部
                    matchLog.scrollTop = matchLog.scrollHeight;
                    
                    currentIndex++;
                }, 500); // 每0.5秒显示一条
            }
            
            skipMatch() {
                // 清除动画定时器
                if (this.matchDisplayInterval) {
                    clearInterval(this.matchDisplayInterval);
                    this.matchDisplayInterval = null;
                }
                
                const match = this.currentMatch;
                const modal = document.getElementById('match-modal');
                const matchLog = document.getElementById('match-log');
                const skipBtn = document.getElementById('skip-match-btn');
                
                // 隐藏跳过按钮
                skipBtn.style.display = 'none';
                
                // 清空并显示简化的比赛记录
                matchLog.innerHTML = '<div style="text-align: center; padding: 20px; color: #ddd;">已跳过比赛过程</div>';
                
                // 根据比赛类型显示不同的结果
                if (match.type === 'formal') {
                    // 正式比赛：显示所有局的结果
                    match.setResults.forEach((set, i) => {
                        const setItem = document.createElement('div');
                        setItem.style.cssText = 'padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 5px;';
                        const color = set.winner === 'my' ? '#2ecc71' : '#e74c3c';
                        setItem.innerHTML = `<div style="color: ${color}; font-weight: bold;">第${i+1}局: ${set.myScore}-${set.opponentScore}</div>`;
                        matchLog.appendChild(setItem);
                    });
                    
                    // 1秒后关闭弹窗并显示结果
                    setTimeout(() => {
                        modal.classList.remove('show');
                        // 恢复野球的背景色
                        const modalContent = document.getElementById('match-modal-content');
                        modalContent.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        this.showFormalMatchResult();
                    }, 1000);
                } else {
                    // 野球和友谊赛：直接显示最终结果
                    const myScoreEl = document.getElementById('my-score');
                    const opponentScoreEl = document.getElementById('opponent-score');
                    const finalLog = match.scoreLog[match.scoreLog.length - 1];
                    myScoreEl.textContent = finalLog.myScore;
                    opponentScoreEl.textContent = finalLog.opponentScore;
                    this.showFinalMatchResult();
                }
            }
            
            // 新增：显示正式比赛动画
            showFormalMatchAnimation() {
                const match = this.currentMatch;
                
                // 显示比赛弹窗
                const modal = document.getElementById('match-modal');
                const modalContent = document.getElementById('match-modal-content');
                const title = document.getElementById('match-modal-title');
                const myScoreEl = document.getElementById('my-score');
                const opponentScoreEl = document.getElementById('opponent-score');
                const matchLog = document.getElementById('match-log');
                const choicesDiv = document.getElementById('match-modal-choices');
                const skipBtn = document.getElementById('skip-match-btn');
                
                // 正式比赛使用金色渐变背景
                modalContent.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 50%, #ffd700 100%)';
                
                // 初始化显示（大局分从0:0开始）
                let displayedMySets = 0;
                let displayedOpponentSets = 0;
                
                title.innerHTML = `🏐 ${match.matchName}<br><span style="font-size: 18px; color: #ffd700;">大局: ${displayedMySets} : ${displayedOpponentSets}</span>`;
                myScoreEl.textContent = '0';
                opponentScoreEl.textContent = '0';
                matchLog.innerHTML = '';
                choicesDiv.innerHTML = '';
                skipBtn.style.display = 'block';
                skipBtn.disabled = false;
                
                modal.classList.add('show');
                
                // 显示"第1局开始"提示
                this.showSetStartMessage(1, matchLog);
                
                // 逐行显示得分记录
                let currentIndex = 0;
                let currentSetNumber = 1;
                let isPaused = true;  // 初始暂停，让"第1局开始"提示显示1秒
                
                // 1秒后开始动画
                setTimeout(() => {
                    isPaused = false;
                }, 1000);
                
                this.matchDisplayInterval = setInterval(() => {
                    // 如果正在暂停，跳过这次更新
                    if (isPaused) {
                        return;
                    }
                    
                    if (currentIndex >= match.scoreLog.length) {
                        clearInterval(this.matchDisplayInterval);
                        this.matchDisplayInterval = null;
                        
                        // 显示最后一局的结果
                        const lastSetResult = match.setResults[match.setResults.length - 1];
                        const isLastSetWin = lastSetResult.winner === 'my';
                        
                        if (isLastSetWin) {
                            displayedMySets++;
                        } else {
                            displayedOpponentSets++;
                        }
                        
                        // 显示最后一局结束提示
                        const lastSetEndItem = document.createElement('div');
                        lastSetEndItem.className = 'match-log-item';
                        const bgColor = isLastSetWin ? 'rgba(46,204,113,0.5)' : 'rgba(231,76,60,0.5)';
                        const borderColor = isLastSetWin ? '#2ecc71' : '#e74c3c';
                        const resultText = isLastSetWin ? '✅ 胜利' : '❌ 失败';
                        const resultColor = isLastSetWin ? '#2ecc71' : '#e74c3c';
                        
                        // 强制显示，不依赖动画
                        lastSetEndItem.style.cssText = `background: ${bgColor}; border: 3px solid ${borderColor}; font-weight: bold; text-align: center; padding: 15px; margin: 10px 0; box-shadow: 0 4px 15px ${bgColor}; opacity: 1 !important; display: block !important;`;
                        lastSetEndItem.innerHTML = `
                            <div style="color: #ffd700; font-size: 22px; margin-bottom: 8px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                                ⭐ 第${match.setResults.length}局结束 ⭐
                            </div>
                            <div style="color: #fff; font-size: 20px; margin: 8px 0; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">
                                ${lastSetResult.myScore} - ${lastSetResult.opponentScore}
                            </div>
                            <div style="color: ${resultColor}; font-size: 18px; margin: 8px 0; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">
                                ${resultText}
                            </div>
                            <div style="color: #ffd700; font-size: 18px; margin-top: 8px; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">
                                大局比分: ${displayedMySets} : ${displayedOpponentSets}
                            </div>
                        `;
                        matchLog.appendChild(lastSetEndItem);
                        matchLog.scrollTop = matchLog.scrollHeight;
                        
                        // 更新标题中的大局分
                        title.innerHTML = `🏐 ${match.matchName}<br><span style="font-size: 18px; color: #ffd700;">大局: ${displayedMySets} : ${displayedOpponentSets}</span>`;
                        
                        // 2秒后显示最终结果
                        setTimeout(() => {
                            const finalWin = displayedMySets > displayedOpponentSets;
                            const finalResultItem = document.createElement('div');
                            finalResultItem.className = 'match-log-item';
                            const finalBgColor = finalWin ? 'rgba(46,204,113,0.6)' : 'rgba(231,76,60,0.6)';
                            const finalBorderColor = finalWin ? '#2ecc71' : '#e74c3c';
                            const finalIcon = finalWin ? '🎉' : '😔';
                            const finalText = finalWin ? '你取得了比赛的胜利！' : '很遗憾，比赛失败了...';
                            const finalTextColor = finalWin ? '#2ecc71' : '#e74c3c';
                            
                            // 强制显示，不依赖动画
                            finalResultItem.style.cssText = `background: ${finalBgColor}; border: 4px solid ${finalBorderColor}; font-weight: bold; text-align: center; padding: 20px; margin: 15px 0; box-shadow: 0 6px 20px ${finalBgColor}; opacity: 1 !important; display: block !important;`;
                            finalResultItem.innerHTML = `
                                <div style="color: #ffd700; font-size: 28px; margin-bottom: 12px; text-shadow: 2px 2px 6px rgba(0,0,0,0.8);">
                                    ${finalIcon} 比赛结束 ${finalIcon}
                                </div>
                                <div style="color: #fff; font-size: 24px; margin: 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                                    最终大局比分
                                </div>
                                <div style="color: #ffd700; font-size: 32px; margin: 10px 0; font-weight: bold; text-shadow: 2px 2px 6px rgba(0,0,0,0.8);">
                                    ${displayedMySets} : ${displayedOpponentSets}
                                </div>
                                <div style="color: ${finalTextColor}; font-size: 20px; margin-top: 12px; text-shadow: 1px 1px 4px rgba(0,0,0,0.8);">
                                    ${finalText}
                                </div>
                            `;
                            matchLog.appendChild(finalResultItem);
                            matchLog.scrollTop = matchLog.scrollHeight;
                            
                            // 再等3秒后关闭弹窗
                            setTimeout(() => {
                                modal.classList.remove('show');
                                // 恢复野球的背景色
                                modalContent.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                                this.showFormalMatchResult();
                            }, 3000);
                        }, 2000);
                        
                        return;
                    }
                    
                    const log = match.scoreLog[currentIndex];
                    
                    // 检查是否进入新的一局
                    if (log.set !== currentSetNumber) {
                        // 暂停动画
                        isPaused = true;
                        
                        // 显示局分提示
                        const setResult = match.setResults[currentSetNumber - 1];
                        const isWin = setResult.winner === 'my';
                        
                        if (isWin) {
                            displayedMySets++;
                        } else {
                            displayedOpponentSets++;
                        }
                        
                        // 显示局结束提示
                        const setEndItem = document.createElement('div');
                        setEndItem.className = 'match-log-item';
                        const bgColor = isWin ? 'rgba(46,204,113,0.5)' : 'rgba(231,76,60,0.5)';
                        const borderColor = isWin ? '#2ecc71' : '#e74c3c';
                        const resultText = isWin ? '✅ 胜利' : '❌ 失败';
                        const resultColor = isWin ? '#2ecc71' : '#e74c3c';
                        
                        // 强制显示，不依赖动画
                        setEndItem.style.cssText = `background: ${bgColor}; border: 3px solid ${borderColor}; font-weight: bold; text-align: center; padding: 15px; margin: 10px 0; box-shadow: 0 4px 15px ${bgColor}; opacity: 1 !important; display: block !important;`;
                        setEndItem.innerHTML = `
                            <div style="color: #ffd700; font-size: 22px; margin-bottom: 8px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                                ⭐ 第${currentSetNumber}局结束 ⭐
                            </div>
                            <div style="color: #fff; font-size: 20px; margin: 8px 0; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">
                                ${setResult.myScore} - ${setResult.opponentScore}
                            </div>
                            <div style="color: ${resultColor}; font-size: 18px; margin: 8px 0; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">
                                ${resultText}
                            </div>
                            <div style="color: #ffd700; font-size: 18px; margin-top: 8px; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">
                                大局比分: ${displayedMySets} : ${displayedOpponentSets}
                            </div>
                        `;
                        matchLog.appendChild(setEndItem);
                        matchLog.scrollTop = matchLog.scrollHeight;
                        
                        currentSetNumber = log.set;
                        
                        // 更新标题中的大局分
                        title.innerHTML = `🏐 ${match.matchName}<br><span style="font-size: 18px; color: #ffd700;">大局: ${displayedMySets} : ${displayedOpponentSets}</span>`;
                        
                        // 重置小局比分显示
                        myScoreEl.textContent = '0';
                        opponentScoreEl.textContent = '0';
                        
                        // 2秒后显示"第X局开始"并继续
                        setTimeout(() => {
                            this.showSetStartMessage(currentSetNumber, matchLog);
                            // 再等1秒后恢复动画
                            setTimeout(() => {
                                isPaused = false;
                            }, 1000);
                        }, 2000);
                        
                        return;
                    }
                    
                    // 更新比分显示
                    myScoreEl.textContent = log.myScore;
                    opponentScoreEl.textContent = log.opponentScore;
                    
                    // 添加得分记录（使用新的辅助函数）
                    const logItem = this.createScoreLogItem(log);
                    
                    matchLog.appendChild(logItem);
                    matchLog.scrollTop = matchLog.scrollHeight;
                    
                    currentIndex++;
                }, 500); // 改为每0.5秒显示一分，更从容
            }
            
            // 新增：显示局开始提示
            showSetStartMessage(setNumber, matchLog) {
                const setStartItem = document.createElement('div');
                setStartItem.className = 'match-log-item';
                
                let setName = `第${setNumber}局`;
                let emoji = '🏐';
                let specialStyle = '';
                
                if (setNumber === 5) {
                    setName = '决胜局';
                    emoji = '🔥';
                    specialStyle = 'background: linear-gradient(135deg, #ff6b6b 0%, #ffd700 100%); border: 3px solid #ff6b6b; box-shadow: 0 4px 15px rgba(255,107,107,0.5);';
                } else {
                    specialStyle = 'background: rgba(0,0,0,0.5); border: 2px solid #ffd700; box-shadow: 0 2px 10px rgba(255,215,0,0.3);';
                }
                
                // 强制显示，不依赖动画
                setStartItem.style.cssText = `${specialStyle} font-weight: bold; text-align: center; padding: 15px; margin: 10px 0; opacity: 1 !important; display: block !important;`;
                
                setStartItem.innerHTML = `
                    <div style="color: #ffd700; font-size: 24px; padding: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                        ${emoji} ${setName}开始！${emoji}
                    </div>
                `;
                matchLog.appendChild(setStartItem);
                matchLog.scrollTop = matchLog.scrollHeight;
            }
            
            // 新增：显示正式比赛结果
            showFormalMatchResult() {
                const match = this.currentMatch;
                const won = match.mySets > match.opponentSets;
                
                // 检查是否是锦标赛模式
                if (match.matchType === 'tournament' && this.tournament.active) {
                    // 锦标赛模式：调用锦标赛结果处理
                    this.onTournamentRoundComplete(won);
                    return;
                }
                
                // 非锦标赛模式：原有逻辑
                // 计算表现评级
                const performance = this.evaluateMatchPerformance();
                
                // 根据表现等级显示不同结果
                this.showMatchResultByPerformance(performance, won);
            }
            
            // 新增：评估比赛表现
            evaluateMatchPerformance() {
                const match = this.currentMatch;
                
                // 基于比赛结果计算表现评分
                const mySets = match.mySets;
                const opponentSets = match.opponentSets;
                const totalSets = mySets + opponentSets;
                
                // 计算局分优势
                const setAdvantage = mySets - opponentSets;
                
                // 计算每局的小分差距
                let totalPointDiff = 0;
                let dominantSets = 0;  // 大比分获胜的局数（差距>=5分）
                
                match.setResults.forEach(set => {
                    const pointDiff = set.myScore - set.opponentScore;
                    totalPointDiff += pointDiff;
                    
                    // 如果赢了这局且分差>=5，算作主导局
                    if (set.winner === 'my' && pointDiff >= 5) {
                        dominantSets++;
                    }
                });
                
                const avgPointDiff = totalPointDiff / totalSets;
                
                // 综合评分逻辑：
                // 1. 3:0或3:1横扫 → excellent
                // 2. 3:2险胜但有多个主导局 → good
                // 3. 3:2险胜 → average
                // 4. 输了 → 根据局分和小分判断
                
                if (mySets >= 3) {
                    // 赢了比赛
                    if (opponentSets === 0) {
                        // 3:0横扫
                        return 'excellent';
                    } else if (opponentSets === 1) {
                        // 3:1大胜
                        return dominantSets >= 2 ? 'excellent' : 'good';
                    } else {
                        // 3:2险胜
                        return dominantSets >= 2 ? 'good' : 'average';
                    }
                } else {
                    // 输了比赛
                    if (mySets === 2) {
                        // 2:3惜败
                        return avgPointDiff >= -2 ? 'average' : 'poor';
                    } else if (mySets === 1) {
                        // 1:3失利
                        return 'poor';
                    } else {
                        // 0:3惨败
                        return 'poor';
                    }
                }
            }
            
            // 新增：根据表现显示比赛结果
            showMatchResultByPerformance(performance, won) {
                const match = this.currentMatch;
                
                // 构建局分显示
                let setsDisplay = `<div class="sets-result" style="margin: 20px 0;">`;
                setsDisplay += `<div class="final-sets" style="font-size: 28px; font-weight: bold; margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">`;
                setsDisplay += `大局比分：<span style="color: #2ecc71;">${match.mySets}</span> : <span style="color: #e74c3c;">${match.opponentSets}</span>`;
                setsDisplay += `</div>`;
                setsDisplay += `<div class="set-details" style="font-size: 16px;">`;
                match.setResults.forEach((set, i) => {
                    const setClass = set.winner === 'my' ? 'won' : 'lost';
                    const color = set.winner === 'my' ? '#2ecc71' : '#e74c3c';
                    setsDisplay += `<div class="set-result ${setClass}" style="padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 5px;">`;
                    setsDisplay += `第${i+1}局: <span style="color: ${color}; font-weight: bold;">${set.myScore}-${set.opponentScore}</span>`;
                    setsDisplay += `</div>`;
                });
                setsDisplay += `</div></div>`;
                
                // 根据表现等级确定奖励
                let rewards = this.getMatchRewards(match.matchType, performance, won);
                
                // 构建属性变化显示
                let rewardsDisplay = `<div style="margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px;">`;
                rewardsDisplay += `<h3 style="margin-top: 0; color: #667eea;">💫 比赛收获</h3>`;
                rewardsDisplay += `<div style="text-align: left; font-size: 14px;">`;
                if (rewards.serve > 0) rewardsDisplay += `🎯 发球 +${rewards.serve}<br>`;
                if (rewards.spike > 0) rewardsDisplay += `⚡ 扣球 +${rewards.spike}<br>`;
                if (rewards.block > 0) rewardsDisplay += `🛡️ 拦网 +${rewards.block}<br>`;
                if (rewards.dig > 0) rewardsDisplay += `🤸 垫球 +${rewards.dig}<br>`;
                if (rewards.set > 0) rewardsDisplay += `🙌 托球 +${rewards.set}<br>`;
                if (rewards.reputation !== 0) rewardsDisplay += `⭐ 声望 ${rewards.reputation > 0 ? '+' : ''}${rewards.reputation}<br>`;
                if (rewards.mood !== 0) rewardsDisplay += `😊 心情 ${rewards.mood > 0 ? '+' : ''}${rewards.mood}<br>`;
                if (rewards.stress !== 0) rewardsDisplay += `😰 压力 ${rewards.stress > 0 ? '+' : ''}${rewards.stress}<br>`;
                if (rewards.teamChemistry > 0) rewardsDisplay += `🤝 全队默契 +${rewards.teamChemistry}<br>`;
                rewardsDisplay += `</div></div>`;
                
                // 显示结果场景
                const resultText = this.getMatchResultText(match.matchType, performance, won, setsDisplay) + rewardsDisplay;
                
                // 清除比赛进行中标记
                this.inMatch = false;
                this.matchCheckpoint = null;
                
                // 比赛结束后自动保存
                this.saveGame();
                
                // 检查是否是校际联赛（触发结局）
                if (match.matchType === 'universityLeague' && rewards.ending) {
                    // 校际联赛结束，触发结局
                    SCENES.matchResult = {
                        text: resultText,
                        choices: [{
                            text: '查看结局',
                            next: rewards.ending,  // 跳转到结局场景
                            effect: rewards
                        }]
                    };
                } else {
                    // 其他比赛，返回周选择，并更新目标
                    // 院际比赛后切换到加入校队目标
                    if (match.matchType === 'collegeMatch') {
                        rewards.goalUpdate = 'universityTryout';
                    }
                    
                    SCENES.matchResult = {
                        text: resultText,
                        choices: [{
                            text: '继续',
                            next: 'weeklyHub',
                            effect: rewards
                        }]
                    };
                }
                
                console.log('显示比赛结果场景');
                this.showScene('matchResult');
            }
            
            // 新增：获取比赛奖励
            getMatchRewards(matchType, performance, won) {
                const rewards = {
                    reputation: 0,
                    serve: 0,
                    spike: 0,
                    block: 0,
                    dig: 0,
                    set: 0,
                    mood: 0,
                    stress: 0,
                    nextGoal: null,
                    teamChemistry: 0  // 队友默契值
                };
                
                // 根据比赛类型和表现等级设置奖励
                if (matchType === 'collegeMatch') {
                    rewards.goalUpdate = 'universityTryout';  // 使用goalUpdate而不是nextGoal
                    if (performance === 'excellent') {
                        // 出色表现（胜利）
                        rewards.reputation = 25;
                        rewards.serve = rewards.spike = rewards.block = rewards.dig = rewards.set = 3;
                        rewards.mood = 15;
                        rewards.stress = -8;
                        rewards.teamChemistry = 3;  // 降低默契增长（原8）
                    } else if (performance === 'good') {
                        // 良好表现（胜利）
                        rewards.reputation = 20;
                        rewards.serve = rewards.spike = rewards.block = rewards.dig = rewards.set = 2;
                        rewards.mood = 12;
                        rewards.stress = -5;
                        rewards.teamChemistry = 2;  // 降低默契增长（原6）
                    } else if (performance === 'average') {
                        // 一般表现（胜利）
                        rewards.reputation = 12;
                        rewards.serve = rewards.spike = rewards.block = rewards.dig = rewards.set = 1;
                        rewards.mood = 8;
                        rewards.stress = 0;
                        rewards.teamChemistry = 1;  // 降低默契增长（原4）
                    } else {
                        // 表现不佳（失败）
                        rewards.reputation = 5;
                        rewards.serve = rewards.spike = rewards.block = rewards.dig = rewards.set = 1;
                        rewards.mood = -10;
                        rewards.stress = 10;
                        rewards.teamChemistry = 1;  // 失败也有小幅默契提升（共同经历）
                    }
                } else if (matchType === 'universityLeague') {
                    // 校际联赛：根据表现触发不同结局
                    if (performance === 'excellent') {
                        rewards.reputation = 70;
                        rewards.serve = rewards.spike = rewards.block = rewards.dig = rewards.set = 12;
                        rewards.mood = 30;
                        rewards.stress = -20;
                        rewards.ending = 'champion';  // 冠军结局
                    } else if (performance === 'good') {
                        rewards.reputation = 50;
                        rewards.serve = rewards.spike = rewards.block = rewards.dig = rewards.set = 8;
                        rewards.mood = 25;
                        rewards.stress = -15;
                        rewards.ending = 'runner_up';  // 亚军结局
                    } else if (performance === 'average') {
                        rewards.reputation = 25;
                        rewards.serve = rewards.spike = rewards.block = rewards.dig = rewards.set = 5;
                        rewards.mood = 10;
                        rewards.stress = 5;
                        rewards.ending = 'participant';  // 参与结局
                    } else {
                        rewards.reputation = 10;
                        rewards.mood = -25;
                        rewards.stress = 20;
                        rewards.ending = 'early_exit';  // 早退结局
                    }
                }
                
                return rewards;
            }
            
            // 新增：获取比赛结果文本
            getMatchResultText(matchType, performance, won, setsDisplay) {
                let matchName = '';
                if (matchType === 'collegeMatch') matchName = '院际比赛';
                else if (matchType === 'universityLeague') matchName = '校际联赛';
                
                let text = `<h2>🏐 ${matchName}</h2>`;
                
                // 显示大局分（加大字体）
                text += `<div style="font-size: 32px; font-weight: bold; margin: 20px 0; color: ${won ? '#2ecc71' : '#e74c3c'};">`;
                text += won ? '🎉 胜利！' : '😔 失败';
                text += `</div>`;
                
                text += setsDisplay;
                
                // 根据胜负和表现显示不同文本
                if (won) {
                    if (performance === 'excellent') {
                        text += `<p><strong>🌟 MVP表现！</strong></p>`;
                        text += `<p>你在比赛中表现出色，完全主导了比赛！</p>`;
                        text += `<p>观众们为你欢呼，教练对你赞不绝口！</p>`;
                    } else if (performance === 'good') {
                        text += `<p><strong>✨ 出色表现！</strong></p>`;
                        text += `<p>你在比赛中发挥稳定，帮助球队获得胜利！</p>`;
                        text += `<p>队友们对你竖起大拇指！</p>`;
                    } else if (performance === 'average') {
                        text += `<p><strong>📊 险胜</strong></p>`;
                        text += `<p>比赛很激烈，你的表现中规中矩，但最终赢得了比赛。</p>`;
                        text += `<p>还有提升的空间，继续努力！</p>`;
                    } else {
                        text += `<p><strong>🍀 幸运获胜</strong></p>`;
                        text += `<p>虽然你的发挥不太理想，但队友们帮助你赢得了比赛。</p>`;
                        text += `<p>需要更多的训练来提升实力。</p>`;
                    }
                } else {
                    if (performance === 'excellent') {
                        text += `<p><strong>💪 虽败犹荣</strong></p>`;
                        text += `<p>你表现出色，但对手更强。这是一场精彩的比赛！</p>`;
                        text += `<p>继续保持，你会变得更强！</p>`;
                    } else if (performance === 'good') {
                        text += `<p><strong>😔 惜败</strong></p>`;
                        text += `<p>你发挥不错，但对手略胜一筹。</p>`;
                        text += `<p>继续努力，下次一定能赢！</p>`;
                    } else if (performance === 'average') {
                        text += `<p><strong>📉 表现一般</strong></p>`;
                        text += `<p>比赛很激烈，但你的表现不够出色。</p>`;
                        text += `<p>需要更多训练来提升实力。</p>`;
                    } else {
                        text += `<p><strong>😞 表现不佳</strong></p>`;
                        text += `<p>这场比赛你的发挥不太理想，输掉了比赛。</p>`;
                        text += `<p>不要气馁，加强训练，下次会更好！</p>`;
                    }
                }
                
                return text;
            }
            
            showFinalMatchResult() {
                const match = this.currentMatch;
                const won = match.myScore >= match.targetScore;
                
                const title = document.getElementById('match-modal-title');
                const choicesDiv = document.getElementById('match-modal-choices');
                const skipBtn = document.getElementById('skip-match-btn');
                
                // 隐藏跳过按钮
                skipBtn.style.display = 'none';
                
                // 更新标题
                title.textContent = won ? '🎉 胜利！' : '😔 失败';
                
                // 更新比赛统计（根据比赛类型）
                if (match.type === 'casual') {
                    // 野球统计
                    this.playerStats.casualMatchesPlayed = (this.playerStats.casualMatchesPlayed || 0) + 1;
                    if (won) {
                        this.playerStats.casualMatchesWon = (this.playerStats.casualMatchesWon || 0) + 1;
                    }
                } else if (match.type === 'friendly') {
                    // 友谊赛统计（可以添加专门的统计字段，这里暂时不计入正式比赛）
                    // 不更新casualMatchesPlayed，因为友谊赛是团队比赛
                }
                
                // 通用比赛统计
                this.player.matchesPlayed = (this.player.matchesPlayed || 0) + 1;
                if (won) {
                    this.player.matchesWon = (this.player.matchesWon || 0) + 1;
                }
                
                // 计算比赛表现评分（简化版）
                const performanceRating = this.calculateMatchPerformance(match, won);
                this.player.performanceHistory.push(performanceRating);
                
                // 更新平均表现
                if (this.player.performanceHistory.length > 0) {
                    this.player.averagePerformance = Math.round(
                        this.player.performanceHistory.reduce((a, b) => a + b, 0) / 
                        this.player.performanceHistory.length
                    );
                }
                
                // 计算奖励
                const rewards = this.calculateMatchRewards(won, performanceRating);
                
                // 显示结果按钮
                choicesDiv.innerHTML = '';
                
                // 添加结果说明
                const resultDiv = document.createElement('div');
                resultDiv.style.cssText = 'margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; text-align: center;';
                
                let rewardsHtml = '';
                if (rewards.teammateGrowth && rewards.teammateGrowth.length > 0) {
                    // 友谊赛奖励显示
                    rewardsHtml = `
                        <h3 style="margin-bottom: 10px;">${won ? '恭喜获胜！' : '虽败犹荣！'}</h3>
                        <p style="margin-bottom: 10px;">${rewards.message}</p>
                        <p style="font-size: 14px; color: #f39c12;">📊 本场表现评分：${performanceRating}/100</p>
                        <div style="text-align: left; font-size: 14px; margin-top: 15px;">
                            <strong>💫 团队成长：</strong><br>
                            ${rewards.teammateGrowth.map(g => `✨ ${g}<br>`).join('')}
                            <span style="color: #3498db;">💛 ${rewards.chemistryGain}</span><br>
                            ${rewards.mood !== 0 ? `😊 心情 ${rewards.mood > 0 ? '+' : ''}${rewards.mood}<br>` : ''}
                            ${rewards.stress !== 0 ? `😰 压力 ${rewards.stress > 0 ? '+' : ''}${rewards.stress}<br>` : ''}
                        </div>
                    `;
                } else {
                    // 野球/正式比赛奖励显示
                    rewardsHtml = `
                        <h3 style="margin-bottom: 10px;">${won ? '恭喜获胜！' : '虽败犹荣！'}</h3>
                        <p style="margin-bottom: 10px;">${rewards.message}</p>
                        <p style="font-size: 14px; color: #f39c12;">📊 本场表现评分：${performanceRating}/100</p>
                        <div style="text-align: left; font-size: 14px; margin-top: 15px;">
                            <strong>💫 比赛收获：</strong><br>
                            ${rewards.serve > 0 ? `🎯 发球 +${rewards.serve}<br>` : ''}
                            ${rewards.spike > 0 ? `⚡ 扣球 +${rewards.spike}<br>` : ''}
                            ${rewards.block > 0 ? `🛡️ 拦网 +${rewards.block}<br>` : ''}
                            ${rewards.dig > 0 ? `🤸 垫球 +${rewards.dig}<br>` : ''}
                            ${rewards.set > 0 ? `🙌 托球 +${rewards.set}<br>` : ''}
                            ${rewards.energy !== 0 ? `💪 体力 ${rewards.energy > 0 ? '+' : ''}${rewards.energy}<br>` : ''}
                            ${rewards.mood !== 0 ? `😊 心情 ${rewards.mood > 0 ? '+' : ''}${rewards.mood}<br>` : ''}
                            ${rewards.stress !== 0 ? `😰 压力 ${rewards.stress > 0 ? '+' : ''}${rewards.stress}<br>` : ''}
                            ${rewards.reputation > 0 ? `⭐ 声望 +${rewards.reputation}<br>` : ''}
                            ${rewards.reputation < 0 ? `⭐ 声望 ${rewards.reputation}<br>` : ''}
                        </div>
                    `;
                }
                
                resultDiv.innerHTML = rewardsHtml;
                choicesDiv.appendChild(resultDiv);
                
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.textContent = '确定';
                button.onclick = () => {
                    // 应用奖励
                    this.applyEffect(rewards);
                    
                    // 关闭弹窗
                    const modal = document.getElementById('match-modal');
                    modal.classList.remove('show');
                    
                    // 更新目标显示
                    this.updateGoalDisplay();
                    
                    // 检查是否触发奇遇事件（比赛结束后）
                    const adventureTriggered = this.checkAdventureEvents('general');
                    if (adventureTriggered) {
                        // 如果触发了奇遇事件，不立即返回周选择
                        return;
                    }
                    
                    // 返回周选择
                    this.currentScene = 'weeklyHub';
                    this.showScene('weeklyHub');
                };
                
                choicesDiv.appendChild(button);
            }
            
            // 新增：计算比赛表现评分
            calculateMatchPerformance(match, won) {
                // 基础分：根据比分差距
                const scoreDiff = match.myScore - match.opponentScore;
                let baseScore = 50;
                
                if (won) {
                    baseScore = 60 + Math.min(scoreDiff * 2, 20); // 60-80分
                } else {
                    baseScore = 40 + Math.max(scoreDiff * 2, -20); // 20-40分
                }
                
                // 技能加成：平均技能越高，表现越好
                const avgSkill = (
                    this.player.skills.serve +
                    this.player.skills.spike +
                    this.player.skills.block +
                    this.player.skills.dig +
                    this.player.skills.set
                ) / 5;
                
                const skillBonus = Math.min(avgSkill / 5, 20); // 最多+20分
                
                const finalScore = Math.round(Math.min(baseScore + skillBonus, 100));
                return finalScore;
            }
            
            calculateMatchRewards(won, performanceRating) {
                const match = this.currentMatch;
                const isCasual = match.type === 'casual';
                const isFriendly = match.type === 'friendly';
                
                // 友谊赛：主要奖励队友成长和默契度
                if (isFriendly) {
                    // 队友能力成长
                    let teammateGrowth = [];
                    if (this.teammates && this.teammates.length > 0) {
                        for (let teammate of this.teammates) {
                            // 随机选择2-3个技能提升
                            const skillsToImprove = ['serve', 'spike', 'block', 'dig', 'set'];
                            const numSkills = won ? 3 : 2;  // 胜利提升3个技能，失败提升2个
                            const selectedSkills = [];
                            
                            for (let i = 0; i < numSkills; i++) {
                                const randomSkill = skillsToImprove[Math.floor(Math.random() * skillsToImprove.length)];
                                if (!selectedSkills.includes(randomSkill)) {
                                    selectedSkills.push(randomSkill);
                                    const growth = won ? Math.floor(Math.random() * 2) + 2 : 1;  // 胜利+2~3，失败+1
                                    teammate.skills[randomSkill] = Math.min(95, teammate.skills[randomSkill] + growth);
                                }
                            }
                            
                            // 重新计算平均能力
                            teammate.averageSkill = Math.round((teammate.skills.serve + teammate.skills.spike + 
                                                                teammate.skills.block + teammate.skills.dig + 
                                                                teammate.skills.set) / 5);
                            
                            teammateGrowth.push(`${teammate.name} 能力提升`);
                        }
                        
                        // 默契度提升（降低增长速度）
                        const chemistryGain = won ? Math.floor(Math.random() * 2) + 1 : 1;  // 胜利+1~2，失败+1
                        for (let teammate of this.teammates) {
                            teammate.chemistry = Math.min(100, teammate.chemistry + chemistryGain);
                        }
                        
                        // 更新队伍统计
                        this.updateTeamStats();
                    }
                    
                    return {
                        message: won ? 
                            '友谊赛胜利！队友们的能力和默契度都得到了提升！' :
                            '虽然输了，但队友们从比赛中学到了很多，默契度也有所提升。',
                        serve: 0,  // 友谊赛不提升玩家个人能力
                        spike: 0,
                        block: 0,
                        dig: 0,
                        set: 0,
                        energy: 0,  // 体力已在选择时扣除
                        mood: won ? 15 : 5,
                        stress: won ? -8 : 0,
                        reputation: 0,
                        teammateGrowth: teammateGrowth,  // 队友成长信息
                        chemistryGain: won ? '全队默契度 +1~2' : '全队默契度 +1'
                    };
                }
                
                if (won) {
                    return {
                        message: isCasual ? 
                            '通过实战，你的技能得到了提升！' :
                            '赢得比赛让你信心大增，技能和声望都有提升！',
                        serve: isCasual ? 1 : 4,
                        spike: isCasual ? 1 : 4,
                        block: isCasual ? 1 : 3,
                        dig: isCasual ? 1 : 4,
                        set: isCasual ? 1 : 3,
                        energy: isCasual ? 0 : -15,  // 野球不额外消耗体力，正式比赛消耗
                        mood: isCasual ? 10 : 20,
                        stress: isCasual ? -5 : -12,
                        reputation: isCasual ? 1 : 6
                    };
                } else {
                    const rewards = {
                        message: isCasual ?
                            '虽然输了，但你从比赛中学到了很多。' :
                            '失败是成功之母，你从这场比赛中吸取了经验。',
                        serve: isCasual ? 0 : 2,
                        spike: isCasual ? 0 : 2,
                        block: isCasual ? 0 : 1,
                        dig: isCasual ? 0 : 2,
                        set: isCasual ? 0 : 1,
                        energy: isCasual ? 0 : -12,  // 野球不额外消耗体力，正式比赛消耗
                        mood: isCasual ? -3 : -10,
                        stress: isCasual ? 3 : 8,
                        reputation: isCasual ? 0 : -2
                    };
                    
                    // 野球失败也有收获：随机2个技能+1
                    if (isCasual) {
                        const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                        const shuffled = skills.sort(() => Math.random() - 0.5);
                        const selectedSkills = shuffled.slice(0, 2);
                        
                        selectedSkills.forEach(skill => {
                            rewards[skill] = (rewards[skill] || 0) + 1;
                        });
                        
                        console.log('野球失败奖励 - 随机技能:', selectedSkills, '完整奖励:', rewards);
                    }
                    
                    return rewards;
                }
            }
            
            // ====================================================
            // 锦标赛系统
            // ====================================================
            
            // 开始锦标赛
            startTournament(type) {
                console.log('=== 开始锦标赛 ===');
                console.log('类型:', type);
                
                // 检查是否选择了位置
                if (this.player.position === 'none') {
                    console.log('玩家还未选择位置，强制进入位置选择');
                    
                    // 显示提示弹窗
                    const modal = document.getElementById('event-modal');
                    const title = document.getElementById('event-modal-title');
                    const text = document.getElementById('event-modal-text');
                    const choicesDiv = document.getElementById('event-modal-choices');
                    
                    modal.style.display = '';
                    modal.classList.remove('show');
                    
                    title.textContent = '⚠️ 必须选择场上位置';
                    text.innerHTML = `
                        <p style="text-align: center; line-height: 1.8;">
                            参加校际联赛前，你必须先选择自己的场上位置！<br>
                            <br>
                            <strong style="color: #ffd700;">这将决定你在比赛中的角色和队友配置</strong>
                        </p>
                    `;
                    
                    choicesDiv.innerHTML = '';
                    
                    const confirmBtn = document.createElement('button');
                    confirmBtn.className = 'choice-btn';
                    confirmBtn.textContent = '✓ 现在选择位置';
                    confirmBtn.onclick = () => {
                        modal.classList.remove('show');
                        // 保存锦标赛类型，选择位置后继续
                        this.pendingTournamentType = type;
                        this.renderPositionSelection();
                    };
                    choicesDiv.appendChild(confirmBtn);
                    
                    setTimeout(() => {
                        modal.classList.add('show');
                    }, 10);
                    
                    return;
                }
                
                this.tournament = {
                    active: true,
                    type: type,
                    currentRound: 'round16',
                    roundsCompleted: [],
                    matchesWon: 0,
                    matchesLost: 0,
                    eliminated: false,
                    finalRank: null
                };
                
                // 显示锦标赛开幕场景
                this.showScene('tournamentStart');
            }
            
            // 开始某一轮比赛
            startTournamentRound(roundId) {
                console.log('=== 开始锦标赛轮次 ===');
                console.log('轮次:', roundId);
                
                this.tournament.currentRound = roundId;
                const roundInfo = this.TOURNAMENT_ROUNDS[roundId];
                
                // 显示轮次开始场景
                SCENES[`roundStart_${roundId}`] = {
                    text: this.getRoundStartText(roundInfo),
                    choices: [
                        {
                            text: '开始比赛',
                            next: null,  // 不跳转场景
                            effect: () => {
                                // 直接开始五局三胜比赛
                                this.startFormalMatch('tournament', roundInfo.name);
                            }
                        }
                    ]
                };
                
                this.showScene(`roundStart_${roundId}`);
            }
            
            // 获取轮次开始文本
            getRoundStartText(roundInfo) {
                const progress = this.renderTournamentProgress();
                const starCount = Math.min(5, Math.floor(roundInfo.opponentStrength / 20));
                const opponentStars = '★'.repeat(starCount) + '☆'.repeat(5 - starCount);
                
                let coachTip = '';
                if (roundInfo.id === 'round16') {
                    coachTip = '"这是单败淘汰，输了就回家。全力以赴，不留遗憾！"';
                } else if (roundInfo.id === 'round8') {
                    coachTip = '"你已经证明了自己的实力。继续保持，稳扎稳打！"';
                } else if (roundInfo.id === 'round4') {
                    coachTip = '"半决赛了！距离冠军只有两步之遥，加油！"';
                } else if (roundInfo.id === 'final') {
                    coachTip = '"你已经证明了自己。现在，去拿下那座冠军奖杯吧！"';
                }
                
                let text = `<h2>${roundInfo.emoji} ${roundInfo.name}</h2>`;
                text += `<div style="margin: 20px 0;">`;
                text += `<h3>🏆 锦标赛进度</h3>`;
                text += `<p>✅ 已晋级：${this.tournament.roundsCompleted.length}轮</p>`;
                text += `<p>📍 当前轮次：${roundInfo.shortName}</p>`;
                if (roundInfo.nextRound) {
                    const nextRoundInfo = this.TOURNAMENT_ROUNDS[roundInfo.nextRound];
                    text += `<p>🎯 下一轮：${nextRoundInfo.shortName}</p>`;
                }
                text += `</div>`;
                
                text += progress;
                
                text += `<div style="margin: 20px 0;">`;
                text += `<p><strong>💪 对手实力：${opponentStars}</strong></p>`;
                
                if (roundInfo.id === 'round16') {
                    text += `<p>这是你的第一场淘汰赛，对手实力中等偏上。保持冷静，发挥实力！</p>`;
                } else if (roundInfo.id === 'round8') {
                    text += `<p>进入8强，对手实力明显提升。需要更加专注和努力！</p>`;
                } else if (roundInfo.id === 'round4') {
                    text += `<p>半决赛的对手非常强大，这将是一场硬仗！</p>`;
                } else if (roundInfo.id === 'final') {
                    text += `<p>决赛对手是本届联赛最强的队伍！这将是一场史诗级的对决！</p>`;
                    text += `<p style="margin-top: 10px;">🎯 <strong>胜利 → 🏆 冠军</strong></p>`;
                    text += `<p>😔 <strong>失败 → 🥈 亚军</strong></p>`;
                }
                text += `</div>`;
                
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">`;
                text += `<p><strong>💡 教练提醒：</strong></p>`;
                text += `<p>${coachTip}</p>`;
                text += `</div>`;
                
                return text;
            }
            
            // 渲染锦标赛进度条
            renderTournamentProgress() {
                const rounds = ['round16', 'round8', 'round4', 'final'];
                const currentIndex = rounds.indexOf(this.tournament.currentRound);
                
                let html = `<div style="margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">`;
                html += `<div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px;">`;
                
                rounds.forEach((roundId, index) => {
                    const roundInfo = this.TOURNAMENT_ROUNDS[roundId];
                    let status = '';
                    let color = '#666';
                    
                    if (this.tournament.roundsCompleted.includes(roundId)) {
                        status = '✅';
                        color = '#2ecc71';
                    } else if (roundId === this.tournament.currentRound) {
                        status = '📍';
                        color = '#f39c12';
                    } else {
                        status = '⭕';
                        color = '#666';
                    }
                    
                    html += `<div style="text-align: center; flex: 1;">`;
                    html += `<div style="font-size: 20px;">${status}</div>`;
                    html += `<div style="color: ${color}; margin-top: 5px;">${roundInfo.shortName}</div>`;
                    html += `</div>`;
                    
                    if (index < rounds.length - 1) {
                        html += `<div style="color: #666;">→</div>`;
                    }
                });
                
                html += `<div style="text-align: center; flex: 1;">`;
                html += `<div style="font-size: 20px;">🏆</div>`;
                html += `<div style="color: #ffd700; margin-top: 5px;">冠军</div>`;
                html += `</div>`;
                
                html += `</div></div>`;
                
                return html;
            }
            
            // 轮次比赛结束
            onTournamentRoundComplete(won) {
                console.log('=== 轮次比赛结束 ===');
                console.log('胜利:', won);
                
                const roundInfo = this.TOURNAMENT_ROUNDS[this.tournament.currentRound];
                
                if (won) {
                    // 晋级
                    this.tournament.matchesWon++;
                    this.tournament.roundsCompleted.push(this.tournament.currentRound);
                    
                    // 清除比赛进行中标记
                    this.inMatch = false;
                    this.matchCheckpoint = null;
                    
                    // 检查是否是决赛胜利
                    if (!roundInfo.nextRound) {
                        // 决赛胜利：标记游戏结束并立即保存
                        this.player.gameOver = true;
                        this.player.endingType = this.getTournamentEnding();
                    } else {
                        // 非决赛：提前更新currentRound为下一轮，方便刷新恢复
                        this.tournament.currentRound = roundInfo.nextRound;
                    }
                    
                    // 立即保存（清除inMatch标记，防止刷新误判为比赛进行中）
                    this.saveGame();
                    
                    // 显示晋级界面
                    this.showTournamentRoundResult(true, roundInfo);
                } else {
                    // 淘汰
                    this.tournament.matchesLost++;
                    this.tournament.eliminated = true;
                    this.tournament.finalRank = roundInfo.eliminationRank;
                    
                    // 清除比赛进行中标记
                    this.inMatch = false;
                    this.matchCheckpoint = null;
                    
                    // 标记游戏即将结束
                    this.player.gameOver = true;
                    this.player.endingType = this.getTournamentEnding();
                    
                    // 立即保存，防止玩家刷新重来
                    this.saveGame();
                    
                    // 显示淘汰界面
                    this.showTournamentRoundResult(false, roundInfo);
                }
            }
            
            // 显示轮次结果
            showTournamentRoundResult(won, roundInfo) {
                const match = this.currentMatch;
                
                // 构建局分显示
                let setsDisplay = `<div class="sets-result" style="margin: 20px 0;">`;
                setsDisplay += `<div class="final-sets" style="font-size: 24px; font-weight: bold; margin-bottom: 15px;">`;
                setsDisplay += `大局比分：<span style="color: #2ecc71;">${match.mySets}</span> : <span style="color: #e74c3c;">${match.opponentSets}</span>`;
                setsDisplay += `</div>`;
                setsDisplay += `<div class="set-details" style="font-size: 14px;">`;
                match.setResults.forEach((set, i) => {
                    const color = set.winner === 'my' ? '#2ecc71' : '#e74c3c';
                    setsDisplay += `<div style="padding: 5px; margin: 3px 0;">`;
                    setsDisplay += `第${i+1}局: <span style="color: ${color}; font-weight: bold;">${set.myScore}-${set.opponentScore}</span>`;
                    if (set.winner === 'my') setsDisplay += ` ✅`;
                    else setsDisplay += ` ❌`;
                    setsDisplay += `</div>`;
                });
                setsDisplay += `</div></div>`;
                
                // 计算奖励
                const rewards = this.getTournamentRoundRewards(won, roundInfo);
                
                let text = '';
                if (won) {
                    text = `<h2>🎉 晋级成功！</h2>`;
                    text += `<h3>${roundInfo.emoji} ${roundInfo.name}</h3>`;
                    text += setsDisplay;
                    text += `<p><strong>⭐ 出色表现！</strong></p>`;
                    text += `<p>你在比赛中发挥稳定，成功战胜对手，晋级下一轮！</p>`;
                } else {
                    text = `<h2>😔 遗憾出局</h2>`;
                    text += `<h3>${roundInfo.emoji} ${roundInfo.name}</h3>`;
                    text += setsDisplay;
                    text += `<p>虽然你努力拼搏，但对手更胜一筹。你的校际联赛之旅止步于此。</p>`;
                }
                
                // 显示奖励
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">`;
                text += `<p><strong>💫 比赛收获：</strong></p>`;
                text += `<div style="text-align: left; font-size: 14px;">`;
                
                // 只显示非零的技能奖励
                const hasSkillRewards = rewards.serve > 0 || rewards.spike > 0 || rewards.block > 0 || 
                                       rewards.dig > 0 || rewards.set > 0;
                
                if (hasSkillRewards) {
                    if (rewards.serve > 0) text += `🎯 发球 +${rewards.serve}<br>`;
                    if (rewards.spike > 0) text += `⚡ 扣球 +${rewards.spike}<br>`;
                    if (rewards.block > 0) text += `🛡️ 拦网 +${rewards.block}<br>`;
                    if (rewards.dig > 0) text += `🤸 垫球 +${rewards.dig}<br>`;
                    if (rewards.set > 0) text += `� 托球 +${rewards.set}<br>`;
                }
                
                // 声望、心情、压力始终显示（可能为负）
                if (rewards.reputation !== 0) text += `⭐ 声望 ${rewards.reputation > 0 ? '+' : ''}${rewards.reputation}<br>`;
                if (rewards.mood !== 0) text += `😊 心情 ${rewards.mood > 0 ? '+' : ''}${rewards.mood}<br>`;
                if (rewards.stress !== 0) text += `😰 压力 ${rewards.stress > 0 ? '+' : ''}${rewards.stress}<br>`;
                if (rewards.teamChemistry > 0) text += `🤝 全队默契 +${rewards.teamChemistry}<br>`;
                
                text += `</div></div>`;
                
                if (won) {
                    // 检查是否是决赛
                    if (!roundInfo.nextRound) {
                        // 决赛胜利：显示冠军祝贺
                        text += `<div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border-radius: 10px; border: 3px solid #ffd700;">`;
                        text += `<h3 style="color: #000; font-size: 24px; margin-bottom: 10px;">🏆 恭喜夺冠！🏆</h3>`;
                        text += `<p style="color: #333; font-size: 16px;">你战胜了所有对手，站上了最高领奖台！</p>`;
                        text += `<p style="color: #333; font-size: 16px;">从16强到冠军，你用实力证明了自己！</p>`;
                        text += `</div>`;
                    } else {
                        // 非决赛：显示进度更新
                        text += `<div style="margin: 20px 0;">`;
                        text += `<h3>🏆 锦标赛进度更新</h3>`;
                        text += `<p>✅ 已晋级：${this.tournament.roundsCompleted.length}轮`;
                        
                        const nextRoundInfo = this.TOURNAMENT_ROUNDS[roundInfo.nextRound];
                        text += ` （进入${nextRoundInfo.shortName}）</p>`;
                        text += `<p>📍 下一轮：${nextRoundInfo.name}</p>`;
                        text += `</div>`;
                        
                        text += this.renderTournamentProgress();
                    }
                } else {
                    // 淘汰：显示最终成绩
                    let rankText = '';
                    if (roundInfo.eliminationRank === 'top16') rankText = '16强';
                    else if (roundInfo.eliminationRank === 'top8') rankText = '8强';
                    else if (roundInfo.eliminationRank === 'top4') rankText = '4强';
                    else if (roundInfo.eliminationRank === 'runner_up') rankText = '亚军';
                    
                    text += `<div style="margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">`;
                    text += `<p><strong>🏆 最终成绩：${rankText}</strong></p>`;
                    text += `<p>"虽然结果不尽如人意，但你已经走到了这里。这是一个新的起点。"</p>`;
                    text += `</div>`;
                }
                
                // 创建结果场景
                const nextRoundId = roundInfo.nextRound;
                const self = this;
                
                SCENES.tournamentRoundResult = {
                    text: text,
                    choices: won ? [
                        {
                            text: nextRoundId ? '继续下一轮' : '查看结局',
                            next: nextRoundId ? null : this.getTournamentEnding(),
                            effect: nextRoundId ? Object.assign({}, rewards, {
                                callback: () => {
                                    self.startTournamentRound(nextRoundId);
                                }
                            }) : rewards
                        }
                    ] : [
                        {
                            text: '查看结局',
                            next: this.getTournamentEnding(),
                            effect: rewards
                        }
                    ]
                };
                
                this.showScene('tournamentRoundResult');
            }
            
            // 获取锦标赛轮次奖励
            getTournamentRoundRewards(won, roundInfo) {
                const rewards = {
                    serve: 0,
                    spike: 0,
                    block: 0,
                    dig: 0,
                    set: 0,
                    reputation: 0,
                    mood: 0,
                    stress: 0,
                    teamChemistry: 0  // 队友默契值
                };
                
                // 决赛阶段（第12周）不再给技能奖励，因为游戏即将结束
                // 只给心情和声望奖励作为荣誉
                const isFinalStage = roundInfo.id === 'final';
                
                if (won) {
                    if (!isFinalStage) {
                        // 非决赛：根据轮次递增技能奖励（进一步降低：3/4/5 → 2/2/3）
                        const baseReward = roundInfo.id === 'round16' ? 2 :
                                          roundInfo.id === 'round8' ? 2 :
                                          roundInfo.id === 'round4' ? 3 : 0;
                        
                        rewards.serve = rewards.spike = rewards.block = rewards.dig = rewards.set = baseReward;
                    }
                    // 决赛不给技能奖励（游戏即将结束，技能提升已无意义）
                    
                    // 所有轮次都给声望和心情奖励
                    const reputationBonus = isFinalStage ? 100 : // 决赛冠军：巨额声望
                                           roundInfo.id === 'round4' ? 50 :
                                           roundInfo.id === 'round8' ? 35 : 25;
                    
                    rewards.reputation = reputationBonus;
                    rewards.mood = isFinalStage ? 30 : 20; // 决赛胜利心情更高
                    rewards.stress = isFinalStage ? 5 : 10; // 决赛后压力较小（尘埃落定）
                    
                    // 队友默契值：根据轮次递增（越往后越难，默契提升越多）
                    const chemistryBonus = isFinalStage ? 25 :  // 决赛冠军：队友默契大幅提升
                                          roundInfo.id === 'round4' ? 15 :  // 半决赛：队友默契显著提升
                                          roundInfo.id === 'round8' ? 10 :  // 8强：队友默契提升
                                          8;  // 16强：队友默契小幅提升
                    
                    rewards.teamChemistry = chemistryBonus;
                } else {
                    // 失败：不给技能奖励（已经是最后阶段）
                    rewards.reputation = isFinalStage ? 50 : 10; // 决赛亚军也有不错的声望
                    rewards.mood = isFinalStage ? -10 : -15; // 决赛失败没那么沮丧（已经很棒了）
                    rewards.stress = 15;
                    rewards.teamChemistry = isFinalStage ? 10 : 3;  // 失败也有一定默契提升（共同经历）
                }
                
                return rewards;
            }
            
            // 获取锦标赛结局
            getTournamentEnding() {
                const rank = this.tournament.finalRank;
                
                if (rank === 'top16') return 'early_exit';
                else if (rank === 'top8' || rank === 'top4') return 'participant';
                else if (rank === 'runner_up') return 'runner_up';
                else return 'champion';  // 赢得决赛
            }
            
            // ====================================================
            // 结束锦标赛系统
            // ====================================================
            
            // ====================================================
            // 结局文本生成系统
            // ====================================================
            
            // 生成动态结局文本
            generateEndingText(endingType) {
                const stats = this.playerStats;
                const player = this.player;
                
                // 计算技能相关数据
                const skills = player.skills;
                const skillValues = [skills.serve, skills.spike, skills.block, skills.dig, skills.set];
                const avgSkill = Math.round(skillValues.reduce((a, b) => a + b, 0) / 5);
                const maxSkill = Math.max(...skillValues);
                const minSkill = Math.min(...skillValues);
                const maxSkillName = ['发球', '扣球', '拦网', '垫球', '托球'][skillValues.indexOf(maxSkill)];
                
                // 计算初始平均技能
                const initialSkillValues = Object.values(stats.initialSkills);
                const initialAvg = Math.round(initialSkillValues.reduce((a, b) => a + b, 0) / 5);
                const totalGrowth = avgSkill - initialAvg;
                
                // 生成主标题和副标题
                let mainTitle = '';
                let subTitle = '';
                
                switch(endingType) {
                    case 'champion':
                        mainTitle = '🏆 冠军之路';
                        break;
                    case 'runner_up':
                        mainTitle = '🥈 亚军荣耀';
                        break;
                    case 'participant':
                        mainTitle = '🏐 参与者';
                        break;
                    case 'early_exit':
                        mainTitle = '📖 新的开始';
                        break;
                }
                
                // 生成个性化称号
                const titles = [];
                if (stats.totalTrainings >= 30) titles.push('训练狂人');
                else if (stats.totalTrainings >= 25) titles.push('刻苦之星');
                else if (stats.totalTrainings < 10) titles.push('佛系玩家');
                
                if (stats.totalMoneySpent >= 5000) titles.push('土豪玩家');
                else if (stats.equipmentPurchased >= 5) titles.push('装备党');
                else if (player.money >= 3000) titles.push('理财高手');
                
                if (stats.casualMatchesPlayed >= 10 && stats.casualMatchesWon / stats.casualMatchesPlayed >= 0.7) {
                    titles.push('野球王者');
                }
                
                subTitle = titles.slice(0, 2).join(' · ') || '排球新星';
                
                // 生成文本
                let text = `<h2>${mainTitle}</h2>`;
                text += `<p style="color: #ffd700; font-size: 18px; margin-bottom: 20px;">${subTitle}</p>`;
                
                // 比赛回顾
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">`;
                text += `<h3>🏐 比赛回顾</h3>`;
                if (endingType === 'champion') {
                    text += `<p>校际联赛决赛，你们战胜对手，夺得冠军！</p>`;
                    text += `<p>从16强到冠军，你连续赢得4场比赛，展现了强大的实力。</p>`;
                } else if (endingType === 'runner_up') {
                    text += `<p>校际联赛决赛，你们拼尽全力，最终获得亚军。</p>`;
                    text += `<p>虽然有些遗憾，但你们已经创造了学校的最好成绩。</p>`;
                } else if (endingType === 'participant') {
                    text += `<p>校际联赛中，你们止步于四强。</p>`;
                    text += `<p>虽然没能走到最后，但这已经是很好的成绩了。</p>`;
                } else {
                    text += `<p>校际联赛首轮，你们遗憾出局。</p>`;
                    text += `<p>虽然结果不尽如人意，但这12周的经历让你收获良多。</p>`;
                }
                text += `</div>`;
                
                // 12周的排球生活
                text += `<div style="margin: 20px 0;">`;
                text += `<h3 style="color: #ffd700;">【12周的排球生活】</h3>`;
                
                // 训练历程
                text += `<div style="margin: 15px 0; padding: 12px; background: rgba(255,255,255,0.03); border-left: 3px solid #3b82f6; border-radius: 5px;">`;
                text += `<p><strong>📊 训练历程</strong></p>`;
                text += `<p>• 共进行了 ${stats.totalTrainings} 次训练</p>`;
                
                // 找出训练最多的技能
                const trainingTypes = stats.trainingByType;
                const maxTrainingType = Object.keys(trainingTypes).reduce((a, b) => 
                    trainingTypes[a] > trainingTypes[b] ? a : b
                );
                const typeNames = {serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球', composite: '组合'};
                if (trainingTypes[maxTrainingType] > 0) {
                    text += `<p>• 最专注于 ${typeNames[maxTrainingType]} 训练（${trainingTypes[maxTrainingType]}次）</p>`;
                }
                
                if (player.position !== 'none') {
                    const posName = this.positions[player.position]?.name || '未知';
                    text += `<p>• 选择了 ${posName} 作为主要位置</p>`;
                }
                
                // 特殊评价
                if (stats.totalTrainings >= 30) {
                    text += `<p style="color: #fbbf24;">你是个训练狂，几乎每周都在球场上挥汗如雨</p>`;
                } else if (stats.totalTrainings < 10) {
                    text += `<p style="color: #fbbf24;">你不是个训练狂，更注重享受过程</p>`;
                }
                text += `</div>`;
                
                // 比赛经历
                if (stats.casualMatchesPlayed > 0 || stats.formalMatchesPlayed > 0) {
                    text += `<div style="margin: 15px 0; padding: 12px; background: rgba(255,255,255,0.03); border-left: 3px solid #10b981; border-radius: 5px;">`;
                    text += `<p><strong>🏐 比赛经历</strong></p>`;
                    if (stats.casualMatchesPlayed > 0) {
                        const winRate = Math.round((stats.casualMatchesWon / stats.casualMatchesPlayed) * 100);
                        text += `<p>• 参加了 ${stats.casualMatchesPlayed} 场野球，胜率 ${winRate}%</p>`;
                        if (stats.casualMatchesPlayed >= 10 && winRate >= 70) {
                            text += `<p style="color: #fbbf24;">你是野球场的常客，在实战中快速成长</p>`;
                        } else if (stats.casualMatchesPlayed < 3) {
                            text += `<p style="color: #fbbf24;">你更喜欢正式比赛的氛围，很少打野球</p>`;
                        }
                    }
                    if (stats.formalMatchesPlayed > 0) {
                        text += `<p>• 正式比赛 ${stats.formalMatchesPlayed} 场，${stats.formalMatchesWon} 胜</p>`;
                    }
                    text += `</div>`;
                }
                
                // 消费记录
                if (stats.totalMoneySpent > 0) {
                    text += `<div style="margin: 15px 0; padding: 12px; background: rgba(255,255,255,0.03); border-left: 3px solid #f59e0b; border-radius: 5px;">`;
                    text += `<p><strong>💰 消费记录</strong></p>`;
                    text += `<p>• 总消费：${stats.totalMoneySpent} 元</p>`;
                    if (stats.equipmentPurchased > 0) text += `<p>• 购买装备：${stats.equipmentPurchased} 件</p>`;
                    if (stats.coachingPurchased > 0) text += `<p>• 私教课程：${stats.coachingPurchased} 次</p>`;
                    if (stats.entertainmentSpent > 0) text += `<p>• 娱乐消费：${stats.entertainmentSpent} 元</p>`;
                    
                    if (stats.totalMoneySpent >= 5000) {
                        text += `<p style="color: #fbbf24;">你舍得为自己投资，装备和私教一样不落</p>`;
                    } else if (player.money >= 3000) {
                        text += `<p style="color: #fbbf24;">你精打细算，结束时还有不少积蓄（剩余${player.money}元）</p>`;
                    }
                    text += `</div>`;
                }
                
                // 课余生活
                const hasLifeActivities = stats.gamesPlayed > 0 || stats.moviesWatched > 0 || 
                                         stats.socialEvents > 0 || stats.restTaken > 0;
                if (hasLifeActivities) {
                    text += `<div style="margin: 15px 0; padding: 12px; background: rgba(255,255,255,0.03); border-left: 3px solid #ec4899; border-radius: 5px;">`;
                    text += `<p><strong>🌈 课余生活</strong></p>`;
                    if (stats.gamesPlayed > 0) text += `<p>• 玩游戏 ${stats.gamesPlayed} 次</p>`;
                    if (stats.moviesWatched > 0) text += `<p>• 看动漫 ${stats.moviesWatched} 次</p>`;
                    if (stats.socialEvents > 0) {
                        text += `<p>• 社交活动 ${stats.socialEvents} 次</p>`;
                        // 显示队伍活动详情
                        const teamDinners = this.playerStats.lifeActivities?.teamDinner || 0;
                        const teamBuildings = this.playerStats.lifeActivities?.teamBuilding || 0;
                        if (teamDinners > 0) text += `<p style="margin-left: 20px; color: #95e1d3;">└ 队伍聚餐 ${teamDinners} 次</p>`;
                        if (teamBuildings > 0) text += `<p style="margin-left: 20px; color: #95e1d3;">└ 团建活动 ${teamBuildings} 次</p>`;
                    }
                    if (stats.restTaken > 0) text += `<p>• 休息放松 ${stats.restTaken} 次</p>`;
                    
                    // 生活方式评价
                    if (stats.gamesPlayed >= 8) {
                        text += `<p style="color: #fbbf24;">你是个游戏爱好者，经常在游戏中放松</p>`;
                    } else if (stats.moviesWatched >= 6) {
                        text += `<p style="color: #fbbf24;">你喜欢文艺活动，动漫网站是常去的地方</p>`;
                    } else if (stats.socialEvents >= 8) {
                        text += `<p style="color: #fbbf24;">你很注重人际关系，经常参加社交活动</p>`;
                    } else if (stats.restTaken >= 10) {
                        text += `<p style="color: #fbbf24;">你懂得休息的重要性，从不让自己过度疲劳</p>`;
                    } else if (stats.restTaken === 0 && stats.totalTrainings >= 25) {
                        text += `<p style="color: #fbbf24;">你是个工作狂，几乎没有休息时间</p>`;
                    } else if (hasLifeActivities) {
                        text += `<p style="color: #fbbf24;">你懂得劳逸结合，享受大学生活</p>`;
                    }
                    text += `</div>`;
                }
                
                // 技能成长
                text += `<div style="margin: 15px 0; padding: 12px; background: rgba(255,255,255,0.03); border-left: 3px solid #8b5cf6; border-radius: 5px;">`;
                text += `<p><strong>📈 技能成长</strong></p>`;
                text += `<p>• 最强技能：${maxSkillName}(${maxSkill})</p>`;
                text += `<p>• 从平均 ${initialAvg} 成长到 ${avgSkill}（提升${totalGrowth}点）</p>`;
                
                // 职业定位评价
                if (player.position !== 'none') {
                    const posName = this.positions[player.position]?.name || '未知';
                    const posLevel = player.positionLevel;
                    text += `<p>• 职业定位：${posName}`;
                    if (posLevel >= 3) {
                        text += ` <span style="color: #fbbf24;">（精通）</span>`;
                    } else if (posLevel >= 2) {
                        text += ` <span style="color: #60a5fa;">（熟练）</span>`;
                    } else {
                        text += ` <span style="color: #9ca3af;">（入门）</span>`;
                    }
                    text += `</p>`;
                }
                
                // 技能特长分析
                if (totalGrowth >= 60) {
                    text += `<p style="color: #fbbf24;">你的成长速度惊人，进步飞快！教练都对你刮目相看</p>`;
                } else if (totalGrowth >= 40) {
                    text += `<p style="color: #fbbf24;">你的进步稳健扎实，每一分努力都有回报</p>`;
                } else if (maxSkill - minSkill < 15) {
                    text += `<p style="color: #fbbf24;">你追求全面发展，各项技能都很均衡，是教练眼中的全能型选手</p>`;
                } else if (maxSkill >= 85) {
                    text += `<p style="color: #fbbf24;">你的${maxSkillName}技术出类拔萃，已经达到了专业水准，成为了你的招牌绝技</p>`;
                } else if (maxSkill >= 70) {
                    text += `<p style="color: #fbbf24;">你在${maxSkillName}上展现出了天赋，这是你的强项</p>`;
                }
                
                // 特殊技能成就
                const skillAchievements = [];
                if (skills.serve >= 80) skillAchievements.push('发球王者');
                if (skills.spike >= 80) skillAchievements.push('扣球高手');
                if (skills.block >= 80) skillAchievements.push('拦网铁壁');
                if (skills.dig >= 80) skillAchievements.push('防守大师');
                if (skills.set >= 80) skillAchievements.push('传球艺术家');
                
                if (skillAchievements.length > 0) {
                    text += `<p>• 特殊成就：${skillAchievements.join('、')}</p>`;
                }
                
                text += `</div>`;
                
                // 个人风格与成就
                text += `<div style="margin: 15px 0; padding: 12px; background: rgba(255,255,255,0.03); border-left: 3px solid #06b6d4; border-radius: 5px;">`;
                text += `<p><strong>🎯 个人风格</strong></p>`;
                
                // 训练风格
                if (stats.totalTrainings >= 30) {
                    text += `<p>• <span style="color: #fbbf24;">训练狂魔</span>：你几乎每周都在球场上挥汗如雨，这份执着让人敬佩</p>`;
                } else if (stats.totalTrainings >= 25) {
                    text += `<p>• <span style="color: #fbbf24;">刻苦训练者</span>：你深知"一分耕耘一分收获"的道理</p>`;
                } else if (stats.totalTrainings >= 20) {
                    text += `<p>• <span style="color: #fbbf24;">稳健型选手</span>：你保持着规律的训练节奏</p>`;
                } else if (stats.totalTrainings < 10) {
                    text += `<p>• <span style="color: #fbbf24;">佛系玩家</span>：你更注重享受过程而非结果</p>`;
                }
                
                // 实战风格
                if (stats.casualMatchesPlayed >= 10) {
                    const winRate = Math.round((stats.casualMatchesWon / stats.casualMatchesPlayed) * 100);
                    if (winRate >= 80) {
                        text += `<p>• <span style="color: #fbbf24;">野球王者</span>：野球场上你几乎无敌（胜率${winRate}%）</p>`;
                    } else if (winRate >= 60) {
                        text += `<p>• <span style="color: #fbbf24;">实战派</span>：你在野球场上积累了丰富的实战经验</p>`;
                    }
                } else if (stats.casualMatchesPlayed < 3 && stats.formalMatchesPlayed >= 5) {
                    text += `<p>• <span style="color: #fbbf24;">正统派</span>：你更喜欢正式比赛的氛围，追求规范的竞技体验</p>`;
                }
                
                // 消费风格
                if (stats.totalMoneySpent >= 5000) {
                    text += `<p>• <span style="color: #fbbf24;">投资型选手</span>：你舍得为自己投资，装备和私教一样不落</p>`;
                } else if (stats.equipmentPurchased >= 5) {
                    text += `<p>• <span style="color: #fbbf24;">装备党</span>：你相信好装备能带来更好的表现</p>`;
                } else if (player.money >= 3000) {
                    text += `<p>• <span style="color: #fbbf24;">理财高手</span>：你精打细算，结束时还有${player.money}元积蓄</p>`;
                } else if (stats.totalMoneySpent < 1000) {
                    text += `<p>• <span style="color: #fbbf24;">节俭派</span>：你把钱花在刀刃上，从不浪费</p>`;
                }
                
                // 生活方式
                const totalLifeActivities = stats.gamesPlayed + stats.moviesWatched + stats.socialEvents + stats.restTaken;
                if (totalLifeActivities >= 20) {
                    text += `<p>• <span style="color: #fbbf24;">生活家</span>：你深知劳逸结合的重要性，享受丰富多彩的大学生活</p>`;
                } else if (stats.restTaken === 0 && stats.totalTrainings >= 25) {
                    text += `<p>• <span style="color: #fbbf24;">拼命三郎</span>：你几乎没有休息时间，全身心投入训练</p>`;
                } else if (stats.gamesPlayed >= 8) {
                    text += `<p>• <span style="color: #fbbf24;">游戏达人</span>：你在游戏中找到了放松的方式</p>`;
                } else if (stats.moviesWatched >= 6) {
                    text += `<p>• <span style="color: #fbbf24;">文艺青年</span>：动漫网站是你常去的地方，你享受光影带来的感动</p>`;
                } else if (stats.socialEvents >= 8) {
                    text += `<p>• <span style="color: #fbbf24;">社交达人</span>：你很注重人际关系，朋友遍布校园</p>`;
                }
                
                text += `</div>`;
                
                text += `</div>`;
                
                // 队友羁绊总结
                if (this.teammates && this.teammates.length > 0) {
                    text += this.generateTeammateBondSummary();
                }
                
                // 结语
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,215,0,0.1); border-radius: 10px;">`;
                if (endingType === 'champion') {
                    text += `<p><strong>🎉 完美结局：冠军之星 🎉</strong></p>`;
                    text += `<p>你用汗水和努力铸就了冠军之路。省队教练已经向你发出邀请，更大的舞台在等着你...</p>`;
                } else if (endingType === 'runner_up') {
                    text += `<p><strong>🎊 优秀结局：不屈之心 🎊</strong></p>`;
                    text += `<p>虽然没能夺冠，但你证明了自己的实力。失败让你更加坚强！</p>`;
                } else if (endingType === 'participant') {
                    text += `<p><strong>🎈 良好结局：成长之路 🎈</strong></p>`;
                    text += `<p>虽然没能走到最后，但你收获了技术、友谊和成长。排球之路还很长！</p>`;
                } else {
                    text += `<p><strong>🌱 普通结局：初心不改 🌱</strong></p>`;
                    text += `<p>虽然这次没能走得更远，但你已经迈出了第一步。继续努力，总有一天你会站上领奖台！</p>`;
                }
                text += `<p><strong>感谢游玩！</strong></p>`;
                text += `</div>`;
                
                return text;
            }
            
            // 生成队友羁绊总结
            generateTeammateBondSummary() {
                let text = '';
                
                text += `<div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%); border-radius: 10px; border: 2px solid #667eea;">`;
                text += `<h3 style="color: #667eea; margin-top: 0;">👥 队友羁绊回忆录</h3>`;
                
                // 统计友谊赛次数
                const friendlyMatchCount = this.playerStats.friendlyMatch || 0;
                
                // 找出默契最高的队友（前3名）
                const sortedTeammates = [...this.teammates].sort((a, b) => b.chemistry - a.chemistry);
                const topTeammates = sortedTeammates.slice(0, Math.min(3, sortedTeammates.length));
                
                // 统计解锁的技能
                const unlockedSkills = this.player.unlockedSkills || [];
                const totalSkills = unlockedSkills.length;
                const maxLevelSkills = unlockedSkills.filter(s => s.level === 3).length;
                
                // 计算平均默契
                const avgChemistry = Math.round(this.teammates.reduce((sum, t) => sum + t.chemistry, 0) / this.teammates.length);
                
                // 开场白
                if (this.player.team === 'university') {
                    text += `<p style="line-height: 1.8; color: #333;">从院队到校队，你和${this.teammates.length}名队友并肩作战，共同经历了${friendlyMatchCount}场友谊赛的磨练。</p>`;
                } else {
                    text += `<p style="line-height: 1.8; color: #333;">在院队的日子里，你和${this.teammates.length}名队友并肩作战，共同经历了${friendlyMatchCount}场友谊赛的磨练。</p>`;
                }
                
                // 最佳搭档
                text += `<div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 8px;">`;
                text += `<h4 style="color: #667eea; margin-top: 0;">⭐ 最佳搭档</h4>`;
                
                for (let i = 0; i < topTeammates.length; i++) {
                    const teammate = topTeammates[i];
                    const posInfo = this.positions[teammate.position];
                    const rank = ['🥇', '🥈', '🥉'][i];
                    
                    // 默契等级描述
                    let chemDesc = '';
                    if (teammate.chemistry >= 95) {
                        chemDesc = '心有灵犀，配合完美无瑕';
                    } else if (teammate.chemistry >= 85) {
                        chemDesc = '默契十足，几乎不需要语言交流';
                    } else if (teammate.chemistry >= 70) {
                        chemDesc = '配合默契，能够互相理解';
                    } else if (teammate.chemistry >= 50) {
                        chemDesc = '相互熟悉，配合渐入佳境';
                    } else {
                        chemDesc = '还在磨合中，但已建立信任';
                    }
                    
                    // 找出与这个队友的技能
                    const skillsWithTeammate = unlockedSkills.filter(s => s.teammateId === teammate.id);
                    let skillText = '';
                    if (skillsWithTeammate.length > 0) {
                        const skillNames = skillsWithTeammate.map(s => {
                            const skillDef = this.COMBO_SKILLS[s.skillKey];
                            return `${skillDef.name}(Lv.${s.level})`;
                        }).join('、');
                        skillText = `<br><span style="color: #f39c12;">⚡ 配合技能：${skillNames}</span>`;
                    }
                    
                    text += `<p style="margin: 10px 0; line-height: 1.6;">`;
                    text += `${rank} <strong>${teammate.name}</strong>（${posInfo.name}）<br>`;
                    text += `<span style="color: #666; font-size: 14px;">默契度 ${teammate.chemistry} - ${chemDesc}${skillText}</span>`;
                    text += `</p>`;
                }
                
                text += `</div>`;
                
                // 配合技能统计
                if (totalSkills > 0) {
                    text += `<div style="margin: 15px 0; padding: 15px; background: rgba(255,215,0,0.1); border-radius: 8px;">`;
                    text += `<h4 style="color: #f39c12; margin-top: 0;">⚡ 配合技能成就</h4>`;
                    text += `<p style="line-height: 1.8; color: #333;">`;
                    text += `你们共同解锁了<strong style="color: #f39c12;">${totalSkills}个</strong>配合技能`;
                    if (maxLevelSkills > 0) {
                        text += `，其中<strong style="color: #ffd700;">${maxLevelSkills}个</strong>达到了最高等级`;
                    }
                    text += `。这些技能在关键时刻为你们赢得了无数分数。`;
                    text += `</p>`;
                    
                    // 显示所有技能
                    const skillsByLevel = { 3: [], 2: [], 1: [] };
                    for (let skill of unlockedSkills) {
                        const skillDef = this.COMBO_SKILLS[skill.skillKey];
                        const teammate = this.teammates.find(t => t.id === skill.teammateId);
                        if (skillDef && teammate) {
                            skillsByLevel[skill.level].push({
                                name: skillDef.name,
                                emoji: skillDef.emoji,
                                teammate: teammate.name,
                                triggerCount: skill.triggerCount || 0
                            });
                        }
                    }
                    
                    for (let level = 3; level >= 1; level--) {
                        if (skillsByLevel[level].length > 0) {
                            const levelColor = ['#667eea', '#9b59b6', '#ffd700'][level - 1];
                            text += `<div style="margin: 10px 0;">`;
                            text += `<strong style="color: ${levelColor};">Lv.${level} 技能：</strong><br>`;
                            for (let skill of skillsByLevel[level]) {
                                text += `<span style="font-size: 14px; color: #666; margin-left: 10px;">`;
                                text += `${skill.emoji} ${skill.name}（与${skill.teammate}）`;
                                if (skill.triggerCount > 0) {
                                    text += ` - 触发${skill.triggerCount}次`;
                                }
                                text += `<br>`;
                                text += `</span>`;
                            }
                            text += `</div>`;
                        }
                    }
                    
                    text += `</div>`;
                }
                
                // 团队氛围
                text += `<div style="margin: 15px 0; padding: 15px; background: rgba(46, 204, 113, 0.1); border-radius: 8px;">`;
                text += `<h4 style="color: #2ecc71; margin-top: 0;">🏐 团队氛围</h4>`;
                text += `<p style="line-height: 1.8; color: #333;">`;
                
                if (avgChemistry >= 85) {
                    text += `队伍平均默契度达到了<strong style="color: #2ecc71;">${avgChemistry}</strong>，这是一支心有灵犀的团队。你们不仅是队友，更是并肩作战的战友。场上的每一次眼神交流，都能准确传达彼此的意图。`;
                } else if (avgChemistry >= 70) {
                    text += `队伍平均默契度<strong style="color: #3498db;">${avgChemistry}</strong>，你们已经建立了深厚的信任。虽然偶尔还会有小摩擦，但大家都知道，这支队伍的目标是一致的。`;
                } else if (avgChemistry >= 50) {
                    text += `队伍平均默契度<strong style="color: #f39c12;">${avgChemistry}</strong>，你们正在逐渐磨合。每个人都在努力理解队友，团队氛围越来越好。`;
                } else {
                    text += `队伍平均默契度<strong style="color: #95a5a6;">${avgChemistry}</strong>，虽然还在磨合期，但大家都在为共同的目标努力。时间会让你们变得更加默契。`;
                }
                
                text += `</p>`;
                text += `</div>`;
                
                // 难忘回忆
                text += `<div style="margin: 15px 0; padding: 15px; background: rgba(155, 89, 182, 0.1); border-radius: 8px;">`;
                text += `<h4 style="color: #9b59b6; margin-top: 0;">💭 难忘回忆</h4>`;
                
                const memories = [];
                
                if (friendlyMatchCount >= 10) {
                    memories.push(`你们一起打了${friendlyMatchCount}场友谊赛，每一场都是成长的见证`);
                } else if (friendlyMatchCount >= 5) {
                    memories.push(`${friendlyMatchCount}场友谊赛让你们从陌生走向熟悉`);
                } else if (friendlyMatchCount > 0) {
                    memories.push(`虽然只打了${friendlyMatchCount}场友谊赛，但每一场都很珍贵`);
                }
                
                if (totalSkills >= 5) {
                    memories.push(`解锁的${totalSkills}个配合技能，是你们默契的最好证明`);
                } else if (totalSkills > 0) {
                    memories.push(`第一次触发配合技能时，大家都激动得欢呼起来`);
                }
                
                if (this.player.team === 'university') {
                    const keptCount = sortedTeammates.filter(t => t.chemistry >= 80).length;
                    if (keptCount > 0) {
                        memories.push(`从院队一起升入校队的${keptCount}名队友，是最珍贵的伙伴`);
                    }
                }
                
                if (avgChemistry >= 85) {
                    memories.push(`训练后一起吃夜宵，比赛前互相鼓励，这些日常点滴构成了最美好的回忆`);
                }
                
                if (memories.length > 0) {
                    text += `<ul style="line-height: 1.8; color: #333; margin: 10px 0; padding-left: 20px;">`;
                    memories.forEach(memory => {
                        text += `<li>${memory}</li>`;
                    });
                    text += `</ul>`;
                } else {
                    text += `<p style="line-height: 1.8; color: #333;">虽然相处时间不长，但你们已经建立了队友之间的信任。</p>`;
                }
                
                text += `</div>`;
                
                // 结语
                text += `<p style="text-align: center; margin-top: 20px; font-style: italic; color: #667eea;">`;
                text += `"排球是六个人的运动，感谢有你们一起并肩作战！"`;
                text += `</p>`;
                
                text += `</div>`;
                
                return text;
            }
            
            // ====================================================
            // 隐藏结局文本生成系统
            // ====================================================
            
            // 隐藏结局1：旁观者
            generateBystanderEndingText() {
                const stats = this.playerStats;
                const player = this.player;
                
                let text = `<h2>🎭 隐藏结局：旁观者</h2>`;
                text += `<div style="margin: 20px 0; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px;">`;
                
                text += `<h3 style="color: #fbbf24;">【第5周 - 院际比赛日】</h3>`;
                text += `<p>体育馆里人声鼎沸，院际排球联赛正在进行。你站在观众席上，看着场上挥洒汗水的队员们，心中五味杂陈。</p>`;
                text += `<p>"如果当初我加入了院队..."你想起了开学时的那些机会。</p>`;
                text += `<br>`;
                
                text += `<p>第1周，学长学姐热情地邀请你参加选拔，你说"再看看"。</p>`;
                text += `<p>第2周，你在训练和其他事情之间犹豫不决。</p>`;
                text += `<p>第3周，你想着"还有时间"。</p>`;
                text += `<p>第4周，选拔窗口关闭了。</p>`;
                text += `<br>`;
                
                text += `<p>现在，比赛开始了，而你只能在场边观看。</p>`;
                text += `<p>场上的队员们配合默契，每一次扣球、每一次拦网都让观众欢呼。你意识到，排球不仅仅是个人技术，更是团队的运动。</p>`;
                text += `<br>`;
                
                text += `<p style="color: #fbbf24; font-weight: bold;">"下次，我一定不会再错过机会。"你暗暗发誓。</p>`;
                text += `</div>`;
                
                // 数据回顾
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">`;
                text += `<h3>📊 你的5周排球生活</h3>`;
                text += `<p>虽然没能参加比赛，但你也有自己的收获：</p>`;
                text += `<ul style="text-align: left; margin-left: 20px; line-height: 1.8;">`;
                text += `<li>训练了 ${stats.totalTrainings} 次，技能有所提升</li>`;
                if (stats.casualMatchesPlayed > 0) {
                    text += `<li>打了 ${stats.casualMatchesPlayed} 场野球，积累了实战经验</li>`;
                }
                text += `<li>结识了一些排球爱好者</li>`;
                text += `</ul>`;
                text += `<br>`;
                text += `<p>但你错过了最重要的东西：</p>`;
                text += `<ul style="text-align: left; margin-left: 20px; line-height: 1.8; color: #e74c3c;">`;
                text += `<li>❌ 没有加入正式队伍</li>`;
                text += `<li>❌ 没有参加院际比赛</li>`;
                text += `<li>❌ 没有体验团队的力量</li>`;
                text += `</ul>`;
                text += `</div>`;
                
                // 教练的话
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,215,0,0.1); border-radius: 10px;">`;
                text += `<h3>💡 教练的话</h3>`;
                text += `<p>"排球是一项需要把握机会的运动。场上的机会稍纵即逝，人生的机会也是如此。"</p>`;
                text += `<br>`;
                text += `<p>"不过，失败不是终点，而是新的起点。下次，记得抓住机会。"</p>`;
                text += `</div>`;
                
                // 结局标识
                text += `<div style="margin: 20px 0; padding: 20px; background: rgba(231,76,60,0.2); border: 2px solid #e74c3c; border-radius: 10px; text-align: center;">`;
                text += `<h3 style="color: #e74c3c;">🔄 隐藏结局：旁观者</h3>`;
                text += `<p style="color: #fbbf24;">成就解锁：【错过的机会】</p>`;
                text += `<br>`;
                text += `<p>这不是你想要的结局，对吗？</p>`;
                text += `<p><strong>重新开始，这次不要犹豫！</strong></p>`;
                text += `</div>`;
                
                return text;
            }
            
            // 隐藏结局2：独行者
            generateLonerEndingText() {
                const stats = this.playerStats;
                const player = this.player;
                
                // 计算技能数据
                const skills = player.skills;
                const skillValues = [skills.serve, skills.spike, skills.block, skills.dig, skills.set];
                const avgSkill = Math.round(skillValues.reduce((a, b) => a + b, 0) / 5);
                const maxSkill = Math.max(...skillValues);
                const maxSkillName = ['发球', '扣球', '拦网', '垫球', '托球'][skillValues.indexOf(maxSkill)];
                
                let text = `<h2>🚶 隐藏结局：独行者</h2>`;
                text += `<div style="margin: 20px 0; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px;">`;
                
                text += `<h3 style="color: #fbbf24;">【第12周 - 校际联赛开幕】</h3>`;
                text += `<p>全校最盛大的体育赛事——校际排球联赛拉开帷幕。校队队员们身穿统一的队服，在开幕式上接受全校师生的欢呼。</p>`;
                text += `<br>`;
                text += `<p>你站在人群中，看着那些熟悉的身影。他们中有些人的技术不如你，但他们站在了那个舞台上。</p>`;
                text += `</div>`;
                
                // 根据玩家情况生成不同文案
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">`;
                text += `<h3>📖 回顾这12周</h3>`;
                text += `<p>你选择了一条不同的道路：</p>`;
                text += `<br>`;
                
                // 根据队伍状态
                if (player.team === 'college') {
                    text += `<p style="color: #3b82f6;">你加入了院队，参加了院际比赛，但最终没能进入校队。</p>`;
                    text += `<p>也许是技术还不够，也许是表现不够出色，也许只是运气不好。但你已经比很多人走得更远了。</p>`;
                } else {
                    text += `<p style="color: #3b82f6;">你选择了独自训练，在野球场上磨练技术。</p>`;
                    text += `<p>你享受了自由，但也错过了团队的温暖和正式比赛的舞台。排球是团队运动，下次试试加入队伍吧。</p>`;
                }
                text += `<br>`;
                
                // 根据技能水平
                if (avgSkill >= 70) {
                    text += `<p style="color: #10b981;">你的技术其实已经很不错了（平均技能：${avgSkill}），但排球不只是技术，还需要团队、机会和时机。</p>`;
                    text += `<p>也许是错过了关键的比赛，也许是没有把握住机会。下次，记得在正确的时间做正确的事。</p>`;
                } else if (avgSkill >= 50) {
                    text += `<p style="color: #f59e0b;">你的技术还算不错（平均技能：${avgSkill}），但还有提升的空间。</p>`;
                    text += `<p>继续努力训练，同时也要注重团队合作和比赛经验的积累。</p>`;
                } else {
                    text += `<p style="color: #ef4444;">你的技术还有很大的提升空间（平均技能：${avgSkill}）。</p>`;
                    text += `<p>也许是训练不够刻苦，也许是方法不够正确。下次，试着更加专注和努力。</p>`;
                }
                text += `<br>`;
                
                // 根据训练次数
                if (stats.totalTrainings >= 30) {
                    text += `<p style="color: #8b5cf6;">你非常刻苦，训练了${stats.totalTrainings}次，几乎每周都在球场上挥汗如雨。</p>`;
                    text += `<p>但排球不只是训练，还需要实战、团队和比赛经验。下次，试着多参加比赛，在实战中成长。</p>`;
                } else if (stats.totalTrainings < 10) {
                    text += `<p style="color: #ec4899;">你的训练次数较少（${stats.totalTrainings}次），也许是时间分配的问题，也许是其他原因。</p>`;
                    text += `<p>要想在排球上有所成就，刻苦训练是必不可少的。</p>`;
                }
                text += `</div>`;
                
                // 感悟
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">`;
                text += `<h3>💭 你的感悟</h3>`;
                text += `<p>站在人群中，你想起了这12周的点点滴滴：</p>`;
                text += `<ul style="text-align: left; margin-left: 20px; line-height: 1.8;">`;
                text += `<li>第一次接触排球时的青涩</li>`;
                text += `<li>每一次训练后的汗水</li>`;
                if (stats.casualMatchesPlayed > 0) {
                    text += `<li>野球场上的欢笑和挫折</li>`;
                }
                if (player.team === 'college') {
                    text += `<li>那场院际比赛的激动</li>`;
                }
                text += `<li>以及，那些错过的机会...</li>`;
                text += `</ul>`;
                text += `<br>`;
                text += `<p>你没有站上校际联赛的舞台，但你收获了：</p>`;
                text += `<ul style="text-align: left; margin-left: 20px; line-height: 1.8; color: #2ecc71;">`;
                text += `<li>✓ 对排球的热爱</li>`;
                text += `<li>✓ 技能的提升（从 ${stats.initialSkills.serve} 到 ${avgSkill}）</li>`;
                text += `<li>✓ 对自己的认识</li>`;
                text += `<li>✓ 对团队运动的理解</li>`;
                text += `</ul>`;
                text += `</div>`;
                
                // 学期结束
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">`;
                text += `<h3>🎓 学期结束</h3>`;
                text += `<p>学期结束了，你的大一排球之旅也告一段落。</p>`;
                text += `<br>`;
                text += `<p>虽然没能实现"排球之星"的梦想，但你并不后悔。这12周的经历让你成长了许多，也让你明白了很多道理。</p>`;
                text += `<br>`;
                text += `<p>也许下学期，你会更加努力。也许你会选择其他的道路。但无论如何，这段经历都将成为你珍贵的回忆。</p>`;
                text += `</div>`;
                
                // 最终数据
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">`;
                text += `<h3>📊 最终数据</h3>`;
                text += `<ul style="text-align: left; margin-left: 20px; line-height: 1.8;">`;
                text += `<li>训练次数：${stats.totalTrainings}</li>`;
                text += `<li>比赛场次：${stats.casualMatchesPlayed}（野球）+ ${stats.formalMatchesPlayed}（正式）</li>`;
                text += `<li>最高技能：${maxSkillName}(${maxSkill})</li>`;
                text += `<li>总消费：${stats.totalMoneySpent}元</li>`;
                text += `<li>声望：${player.reputation}</li>`;
                text += `</ul>`;
                text += `</div>`;
                
                // 教练的寄语
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,215,0,0.1); border-radius: 10px;">`;
                text += `<h3>🌟 教练的寄语</h3>`;
                text += `<p>"每个人都有自己的节奏和道路。你没能进入校队，但这不代表你失败了。"</p>`;
                text += `<br>`;
                text += `<p>"排球教会我们的，不只是如何赢得比赛，更是如何面对挫折，如何坚持梦想。"</p>`;
                text += `<br>`;
                text += `<p>"记住这12周的经历，它们会让你变得更强。下次，你一定能做得更好。"</p>`;
                text += `</div>`;
                
                // 结局标识
                text += `<div style="margin: 20px 0; padding: 20px; background: rgba(100,116,139,0.2); border: 2px solid #64748b; border-radius: 10px; text-align: center;">`;
                text += `<h3 style="color: #94a3b8;">🔄 隐藏结局：独行者</h3>`;
                text += `<p style="color: #fbbf24;">成就解锁：【另一条路】</p>`;
                text += `<br>`;
                text += `<p>这是一段不完美但真实的旅程。</p>`;
                text += `<p><strong>想要不同的结局吗？重新开始吧！</strong></p>`;
                text += `</div>`;
                
                return text;
            }
            
            // 隐藏结局3：替补席
            generateBenchwarmerEndingText() {
                const stats = this.playerStats;
                const player = this.player;
                
                let text = `<h2>🪑 隐藏结局：替补席</h2>`;
                text += `<div style="margin: 20px 0; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px;">`;
                
                text += `<h3 style="color: #fbbf24;">【第5周 - 院际比赛日】</h3>`;
                text += `<p>体育馆里人声鼎沸，院际排球联赛即将开始。你穿着院队的队服，坐在替补席上。</p>`;
                text += `<p>教练看了看你，又看了看其他队员，最终摇了摇头："你还没有确定自己的位置，今天先观摩学习吧。"</p>`;
                text += `<br>`;
                
                text += `<p>你加入了院队，参加了训练，但从未真正融入这个团队。</p>`;
                text += `<p>队友们在场上挥洒汗水，你却只能坐在板凳上。不是因为技术不够，而是因为你从未真正决定自己要打什么位置。</p>`;
                text += `<br>`;
                
                text += `<p>第1周，你成功加入了院队，大家都很欢迎你。</p>`;
                text += `<p>第2周，教练问你想打什么位置，你说"再想想"。</p>`;
                text += `<p>第3周，队友们开始练习配合，你还在犹豫。</p>`;
                text += `<p>第4周，教练再次询问，你说"下周一定决定"。</p>`;
                text += `<p>第5周，比赛来了，而你还没有自己的位置。</p>`;
                text += `<br>`;
                
                text += `<p>场上的队员们配合默契，二传精准传球，主攻强力扣杀，副攻及时拦网，自由人稳定防守...</p>`;
                text += `<p>每个人都有自己的位置，每个人都知道自己该做什么。</p>`;
                text += `<p>而你，坐在替补席上，看着他们创造奇迹。</p>`;
                text += `<br>`;
                
                text += `<p style="color: #fbbf24; font-weight: bold;">"如果我早点选择自己的位置..."你心想，"也许现在在场上的就是我了。"</p>`;
                text += `</div>`;
                
                // 数据回顾
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">`;
                text += `<h3>📊 你的5周院队生活</h3>`;
                text += `<ul style="text-align: left; margin-left: 20px; line-height: 1.8;">`;
                text += `<li>✅ 成功加入了院队</li>`;
                text += `<li>✅ 训练了 ${stats.totalTrainings} 次</li>`;
                text += `<li>✅ 技能有所提升</li>`;
                text += `<li>❌ 但从未选择场上位置</li>`;
                text += `<li>❌ 没有和队友建立配合</li>`;
                text += `<li>❌ 错过了院际比赛</li>`;
                text += `</ul>`;
                text += `</div>`;
                
                // 教练的话
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px;">`;
                text += `<h3 style="color: #667eea;">💬 教练的话</h3>`;
                text += `<p style="line-height: 1.8; font-style: italic;">"排球是团队运动，每个位置都很重要。但更重要的是，你要知道自己想成为什么样的球员。"</p>`;
                text += `<p style="line-height: 1.8; font-style: italic;">"犹豫不决，永远无法在场上找到自己的位置。"</p>`;
                text += `<p style="line-height: 1.8; font-style: italic;">"下次，早点做决定吧。"</p>`;
                text += `</div>`;
                
                // 队友的反应
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(155, 89, 182, 0.1); border-radius: 10px;">`;
                text += `<h3 style="color: #9b59b6;">👥 队友们</h3>`;
                text += `<p style="line-height: 1.8;">比赛结束后，队友们围过来：</p>`;
                text += `<p style="line-height: 1.8; font-style: italic;">"下次比赛，你一定要上场啊！"</p>`;
                text += `<p style="line-height: 1.8; font-style: italic;">"快点决定位置吧，我们需要你！"</p>`;
                text += `<p style="line-height: 1.8; font-style: italic;">"你的技术不错，就是太犹豫了。"</p>`;
                text += `<p style="line-height: 1.8;">他们没有责怪你，但你能感受到他们的期待和遗憾。</p>`;
                text += `</div>`;
                
                // 反思
                text += `<div style="margin: 20px 0; padding: 15px; background: rgba(231, 76, 60, 0.1); border-radius: 10px;">`;
                text += `<h3 style="color: #e74c3c;">💭 反思</h3>`;
                text += `<p style="line-height: 1.8;">你意识到：</p>`;
                text += `<ul style="text-align: left; margin-left: 20px; line-height: 1.8; color: #e74c3c;">`;
                text += `<li>加入队伍只是第一步</li>`;
                text += `<li>选择位置才能真正融入团队</li>`;
                text += `<li>犹豫不决会错过机会</li>`;
                text += `<li>排球需要明确的分工和配合</li>`;
                text += `<li>每个位置都有自己的价值</li>`;
                text += `</ul>`;
                text += `</div>`;
                
                // 结局标识
                text += `<div style="margin: 20px 0; padding: 20px; background: rgba(243, 156, 18, 0.2); border: 2px solid #f39c12; border-radius: 10px; text-align: center;">`;
                text += `<h3 style="color: #f39c12;">🔄 隐藏结局：替补席</h3>`;
                text += `<p style="color: #fbbf24;">成就解锁：【犹豫不决】</p>`;
                text += `<br>`;
                text += `<p>你有实力，有机会，但缺少决断。</p>`;
                text += `<p><strong>重新开始，这次早点选择你的位置！</strong></p>`;
                text += `</div>`;
                
                return text;
            }
            
            // ====================================================
            // 结束隐藏结局文本生成系统
            // ====================================================
            
            randomName() {
                const randomName = generateRandomName();
                const nameInput = document.getElementById('player-name-input');
                if (nameInput) {
                    nameInput.value = randomName;
                    // 添加一个小动画效果
                    nameInput.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        nameInput.style.transform = 'scale(1)';
                    }, 200);
                }
            }
            
            rerollAttributes() {
                if (this.rerollsRemaining <= 0) {
                    return;
                }
                
                this.rerollsRemaining--;
                this.rollAttributes();
                this.updateInitialSkillsDisplay();
                
                // 更新周开始数据快照（因为重新随机了初始值）
                this.player.weekStartStats = {
                    serve: this.player.skills.serve,
                    spike: this.player.skills.spike,
                    block: this.player.skills.block,
                    dig: this.player.skills.dig,
                    set: this.player.skills.set,
                    maxEnergy: this.player.maxEnergy
                };
                
                // 更新剩余次数显示
                const rerollCount = document.getElementById('reroll-count');
                const rerollBtn = document.getElementById('reroll-btn');
                if (rerollCount) {
                    rerollCount.textContent = `剩余次数：${this.rerollsRemaining}/5`;
                }
                if (rerollBtn && this.rerollsRemaining <= 0) {
                    rerollBtn.disabled = true;
                    rerollBtn.textContent = '已用完';
                }
            }
            
            updateInitialSkillsDisplay() {
                const initServe = document.getElementById('init-serve');
                const initSpike = document.getElementById('init-spike');
                const initBlock = document.getElementById('init-block');
                const initDig = document.getElementById('init-dig');
                const initSet = document.getElementById('init-set');
                const initEnergy = document.getElementById('init-energy');
                const initMoney = document.getElementById('init-money');
                
                // 只有当元素存在时才更新（避免在非名字输入界面时报错）
                if (initServe) initServe.textContent = this.player.skills.serve;
                if (initSpike) initSpike.textContent = this.player.skills.spike;
                if (initBlock) initBlock.textContent = this.player.skills.block;
                if (initDig) initDig.textContent = this.player.skills.dig;
                if (initSet) initSet.textContent = this.player.skills.set;
                if (initEnergy) initEnergy.textContent = this.player.maxEnergy;
                if (initMoney) initMoney.textContent = this.player.money;
            }
            
            submitName() {
                const nameInput = document.getElementById('player-name-input');
                const name = nameInput.value.trim();
                
                if (name === '') {
                    alert('请输入你的名字！');
                    return;
                }
                
                this.player.name = name;
                // 不要再次调用 rollAttributes()，因为属性已经在 init() 时生成
                // 只需要更新 UI 即可
                
                // 测试模式下隐藏重新随机按钮
                if (TEST_MODE) {
                    const rerollContainer = document.getElementById('reroll-container');
                    if (rerollContainer) {
                        rerollContainer.style.display = 'none';
                    }
                    console.log('测试模式已启用，初始技能:', this.player.skills);
                }
                
                // 初始化周开始数据快照
                this.player.weekStartStats = {
                    serve: this.player.skills.serve,
                    spike: this.player.skills.spike,
                    block: this.player.skills.block,
                    dig: this.player.skills.dig,
                    set: this.player.skills.set,
                    maxEnergy: this.player.maxEnergy
                };
                
                // 更新 UI（使用当前已有的属性）
                this.updateUI();
                
                // 显示能力面板和游戏头部
                document.getElementById('character-panel').classList.add('show');
                document.getElementById('game-header').classList.add('show');
                
                // 直接进入游戏开始场景
                this.currentScene = 'start';
                this.showScene('start');
            }
            
            rollAttributes() {
                // 测试模式下跳过随机生成
                if (TEST_MODE) {
                    console.log('测试模式：跳过随机属性生成');
                    this.updateUI();
                    this.updateInitialSkillsDisplay();
                    return;
                }
                
                // 使用更平衡的随机算法
                // 总点数固定在20-25之间，然后分配到5个技能
                const totalPoints = Math.floor(Math.random() * 6) + 20; // 20-25点
                let remainingPoints = totalPoints;
                const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                
                // 先给每个技能分配最少1点
                skills.forEach(skill => {
                    this.player.skills[skill] = 1;
                    remainingPoints -= 1;
                });
                
                // 随机分配剩余点数
                while (remainingPoints > 0) {
                    const randomSkill = skills[Math.floor(Math.random() * skills.length)];
                    if (this.player.skills[randomSkill] < 8) { // 单项最高8
                        this.player.skills[randomSkill]++;
                        remainingPoints--;
                    }
                }
                
                // 随机生成体力上限，范围在85-105之间（更集中）
                this.player.maxEnergy = Math.floor(Math.random() * 21) + 85;
                this.player.energy = this.player.maxEnergy;
                
                // 随机生成初始金钱，范围在400-600之间
                this.player.money = Math.floor(Math.random() * 201) + 400;
                
                this.updateUI();
                this.updateInitialSkillsDisplay();
            }
            
            updateWeeklyHub() {
                const canTrain = this.player.trainingCount < this.player.maxTrainingPerWeek;
                const trainingText = canTrain ? 
                    `本周还可以训练 ${this.player.maxTrainingPerWeek - this.player.trainingCount} 次` :
                    `本周训练次数已用完`;
                
                let statusText = '';
                if (this.player.energy < 30) statusText += '<p style="color: #e74c3c;">⚠️ 体力不足，需要休息！</p>';
                if (this.player.mood < 40) statusText += '<p style="color: #e67e22;">⚠️ 心情低落，建议放松一下</p>';
                if (this.player.stress > 70) statusText += '<p style="color: #e74c3c;">⚠️ 压力过大，小心影响表现！</p>';
                
                // 周初提示（第2周开始显示）
                let weekStartNotice = '';
                if (this.player.week > 1 && this.player.trainingCount === 0 && !this.weekStartNoticeShown) {
                    const allowance = this.player.weeklyAllowance || 120;
                    console.log(`周初提示 - 周数:${this.player.week}, 队伍:${this.player.team}, 零花钱:${allowance}, 院队提示已显示:${this.player.collegeAllowanceNoticeShown}`);
                    
                    weekStartNotice = `<p style="color: #2ecc71; background: rgba(46, 204, 113, 0.1); padding: 10px; border-radius: 5px; margin: 10px 0;">💰 获得本周零花钱 +${allowance}元，💪 体力恢复到满值</p>`;
                    
                    // 队友成长提示
                    if (this.teammateWeeklyGrowth && this.teammateWeeklyGrowth.length > 0) {
                        let teammateGrowthHTML = '<div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #667eea;">';
                        teammateGrowthHTML += '<p style="color: #667eea; font-weight: bold; margin-bottom: 8px;">👥 队友本周成长</p>';
                        
                        for (let record of this.teammateWeeklyGrowth) {
                            const skillNames = { serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球' };
                            const skillGrowthText = Object.entries(record.skillGrowth)
                                .map(([skill, growth]) => `${skillNames[skill]}+${growth}`)
                                .join('、');
                            
                            teammateGrowthHTML += `<p style="color: #333; font-size: 14px; margin: 5px 0;">`;
                            teammateGrowthHTML += `<strong>${record.name}</strong>: ${skillGrowthText}`;
                            if (record.chemistryGrowth > 0) {
                                teammateGrowthHTML += `，默契+${record.chemistryGrowth}`;
                            }
                            teammateGrowthHTML += `</p>`;
                        }
                        
                        teammateGrowthHTML += '</div>';
                        weekStartNotice += teammateGrowthHTML;
                    }
                    
                    // 首次加入院队后的特殊提示（第2周或第3周，刚加入院队）
                    if ((this.player.week === 2 || this.player.week === 3) && this.player.team === 'college' && allowance === 150 && !this.player.collegeAllowanceNoticeShown) {
                        console.log('显示院队零花钱提示');
                        weekStartNotice += '<p style="color: #ffd700; background: rgba(255, 215, 0, 0.1); padding: 10px; border-radius: 5px; margin: 10px 0;">�  父母得知你加入院队后很高兴：<br>「太好了！以后每周多给你30元零花钱，好好训练！」<br><strong>每周零花钱：120元 → 150元</strong></p>';
                        this.player.collegeAllowanceNoticeShown = true;
                    }
                    
                    // 首次加入校队后的特殊提示
                    if (this.player.team === 'university' && allowance === 200 && !this.player.universityAllowanceNoticeShown) {
                        console.log('显示校队零花钱提示');
                        weekStartNotice += '<p style="color: #ffd700; background: rgba(255, 215, 0, 0.1); padding: 10px; border-radius: 5px; margin: 10px 0;">🌟 父母得知你进入校队后激动不已：<br>「居然进了校队！爸妈为你骄傲！以后每周给你200元，需要什么尽管说！」<br><strong>每周零花钱：150元 → 200元</strong></p>';
                        this.player.universityAllowanceNoticeShown = true;
                    }
                    
                    this.weekStartNoticeShown = true;
                }
                
                // 检查是否到达目标周
                const goalInfo = this.getGoalInfo();
                let goalNotice = '';
                
                if (goalInfo.deadline && this.player.week >= goalInfo.deadline) {
                    goalNotice = '<p style="color: #2ecc71; font-weight: bold;">✨ 选拔/比赛时间已到！</p>';
                }
                
                SCENES.weeklyHub.text = `<h2>📅 第 ${this.player.week} 周</h2>
                ${weekStartNotice}
                <p>${trainingText}</p>
                ${statusText}
                ${goalNotice}
                <p style="margin-top: 15px;">你想做什么？</p>`;
                
                // 根据队伍状态决定训练场景
                let trainingScene = 'trainingChoice'; // 默认基础训练
                if (this.player.team === 'university') {
                    trainingScene = 'universityTeam';
                } else if (this.player.team === 'college') {
                    trainingScene = 'collegeTeam';
                }
                
                SCENES.weeklyHub.choices = [
                    {
                        text: '🏋️ 进行训练',
                        next: trainingScene,
                        requirement: { trainingCount: this.player.maxTrainingPerWeek - 1, maxCheck: true }
                    },
                    {
                        text: '🛒 学校商店',
                        next: 'shopMain'
                    },
                    {
                        text: '⏭️ 结束本周',
                        next: 'weekEnd'
                    }
                ];
                
                // 如果已加入队伍且选择了位置，显示队友入口
                if ((this.player.team === 'college' || this.player.team === 'university') && this.player.position !== 'none') {
                    SCENES.weeklyHub.choices.splice(SCENES.weeklyHub.choices.length - 1, 0, {
                        text: '👥 我的队友',
                        next: 'teammates'
                    });
                }
                
                // 如果已加入队伍但还没选择位置，添加位置选择入口
                if ((this.player.team === 'college' || this.player.team === 'university') && this.player.position === 'none') {
                    SCENES.weeklyHub.choices.splice(SCENES.weeklyHub.choices.length - 1, 0, {
                        text: '🎯 选择场上位置',
                        next: 'positionSelection'
                    });
                }
                
                // 如果有足够的技能，添加选拔选项（只保留选拔，不包括比赛）
                // 根据当前目标和周数添加选拔选项
                if (this.currentGoal === 'collegeTryout' && this.player.week >= 2 && this.player.team === 'none') {
                    // 使用新的评估系统检查是否满足条件
                    const goalInfo = this.getGoalInfo();
                    const evaluation = this.evaluateGoal(goalInfo);
                    const canTryout = evaluation.score >= 0.7; // 70%即可参加
                    
                    SCENES.weeklyHub.choices.splice(SCENES.weeklyHub.choices.length - 1, 0, {
                        text: '🏆 参加院队选拔',
                        next: 'collegeTryout',
                        requirement: canTryout ? {} : { serve: 999 } // 如果满足条件则无要求，否则设置不可能达到的要求
                    });
                } else if (this.currentGoal === 'universityTryout' && this.player.week >= 8 && this.player.team === 'college') {
                    const goalInfo = this.getGoalInfo();
                    const evaluation = this.evaluateGoal(goalInfo);
                    
                    // 校队选拔必须所有条件都达标（不是加权平均）
                    const skillCountPassed = evaluation.breakdown.skillCount?.details?.progress >= 1.0;
                    const skillSumPassed = evaluation.breakdown.skillSum?.details?.progress >= 1.0;
                    const reputationPassed = evaluation.breakdown.stats?.details?.reputation?.progress >= 1.0;
                    const canTryout = skillCountPassed && skillSumPassed && reputationPassed;
                    
                    SCENES.weeklyHub.choices.splice(SCENES.weeklyHub.choices.length - 1, 0, {
                        text: '⭐ 申请校队选拔',
                        next: 'universityTryout',
                        requirement: canTryout ? {} : { serve: 999 }
                    });
                }
                
                // 比赛会在固定周数自动触发，不需要按钮
            }
            
            triggerRandomEvent(eventType) {
                // 30% 概率触发事件
                if (Math.random() > 0.3) {
                    return null;
                }
                
                // 筛选符合类型的事件
                let availableEvents = RANDOM_EVENTS.filter(e => e.type === eventType);
                if (availableEvents.length === 0) return null;
                
                // 根据条件和权重计算每个事件的触发概率
                const weightedEvents = [];
                availableEvents.forEach(event => {
                    let weight = 1; // 默认权重
                    
                    // 检查是否满足条件
                    if (event.condition) {
                        const { operator } = event.condition;
                        let conditionMet = false;
                        
                        // 支持多属性条件检查
                        if (operator === '<') {
                            // 小于条件（如体力<30）
                            for (let key in event.condition) {
                                if (key !== 'operator' && this.player[key] !== undefined) {
                                    if (this.player[key] < event.condition[key]) {
                                        conditionMet = true;
                                        break;
                                    }
                                }
                            }
                        } else if (operator === '>') {
                            // 大于条件（如声望>50）
                            let allMet = true;
                            for (let key in event.condition) {
                                if (key !== 'operator' && this.player[key] !== undefined) {
                                    if (this.player[key] <= event.condition[key]) {
                                        allMet = false;
                                        break;
                                    }
                                }
                                // 检查技能
                                if (key !== 'operator' && this.player.skills && this.player.skills[key] !== undefined) {
                                    if (this.player.skills[key] <= event.condition[key]) {
                                        allMet = false;
                                        break;
                                    }
                                }
                            }
                            conditionMet = allMet;
                        }
                        
                        // 如果条件不满足，跳过此事件
                        if (!conditionMet) {
                            return; // 跳过此事件，不加入候选列表
                        }
                        
                        // 条件满足，应用权重加成
                        if (event.weight) {
                            weight = event.weight;
                        }
                    }
                    
                    // 护膝护腕降低受伤事件权重
                    const injuryEvents = ['injury_risk', 'serious_injury'];
                    if (injuryEvents.includes(event.id) && this.player.ownedItems?.protection) {
                        const resistPercent = this.player.ownedItems.protection.injuryResist || 0;
                        weight = weight * (1 - resistPercent / 100);
                        console.log(`护膝护腕降低受伤事件权重: ${event.id}, 调整后权重: ${weight.toFixed(2)}`);
                    }
                    
                    // 将事件按权重添加到列表中
                    for (let i = 0; i < weight; i++) {
                        weightedEvents.push(event);
                    }
                });
                
                if (weightedEvents.length === 0) return null;
                
                // 从加权列表中随机选择一个事件
                const event = weightedEvents[Math.floor(Math.random() * weightedEvents.length)];
                return event;
            }
            
            showRandomEvent(event) {
                this.currentEvent = event;
                this.currentEventType = event.type; // 记录事件类型
                
                // 使用弹窗显示事件
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                // 确保元素存在
                if (!modal || !title || !text || !choicesDiv) {
                    console.error('Modal elements not found');
                    return;
                }
                
                // 重置弹窗状态，确保可以显示
                modal.style.display = '';
                modal.classList.remove('show');
                
                title.textContent = event.title;
                text.textContent = event.text;
                choicesDiv.innerHTML = '';
                
                event.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    
                    if (choice.requirement) {
                        const meetsRequirement = this.checkRequirement(choice.requirement);
                        if (!meetsRequirement) {
                            button.disabled = true;
                            button.textContent += ' (条件不足)';
                        }
                    }
                    
                    button.onclick = () => {
                        // 应用效果
                        if (choice.effect) {
                            this.applyEffect(choice.effect);
                        }
                        
                        // 在弹窗中显示结果
                        title.textContent = '✨ 结果';
                        text.innerHTML = this.formatEventResult(choice.result, choice.effect);
                        choicesDiv.innerHTML = '';
                        
                        const continueBtn = document.createElement('button');
                        continueBtn.className = 'choice-btn';
                        continueBtn.textContent = '继续';
                        continueBtn.onclick = () => {
                            modal.classList.remove('show');
                            
                            // 根据事件类型决定下一步
                            if (this.currentEventType === 'training') {
                                // 训练事件后进入课余生活
                                this.currentScene = 'lifeChoice';
                                this.showScene('lifeChoice');
                            } else {
                                // 生活事件后返回周选择
                                this.currentScene = 'weeklyHub';
                                this.showScene('weeklyHub');
                            }
                        };
                        choicesDiv.appendChild(continueBtn);
                    };
                    
                    choicesDiv.appendChild(button);
                });
                
                // 显示弹窗
                modal.classList.add('show');
            }
            
            formatEventResult(result, effect) {
                let html = `<p>${result}</p>`;
                
                // 构建属性变化显示
                let changesText = '<br><strong>属性变化：</strong><br>';
                let hasChanges = false;
                
                if (effect.serve) {
                    changesText += `🎯 发球 ${effect.serve > 0 ? '+' : ''}${effect.serve}<br>`;
                    hasChanges = true;
                }
                if (effect.spike) {
                    changesText += `⚡ 扣球 ${effect.spike > 0 ? '+' : ''}${effect.spike}<br>`;
                    hasChanges = true;
                }
                if (effect.block) {
                    changesText += `🛡️ 拦网 ${effect.block > 0 ? '+' : ''}${effect.block}<br>`;
                    hasChanges = true;
                }
                if (effect.dig) {
                    changesText += `🤸 垫球 ${effect.dig > 0 ? '+' : ''}${effect.dig}<br>`;
                    hasChanges = true;
                }
                if (effect.set) {
                    changesText += `🙌 托球 ${effect.set > 0 ? '+' : ''}${effect.set}<br>`;
                    hasChanges = true;
                }
                if (effect.energy) {
                    changesText += `💪 体力 ${effect.energy > 0 ? '+' : ''}${effect.energy}<br>`;
                    hasChanges = true;
                }
                if (effect.mood) {
                    changesText += `😊 心情 ${effect.mood > 0 ? '+' : ''}${effect.mood}<br>`;
                    hasChanges = true;
                }
                if (effect.stress) {
                    changesText += `😰 压力 ${effect.stress > 0 ? '+' : ''}${effect.stress}<br>`;
                    hasChanges = true;
                }
                if (effect.reputation) {
                    changesText += `⭐ 声望 ${effect.reputation > 0 ? '+' : ''}${effect.reputation}<br>`;
                    hasChanges = true;
                }
                if (effect.money) {
                    changesText += `💰 金钱 ${effect.money > 0 ? '+' : ''}${effect.money}<br>`;
                    hasChanges = true;
                }
                if (effect.relationship) {
                    changesText += `👥 队友关系 ${effect.relationship > 0 ? '+' : ''}${effect.relationship}<br>`;
                    hasChanges = true;
                }
                if (effect.teamChemistry) {
                    changesText += `🤝 全队默契 ${effect.teamChemistry > 0 ? '+' : ''}${effect.teamChemistry}<br>`;
                    hasChanges = true;
                }
                if (effect.teammateChemistry && effect.teammateChemistry.random) {
                    changesText += `💫 随机队友默契 ${effect.teammateChemistry.random > 0 ? '+' : ''}${effect.teammateChemistry.random}<br>`;
                    hasChanges = true;
                }
                
                if (hasChanges) {
                    html += changesText;
                }
                
                return html;
            }
            
            // 刮刮乐系统
            buyScratchCard(checkAdventure = false) {
                // 追踪刮刮乐活动
                this.trackLifeActivity('scratchCard');
                
                // 执行抽奖
                const result = this.scratchCardDraw();
                
                // 显示结果弹窗（传入是否需要检查奇遇事件）
                this.showScratchCardResult(result, checkAdventure);
            }
            
            scratchCardDraw(boostedLuck = false) {
                let random = Math.random() * 100;
                
                // 如果是神秘老人赠送的刮刮乐，提高中奖概率
                if (boostedLuck) {
                    // 谢谢惠顾概率降到10%
                    if (random >= 70) {
                        random = random * 0.625; // 将70-100映射到0-18.75
                    }
                }
                
                let result;
                if (random < 2) {
                    // 特等奖 2%
                    result = {
                        level: 'grand',
                        name: '特等奖',
                        icon: '🏆',
                        rewards: { money: 800, mood: 40, reputation: 20 },
                        message: '恭喜中特等奖！大奖！'
                    };
                    // 追踪特等奖次数
                    this.playerStats.scratchCardJackpots = (this.playerStats.scratchCardJackpots || 0) + 1;
                } else if (random < 10) {
                    // 一等奖 8%
                    result = {
                        level: 'first',
                        name: '一等奖',
                        icon: '🥇',
                        rewards: { money: 300, mood: 25, reputation: 12 },
                        message: '恭喜中一等奖！'
                    };
                } else if (random < 25) {
                    // 二等奖 15%
                    result = {
                        level: 'second',
                        name: '二等奖',
                        icon: '🥈',
                        rewards: { money: 150, mood: 18, reputation: 5 },
                        message: '恭喜中二等奖！'
                    };
                } else if (random < 50) {
                    // 三等奖 25%
                    result = {
                        level: 'third',
                        name: '三等奖',
                        icon: '🥉',
                        rewards: { money: 80, mood: 12 },
                        message: '恭喜中三等奖！'
                    };
                } else if (random < 70) {
                    // 安慰奖 20%
                    result = {
                        level: 'consolation',
                        name: '安慰奖',
                        icon: '🎁',
                        rewards: { money: 40, mood: 8 },
                        message: '获得安慰奖'
                    };
                } else {
                    // 谢谢惠顾 30%
                    result = {
                        level: 'nothing',
                        name: '谢谢惠顾',
                        icon: '😅',
                        rewards: { mood: 3 },
                        message: '谢谢惠顾'
                    };
                }
                
                return result;
            }
            
            showScratchCardResult(result, checkAdventure = false) {
                // 应用奖励
                if (result.rewards.money) {
                    this.player.money += result.rewards.money;
                }
                if (result.rewards.mood) {
                    this.player.mood = Math.min(100, this.player.mood + result.rewards.mood);
                }
                if (result.rewards.reputation) {
                    this.player.reputation += result.rewards.reputation;
                }
                
                // 更新统计
                if (!this.playerStats.scratchCards) {
                    this.playerStats.scratchCards = {
                        total: 0,
                        grand: 0,
                        first: 0,
                        second: 0,
                        third: 0,
                        consolation: 0,
                        nothing: 0,
                        totalSpent: 0,
                        totalEarned: 0
                    };
                }
                this.playerStats.scratchCards.total++;
                this.playerStats.scratchCards[result.level]++;
                this.playerStats.scratchCards.totalSpent += 30;
                this.playerStats.scratchCards.totalEarned += (result.rewards.money || 0);
                
                // 构建奖励文本
                let rewardsText = '';
                if (result.rewards.money) rewardsText += `💰 金钱 +${result.rewards.money}<br>`;
                if (result.rewards.mood) rewardsText += `😊 心情 +${result.rewards.mood}<br>`;
                if (result.rewards.reputation) rewardsText += `⭐ 声望 +${result.rewards.reputation}<br>`;
                
                if (rewardsText === '') {
                    rewardsText = '再接再厉！<br>下次一定能中奖！';
                }
                
                // 显示弹窗
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                const modalContent = document.getElementById('event-modal-content');
                
                // 确保所有元素存在
                if (!modal || !title || !text || !choicesDiv || !modalContent) {
                    console.error('Modal elements not found');
                    return;
                }
                
                // 重置modal的display样式（可能被奇遇事件设置为none）
                modal.style.display = '';
                
                // 设置样式类
                modalContent.className = `scratch-card-result scratch-${result.level}-prize`;
                
                // 设置内容
                title.innerHTML = `<div class="scratch-card-icon">${result.icon}</div>`;
                text.innerHTML = `<h2 class="scratch-card-title">${result.message}</h2>
                    <div class="scratch-card-rewards">${rewardsText}</div>`;
                
                choicesDiv.innerHTML = '';
                const continueBtn = document.createElement('button');
                continueBtn.className = 'choice-btn scratch-card-close';
                continueBtn.textContent = '确定';
                continueBtn.onclick = () => {
                    modal.classList.remove('show');
                    modal.style.display = ''; // 重置display
                    modalContent.className = ''; // 重置样式
                    
                    // 如果需要检查奇遇事件
                    if (checkAdventure) {
                        const hasEvent = this.checkSpecificAdventureEvent('scratchCard');
                        if (hasEvent) {
                            // 触发了奇遇事件，不返回周选择（奇遇事件会处理）
                            return;
                        }
                    }
                    
                    // 返回周选择
                    this.currentScene = 'weeklyHub';
                    this.showScene('weeklyHub');
                };
                choicesDiv.appendChild(continueBtn);
                
                // 更新UI
                this.updateUI();
                
                // 显示弹窗
                modal.classList.add('show');
            }
            
            // 排球点击小游戏
            startVolleyballClickGame() {
                // 创建游戏容器（外层遮罩）
                const gameContainer = document.createElement('div');
                gameContainer.className = 'volleyball-game-container';
                
                // 创建弹窗内容
                gameContainer.innerHTML = `
                    <div class="volleyball-game-modal">
                        <div class="volleyball-game-hint"><span class="hint-time">20秒</span>内点击更多的排球！</div>
                        <div class="volleyball-game-countdown" id="vb-countdown">
                            <div class="countdown-number">3</div>
                        </div>
                        <div class="volleyball-game-header" style="opacity: 0;">
                            <div>⏱️ <span id="vb-timer">20</span>秒</div>
                            <div>💰 <span id="vb-money">0</span>元</div>
                            <div id="vb-combo-display">连击 <span id="vb-combo">0</span></div>
                        </div>
                        <button class="volleyball-game-skip" id="vb-skip-btn" style="opacity: 0;">跳过</button>
                        <div class="volleyball-game-grid" id="vb-grid" style="opacity: 0;">
                            ${Array(16).fill('<div class="volleyball-game-cell"></div>').join('')}
                        </div>
                    </div>
                `;
                document.body.appendChild(gameContainer);
                
                // 获取元素
                const countdownEl = document.getElementById('vb-countdown');
                const headerEl = gameContainer.querySelector('.volleyball-game-header');
                const gridEl = document.getElementById('vb-grid');
                const skipBtn = document.getElementById('vb-skip-btn');
                const cells = gameContainer.querySelectorAll('.volleyball-game-cell');
                const timerEl = document.getElementById('vb-timer');
                const moneyEl = document.getElementById('vb-money');
                const comboEl = document.getElementById('vb-combo');
                const comboDisplay = document.getElementById('vb-combo-display');
                
                // 倒计时动画
                let countdownNum = 3;
                const countdownInterval = setInterval(() => {
                    countdownNum--;
                    if (countdownNum > 0) {
                        countdownEl.querySelector('.countdown-number').textContent = countdownNum;
                        countdownEl.querySelector('.countdown-number').style.animation = 'none';
                        setTimeout(() => {
                            countdownEl.querySelector('.countdown-number').style.animation = 'countdownPulse 1s ease-out';
                        }, 10);
                    } else {
                        countdownEl.querySelector('.countdown-number').textContent = '开始！';
                        countdownEl.querySelector('.countdown-number').style.fontSize = '48px';
                        countdownEl.querySelector('.countdown-number').style.animation = 'countdownPulse 0.5s ease-out';
                        setTimeout(() => {
                            countdownEl.style.display = 'none';
                            headerEl.style.opacity = '1';
                            gridEl.style.opacity = '1';
                            skipBtn.style.opacity = '1';
                            startGame();
                        }, 500);
                        clearInterval(countdownInterval);
                    }
                }, 1000);
                
                // 开始游戏的函数
                const startGame = () => {
                    // 游戏状态
                    const gameState = {
                        timeLeft: 20,
                        money: 0,
                        combo: 0,
                        maxCombo: 0,
                        hits: 0,
                        misses: 0,
                        totalClicks: 0,
                        isRunning: true,
                        activeItems: new Set()
                    };
                    
                    // 声明定时器变量
                    let spawnInterval, timerInterval;
                    
                    // 跳过按钮点击事件
                    skipBtn.onclick = () => {
                        if (!gameState.isRunning) return;
                        
                        gameState.isRunning = false;
                        clearInterval(spawnInterval);
                        clearInterval(timerInterval);
                        
                        // 立即结束游戏，使用当前得分
                        this.endVolleyballClickGame(gameContainer, gameState);
                    };
                    
                    // 物品类型定义
                    const items = {
                        volleyball: { emoji: '🏐', reward: () => 2 + Math.floor(Math.random() * 2), weight: 100 },
                        plate: { emoji: '⚪', penalty: -2, weight: 30 },
                        basketball: { emoji: '🏀', penalty: -4, weight: 25 },
                        football: { emoji: '⚽', penalty: -2, weight: 20 },
                        baseball: { emoji: '⚾', penalty: -3, weight: 15 },
                        moon: { emoji: '🌕', penalty: -2, weight: 10 }
                    };
                    
                    // 更新连击显示
                    const updateComboDisplay = () => {
                        comboEl.textContent = gameState.combo;
                        if (gameState.combo >= 5) {
                            comboDisplay.classList.add('volleyball-game-combo');
                        } else {
                            comboDisplay.classList.remove('volleyball-game-combo');
                        }
                    };
                    
                    // 显示反馈动画
                    const showFeedback = (cell, text, isPositive) => {
                        const feedback = document.createElement('div');
                        feedback.className = `volleyball-game-feedback ${isPositive ? 'feedback-positive' : 'feedback-negative'}`;
                        feedback.textContent = text;
                        feedback.style.left = '50%';
                        feedback.style.top = '50%';
                        feedback.style.transform = 'translate(-50%, -50%)';
                        cell.appendChild(feedback);
                        setTimeout(() => feedback.remove(), 1000);
                    };
                    
                    // 生成随机物品
                    const spawnItem = () => {
                        if (!gameState.isRunning) return;
                        
                        // 找到空闲的格子
                        const availableCells = Array.from(cells).filter((_, index) => !gameState.activeItems.has(index));
                        if (availableCells.length === 0) return;
                        
                        const cell = availableCells[Math.floor(Math.random() * availableCells.length)];
                        const cellIndex = Array.from(cells).indexOf(cell);
                        
                        // 根据时间调整难度
                        let isVolleyball = Math.random() < 0.6; // 60%概率是排球
                        
                        let itemType, itemData;
                        if (isVolleyball) {
                            itemType = 'volleyball';
                            itemData = items.volleyball;
                        } else {
                            // 选择干扰物品
                            const distractors = ['plate', 'basketball', 'football', 'baseball', 'moon'];
                            const weights = distractors.map(d => items[d].weight);
                            const totalWeight = weights.reduce((a, b) => a + b, 0);
                            let random = Math.random() * totalWeight;
                            
                            for (let i = 0; i < distractors.length; i++) {
                                random -= weights[i];
                                if (random <= 0) {
                                    itemType = distractors[i];
                                    itemData = items[itemType];
                                    break;
                                }
                            }
                        }
                        
                        // 显示物品
                        cell.innerHTML = `<span class="volleyball-game-item">${itemData.emoji}</span>`;
                        gameState.activeItems.add(cellIndex);
                        
                        // 设置点击事件
                        const clickHandler = () => {
                            if (!gameState.activeItems.has(cellIndex)) return;
                            
                            gameState.totalClicks++;
                            gameState.activeItems.delete(cellIndex);
                            cell.innerHTML = '';
                            cell.removeEventListener('click', clickHandler);
                            
                            if (itemType === 'volleyball') {
                                // 点击排球
                                gameState.hits++;
                                gameState.combo++;
                                if (gameState.combo > gameState.maxCombo) {
                                    gameState.maxCombo = gameState.combo;
                                }
                                
                                let reward = itemData.reward();
                                
                                // 连击加成
                                if (gameState.combo >= 11) {
                                    reward += 4;
                                } else if (gameState.combo >= 6) {
                                    reward += 2;
                                } else if (gameState.combo >= 3) {
                                    reward += 1;
                                }
                                
                                gameState.money += reward;
                                moneyEl.textContent = gameState.money;
                                updateComboDisplay();
                                showFeedback(cell, `+${reward}元`, true);
                            } else {
                                // 点击干扰物品
                                gameState.misses++;
                                gameState.combo = 0;
                                gameState.money += itemData.penalty;
                                moneyEl.textContent = gameState.money;
                                updateComboDisplay();
                                showFeedback(cell, `${itemData.penalty}元`, false);
                                
                                // 轻微震动效果
                                gameContainer.style.animation = 'none';
                                setTimeout(() => {
                                    gameContainer.style.animation = '';
                                }, 10);
                            }
                        };
                        
                        cell.addEventListener('click', clickHandler);
                        
                        // 物品停留时间（延长）
                        const lifetime = 1200 + Math.random() * 600; // 1.2-1.8秒
                        setTimeout(() => {
                            if (gameState.activeItems.has(cellIndex)) {
                                gameState.activeItems.delete(cellIndex);
                                cell.innerHTML = '';
                                cell.removeEventListener('click', clickHandler);
                                
                                // 漏掉排球，连击中断
                                if (itemType === 'volleyball') {
                                    gameState.combo = 0;
                                    updateComboDisplay();
                                }
                            }
                        }, lifetime);
                    };
                    
                    // 游戏循环 - 生成物品
                    spawnInterval = setInterval(() => {
                        if (!gameState.isRunning) {
                            clearInterval(spawnInterval);
                            return;
                        }
                        spawnItem();
                    }, 600); // 每0.6秒生成一个物品
                    
                    // 倒计时
                    timerInterval = setInterval(() => {
                        gameState.timeLeft--;
                        timerEl.textContent = gameState.timeLeft;
                        
                        if (gameState.timeLeft <= 0) {
                            clearInterval(timerInterval);
                            clearInterval(spawnInterval);
                            gameState.isRunning = false;
                            
                            // 游戏结束
                            setTimeout(() => {
                                this.endVolleyballClickGame(gameContainer, gameState);
                            }, 500);
                        }
                    }, 1000);
                }; // 结束 startGame 函数
            }
            
            // 结束排球点击小游戏
            endVolleyballClickGame(gameContainer, gameState) {
                // 移除游戏容器
                gameContainer.remove();
                
                // 确保金钱不为负
                const finalMoney = Math.max(0, gameState.money);
                
                // 计算命中率
                const accuracy = gameState.totalClicks > 0 
                    ? Math.round((gameState.hits / gameState.totalClicks) * 100) 
                    : 0;
                
                // 应用奖励
                this.player.money += finalMoney;
                this.player.mood = Math.min(100, this.player.mood + 10);
                this.player.stress = Math.max(0, this.player.stress - 8);
                this.player.energy = Math.max(0, this.player.energy - 3);
                
                // 更新统计
                if (!this.playerStats.lifeActivities) {
                    this.playerStats.lifeActivities = {};
                }
                if (!this.playerStats.lifeActivities.game) {
                    this.playerStats.lifeActivities.game = 0;
                }
                this.playerStats.lifeActivities.game++;
                
                // 评价等级
                let rating = '';
                if (finalMoney >= 40 && accuracy >= 90) {
                    rating = '火眼金睛！🔥';
                } else if (finalMoney >= 30) {
                    rating = '眼疾手快！⚡';
                } else if (finalMoney >= 20) {
                    rating = '反应不错！👍';
                } else if (finalMoney >= 10) {
                    rating = '继续练习！💪';
                } else {
                    rating = '多看看排球长啥样吧~😅';
                }
                
                // 显示结果
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                title.textContent = '🎮 游戏结束！';
                text.innerHTML = `
                    <div style="text-align: center; line-height: 2;">
                        <h3 style="color: #ffd700; margin-bottom: 15px;">${rating}</h3>
                        <p><strong>💰 总收入：</strong>+${finalMoney}元</p>
                        <p><strong>🔥 最高连击：</strong>${gameState.maxCombo}次</p>
                        <p><strong>🎯 命中率：</strong>${accuracy}% (${gameState.hits}/${gameState.totalClicks})</p>
                        <p><strong>❌ 失误：</strong>${gameState.misses}次</p>
                    </div>
                `;
                
                choicesDiv.innerHTML = '';
                const continueBtn = document.createElement('button');
                continueBtn.className = 'choice-btn';
                continueBtn.textContent = '确定';
                continueBtn.onclick = () => {
                    modal.classList.remove('show');
                    
                    // 检查奇遇事件
                    const hasEvent = this.checkAdventureEvents();
                    if (hasEvent) {
                        return;
                    }
                    
                    // 返回周选择
                    this.currentScene = 'weeklyHub';
                    this.showScene('weeklyHub');
                };
                choicesDiv.appendChild(continueBtn);
                
                // 更新UI并显示弹窗
                this.updateUI();
                modal.classList.add('show');
            }
            
            // 排球少年剧情系统
            showHaikyuuEpisode() {
                // 100段排球少年风格的原创剧情（扩写版）
                const episodes = [
                    "日向翔阳第一次在电视上看到'小巨人'的比赛，被他在球场上的飞翔身姿深深震撼。尽管身高只有170cm，小巨人却能在高大的拦网手面前自由扣球，那种不屈的精神和惊人的弹跳力让日向热血沸腾。从那一刻起，日向心中燃起了排球的梦想，他发誓要成为像小巨人一样的选手，用实力证明身高不是限制。他开始疯狂地练习跳跃，每天在家附近的山坡上跑步，为了那个遥远却清晰的梦想而努力。",
                    "影山飞雄在初中时期被队友称为'球场上的国王'，他的传球精准无比，技术远超同龄人，但过于严苛的要求和独断专行的作风让队友们渐渐疏远。决赛中，当他需要队友配合时，却发现没有人愿意接他的球，所有人都选择了回避。那一刻，影山第一次体会到孤独的滋味，他站在空荡荡的球场上，看着对手庆祝胜利，内心充满了迷茫和痛苦。这次失败让他开始反思，也许技术不是排球的全部，团队的信任才是最重要的。",
                    "乌野高中排球部面临废部危机，曾经的强豪如今只剩下5名成员，连正式比赛都凑不齐人数。新教练武田一铁为了重振球队，四处奔走寻找新队员，他拜访每一个有潜力的学生，用真诚和热情打动他们。虽然屡次碰壁，但武田老师从未放弃，他相信乌野的荣光终将重现。他的执着和热情，让大家看到了希望的曙光，也让这支濒临解散的球队重新燃起了斗志。正是这份不放弃的精神，为乌野的复兴埋下了种子。",
                    "日向和影山第一次配合快攻，虽然失败了无数次，但他们都不愿放弃。影山惊讶地发现，这个矮个子有着惊人的弹跳力和对球的执着，他的眼神中充满了对排球的纯粹热爱。日向则被影山精准的传球所震撼，那种完美的弧线和时机把握，是他从未见过的。两人在体育馆里反复练习，从天亮练到天黑，汗水浸湿了球衣，手掌磨出了水泡，但他们的眼神却越来越坚定。这种化学反应开始萌芽，预示着一对传奇搭档的诞生。",
                    "月岛萤对排球持冷淡态度，他认为努力不一定有回报，与其全力以赴后失败，不如一开始就不抱期待。他用冷嘲热讽来掩饰内心的恐惧，用理性的分析来逃避情感的投入。但在看到前辈们拼尽全力的比赛后，看到他们即使落后也不放弃，即使受伤也要站起来，他内心的防线开始松动。那些汗水、泪水和不屈的呐喊，让他开始质疑自己的人生哲学。也许，全力以赴本身就是一种意义，也许，真正的失败是从未尝试过。",
                    "菅原孝支作为三年级的二传手，在影山加入后失去了正选位置。看着比自己年轻、技术更好的后辈站在球场上，他的心中不可能没有失落。但他没有嫉妒，没有抱怨，反而全力支持后辈成长，在训练中给予指导，在比赛中加油鼓劲。他明白，球队的胜利比个人的荣誉更重要，前辈的责任就是为后辈铺路。他的成熟和包容，成为球队的精神支柱，也让年轻队员们学会了什么是真正的团队精神。",
                    "西谷夕在防守训练中展现了惊人的反应速度，无论多刁钻的球都能救起。他的身高只有159cm，是队里最矮的，但他的气势却无人能敌。他的口头禅'滚动接球'成为了乌野的防守信条，那种不惜一切代价也要把球救起的决心，感染了每一个队员。他的身体在地板上翻滚，手臂被磨得通红，但他的眼神始终坚定。西谷用实际行动证明，身高不是问题，意志和技术才是关键。他就是乌野的'守护神'，只要他在，球队就有安全感。",
                    "田中龙之介在关键时刻总是第一个站出来鼓舞士气，他的热血和直率感染着每一个队员。当队友失误时，他会大声鼓励；当气氛低迷时，他会用夸张的动作活跃气氛；当需要有人挺身而出时，他会毫不犹豫地冲在最前面。即使技术不是最强，但他的存在让球队更有凝聚力。他的口头禅'王牌不是一个人，而是整个团队'，道出了排球的真谛。田中用自己的方式，成为了球队不可或缺的一员。",
                    "泽村大地作为队长，用稳重的表现稳定军心。他的接发球技术虽然朴实无华，但成功率极高，很少出现失误。在比赛的关键时刻，当其他人紧张时，他总能用稳定的表现给大家信心。他不需要华丽的技术，不需要惊人的得分，他只需要做好自己的本职工作，成为球队最可靠的后盾。队友们都说，有大地在，就有安全感。他就像球队的基石，默默支撑着整个团队，让每个人都能放心地发挥。",
                    "东峰旭曾因为被拦网而失去自信，那次失败的阴影一直笼罩着他，让他甚至一度退出球队。他害怕再次面对那种无力感，害怕看到队友失望的眼神。但在队友们的鼓励下，在大家真诚的呼唤中，他重新找回了作为王牌的勇气。当他再次站上球场，当他的扣球突破拦网得分时，全场沸腾了。那记重扣不仅是得分，更是宣告着王牌的回归，宣告着他战胜了自己的恐惧。东峰用实际行动证明，真正的强者不是从不失败，而是能从失败中站起来。",
                    "乌野与青叶城西的练习赛，及川彻的发球直接得分让乌野措手不及。他那完美的发球姿势，精准的落点控制，强大的旋转力量，展现了顶级二传手的全面实力。每一个发球都像是精心设计的陷阱，让对手防不胜防。影山看着这个曾经的前辈，心中既有敬佩也有不甘，他知道自己还有很长的路要走。及川的存在，成为了影山前进的目标，也让他明白了什么是真正的'天才'。",
                    "日向在比赛中闭上眼睛接影山的传球，完全信任队友的判断。这种盲目的信任让影山震撼，他从未见过有人能如此毫无保留地相信自己。那一刻，影山明白了什么是真正的搭档，不是技术的配合，而是心灵的相通。他开始调整自己的传球方式，不再追求完美的弧线，而是传出日向最容易扣到的球。这种改变，让他们的配合达到了新的高度，也让影山从'国王'蜕变成了真正的'二传手'。",
                    "月岛第一次全力拦网成功，那一刻他终于理解了排球的魅力。看着对手因为自己的拦网而沮丧，看着队友因为自己的防守而欢呼，他感受到了前所未有的成就感。原来，全力以赴的感觉是如此美妙，原来，为了团队而战的感觉是如此充实。那个曾经冷漠的少年，眼中终于燃起了对胜利的渴望。他开始主动练习拦网，开始研究对手的习惯，开始真正投入到排球中。这一刻，月岛找到了自己的排球意义。",
                    "乌野在春高预选赛中遇到强敌，比分一直胶着，双方你来我往，谁都不肯让步。关键时刻，替补上场的菅原用一记精准的二传帮助球队得分，那个传球的时机和弧线都恰到好处，让攻手能够轻松得分。全场为之沸腾，队友们冲上去拥抱他，感谢这位老将的贡献。菅原用实际行动证明了老将的价值，证明了经验和冷静在关键时刻的重要性。他的存在，让年轻队员们明白，排球不仅需要天赋，更需要积累和沉淀。",
                    "影山学会了用队友能接到的方式传球，而不是只追求完美的弧线。他开始观察每个队友的习惯，了解他们的节奏，调整自己的传球方式。这个改变让他从'国王'变成了真正的'二传手'，队友们也更愿意相信他，更愿意配合他。影山发现，原来排球不是一个人的表演，而是团队的协作。当他看到队友们因为自己的传球而得分时的笑容，他终于明白了什么是真正的快乐。这种成长，让他成为了更强大的二传手。",
                    "日向在沙滩排球训练中学会了如何更好地控制身体，他的空中停留时间变得更长，动作变得更加灵活。在沙地上训练需要更强的腿部力量和平衡感，每一次起跳都比在室内更费力。但正是这种艰苦的训练，让日向的基本功得到了质的提升。他学会了在空中调整身体，学会了用不同的角度扣球，学会了更好地阅读比赛。这段经历让他的进攻变得更加难以预测，也让他成为了更全面的攻手。",
                    "音驹高中的黑尾铁朗教导日向拦网技巧，告诉他'拦网不是为了得分，而是为了给队友创造机会'。这句话让日向对排球有了新的理解，原来排球的每一个环节都是相互关联的，每一个动作都是为了团队。黑尾耐心地示范动作，纠正日向的姿势，分享自己的经验。他告诉日向，即使拦不到球，也要干扰对手的节奏，给队友争取防守的时间。这种无私的指导，让日向明白了什么是真正的排球精神。",
                    "孤爪研磨虽然看起来懒散，但他的观察力和判断力极其敏锐。他能准确预判对手的进攻路线，提前移动到最佳位置，用最小的动作完成最有效的防守。他不需要华丽的动作，不需要夸张的表现，他只需要出现在正确的位置，做出正确的判断。这种'省力'的打法背后，是对比赛的深刻理解和对对手的精准分析。研磨用自己的方式，成为了音驹不可或缺的核心。",
                    "夜久衍在防守训练中展示了'滚动接球'的精髓，他的身体像不倒翁一样，无论多难的球都能救起。他的手臂、膝盖、肘部都有伤痕，那是无数次救球留下的印记。但他从不在意，因为他知道，每一次救球都可能改变比赛的走向。这种永不放弃的精神感染了所有人，让大家明白，只要球还没落地，就还有希望。夜久用实际行动诠释了什么是'守护神'，什么是永不言弃。",
                    "乌野与音驹的'垃圾场决战'终于实现，两队的默契配合和激烈对抗让观众热血沸腾。这场比赛不是为了输赢，而是为了享受排球的快乐，为了实现前辈们的约定。双方你来我往，每一个球都打得精彩纷呈，每一次得分都引来欢呼。比赛结束后，两队队员相互拥抱，感谢对手给予的精彩对决。这场比赛让所有人明白，排球的魅力不仅在于胜利，更在于过程中的拼搏和友谊。",
                    "白鸟泽学园的牛岛若利用绝对的力量和技术碾压对手，他的左手扣球几乎无人能挡。每一记扣球都势大力沉，让拦网手的手臂发麻，让防守队员望而生畏。他的存在就像一座大山，压得对手喘不过气来。面对这样的王者，乌野能否找到突破口？这成为了所有人心中的疑问。但正是这种强大的对手，才能激发出球队的最大潜力，才能让他们突破自己的极限。",
                    "天童觉的'猜测拦网'让对手防不胜防，他能凭直觉判断出扣球的路线，提前移动到最佳位置。这种独特的拦网方式，让他成为白鸟泽最可怕的拦网手。他的眼神锐利，动作诡异，总能出现在最意想不到的地方。对手们都说，和天童对决就像在和一个读心者战斗，你的每一个想法都被他看穿。这种心理压力，往往比技术上的压制更让人难以应对。",
                    "五色工在关键时刻的发球直接得分，他那独特的跳发姿势和强大的力量，让对手接发球时压力倍增。每一个发球都像炮弹一样飞向对方场地，速度快、力量大、落点刁钻。这就是白鸟泽的'发球机器'，他用一个又一个的发球得分，为球队奠定了胜利的基础。对手们都说，面对五色工的发球，就像在面对一场暴风雨，只能咬牙硬撑。",
                    "乌野在对阵白鸟泽时，日向和影山的'变人快攻'首次成功。日向在空中改变扣球方向，突破了牛岛的拦网，球重重地砸在对方场地上，全场沸腾。这一球不仅是得分，更是宣告了乌野的进化，宣告了他们有能力挑战王者。队友们冲上去拥抱日向和影山，庆祝这个历史性的时刻。这一球，成为了比赛的转折点，也成为了乌野传奇的开始。",
                    "月岛在关键时刻连续拦网成功，他终于找到了自己的排球意义。那个曾经冷漠的少年，现在眼中燃烧着对胜利的渴望，手臂高高举起，坚定地守护着球队的防线。每一次拦网成功，他都会大声呐喊，释放内心的激情。队友们看到他的改变，都为之感动。月岛用实际行动证明，只要找到了意义，任何人都能爆发出惊人的力量。他不再是那个冷眼旁观的人，而是球队不可或缺的一员。",
                    "西谷在最后一球救起了看似不可能的球，他的身体几乎贴着地面滑行，手臂伸到了极限。这记神奇的救球，让乌野有了反击的机会，也让全场观众为之欢呼。西谷的膝盖和手肘都磨破了皮，但他毫不在意，因为他知道，只要球还在空中，就还有希望。他用实际行动诠释了什么是'永不放弃'，什么是'守护神'。队友们看到他的拼搏，都被深深感动，更加坚定了战斗到最后的决心。",

"影山在比赛中尝试了新的传球路线，虽然风险很大，但他相信队友能接到。这种信任让球队的进攻变得更加多样化，对手无法预判进攻点。当这个冒险的传球成功时，影山露出了难得的笑容。他终于明白，排球不是一个人的表演，而是团队的协作。这种改变让他成为了更强大的二传手，也让队友们更加信任他。影山从'国王'蜕变成了真正的'二传手'，这是他成长路上最重要的一步。",

"日向在全国大赛中遇到了更多强大的对手，他意识到自己还有很多不足。每一场比赛都让他看到新的技术，新的战术，新的可能性。但正是这些挑战，让他更加渴望变强，更加努力训练。他开始研究对手的录像，学习他们的技术，思考如何突破他们的防守。日向明白，要成为真正的王牌，光有热情是不够的，还需要技术、智慧和经验的积累。这种觉悟，让他的成长速度加快了。",

"稻荷崎高中的宫侑展现了顶级二传手的实力，他的传球能让每个攻手都发挥出最大威力。无论是快攻、强攻还是后排进攻，他都能传出最合适的球。影山看到了自己的目标和差距，他意识到自己还有很长的路要走。宫侑的存在，让影山明白了什么是'为攻手而生的二传'，什么是真正的'最强二传'。这次对决，成为了影山成长的重要契机，也让他找到了新的努力方向。",

"宫治的扣球力量惊人，他和哥哥宫侑的配合天衣无缝。双胞胎的默契让对手防不胜防，他们甚至不需要眼神交流就能完成配合。这就是'最强双子'的实力，这就是从小一起长大、一起打球培养出的默契。对手们都说，和稻荷崎对决，就像在和一个人战斗，因为双胞胎的配合实在太完美了。这种默契，是其他搭档无法复制的，也是稻荷崎最强大的武器。",

"角名伦太郎的接发球技术堪称完美，他能将任何刁钻的发球稳稳接起。无论是跳发、飘球还是旋转球，他都能用最合适的方式处理。这种稳定性让稻荷崎的进攻体系运转流畅，因为他们知道，只要球发过来，角名就能接起来。他就像球队的定海神针，用稳定的表现给队友们信心。对手们都说，想要击败稻荷崎，首先要突破角名的防线，但这几乎是不可能的任务。",

"北信介的拦网判断力极强，他总能出现在最关键的位置。他不需要惊人的弹跳，不需要夸张的动作，他只需要准确的判断和及时的移动。面对这样的拦网手，乌野的进攻受到了极大限制，每一次扣球都要考虑他的位置。北信介用智慧和经验，弥补了身体条件的不足，成为了稻荷崎防守体系的核心。他证明了，拦网不仅需要身体素质，更需要头脑和判断力。",

"日向在比赛中发烧，但他坚持要上场。队友们看到他的执着，都被他的热情所感染。即使身体不适，他也不愿放弃任何一球，每一次起跳都用尽全力。教练看到他的状态，既担心又感动，最终决定让他上场，但要求他注意身体。日向用实际行动证明，对排球的热爱可以战胜身体的不适。这种精神，感染了每一个队员，也让对手肃然起敬。",

"影山学会了'后排二传'，这让乌野的进攻变得更加立体。对手无法判断进攻点，因为攻手可以从任何位置发起进攻。这种战术的多样性，让乌野的进攻威力大增。影山在后排的传球同样精准，同样能让攻手发挥出最大威力。这个新技能的掌握，标志着影山又上了一个台阶，他正在向'最强二传'的目标稳步前进。",

"月岛在防守时受伤，但他咬牙坚持完成了拦网。那一刻，队友们看到了他的成长，这个曾经冷漠的人已经全心投入了。他的手指肿了，手臂发麻，但他依然高高举起双手，守护着球队的防线。比赛结束后，队友们冲上去扶住他，感谢他的付出。月岛用实际行动证明，他已经找到了自己的排球意义，他不再是那个冷眼旁观的人。",

"东峰在关键时刻的直线扣球得分，他终于突破了心理阴影。王牌的重扣让全场震撼，球重重地砸在对方场地上，发出巨大的声响。这就是乌野的'不屈的王牌'，这就是东峰的实力。队友们冲上去拥抱他，庆祝这个关键的得分。东峰用实际行动证明，他已经战胜了过去的自己，他已经成为了真正的王牌。",

"田中在比赛中连续得分，他的'直线扣球'成为了乌野的秘密武器。虽然不是王牌，但他的存在让球队更加完整。每一次得分，他都会大声呐喊，释放内心的激情。田中用自己的方式，为球队做出贡献，证明了自己的价值。他告诉大家，排球不是一个人的运动，每个位置都很重要，每个人都不可或缺。",

"菅原替补上场后，用经验和冷静稳定了局势。他的传球虽然不如影山华丽，但每一球都恰到好处，让攻手能够轻松得分。这就是老将的价值，这就是经验的力量。菅原用实际行动证明，年龄不是问题，经验和智慧同样重要。他的存在，让年轻队员们明白，排球是一项需要积累的运动，需要时间的沉淀。",

"西谷的'滚动接球'再次救起关键球，他的身体在地板上翻滚，但眼神始终盯着球。这种永不放弃的精神，是乌野的灵魂，是球队的信念。无论多么困难的球，只要西谷在，就有希望。他用实际行动诠释了什么是'守护神'，什么是永不言弃。队友们看到他的拼搏，都更加坚定了战斗到底的决心。",

"泽村大地在最后关头的接发球稳如磐石，他用实力告诉大家，队长不需要华丽的技术，只需要可靠的表现。每一个接发球都稳稳地传到二传手位置，为球队的进攻创造机会。大地就像球队的基石，默默支撑着整个团队。他的存在，让每个人都能放心地发挥，因为他们知道，有大地在，就有安全感。",

"乌野在全国大赛中不断成长，每一场比赛都让他们变得更强。虽然最终没能夺冠，但这段经历成为了他们一生的财富。他们学会了什么是团队，什么是坚持，什么是永不放弃。这些经历，将伴随他们一生，成为他们面对困难时的力量源泉。排球教会了他们的，不仅是技术，更是人生的道理。",

"日向在巴西学习沙滩排球，他的技术得到了全面提升。在异国他乡，他依然保持着对排球的热爱和执着。沙滩排球的训练让他学会了更多技巧，让他的基本功更加扎实。他在海滩上挥洒汗水，在烈日下坚持训练，为了梦想而努力。这段经历，让日向成长为更全面的选手，也让他更加理解排球的本质。",

"影山进入日本国家队，成为了世界级的二传手。他的传球让每个攻手都能发挥出最大威力，这就是他追求的'最强二传'。在国际赛场上，影山展现了日本二传的实力，让世界看到了他的成长。他不再是那个'国王'，而是真正的'二传手'，是球队的核心，是攻手们最信赖的搭档。",

"月岛成为了职业球员，他的拦网技术在联赛中名列前茅。那个曾经对排球冷漠的少年，现在已经成为了顶级拦网手。他用实际行动证明，只要找到了意义，任何人都能爆发出惊人的力量。月岛的成功，激励着无数曾经迷茫的年轻人，告诉他们，永远不要放弃寻找自己的意义。",

"山口忠在大学联赛中成为了主力，他的跳发球成为了球队的得分利器。曾经胆小的他，现在已经能独当一面，能在关键时刻挺身而出。山口用实际行动证明，只要坚持努力，就能实现梦想。他的成长，是对所有努力者的最好回报，也是对坚持的最好诠释。",

"东峰在职业联赛中继续担任王牌，他的重扣依然让对手胆寒。那个曾经失去自信的少年，现在已经成为了真正的王牌，成为了球队的支柱。东峰用实际行动证明，真正的强者不是从不失败，而是能从失败中站起来。他的经历，激励着无数曾经失败过的人，告诉他们，永远不要放弃。",

"西谷在意大利联赛打球，他的防守技术得到了世界的认可。身高虽小，但他的存在感却无人能忽视。西谷用实际行动证明，身高不是限制，技术和意志才是关键。他在国际赛场上的表现，让世界看到了日本自由人的实力，也让更多人明白，排球是一项不看身高的运动。",

"田中在职业生涯中找到了自己的位置，他的热血和拼搏精神感染着每一个队友。这就是他的排球之路，这就是他的人生哲学。田中用实际行动证明，不是每个人都能成为明星，但每个人都能发光发热。他的存在，让球队更有凝聚力，让比赛更有激情。",

"菅原成为了小学老师，他用自己的经历教导孩子们排球的乐趣。虽然没有成为职业球员，但他依然热爱着排球，依然在用自己的方式传承着排球精神。菅原告诉孩子们，排球不仅是一项运动，更是一种精神，是团队合作，是永不放弃，是追求梦想。",

"泽村大地成为了警察，但他依然关注着排球。那段在乌野的日子，是他一生中最宝贵的回忆。大地用自己的方式，继续守护着他人，就像他在球场上守护球队一样。他告诉年轻人，排球教会他的责任感和使命感，让他成为了更好的人。",

"及川彻在阿根廷联赛大放异彩，他的传球和发球让对手闻风丧胆。这个天才二传手，终于在世界舞台上证明了自己。及川用实际行动告诉大家，天才不是天生的，而是通过无数次的努力和坚持铸就的。他的成功，是对所有努力者的最好回报。",

"岩泉一在职业联赛中成为了可靠的副攻，他的拦网和进攻都很稳定。虽然不如及川耀眼，但他依然是不可或缺的存在。岩泉用实际行动证明，不是每个人都能成为明星，但每个人都有自己的价值。他和及川的友谊，经受住了时间的考验，成为了最好的搭档关系。",

"黑尾铁朗在大学毕业后进入体育公司工作，他用自己的方式推广排球运动。那段在音驹的日子，让他永远热爱排球。黑尾希望更多人能感受到排球的魅力，能体会到团队合作的快乐。他用自己的方式，延续着排球的精神，传承着排球的文化。",

"孤爪研磨成为了职业游戏主播，但他依然关注着排球比赛。那个曾经懒散的少年，心中依然有着对排球的特殊感情。研磨在直播中经常聊起排球，分享自己的经历，让更多人了解这项运动。他用自己的方式，延续着对排球的热爱。",

"夜久衍在俄罗斯联赛打球，他的防守技术让对手头疼。那个'守护神'依然在球场上守护着每一个球，依然用'滚动接球'诠释着永不放弃的精神。夜久的存在，让世界看到了日本自由人的实力，也让更多人明白，防守同样可以很精彩。",

"牛岛若利成为了日本国家队的王牌，他的扣球依然无人能挡。这个天才左撇子，在世界舞台上继续书写传奇。牛岛用绝对的实力，证明了什么是真正的王牌，什么是真正的强者。他的存在，让日本队的进攻更加犀利，让对手更加忌惮。",

"天童觉在法国联赛打球，他的'猜测拦网'让欧洲球员大开眼界。这个独特的拦网手，在异国他乡依然闪耀，依然用自己的方式守护着球队。天童的成功，证明了独特的风格同样可以成功，证明了创新和突破的重要性。",

"五色工成为了职业球员，他的发球依然是球队的秘密武器。那个'发球机器'继续在球场上发光发热，继续用一个又一个的发球得分为球队做贡献。五色工用实际行动证明，专注和坚持可以让一个人在某个领域达到极致。",

"宫侑成为了日本国家队的主力二传，他的传球让每个攻手都能发挥出最大威力。这就是'最强二传'的实力，这就是天才的表现。宫侑在国际赛场上的表现，让世界看到了日本二传的实力，也让影山找到了追赶的目标。",

"宫治在职业联赛中担任王牌，他的扣球力量依然惊人。双胞胎虽然分开打球，但他们的羁绊永远不会断。宫治用实际行动证明，即使分开，他们依然是最强的双子，依然有着最深的默契。他们的故事，成为了排球界的佳话。",

"角名伦太郎在职业联赛中继续担任自由人，他的接发球技术依然完美。这个'完美接球手'是球队最可靠的后盾，是进攻体系的基石。角名用实际行动证明，稳定和可靠同样重要，同样值得尊敬。",

"北信介在职业联赛中成为了顶级拦网手，他的判断力和反应速度让对手防不胜防。这就是'铁壁'的实力，这就是智慧型拦网手的典范。北信介用实际行动证明，拦网不仅需要身体素质，更需要头脑和判断力。",

"日向和影山在奥运会上再次相遇，一个代表日本，一个代表巴西。曾经的搭档，现在成为了对手，但他们的羁绊永远不会改变。比赛结束后，两人相视一笑，拥抱在一起。这一刻，胜负已经不重要了，重要的是他们都实现了梦想，都站在了世界的舞台上。",

"乌野的队员们在多年后重聚，他们回忆起那段热血的青春。虽然各自走上了不同的道路，但排球永远是他们共同的回忆，永远是他们心中最美好的时光。他们感谢排球，感谢那段一起奋斗的日子，感谢彼此的陪伴和支持。",

"日向在职业生涯中不断挑战自己，他从一个只会扣球的'诱饵'，成长为了全能型的攻手。这就是他的排球之路，这就是他的成长历程。日向用实际行动证明，只要不放弃，就能实现梦想，就能超越自己。",

"影山在国家队中成为了核心，他的传球让日本队的进攻变得更加犀利。这个曾经的'国王'，现在已经成为了真正的王者，成为了球队的灵魂。影山用实际行动证明，成长需要时间，需要经历，需要不断的反思和改变。",

"月岛在职业生涯中找到了自己的价值，他的拦网成为了球队的防守支柱。那个曾经迷茫的少年，现在已经找到了答案，找到了自己的排球意义。月岛用实际行动证明，每个人都有自己的价值，每个人都能找到自己的位置。",

"山口在大学联赛中成为了主力，他的跳发球帮助球队赢得了冠军。曾经只能在场边加油的他，现在已经成为了场上的英雄，成为了球队的得分利器。山口用实际行动证明，坚持和努力终会有回报，梦想终会实现。",

"东峰在职业生涯中继续发光发热，他的重扣依然是球队的得分利器。这个'不屈的王牌'永远不会放弃，永远会为球队战斗到最后。东峰用实际行动证明，真正的王牌不是从不失败，而是能从失败中站起来，能在关键时刻挺身而出。",

"西谷在国际赛场上展现了日本自由人的实力，他的防守让世界惊叹。身高不是问题，技术和意志才是关键。西谷用实际行动证明，只要有梦想，只要肯努力，就能在世界舞台上闪耀，就能让世界看到自己的实力。",

"田中在职业生涯中找到了自己的位置，他的拼搏精神感染着每一个队友。这就是他的排球哲学，这就是他的人生态度。田中用实际行动证明，热情和拼搏同样重要，同样能为球队做出贡献，同样值得尊敬。",

"菅原虽然没有成为职业球员，但他用自己的方式传承着排球精神。那段在乌野的日子，让他永远热爱排球，永远珍惜那段青春岁月。菅原告诉孩子们，排球教会他的不仅是技术，更是团队合作，是永不放弃，是追求梦想的勇气。",

"泽村大地虽然离开了球场，但他依然关注着排球。那段作为队长的日子，是他一生中最骄傲的时光，是他最宝贵的回忆。大地用自己的方式，延续着排球的精神，用责任感和使命感影响着身边的人。",

"乌野高中排球部的传奇还在继续，新一代的队员们继承了前辈的意志。'飞翔'的精神，永远不会消失，永远会在球场上闪耀。每一代乌野人，都在用自己的方式，书写着新的传奇，延续着乌野的荣光。",

"日向在沙滩排球世界巡回赛中夺冠，他用实力证明了身高不是限制。那个曾经被嘲笑的矮个子，现在已经成为了世界冠军，成为了传奇。日向用实际行动告诉所有人，只要有梦想，只要肯努力，就没有什么是不可能的。",

"影山在世界杯上带领日本队夺冠，他的传球让全世界都为之惊叹。这就是他追求的'最强二传'的终极形态，这就是他梦想的实现。影山用实际行动证明，天才不是天生的，而是通过无数次的努力和坚持铸就的。",

"月岛在职业生涯巅峰时期，他的拦网成功率位居联赛第一。那个曾经对排球冷漠的少年，现在已经成为了传奇，成为了后辈们学习的榜样。月岛用实际行动证明，只要找到了意义，任何人都能爆发出惊人的力量，都能创造奇迹。",

"山口在国家队中担任替补，但他的跳发球依然是球队的秘密武器。关键时刻，他总能挺身而出，用发球为球队打开局面。山口用实际行动证明，替补同样重要，同样能为球队做出贡献，同样值得尊敬和认可。",

"东峰在职业生涯末期，他依然保持着对排球的热爱。那个'不屈的王牌'用一生诠释了什么是坚持，什么是热爱。东峰的经历，激励着无数年轻球员，告诉他们，真正的强者不是从不失败，而是能从失败中站起来，能坚持到最后。",

"西谷在退役后成为了教练，他用自己的经历教导年轻球员。'滚动接球'的精神，将永远传承下去，将永远激励着后辈们。西谷告诉年轻球员，身高不是限制，技术和意志才是关键，只要肯努力，就能实现梦想。",

"田中在退役后开了一家体育用品店，他依然关注着排球，依然为排球事业做贡献。那段热血的青春，是他一生的骄傲，是他最宝贵的回忆。田中用自己的方式，延续着对排球的热爱，支持着年轻球员的梦想。",

"菅原在教师岗位上培养了无数热爱排球的孩子，他用自己的方式延续着排球的梦想。这就是他的排球之路，这就是他的人生选择。菅原用实际行动证明，传承和教育同样重要，同样能为排球事业做出贡献。",

"泽村大地在警察岗位上兢兢业业，但他依然会在休息日去看排球比赛。那段作为队长的日子，永远铭刻在心，永远是他最骄傲的回忆。大地用自己的方式，延续着排球教会他的责任感和使命感，影响着身边的每一个人。",

"及川彻在国际赛场上与日本队对决，他用实力证明了自己的选择。虽然没能在高中时期击败乌野，但他在职业生涯中找到了答案，实现了梦想。及川用实际行动告诉大家，失败不是终点，而是新的起点，只要不放弃，就能实现梦想。",

"岩泉一在职业生涯中一直支持着及川，他们的友谊经受住了时间的考验。这就是最好的搭档关系，这就是最深的羁绊。岩泉用实际行动证明，真正的友谊不会因为时间和距离而改变，真正的搭档会永远支持彼此。",

"黑尾铁朗在体育公司中推广排球运动，他希望更多人能感受到排球的魅力。那段在音驹的日子，让他永远热爱这项运动，永远想为排球事业做贡献。黑尾用自己的方式，延续着排球的精神，传播着排球的文化。",

"孤爪研磨虽然成为了游戏主播，但他依然会在直播中聊起排球。那段青春岁月，是他人生中最特别的回忆，是他最珍贵的经历。研磨用自己的方式，延续着对排球的热爱，让更多人了解这项运动的魅力。",

"夜久衍在国际赛场上继续守护着球队，他的防守依然让对手头疼。这个'守护神'永远不会退缩，永远会为球队战斗到最后。夜久用实际行动证明，防守同样精彩，同样能改变比赛，同样值得尊敬和认可。",

"牛岛若利在职业生涯中创造了无数记录，他的扣球依然是联赛中最强的武器。这就是天才的实力，这就是王牌的表现。牛岛用绝对的实力，证明了什么是真正的强者，什么是真正的传奇。",
                ];
                
                // 确保本局游戏中看过的剧情不重复
                if (!this.watchedEpisodes) {
                    this.watchedEpisodes = [];
                }
                
                // 如果所有剧情都看过了，重置
                if (this.watchedEpisodes.length >= episodes.length) {
                    this.watchedEpisodes = [];
                }
                
                // 随机选择一个未看过的剧情
                let availableEpisodes = episodes.filter((_, index) => !this.watchedEpisodes.includes(index));
                let randomIndex = episodes.indexOf(availableEpisodes[Math.floor(Math.random() * availableEpisodes.length)]);
                this.watchedEpisodes.push(randomIndex);
                
                const episode = episodes[randomIndex];
                const episodeNumber = randomIndex + 1;
                
                // 显示剧情弹窗
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                title.textContent = `🍿 小排球 第${episodeNumber}集`;
                text.innerHTML = `
                    <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; margin-bottom: 20px;">
                        <p style="color: white; line-height: 1.8; font-size: 15px; text-align: justify;">
                            ${episode}
                        </p>
                    </div>
                    <div style="text-align: center; color: #f093fb; font-size: 14px; margin-top: 15px;">
                        <p>✨ 心情 +25，压力 -12</p>
                    </div>
                `;
                
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.closeHaikyuuEpisode()">
                        继续游戏
                    </button>
                `;
                
                modal.classList.add('show');
            }
            
            closeHaikyuuEpisode() {
                const modal = document.getElementById('event-modal');
                modal.classList.remove('show');
                
                // 检查奇遇事件
                const hasEvent = this.checkAdventureEvents();
                if (hasEvent) {
                    return;
                }
                
                // 返回周选择
                this.currentScene = 'weeklyHub';
                this.showScene('weeklyHub');
            }
            
            // ====================================================
            // 队友系统
            // ====================================================
            
            // 生成队友
            generateTeammates(team, playerPosition) {
                this.teammates = [];
                
                // 定义需要的位置（6人队伍，包括玩家）
                const allPositions = [
                    'outsideHitter',      // 主攻x1
                    'middleBlocker',      // 副攻x1
                    'setter',             // 二传x1
                    'oppositeHitter',     // 接应x1
                    'libero',             // 自由人x1
                    'outsideHitter'       // 主攻x1（第二个）
                ];
                
                // 移除玩家的位置，得到需要生成的队友位置
                const neededPositions = [];
                let playerPosRemoved = false;
                for (let pos of allPositions) {
                    if (pos === playerPosition && !playerPosRemoved) {
                        // 跳过玩家的位置（只移除一次）
                        playerPosRemoved = true;
                        continue;
                    }
                    neededPositions.push(pos);
                }
                
                console.log('玩家位置:', playerPosition);
                console.log('需要生成的队友位置:', neededPositions);
                console.log('队友数量:', neededPositions.length);
                
                // 计算玩家当前平均能力
                const playerAvgSkill = Math.round((this.player.skills.serve + this.player.skills.spike + 
                                                   this.player.skills.block + this.player.skills.dig + 
                                                   this.player.skills.set) / 5);
                
                // 队友平均能力 = 玩家平均能力 ± 5
                const teammateBaseSkill = playerAvgSkill + Math.floor(Math.random() * 11) - 5;  // -5 到 +5
                
                console.log('玩家平均能力:', playerAvgSkill);
                console.log('队友基准能力:', teammateBaseSkill);
                
                // 生成队友（应该是5名）
                for (let i = 0; i < neededPositions.length; i++) {
                    const position = neededPositions[i];
                    const posInfo = this.positions[position];
                    
                    if (!posInfo) {
                        console.error('位置信息不存在:', position);
                        continue;
                    }
                    
                    // 生成技能值（基于队友基准能力，每个队友有±3的浮动）
                    const thisTeammateBase = teammateBaseSkill + Math.floor(Math.random() * 7) - 3;  // -3 到 +3
                    const skills = {};
                    
                    for (let skill of ['serve', 'spike', 'block', 'dig', 'set']) {
                        if (posInfo.coreSkills.includes(skill)) {
                            // 核心技能：基准+5到+10
                            skills[skill] = Math.min(95, Math.max(10, thisTeammateBase + Math.floor(Math.random() * 6) + 5));
                        } else if (posInfo.secondarySkills.includes(skill)) {
                            // 次要技能：基准-5到+5
                            skills[skill] = Math.min(95, Math.max(10, thisTeammateBase + Math.floor(Math.random() * 11) - 5));
                        } else {
                            // 其他技能：基准-10到-5
                            skills[skill] = Math.min(95, Math.max(10, thisTeammateBase - Math.floor(Math.random() * 6) - 5));
                        }
                    }
                    
                    // 计算平均能力
                    const avgSkill = Math.round((skills.serve + skills.spike + skills.block + skills.dig + skills.set) / 5);
                    
                    // 生成队友对象
                    const teammate = {
                        id: `teammate_${i}`,
                        name: generateRandomName(),
                        position: position,
                        skills: skills,
                        averageSkill: avgSkill,
                        chemistry: Math.floor(Math.random() * 6) + 5,  // 初始默契5-10（降低）
                        personality: ['热血型', '冷静型', '开朗型', '内向型', '严肃型'][Math.floor(Math.random() * 5)],
                        weeklyInteractions: {
                            chatted: false,    // 本周是否已聊天
                            gifted: false      // 本周是否已送礼
                        }
                    };
                    
                    this.teammates.push(teammate);
                }
                
                // 更新队伍统计
                this.updateTeamStats();
            }
            
            // 更新队伍统计
            updateTeamStats() {
                if (this.teammates.length === 0) {
                    this.teamStats = { averageChemistry: 0, averageSkill: 0, atmosphere: 0 };
                    console.log('队友数量为0，重置队伍统计');
                    return;
                }
                
                let totalChemistry = 0;
                let totalSkill = 0;
                
                for (let teammate of this.teammates) {
                    totalChemistry += teammate.chemistry;
                    totalSkill += teammate.averageSkill;
                }
                
                this.teamStats.averageChemistry = Math.round(totalChemistry / this.teammates.length);
                this.teamStats.averageSkill = Math.round(totalSkill / this.teammates.length);
                
                console.log('更新队伍统计:', {
                    队友数量: this.teammates.length,
                    总默契: totalChemistry,
                    总能力: totalSkill,
                    平均默契: this.teamStats.averageChemistry,
                    平均能力: this.teamStats.averageSkill
                });
                
                // 队伍氛围基于平均默契
                if (this.teamStats.averageChemistry < 40) {
                    this.teamStats.atmosphere = 0.9;
                } else if (this.teamStats.averageChemistry < 70) {
                    this.teamStats.atmosphere = 1.0;
                } else {
                    this.teamStats.atmosphere = 1.1;
                }
            }
            
            // 队友周初自动成长
            processTeammateWeeklyGrowth() {
                if (!this.teammates || this.teammates.length === 0) return;
                
                // 初始化队友成长记录（用于周初提示显示）
                this.teammateWeeklyGrowth = [];
                
                for (let teammate of this.teammates) {
                    const growthRecord = {
                        name: teammate.name,
                        skillGrowth: {},
                        chemistryGrowth: 0,
                        totalGrowth: 0
                    };
                    
                    // 基础成长率：每周6-8点（约等于玩家2次训练）
                    const baseGrowth = Math.floor(Math.random() * 3) + 6;  // 6-8点
                    
                    // 默契加成：默契越高，成长越快（0-2点）
                    let chemistryBonus = 0;
                    if (teammate.chemistry >= 85) {
                        chemistryBonus = 2;
                    } else if (teammate.chemistry >= 70) {
                        chemistryBonus = 1;
                    }
                    
                    // 队伍加成：校队成长更快（+1点）
                    const teamBonus = this.player.team === 'university' ? 1 : 0;
                    
                    // 总成长点数：6-11点/周
                    const totalGrowthPoints = baseGrowth + chemistryBonus + teamBonus;
                    
                    // 获取位置信息
                    const posInfo = this.positions[teammate.position];
                    if (!posInfo) continue;
                    
                    // 分配成长点数到技能
                    // 70%概率提升核心技能，30%概率提升次要技能
                    let remainingPoints = totalGrowthPoints;
                    const grownSkills = new Set();
                    
                    while (remainingPoints > 0) {
                        let targetSkills;
                        if (Math.random() < 0.7) {
                            // 优先核心技能
                            targetSkills = posInfo.coreSkills.filter(s => teammate.skills[s] < 95);
                        } else {
                            // 次要技能
                            targetSkills = posInfo.secondarySkills.filter(s => teammate.skills[s] < 95);
                        }
                        
                        // 如果没有可提升的技能，尝试其他技能
                        if (targetSkills.length === 0) {
                            targetSkills = ['serve', 'spike', 'block', 'dig', 'set'].filter(s => teammate.skills[s] < 95);
                        }
                        
                        if (targetSkills.length === 0) break; // 所有技能都满了
                        
                        const skill = targetSkills[Math.floor(Math.random() * targetSkills.length)];
                        teammate.skills[skill] = Math.min(95, teammate.skills[skill] + 1);
                        
                        if (!growthRecord.skillGrowth[skill]) {
                            growthRecord.skillGrowth[skill] = 0;
                        }
                        growthRecord.skillGrowth[skill]++;
                        grownSkills.add(skill);
                        
                        remainingPoints--;
                    }
                    
                    // 重新计算平均能力
                    teammate.averageSkill = Math.round((teammate.skills.serve + teammate.skills.spike + 
                                                        teammate.skills.block + teammate.skills.dig + 
                                                        teammate.skills.set) / 5);
                    
                    // 默契度自然增长（每周+0~1，降低速度）
                    const chemistryGain = Math.random() < 0.3 ? 1 : 0;
                    teammate.chemistry = Math.min(100, teammate.chemistry + chemistryGain);
                    growthRecord.chemistryGrowth = chemistryGain;
                    growthRecord.totalGrowth = totalGrowthPoints;
                    
                    // 只记录有成长的队友
                    if (totalGrowthPoints > 0 || chemistryGain > 0) {
                        this.teammateWeeklyGrowth.push(growthRecord);
                    }
                }
                
                // 更新队伍统计
                this.updateTeamStats();
                
                // 检查并解锁技能
                this.checkAndUnlockSkills();
            }
            
            // 获取本周聊天次数
            getWeeklyChatCount() {
                if (!this.teammates || this.teammates.length === 0) return 0;
                return this.teammates.filter(t => t.weeklyInteractions && t.weeklyInteractions.chatted).length;
            }
            
            // 获取本周送礼次数
            getWeeklyGiftCount() {
                if (!this.teammates || this.teammates.length === 0) return 0;
                return this.teammates.filter(t => t.weeklyInteractions && t.weeklyInteractions.gifted).length;
            }
            
            // 渲染队友面板
            renderTeammatesPanel() {
                // 确保队伍统计是最新的
                this.updateTeamStats();
                
                const storyText = document.getElementById('story-text');
                const choicesDiv = document.getElementById('choices');
                
                const teamName = this.player.team === 'college' ? '院队' : '校队';
                
                let html = `
                    <h2>👥 我的队友 - ${teamName}</h2>
                    <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px;">
                        <p style="font-size: 14px; margin: 10px 0 5px 0; color: #667eea;">
                            <strong>本周互动次数：</strong>
                        </p>
                        <div style="display: flex; justify-content: center; gap: 30px; font-size: 14px;">
                            <span>💬 聊天：${this.getWeeklyChatCount()}/3</span>
                            <span>🎁 送礼：${this.getWeeklyGiftCount()}/3</span>
                        </div>
                    </div>
                `;
                
                // 按位置排列队友（排球场地布局）
                const positionLayout = {
                    frontLeft: null,    // 前排左（4号位）
                    frontCenter: null,  // 前排中（3号位）
                    frontRight: null,   // 前排右（2号位）
                    backLeft: null,     // 后排左（5号位）
                    backCenter: null,   // 后排中（6号位）
                    backRight: null     // 后排右（1号位）
                };
                
                // 根据玩家和队友的位置分配场上位置
                const allPlayers = [
                    { ...this.player, isPlayer: true, name: this.player.name, position: this.player.position },
                    ...this.teammates.map(t => ({ ...t, isPlayer: false }))
                ];
                
                // 位置映射规则（6人制排球）
                const positionMapping = {
                    'outsideHitter': ['frontLeft', 'backRight'],     // 主攻：优先4号位，其次1号位
                    'middleBlocker': ['frontCenter'],                 // 副攻：3号位（前排中）
                    'setter': ['frontRight'],                         // 二传：2号位（前排右）
                    'oppositeHitter': ['backLeft'],                   // 接应：5号位（后排左）
                    'libero': ['backCenter']                          // 自由人：6号位（后排中）
                };
                
                // 分配位置
                for (let player of allPlayers) {
                    const availableSlots = positionMapping[player.position] || [];
                    for (let slot of availableSlots) {
                        if (!positionLayout[slot]) {
                            positionLayout[slot] = player;
                            break;
                        }
                    }
                }
                
                // 渲染场地布局
                html += `<div style="max-width: 600px; margin: 0 auto;">`;
                
                // 前排
                html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">`;
                for (let pos of ['frontLeft', 'frontCenter', 'frontRight']) {
                    html += this.renderPlayerCard(positionLayout[pos], pos);
                }
                html += `</div>`;
                
                // 中线
                html += `<div style="height: 3px; background: linear-gradient(90deg, transparent, #667eea, transparent); margin: 15px 0;"></div>`;
                
                // 后排
                html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">`;
                for (let pos of ['backLeft', 'backCenter', 'backRight']) {
                    html += this.renderPlayerCard(positionLayout[pos], pos);
                }
                html += `</div>`;
                
                html += `</div>`;
                
                storyText.innerHTML = html;
                
                // 返回按钮和帮助按钮
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.showTeammateGuide()">❓ 队友玩法说明</button>
                    <button class="choice-btn" onclick="game.showScene('weeklyHub')">🔙 返回</button>
                `;
            }
            
            // 渲染单个球员卡片
            renderPlayerCard(player, position) {
                if (!player) {
                    return `<div style="padding: 15px; background: rgba(200,200,200,0.1); border-radius: 10px; min-height: 120px;"></div>`;
                }
                
                const posInfo = this.positions[player.position];
                const isPlayer = player.isPlayer;
                
                // 玩家卡片特殊样式
                const cardStyle = isPlayer 
                    ? 'background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%); color: #333; border: 3px solid #ff6b6b;'
                    : 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;';
                
                let html = `
                    <div style="${cardStyle} padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: ${isPlayer ? 'default' : 'pointer'};" 
                         ${!isPlayer ? `onclick="game.showTeammateDetail('${player.id}')"` : ''}>
                        <div style="text-align: center; font-size: 24px; margin-bottom: 5px;">${posInfo.icon}</div>
                        <div style="text-align: center; font-weight: bold; margin-bottom: 3px;">${player.name}${isPlayer ? '（你）' : ''}</div>
                        <div style="text-align: center; font-size: 12px; opacity: 0.9; margin-bottom: 8px;">${posInfo.name}</div>
                `;
                
                if (isPlayer) {
                    const avgSkill = Math.round((this.player.skills.serve + this.player.skills.spike + 
                                                 this.player.skills.block + this.player.skills.dig + 
                                                 this.player.skills.set) / 5);
                    html += `
                        <div style="text-align: center; font-size: 12px; margin-top: 5px;">
                            <div style="margin-bottom: 5px;">能力</div>
                            <div style="background: rgba(0,0,0,0.2); height: 16px; border-radius: 8px; overflow: hidden; position: relative;">
                                <div style="background: #4CAF50; height: 100%; width: ${avgSkill}%; transition: width 0.3s;"></div>
                                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${avgSkill}</div>
                            </div>
                        </div>
                    `;
                } else {
                    // 默契度颜色
                    let chemColor = '#95a5a6';
                    if (player.chemistry >= 76) chemColor = '#f1c40f';
                    else if (player.chemistry >= 51) chemColor = '#3498db';
                    else if (player.chemistry >= 26) chemColor = '#2ecc71';
                    
                    // 互动状态图标
                    let interactionIcons = '';
                    if (player.weeklyInteractions) {
                        if (player.weeklyInteractions.chatted) {
                            interactionIcons += '💬';
                        }
                        if (player.weeklyInteractions.gifted) {
                            interactionIcons += '🎁';
                        }
                    }
                    
                    html += `
                        <div style="text-align: center; font-size: 12px; margin-top: 5px;">
                            <div style="margin-bottom: 5px;">能力</div>
                            <div style="background: rgba(255,255,255,0.2); height: 16px; border-radius: 8px; overflow: hidden; position: relative; margin-bottom: 8px;">
                                <div style="background: #4CAF50; height: 100%; width: ${player.averageSkill}%; transition: width 0.3s;"></div>
                                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${player.averageSkill}</div>
                            </div>
                            <div style="margin-bottom: 5px;">默契</div>
                            <div style="background: rgba(255,255,255,0.2); height: 16px; border-radius: 8px; overflow: hidden; position: relative;">
                                <div style="background: ${chemColor}; height: 100%; width: ${player.chemistry}%; transition: width 0.3s;"></div>
                                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${player.chemistry}</div>
                            </div>
                            ${interactionIcons ? `<div style="margin-top: 5px; font-size: 14px;">${interactionIcons}</div>` : ''}
                        </div>
                    `;
                }
                
                html += `</div>`;
                
                return html;
            }
            
            // 显示队友详情
            showTeammateDetail(teammateId) {
                const teammate = this.teammates.find(t => t.id === teammateId);
                if (!teammate) return;
                
                const posInfo = this.positions[teammate.position];
                
                // 默契等级
                let chemLevel = '陌生';
                let chemColor = '#95a5a6';
                if (teammate.chemistry >= 76) {
                    chemLevel = '心有灵犀';
                    chemColor = '#f1c40f';
                } else if (teammate.chemistry >= 51) {
                    chemLevel = '默契';
                    chemColor = '#3498db';
                } else if (teammate.chemistry >= 26) {
                    chemLevel = '熟悉';
                    chemColor = '#2ecc71';
                }
                
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                title.textContent = `${posInfo.icon} ${teammate.name}`;
                text.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="font-size: 16px; color: #667eea; margin: 5px 0;">${posInfo.name} | ${teammate.personality}</p>
                    </div>
                    
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h3 style="margin-top: 0; color: #667eea;">能力值</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                    <span>🎯 发球</span>
                                    <span style="font-weight: bold;">${teammate.skills.serve}</span>
                                </div>
                                <div style="background: #ddd; height: 18px; border-radius: 9px; overflow: hidden; position: relative;">
                                    <div style="background: #4CAF50; height: 100%; width: ${teammate.skills.serve}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                    <span>⚡ 扣球</span>
                                    <span style="font-weight: bold;">${teammate.skills.spike}</span>
                                </div>
                                <div style="background: #ddd; height: 18px; border-radius: 9px; overflow: hidden; position: relative;">
                                    <div style="background: #FF6B6B; height: 100%; width: ${teammate.skills.spike}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                    <span>🛡️ 拦网</span>
                                    <span style="font-weight: bold;">${teammate.skills.block}</span>
                                </div>
                                <div style="background: #ddd; height: 18px; border-radius: 9px; overflow: hidden; position: relative;">
                                    <div style="background: #667eea; height: 100%; width: ${teammate.skills.block}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                    <span>🤸 垫球</span>
                                    <span style="font-weight: bold;">${teammate.skills.dig}</span>
                                </div>
                                <div style="background: #ddd; height: 18px; border-radius: 9px; overflow: hidden; position: relative;">
                                    <div style="background: #3498db; height: 100%; width: ${teammate.skills.dig}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                    <span>🙌 托球</span>
                                    <span style="font-weight: bold;">${teammate.skills.set}</span>
                                </div>
                                <div style="background: #ddd; height: 18px; border-radius: 9px; overflow: hidden; position: relative;">
                                    <div style="background: #f39c12; height: 100%; width: ${teammate.skills.set}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div style="margin-top: 5px; padding-top: 10px; border-top: 2px solid rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                    <span><strong>平均能力</strong></span>
                                    <span style="font-weight: bold; color: #667eea;">${teammate.averageSkill}</span>
                                </div>
                                <div style="background: #ddd; height: 20px; border-radius: 10px; overflow: hidden; position: relative;">
                                    <div style="background: #667eea; height: 100%; width: ${teammate.averageSkill}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px;">
                        <h3 style="margin-top: 0; color: #667eea;">默契度</h3>
                        <div style="margin-bottom: 10px;">
                            <div style="background: #ddd; height: 24px; border-radius: 12px; overflow: hidden; position: relative;">
                                <div style="background: ${chemColor}; height: 100%; width: ${teammate.chemistry}%; transition: width 0.3s;"></div>
                                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                    ${teammate.chemistry}/100
                                </div>
                            </div>
                        </div>
                        <p style="text-align: center; font-size: 16px; color: ${chemColor}; font-weight: bold; margin: 10px 0 0 0;">
                            ${chemLevel}
                        </p>
                    </div>
                    
                    ${this.renderUnlockedSkillsForTeammate ? this.renderUnlockedSkillsForTeammate(teammate.id) : ''}
                `;
                
                // 检查互动状态
                const weeklyChatCount = this.getWeeklyChatCount();
                const weeklyGiftCount = this.getWeeklyGiftCount();
                const canChat = !teammate.weeklyInteractions.chatted && this.player.energy >= 3 && weeklyChatCount < 3;
                const canGift = !teammate.weeklyInteractions.gifted && this.player.money >= 50 && weeklyGiftCount < 3;
                
                // 生成按钮HTML
                let buttonsHtml = '<div style="display: flex; gap: 10px; margin-top: 15px;">';
                
                // 聊天按钮
                if (teammate.weeklyInteractions.chatted) {
                    buttonsHtml += `<button class="choice-btn" disabled style="flex: 1; opacity: 0.5;">💬 本周已聊天</button>`;
                } else if (weeklyChatCount >= 3) {
                    buttonsHtml += `<button class="choice-btn" disabled style="flex: 1; opacity: 0.5;">💬 聊天次数已用完</button>`;
                } else if (!canChat) {
                    buttonsHtml += `<button class="choice-btn" disabled style="flex: 1; opacity: 0.5;">💬 聊天 (体力-3)</button>`;
                } else {
                    buttonsHtml += `<button class="choice-btn" onclick="game.chatWithTeammate('${teammate.id}')" style="flex: 1;">💬 聊天 (体力-3)</button>`;
                }
                
                // 送礼按钮
                if (teammate.weeklyInteractions.gifted) {
                    buttonsHtml += `<button class="choice-btn" disabled style="flex: 1; opacity: 0.5;">🎁 本周已送礼</button>`;
                } else if (weeklyGiftCount >= 3) {
                    buttonsHtml += `<button class="choice-btn" disabled style="flex: 1; opacity: 0.5;">🎁 送礼次数已用完</button>`;
                } else if (!canGift) {
                    buttonsHtml += `<button class="choice-btn" disabled style="flex: 1; opacity: 0.5;">🎁 送礼 (💰50)</button>`;
                } else {
                    buttonsHtml += `<button class="choice-btn" onclick="game.giftToTeammate('${teammate.id}')" style="flex: 1;">🎁 送礼 (💰50)</button>`;
                }
                
                buttonsHtml += '</div>';
                
                choicesDiv.innerHTML = buttonsHtml + `
                    <button class="choice-btn" onclick="game.closeTeammateDetail()" style="margin-top: 10px;">关闭</button>
                `;
                
                modal.classList.add('show');
            }
            
            // 关闭队友详情
            closeTeammateDetail() {
                const modal = document.getElementById('event-modal');
                modal.classList.remove('show');
            }
            
            // 显示队友玩法说明
            showTeammateGuide() {
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                title.textContent = '📖 队友系统玩法说明';
                text.innerHTML = `
                    <div style="text-align: left; line-height: 1.8; color: #333;">
                        <h3 style="color: #667eea; margin-top: 0;">🏐 队友成长</h3>
                        <p style="margin: 10px 0;">
                            • 每周自动成长，默契越高成长越快<br>
                            • 打友谊赛可以快速提升队友能力<br>
                            • 校队队友成长速度更快<br>
                        </p>
                        
                        <h3 style="color: #667eea; margin-top: 20px;">🤝 默契系统</h3>
                        <p style="margin: 10px 0;">
                            <strong>提升默契：</strong><br>
                            • 💬 聊天、🎁 送礼（每周各1次/人）<br>
                            • 🤝 友谊赛、🏐 比赛<br>
                            • 🍕 队伍聚餐、🎉 团建活动<br><br>
                            
                            <strong>默契作用：</strong><br>
                            • 默契越高，队友成长越快<br>
                            • 默契70/85/95解锁配合技能<br>
                            • 配合技能在比赛中触发有金色边框<br>
                        </p>
                        
                        <h3 style="color: #f39c12; margin-top: 20px;">🎓 升入校队</h3>
                        <p style="margin: 10px 0; padding: 12px; background: rgba(243, 156, 18, 0.1); border-left: 4px solid #f39c12; border-radius: 5px;">
                            • 会保留1-3名优秀的院队队友（默契≥80或能力≥75）<br>
                            • 新队友初始默契较低，需要重新培养<br>
                            • 零花钱增加到200元/周<br><br>
                            <span style="color: #e67e22; font-weight: bold;">💡 建议：在院队时多培养默契，升校队后能保留更多熟悉的队友！</span>
                        </p>
                    </div>
                `;
                
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.closeTeammateGuide()">知道了</button>
                `;
                
                modal.classList.add('show');
            }
            
            // 关闭队友说明
            closeTeammateGuide() {
                const modal = document.getElementById('event-modal');
                modal.classList.remove('show');
            }
            
            // 和队友聊天
            chatWithTeammate(teammateId) {
                const teammate = this.teammates.find(t => t.id === teammateId);
                if (!teammate) return;
                
                // 检查全局聊天次数限制
                const weeklyChatCount = this.getWeeklyChatCount();
                if (weeklyChatCount >= 3) {
                    alert('本周聊天次数已用完！（3/3）');
                    return;
                }
                
                // 检查条件
                if (teammate.weeklyInteractions.chatted) {
                    alert('本周已经和这位队友聊过天了！');
                    return;
                }
                if (this.player.energy < 3) {
                    alert('体力不足！需要至少3点体力。');
                    return;
                }
                
                // 扣除体力
                this.player.energy -= 3;
                
                // 标记本周已聊天
                teammate.weeklyInteractions.chatted = true;
                
                // 根据性格类型和默契等级生成对话
                const dialogue = this.generateDialogue(teammate);
                
                // 计算默契提升（基础5-8，性格加成）
                let chemistryGain = Math.floor(Math.random() * 4) + 5;  // 5-8
                
                // 性格加成：开朗型聊天效果+20%
                if (teammate.personality === '开朗型') {
                    chemistryGain = Math.round(chemistryGain * 1.2);
                }
                
                // 应用默契提升
                const oldChemistry = teammate.chemistry;
                teammate.chemistry = Math.min(100, teammate.chemistry + chemistryGain);
                
                // 更新队伍统计
                this.updateTeamStats();
                this.updateUI();
                
                // 显示对话结果
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                const posInfo = this.positions[teammate.position];
                
                title.textContent = `💬 和${teammate.name}聊天`;
                text.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="font-size: 18px; color: #667eea;">${posInfo.icon} ${teammate.name}</p>
                        <p style="font-size: 14px; color: #999;">${teammate.personality}</p>
                    </div>
                    
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <p style="font-size: 15px; line-height: 1.6; color: #333; margin: 0;">
                            ${dialogue}
                        </p>
                    </div>
                    
                    <div style="text-align: center; padding: 15px; background: rgba(46, 204, 113, 0.15); border: 2px solid #2ecc71; border-radius: 10px;">
                        <p style="margin: 5px 0; font-size: 16px; color: #27ae60;">✨ 默契度提升了！</p>
                        <p style="margin: 5px 0; font-size: 18px; font-weight: bold; color: #2ecc71;">
                            ${oldChemistry} → ${teammate.chemistry} (+${chemistryGain})
                        </p>
                        ${teammate.personality === '开朗型' ? '<p style="margin: 5px 0; font-size: 12px; color: #27ae60;">（开朗型性格加成 +20%）</p>' : ''}
                    </div>
                `;
                
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.closeTeammateDetail(); game.renderTeammatesPanel();">确定</button>
                `;
                
                modal.classList.add('show');
            }
            
            // 给队友送礼物
            giftToTeammate(teammateId) {
                const teammate = this.teammates.find(t => t.id === teammateId);
                if (!teammate) return;
                
                // 检查全局送礼次数限制
                const weeklyGiftCount = this.getWeeklyGiftCount();
                if (weeklyGiftCount >= 3) {
                    alert('本周送礼次数已用完！（3/3）');
                    return;
                }
                
                // 检查条件
                if (teammate.weeklyInteractions.gifted) {
                    alert('本周已经给这位队友送过礼物了！');
                    return;
                }
                if (this.player.money < 50) {
                    alert('金钱不足！需要50元购买礼物。');
                    return;
                }
                
                // 扣除金钱
                this.player.money -= 50;
                
                // 标记本周已送礼
                teammate.weeklyInteractions.gifted = true;
                
                // 随机选择礼物
                const gifts = [
                    { name: '运动毛巾', icon: '🧣' },
                    { name: '能量饮料', icon: '🥤' },
                    { name: '护膝护腕', icon: '🎽' },
                    { name: '排球杂志', icon: '📖' },
                    { name: '零食大礼包', icon: '🍫' },
                    { name: '音乐耳机', icon: '🎧' },
                    { name: '运动水壶', icon: '🍶' },
                    { name: '手机支架', icon: '📱' }
                ];
                const gift = gifts[Math.floor(Math.random() * gifts.length)];
                
                // 根据性格生成反应
                const reaction = this.generateGiftReaction(teammate, gift);
                
                // 计算默契提升（基础12-18，性格加成）
                let chemistryGain = Math.floor(Math.random() * 7) + 12;  // 12-18
                
                // 性格加成：内向型送礼效果+20%
                if (teammate.personality === '内向型') {
                    chemistryGain = Math.round(chemistryGain * 1.2);
                }
                
                // 应用默契提升
                const oldChemistry = teammate.chemistry;
                teammate.chemistry = Math.min(100, teammate.chemistry + chemistryGain);
                
                // 更新队伍统计
                this.updateTeamStats();
                this.updateUI();
                
                // 显示送礼结果
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                const posInfo = this.positions[teammate.position];
                
                title.textContent = `🎁 送礼物给${teammate.name}`;
                text.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="font-size: 18px; color: #667eea;">${posInfo.icon} ${teammate.name}</p>
                        <p style="font-size: 14px; color: #999;">${teammate.personality}</p>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; margin: 10px 0;">${gift.icon}</div>
                        <p style="font-size: 16px; color: #667eea; font-weight: bold;">你送了${gift.name}</p>
                    </div>
                    
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <p style="font-size: 15px; line-height: 1.6; color: #333; margin: 0;">
                            ${reaction}
                        </p>
                    </div>
                    
                    <div style="text-align: center; padding: 15px; background: rgba(46, 204, 113, 0.15); border: 2px solid #2ecc71; border-radius: 10px;">
                        <p style="margin: 5px 0; font-size: 16px; color: #27ae60;">✨ 默契度大幅提升！</p>
                        <p style="margin: 5px 0; font-size: 18px; font-weight: bold; color: #2ecc71;">
                            ${oldChemistry} → ${teammate.chemistry} (+${chemistryGain})
                        </p>
                        ${teammate.personality === '内向型' ? '<p style="margin: 5px 0; font-size: 12px; color: #27ae60;">（内向型性格加成 +20%）</p>' : ''}
                    </div>
                `;
                
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.closeTeammateDetail(); game.renderTeammatesPanel();">确定</button>
                `;
                
                modal.classList.add('show');
            }
            
            // 生成对话内容（根据性格和默契等级）
            generateDialogue(teammate) {
                const chemistry = teammate.chemistry;
                const personality = teammate.personality;
                
                // 根据默契等级确定对话深度
                let dialogues = [];
                
                if (chemistry < 26) {
                    // 陌生阶段
                    if (personality === '热血型') {
                        dialogues = [
                            '"嘿！你好啊！我超喜欢排球的，以后多多指教！"',
                            '"听说你也很厉害，有机会一起练练吧！"',
                            '"我会努力训练的，一起加油！"'
                        ];
                    } else if (personality === '冷静型') {
                        dialogues = [
                            '"你好。我会尽力配合团队的。"',
                            '"嗯，有什么需要帮忙的可以说。"',
                            '"训练的时候注意观察对手的习惯。"'
                        ];
                    } else if (personality === '开朗型') {
                        dialogues = [
                            '"哈哈，很高兴认识你！我们一定能成为好朋友的！"',
                            '"你看起来很好相处呢，以后一起吃饭吧！"',
                            '"今天天气真好，心情也变好了呢！"'
                        ];
                    } else if (personality === '内向型') {
                        dialogues = [
                            '"嗯...你好...请多关照..."',
                            '"那个...有空的话...可以一起练习..."',
                            '"...谢谢你愿意和我聊天..."'
                        ];
                    } else if (personality === '严肃型') {
                        dialogues = [
                            '"既然是队友，就要认真对待每一次训练。"',
                            '"我不喜欢浪费时间，希望你也一样。"',
                            '"比赛的时候，我会全力以赴。"'
                        ];
                    }
                } else if (chemistry < 51) {
                    // 熟悉阶段
                    if (personality === '热血型') {
                        dialogues = [
                            '"和你一起打球真的很开心！感觉我们越来越有默契了！"',
                            '"上次那个配合太棒了！我们继续保持这种状态！"',
                            '"我觉得我们的组合能创造奇迹！"'
                        ];
                    } else if (personality === '冷静型') {
                        dialogues = [
                            '"你的判断很准确，和你配合很舒服。"',
                            '"我注意到你最近进步很快，继续保持。"',
                            '"下次比赛我们可以尝试那个战术。"'
                        ];
                    } else if (personality === '开朗型') {
                        dialogues = [
                            '"和你在一起训练总是很愉快！你真是个好队友！"',
                            '"昨天那个笑话你听了吗？哈哈太好笑了！"',
                            '"周末要不要一起去吃好吃的？我知道一家很棒的店！"'
                        ];
                    } else if (personality === '内向型') {
                        dialogues = [
                            '"谢谢你...一直这么照顾我...我会努力的..."',
                            '"其实...我一直想说...和你一起打球很安心..."',
                            '"你是个...很好的人...我很高兴能认识你..."'
                        ];
                    } else if (personality === '严肃型') {
                        dialogues = [
                            '"你的态度我很认可，这才是真正的运动员。"',
                            '"我们的配合还有提升空间，继续努力。"',
                            '"你有成为顶尖选手的潜力，不要松懈。"'
                        ];
                    }
                } else if (chemistry < 76) {
                    // 默契阶段
                    if (personality === '热血型') {
                        dialogues = [
                            '"我们已经是最佳搭档了！没有什么能阻挡我们！"',
                            '"每次和你配合，我都能感受到那种心有灵犀的感觉！"',
                            '"有你在，我觉得什么困难都能克服！让我们一起冲向全国大赛！"'
                        ];
                    } else if (personality === '冷静型') {
                        dialogues = [
                            '"和你的配合已经达到了很高的水平，我很满意。"',
                            '"你能理解我的意图，这种默契很难得。"',
                            '"我相信我们能走得更远，一起实现目标吧。"'
                        ];
                    } else if (personality === '开朗型') {
                        dialogues = [
                            '"你真的是我最好的朋友！有你在队里太好了！"',
                            '"我们的友谊和默契都是最棒的！以后也要一直在一起哦！"',
                            '"每天和你一起训练、一起欢笑，这就是我最幸福的时光！"'
                        ];
                    } else if (personality === '内向型') {
                        dialogues = [
                            '"能遇到你...真的很幸运...你是我最重要的队友..."',
                            '"以前我总是一个人...但现在有你在...我不再感到孤单了..."',
                            '"谢谢你...一直相信我...我会用行动回报你的..."'
                        ];
                    } else if (personality === '严肃型') {
                        dialogues = [
                            '"你是我见过最有天赋和毅力的选手，我认可你。"',
                            '"我们的配合已经接近完美，这是长期努力的结果。"',
                            '"和你一起，我相信我们能达到前所未有的高度。"'
                        ];
                    }
                } else {
                    // 心有灵犀阶段
                    if (personality === '热血型') {
                        dialogues = [
                            '"我们就是最强的组合！无论什么对手都不在话下！"',
                            '"和你并肩作战，我感觉自己能超越极限！这就是羁绊的力量！"',
                            '"我们的梦想一定能实现！因为我们是最好的伙伴！"'
                        ];
                    } else if (personality === '冷静型') {
                        dialogues = [
                            '"我们之间已经不需要太多语言了，一个眼神就能明白。"',
                            '"这种默契是无价的，我很珍惜我们的搭档关系。"',
                            '"无论面对什么挑战，我都相信我们能一起克服。"'
                        ];
                    } else if (personality === '开朗型') {
                        dialogues = [
                            '"你不仅是我最好的队友，更是我一生的挚友！"',
                            '"和你在一起的每一天都充满欢笑和感动，这份友谊我会永远珍藏！"',
                            '"无论将来走到哪里，我们的友谊都不会改变！"'
                        ];
                    } else if (personality === '内向型') {
                        dialogues = [
                            '"你...改变了我的人生...我真的很感激...能遇到你..."',
                            '"以前我从不敢想象...能有这样的朋友...谢谢你...一直陪伴我..."',
                            '"你就像...家人一样...我会永远...珍惜这份羁绊..."'
                        ];
                    } else if (personality === '严肃型') {
                        dialogues = [
                            '"你是我唯一认可的真正的伙伴，我们会一起登上顶峰。"',
                            '"这种完美的配合，是我们共同努力的结晶，我为此感到骄傲。"',
                            '"和你一起，我看到了通往冠军的道路。让我们一起创造历史。"'
                        ];
                    }
                }
                
                return dialogues[Math.floor(Math.random() * dialogues.length)];
            }
            
            // 生成送礼反应（根据性格）
            generateGiftReaction(teammate, gift) {
                const personality = teammate.personality;
                const chemistry = teammate.chemistry;
                
                let reactions = [];
                
                if (personality === '热血型') {
                    reactions = [
                        `"哇！${gift.name}！太棒了！你真是太贴心了！我一定会好好使用的！"`,
                        `"${gift.name}！这正是我想要的！谢谢你！我会更加努力训练的！"`,
                        `"收到${gift.name}我超开心的！有你这样的队友真好！"`
                    ];
                } else if (personality === '冷静型') {
                    reactions = [
                        `"${gift.name}...很实用，谢谢。我会珍惜的。"`,
                        `"你有心了。${gift.name}确实是我需要的，感谢。"`,
                        `"${gift.name}...不错的选择。我收下了，谢谢你。"`
                    ];
                } else if (personality === '开朗型') {
                    reactions = [
                        `"哇啊！${gift.name}！你怎么知道我喜欢这个的！太开心了！"`,
                        `"${gift.name}耶！你真是太好了！我也要送你礼物！"`,
                        `"收到${gift.name}好开心！我们的友谊又加深了呢！"`
                    ];
                } else if (personality === '内向型') {
                    reactions = [
                        `"这...这是给我的吗...${gift.name}...谢谢你...我很喜欢..."`,
                        `"${gift.name}...你太好了...我...我会好好珍惜的..."`,
                        `"没想到...你会送我${gift.name}...真的...很感动..."`
                    ];
                } else if (personality === '严肃型') {
                    reactions = [
                        `"${gift.name}...你的心意我收到了。我会记住的。"`,
                        `"${gift.name}，很有用。你是个值得信赖的队友。"`,
                        `"谢谢你的${gift.name}。我会用实力回报你的期待。"`
                    ];
                }
                
                // 高默契时添加额外的感情表达
                if (chemistry >= 51) {
                    if (personality === '热血型') {
                        reactions.push(`"${gift.name}！你真的太了解我了！我们果然是最佳搭档！"`);
                    } else if (personality === '冷静型') {
                        reactions.push(`"${gift.name}...你总是这么细心。和你做队友，我很幸运。"`);
                    } else if (personality === '开朗型') {
                        reactions.push(`"${gift.name}！你真是我最好的朋友！我好喜欢你啊！"`);
                    } else if (personality === '内向型') {
                        reactions.push(`"${gift.name}...你对我这么好...我...我真的不知道该怎么感谢你..."`);
                    } else if (personality === '严肃型') {
                        reactions.push(`"${gift.name}...你的这份心意，比任何东西都珍贵。谢谢。"`);
                    }
                }
                
                return reactions[Math.floor(Math.random() * reactions.length)];
            }
            
            // ====================================================
            // 位置配合技能系统
            // ====================================================
            
            // 检查并解锁技能
            checkAndUnlockSkills() {
                if (!this.teammates || this.teammates.length === 0) return;
                if (this.player.position === 'none') return;
                
                // 确保unlockedSkills数组存在
                if (!this.player.unlockedSkills) {
                    this.player.unlockedSkills = [];
                }
                
                const newlyUnlocked = [];
                
                this.teammates.forEach(teammate => {
                    const skillKey = this.getSkillKey(this.player.position, teammate.position);
                    if (!skillKey) return;
                    
                    const skillDef = this.COMBO_SKILLS[skillKey];
                    if (!skillDef) return;
                    
                    // 检查是否已解锁
                    const existing = this.player.unlockedSkills.find(s => 
                        s.skillId === skillDef.id && s.teammateId === teammate.id
                    );
                    
                    if (!existing && teammate.chemistry >= skillDef.unlockChemistry) {
                        // 解锁新技能
                        const newSkill = {
                            skillId: skillDef.id,
                            skillKey: skillKey,
                            level: 1,
                            teammateId: teammate.id,
                            unlockedAt: this.player.week,
                            triggerCount: 0
                        };
                        this.player.unlockedSkills.push(newSkill);
                        newlyUnlocked.push({ skill: skillDef, teammate: teammate });
                    } else if (existing) {
                        // 检查是否可以升级
                        const currentLevel = existing.level;
                        if (currentLevel < 3) {
                            const nextLevelChem = skillDef.upgradeChemistry[currentLevel - 1];
                            if (teammate.chemistry >= nextLevelChem) {
                                existing.level++;
                                newlyUnlocked.push({ 
                                    skill: skillDef, 
                                    teammate: teammate, 
                                    upgraded: true, 
                                    newLevel: existing.level 
                                });
                            }
                        }
                    }
                });
                
                // 显示解锁/升级提示
                if (newlyUnlocked.length > 0) {
                    this.showSkillUnlockNotification(newlyUnlocked);
                }
            }
            
            // 获取技能键名
            getSkillKey(playerPos, teammatePos) {
                // 特殊处理：相同位置
                if (playerPos === teammatePos) {
                    return `${playerPos}_${teammatePos}`;
                }
                
                // 尝试两种组合
                const key1 = `${playerPos}_${teammatePos}`;
                const key2 = `${teammatePos}_${playerPos}`;
                
                if (this.COMBO_SKILLS[key1]) return key1;
                if (this.COMBO_SKILLS[key2]) return key2;
                
                return null;
            }
            
            // 显示技能解锁通知
            showSkillUnlockNotification(unlockedSkills) {
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                let html = '';
                
                unlockedSkills.forEach((item, index) => {
                    const { skill, teammate, upgraded, newLevel } = item;
                    const posInfo = this.positions[teammate.position];
                    
                    if (upgraded) {
                        // 技能升级
                        html += `
                            ${index > 0 ? '<hr style="margin: 20px 0; border: none; border-top: 2px dashed #ddd;">' : ''}
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-size: 48px; margin: 10px 0;">${skill.emoji}</div>
                                <h3 style="color: #667eea; margin: 10px 0;">✨ 技能升级！✨</h3>
                                <p style="font-size: 20px; font-weight: bold; color: #f39c12; margin: 10px 0;">
                                    ${skill.name} [Lv.${newLevel}]
                                </p>
                                <p style="font-size: 14px; color: #666; margin: 5px 0;">
                                    配合队友：${posInfo.icon} ${teammate.name}
                                </p>
                                <p style="font-size: 14px; color: #999; margin: 5px 0;">
                                    默契度：${teammate.chemistry}/100
                                </p>
                            </div>
                            <div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 10px; border: 2px solid #f39c12;">
                                <p style="font-size: 14px; line-height: 1.6; color: #333; margin: 0;">
                                    ${skill.description}
                                </p>
                                <p style="font-size: 13px; color: #f39c12; margin-top: 10px; font-weight: bold;">
                                    技能效果增强！触发率提升至 ${Math.round(skill.effects.triggerRate[newLevel - 1] * 100)}%
                                </p>
                            </div>
                        `;
                    } else {
                        // 新技能解锁
                        html += `
                            ${index > 0 ? '<hr style="margin: 20px 0; border: none; border-top: 2px dashed #ddd;">' : ''}
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-size: 48px; margin: 10px 0;">${skill.emoji}</div>
                                <h3 style="color: #667eea; margin: 10px 0;">🌟 新技能解锁！🌟</h3>
                                <p style="font-size: 20px; font-weight: bold; color: #667eea; margin: 10px 0;">
                                    ${skill.name} [Lv.1]
                                </p>
                                <p style="font-size: 14px; color: #666; margin: 5px 0;">
                                    配合队友：${posInfo.icon} ${teammate.name}
                                </p>
                                <p style="font-size: 14px; color: #999; margin: 5px 0;">
                                    默契度：${teammate.chemistry}/100
                                </p>
                            </div>
                            <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; border: 2px solid #667eea;">
                                <p style="font-size: 14px; line-height: 1.6; color: #333; margin: 0;">
                                    ${skill.description}
                                </p>
                                <p style="font-size: 13px; color: #667eea; margin-top: 10px;">
                                    "这就是...完美的配合！"
                                </p>
                            </div>
                        `;
                    }
                });
                
                title.textContent = unlockedSkills.length === 1 && unlockedSkills[0].upgraded ? '✨ 技能升级' : '🌟 技能解锁';
                text.innerHTML = html;
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.closeSkillNotification()">太棒了！</button>
                `;
                
                modal.classList.add('show');
            }
            
            // 关闭技能通知
            closeSkillNotification() {
                const modal = document.getElementById('event-modal');
                modal.classList.remove('show');
            }
            
            // 获取玩家与队友的已解锁技能
            getUnlockedSkillsWithTeammate(teammateId) {
                if (!this.player.unlockedSkills) {
                    this.player.unlockedSkills = [];
                }
                return this.player.unlockedSkills.filter(s => s.teammateId === teammateId);
            }
            
            // 获取所有已解锁技能的胜率加成
            getTotalWinRateBonus() {
                if (!this.player.unlockedSkills) {
                    this.player.unlockedSkills = [];
                }
                
                let totalBonus = 0;
                
                this.player.unlockedSkills.forEach(skill => {
                    const skillDef = this.COMBO_SKILLS[skill.skillKey];
                    if (skillDef) {
                        const bonus = skillDef.effects.winRateBonus[skill.level - 1];
                        totalBonus += bonus;
                    }
                });
                
                // 最多累加10%
                return Math.min(0.10, totalBonus);
            }
            
            // 创建得分记录元素（带技能特效）
            createScoreLogItem(log) {
                const logItem = document.createElement('div');
                let className = `match-log-item ${log.scorer === 'my' ? 'my-point' : 'opponent-point'}`;
                
                // 如果触发了技能，添加特殊样式
                if (log.skillTriggered) {
                    className += ' skill-triggered';
                }
                
                logItem.className = className;
                
                // 技能触发时使用金色，否则使用默认颜色
                const scoreColor = log.skillTriggered ? '#ffd700' : (log.scorer === 'my' ? '#2ecc71' : '#e74c3c');
                let descriptionHTML = `<div class="match-log-description">${log.description}</div>`;
                
                // 如果触发了技能，添加技能标记
                if (log.skillTriggered && log.skillDef) {
                    const levelColors = ['#667eea', '#9b59b6', '#ffd700'];
                    const levelColor = levelColors[log.skillLevel - 1];
                    descriptionHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <span style="font-size: 20px;">${log.skillDef.emoji}</span>
                            <span style="color: ${levelColor}; font-weight: bold; font-size: 14px;">${log.skillDef.name} [Lv.${log.skillLevel}]</span>
                        </div>
                        <div class="match-log-description">${log.description}</div>
                    `;
                }
                
                logItem.innerHTML = `
                    <div class="match-log-score" style="color: ${scoreColor};">
                        ${log.myScore} : ${log.opponentScore}
                    </div>
                    ${descriptionHTML}
                `;
                
                return logItem;
            }
            
            // 渲染队友的已解锁技能
            renderUnlockedSkillsForTeammate(teammateId) {
                const unlockedSkills = this.getUnlockedSkillsWithTeammate(teammateId);
                
                if (unlockedSkills.length === 0) {
                    // 显示未解锁提示
                    const teammate = this.teammates.find(t => t.id === teammateId);
                    if (!teammate) return '';
                    
                    const skillKey = this.getSkillKey(this.player.position, teammate.position);
                    if (!skillKey) return '';
                    
                    const skillDef = this.COMBO_SKILLS[skillKey];
                    if (!skillDef) return '';
                    
                    const needed = skillDef.unlockChemistry - teammate.chemistry;
                    
                    return `
                        <div style="background: rgba(200, 200, 200, 0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <h3 style="margin-top: 0; color: #999;">🔒 配合技能</h3>
                            <div style="text-align: center; padding: 15px;">
                                <div style="font-size: 36px; margin-bottom: 10px; opacity: 0.5;">${skillDef.emoji}</div>
                                <p style="font-size: 16px; color: #666; margin: 5px 0;">${skillDef.name}</p>
                                <p style="font-size: 13px; color: #999; margin: 10px 0;">${skillDef.description}</p>
                                <p style="font-size: 14px; color: #f39c12; margin-top: 10px;">
                                    还需 ${needed} 默契度解锁
                                </p>
                            </div>
                        </div>
                    `;
                }
                
                // 显示已解锁的技能
                let html = `
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">
                        <h3 style="margin-top: 0; color: #667eea;">🌟 已解锁配合技能</h3>
                `;
                
                unlockedSkills.forEach(skill => {
                    const skillDef = this.COMBO_SKILLS[skill.skillKey];
                    if (!skillDef) return;
                    
                    const levelColors = ['#667eea', '#9b59b6', '#f39c12'];
                    const levelColor = levelColors[skill.level - 1];
                    
                    html += `
                        <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 2px solid ${levelColor};">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 32px;">${skillDef.emoji}</div>
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: bold; color: ${levelColor};">
                                        ${skillDef.name} [Lv.${skill.level}]
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 3px;">
                                        ${skillDef.description}
                                    </div>
                                    <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                        触发率: ${Math.round(skillDef.effects.triggerRate[skill.level - 1] * 100)}% | 
                                        已触发: ${skill.triggerCount}次
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                return html;
            }
            
            // ====================================================
            // 结束位置配合技能系统
            // ====================================================
            
            // 院队队友转入校队（方案B）
            transferTeammatesToUniversity() {
                console.log('=== 开始队友转换：院队 → 校队 ===');
                
                // 筛选可以保留的队友（默契≥80 或 能力≥75）
                const qualifiedTeammates = this.teammates.filter(t => 
                    t.chemistry >= 80 || t.averageSkill >= 75
                );
                
                // 按优先级排序：默契 > 能力
                qualifiedTeammates.sort((a, b) => {
                    if (a.chemistry !== b.chemistry) {
                        return b.chemistry - a.chemistry;  // 默契高的优先
                    }
                    return b.averageSkill - a.averageSkill;  // 能力高的优先
                });
                
                // 保留2-3人
                const keepCount = Math.min(3, qualifiedTeammates.length);
                const keptTeammates = qualifiedTeammates.slice(0, keepCount);
                
                console.log(`符合条件的队友: ${qualifiedTeammates.length}人，保留: ${keepCount}人`);
                
                // 记录保留的队友名字
                const keptNames = keptTeammates.map(t => t.name);
                
                // 获取需要补充的位置（6人制）
                const neededPositions = [
                    'outsideHitter',
                    'middleBlocker',
                    'setter',
                    'oppositeHitter',
                    'libero',
                    'outsideHitter'
                ];
                
                // 移除玩家位置
                const playerPosIndex = neededPositions.indexOf(this.player.position);
                if (playerPosIndex !== -1) {
                    neededPositions.splice(playerPosIndex, 1);
                }
                
                // 移除已保留队友的位置
                for (let teammate of keptTeammates) {
                    const posIndex = neededPositions.indexOf(teammate.position);
                    if (posIndex !== -1) {
                        neededPositions.splice(posIndex, 1);
                    }
                    
                    // 提升保留队友的能力（+5）和默契（+10）
                    for (let skill in teammate.skills) {
                        teammate.skills[skill] = Math.min(95, teammate.skills[skill] + 5);
                    }
                    teammate.averageSkill = Math.round((teammate.skills.serve + teammate.skills.spike + 
                                                        teammate.skills.block + teammate.skills.dig + 
                                                        teammate.skills.set) / 5);
                    teammate.chemistry = Math.min(100, teammate.chemistry + 10);
                }
                
                // 生成新的校队队友补充剩余位置
                const newTeammates = [];
                const skillRange = { min: 65, max: 80, potential: 90 };
                
                for (let position of neededPositions) {
                    const posInfo = this.positions[position];
                    
                    const skills = {};
                    for (let skill of ['serve', 'spike', 'block', 'dig', 'set']) {
                        if (posInfo.coreSkills.includes(skill)) {
                            skills[skill] = Math.floor(Math.random() * (skillRange.max - skillRange.min + 1)) + skillRange.min;
                        } else if (posInfo.secondarySkills.includes(skill)) {
                            skills[skill] = Math.floor(Math.random() * (skillRange.max - skillRange.min - 10 + 1)) + skillRange.min - 10;
                        } else {
                            skills[skill] = Math.floor(Math.random() * (skillRange.min - 30 + 1)) + 30;
                        }
                    }
                    
                    const avgSkill = Math.round((skills.serve + skills.spike + skills.block + skills.dig + skills.set) / 5);
                    
                    const teammate = {
                        id: `teammate_uni_${newTeammates.length}`,
                        name: generateRandomName(),
                        position: position,
                        skills: skills,
                        averageSkill: avgSkill,
                        chemistry: Math.floor(Math.random() * 15) + 15,  // 新队友默契15-30
                        personality: ['热血型', '冷静型', '开朗型', '内向型', '严肃型'][Math.floor(Math.random() * 5)],
                        weeklyInteractions: {
                            chatted: false,
                            gifted: false
                        }
                    };
                    
                    newTeammates.push(teammate);
                }
                
                // 更新队友列表
                this.teammates = [...keptTeammates, ...newTeammates];
                this.updateTeamStats();
                
                console.log(`队友转换完成：保留${keptTeammates.length}人，新增${newTeammates.length}人`);
                
                // 显示详细的转换提示弹窗
                this.showUniversityTransferNotification(keptTeammates, newTeammates);
            }
            
            // 显示入选校队的队友转换通知
            showUniversityTransferNotification(keptTeammates, newTeammates) {
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                title.textContent = '🌟 恭喜入选校队！';
                
                let contentHTML = '';
                
                if (keptTeammates.length > 0) {
                    // 有队友一起入选
                    const keptNames = keptTeammates.map(t => t.name).join('、');
                    const otherCount = 5 - keptTeammates.length;
                    
                    contentHTML = `
                        <div style="text-align: center; line-height: 1.8; color: #333;">
                            <div style="font-size: 48px; margin: 20px 0;">🎉</div>
                            
                            <h3 style="color: #667eea; margin: 20px 0;">一起进入校队的队友</h3>
                            <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <p style="font-size: 18px; font-weight: bold; color: #667eea; margin: 10px 0;">
                                    ${keptNames}
                                </p>
                                <p style="color: #666; font-size: 14px; margin: 10px 0;">
                                    你们在院队建立的深厚默契将在校队继续延续！<br>
                                    他们的能力和默契都得到了提升！
                                </p>
                            </div>
                            
                            ${otherCount > 0 ? `
                            <p style="color: #999; font-size: 14px; margin: 15px 0;">
                                其他${otherCount}名院队队友将继续在院队发光发热，<br>
                                他们为你们感到骄傲，并祝福你们在校队取得更好的成绩！
                            </p>
                            ` : ''}
                            
                            <h3 style="color: #f39c12; margin: 25px 0 15px 0;">新的校队队友</h3>
                            <div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    `;
                    
                    // 显示新队友信息
                    for (let teammate of newTeammates) {
                        const posInfo = this.positions[teammate.position];
                        contentHTML += `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.5); border-radius: 5px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 24px;">${posInfo.icon}</span>
                                    <div style="text-align: left;">
                                        <div style="font-weight: bold; color: #333;">${teammate.name}</div>
                                        <div style="font-size: 12px; color: #666;">${posInfo.name} | ${teammate.personality}</div>
                                    </div>
                                </div>
                                <div style="text-align: right; font-size: 12px;">
                                    <div style="color: #4CAF50;">能力 ${teammate.averageSkill}</div>
                                    <div style="color: #3498db;">默契 ${teammate.chemistry}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    contentHTML += `
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                                <p style="font-size: 16px; font-weight: bold; margin: 10px 0;">
                                    🏐 你们${keptTeammates.length + 1}人和${newTeammates.length}名新队友组成了校队首发阵容！
                                </p>
                                <p style="font-size: 14px; margin: 10px 0; opacity: 0.9;">
                                    这是一支实力强劲的队伍，让我们一起向全国冠军发起冲击！
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    // 没有队友一起入选
                    contentHTML = `
                        <div style="text-align: center; line-height: 1.8; color: #333;">
                            <div style="font-size: 48px; margin: 20px 0;">🌟</div>
                            
                            <p style="font-size: 16px; color: #666; margin: 20px 0;">
                                虽然院队的队友们没能一起进入校队，<br>
                                但你们在院队建立的友谊和回忆将永远珍藏在心中。<br>
                                他们为你感到骄傲，并祝福你在校队取得更好的成绩！
                            </p>
                            
                            <h3 style="color: #f39c12; margin: 25px 0 15px 0;">新的校队队友</h3>
                            <div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    `;
                    
                    // 显示新队友信息
                    for (let teammate of newTeammates) {
                        const posInfo = this.positions[teammate.position];
                        contentHTML += `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.5); border-radius: 5px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 24px;">${posInfo.icon}</span>
                                    <div style="text-align: left;">
                                        <div style="font-weight: bold; color: #333;">${teammate.name}</div>
                                        <div style="font-size: 12px; color: #666;">${posInfo.name} | ${teammate.personality}</div>
                                    </div>
                                </div>
                                <div style="text-align: right; font-size: 12px;">
                                    <div style="color: #4CAF50;">能力 ${teammate.averageSkill}</div>
                                    <div style="color: #3498db;">默契 ${teammate.chemistry}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    contentHTML += `
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                                <p style="font-size: 16px; font-weight: bold; margin: 10px 0;">
                                    🏐 你和${newTeammates.length}名校队队友组成了首发阵容！
                                </p>
                                <p style="font-size: 14px; margin: 10px 0; opacity: 0.9;">
                                    这是一支实力强劲的队伍，让我们一起向全国冠军发起冲击！
                                </p>
                            </div>
                        </div>
                    `;
                }
                
                text.innerHTML = contentHTML;
                
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.closeUniversityTransferNotification()">开始校队生涯！</button>
                `;
                
                modal.classList.add('show');
            }
            
            // 关闭入选校队通知
            closeUniversityTransferNotification() {
                const modal = document.getElementById('event-modal');
                modal.classList.remove('show');
            }
            
            // 显示入选院队的欢迎通知
            showCollegeTeamWelcomeNotification() {
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                title.textContent = '🎉 欢迎加入院队！';
                
                const position = this.positions[this.player.position];
                const teammateNames = this.teammates.map(t => t.name).join('、');
                
                let contentHTML = `
                    <div style="text-align: center; line-height: 1.8; color: #333;">
                        <div style="font-size: 48px; margin: 20px 0;">🏐</div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <p style="font-size: 16px; color: #666; margin: 10px 0;">
                                恭喜你成功入选院队！<br>
                                你选择了 <strong style="color: #667eea;">${position.icon} ${position.name}</strong> 位置。
                            </p>
                        </div>
                        
                        <h3 style="color: #f39c12; margin: 25px 0 15px 0;">你的队友们</h3>
                        <div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                `;
                
                // 显示所有队友信息
                for (let teammate of this.teammates) {
                    const posInfo = this.positions[teammate.position];
                    contentHTML += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.5); border-radius: 5px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">${posInfo.icon}</span>
                                <div style="text-align: left;">
                                    <div style="font-weight: bold; color: #333;">${teammate.name}</div>
                                    <div style="font-size: 12px; color: #666;">${posInfo.name} | ${teammate.personality}</div>
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 12px;">
                                <div style="color: #4CAF50;">能力 ${teammate.averageSkill}</div>
                                <div style="color: #3498db;">默契 ${teammate.chemistry}</div>
                            </div>
                        </div>
                    `;
                }
                
                contentHTML += `
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                            <p style="font-size: 16px; font-weight: bold; margin: 10px 0;">
                                🏐 你和${this.teammates.length}名队友组成了院队首发阵容！
                            </p>
                            <p style="font-size: 14px; margin: 10px 0; opacity: 0.9;">
                                通过训练、聊天、送礼来提升队友的能力和默契度，<br>
                                解锁强大的配合技能，一起向更高的目标前进！
                            </p>
                        </div>
                        
                        <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 4px solid #3498db;">
                            <p style="font-size: 13px; color: #555; margin: 5px 0; text-align: left;">
                                💡 <strong>提示：</strong><br>
                                • 每周可以和队友聊天3次、送礼3次来提升默契<br>
                                • 默契达到70/85/95时会解锁/升级配合技能<br>
                                • 队友会在每周自动成长（6-11点/周），默契越高成长越快<br>
                                • 打友谊赛可以同时提升队友能力和默契
                            </p>
                        </div>
                    </div>
                `;
                
                text.innerHTML = contentHTML;
                
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.closeCollegeTeamWelcomeNotification()">开始院队生涯！</button>
                `;
                
                modal.classList.add('show');
            }
            
            // 关闭入选院队欢迎通知
            closeCollegeTeamWelcomeNotification() {
                const modal = document.getElementById('event-modal');
                modal.classList.remove('show');
                
                // 继续正常流程
                this.currentScene = 'weeklyHub';
                this.showScene('weeklyHub');
                this.updateUI();
            }
            
            // ====================================================
            // 群体社交活动
            // ====================================================
            
            // 处理队伍聚餐
            handleTeamDinner() {
                // 检查是否有队友
                if (!this.teammates || this.teammates.length === 0) {
                    alert('你还没有队友！加入院队或校队后才能组织队伍活动。');
                    return;
                }
                
                // 检查条件
                if (this.player.money < 80) {
                    alert('金钱不足！需要80元组织聚餐。');
                    return;
                }
                if (this.player.energy < 5) {
                    alert('体力不足！需要至少5点体力。');
                    return;
                }
                
                // 扣除资源
                this.player.money -= 80;
                this.player.energy -= 5;
                
                // 应用心情和压力效果
                this.player.mood = Math.min(100, (this.player.mood || 50) + 10);
                this.player.stress = Math.max(0, (this.player.stress || 0) - 5);
                
                // 为每个队友增加默契（降低增长）
                const chemistryGains = [];
                this.teammates.forEach(teammate => {
                    const gain = Math.floor(Math.random() * 2) + 1; // 1-2（原3-5）
                    const oldChemistry = teammate.chemistry;
                    teammate.chemistry = Math.min(100, teammate.chemistry + gain);
                    chemistryGains.push({
                        name: teammate.name,
                        gain: gain,
                        oldChemistry: oldChemistry,
                        newChemistry: teammate.chemistry
                    });
                });
                
                // 更新队伍统计
                this.updateTeamStats();
                
                // 检查并解锁技能
                this.checkAndUnlockSkills();
                
                this.updateUI();
                
                // 显示结果弹窗
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                title.textContent = '🍕 队伍聚餐';
                
                let chemistryHTML = '';
                chemistryGains.forEach(item => {
                    chemistryHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.5); border-radius: 5px;">
                            <span style="font-weight: bold; color: #333;">${item.name}</span>
                            <span style="color: #2ecc71; font-weight: bold;">默契 ${item.oldChemistry} → ${item.newChemistry} (+${item.gain})</span>
                        </div>
                    `;
                });
                
                text.innerHTML = `
                    <div style="text-align: center; line-height: 1.8; color: #333;">
                        <div style="font-size: 48px; margin: 20px 0;">🍕</div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <p style="font-size: 15px; line-height: 1.8; color: #555; margin: 0;">
                                你请队友们去食堂吃了顿好的，大家边吃边聊，<br>
                                气氛很轻松。虽然只是简单的聚餐，<br>
                                但队友们都很开心，彼此的关系更近了一步。
                            </p>
                        </div>
                        
                        <h3 style="color: #667eea; margin: 20px 0 10px 0;">队友默契提升</h3>
                        <div style="background: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            ${chemistryHTML}
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                            <div style="background: rgba(255, 193, 7, 0.2); padding: 10px 15px; border-radius: 8px; flex: 1;">
                                <div style="font-size: 12px; color: #666;">心情</div>
                                <div style="font-size: 16px; font-weight: bold; color: #f39c12;">+10</div>
                            </div>
                            <div style="background: rgba(52, 152, 219, 0.2); padding: 10px 15px; border-radius: 8px; flex: 1;">
                                <div style="font-size: 12px; color: #666;">压力</div>
                                <div style="font-size: 16px; font-weight: bold; color: #3498db;">-5</div>
                            </div>
                        </div>
                    </div>
                `;
                
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.closeTeamActivityModal()">太棒了！</button>
                `;
                
                modal.classList.add('show');
                
                // 追踪课余活动
                this.trackLifeActivity('teamDinner');
            }
            
            // 处理团队建设活动
            handleTeamBuilding() {
                // 检查是否有队友
                if (!this.teammates || this.teammates.length === 0) {
                    alert('你还没有队友！加入院队或校队后才能组织队伍活动。');
                    return;
                }
                
                // 检查条件
                if (this.player.money < 200) {
                    alert('金钱不足！需要200元组织团建活动。');
                    return;
                }
                if (this.player.energy < 15) {
                    alert('体力不足！需要至少15点体力。');
                    return;
                }
                
                // 扣除资源
                this.player.money -= 200;
                this.player.energy -= 15;
                
                // 应用心情、压力和声望效果
                this.player.mood = Math.min(100, (this.player.mood || 50) + 20);
                this.player.stress = Math.max(0, (this.player.stress || 0) - 15);
                this.player.reputation = (this.player.reputation || 0) + 5;
                
                // 为每个队友增加默契（降低增长）
                const chemistryGains = [];
                this.teammates.forEach(teammate => {
                    const gain = Math.floor(Math.random() * 3) + 3; // 3-5（原8-12）
                    const oldChemistry = teammate.chemistry;
                    teammate.chemistry = Math.min(100, teammate.chemistry + gain);
                    chemistryGains.push({
                        name: teammate.name,
                        gain: gain,
                        oldChemistry: oldChemistry,
                        newChemistry: teammate.chemistry
                    });
                });
                
                // 随机选择2-3名队友提升能力
                const luckyCount = Math.random() < 0.5 ? 2 : 3;
                const shuffled = [...this.teammates].sort(() => Math.random() - 0.5);
                const luckyTeammates = shuffled.slice(0, luckyCount);
                
                const skillGains = [];
                luckyTeammates.forEach(teammate => {
                    const posInfo = this.positions[teammate.position];
                    // 优先提升核心技能，如果次要技能为空则只用核心技能
                    let skillPool;
                    if (Math.random() < 0.7 || posInfo.secondarySkills.length === 0) {
                        skillPool = posInfo.coreSkills;
                    } else {
                        skillPool = posInfo.secondarySkills;
                    }
                    
                    const skill = skillPool[Math.floor(Math.random() * skillPool.length)];
                    const gain = Math.floor(Math.random() * 2) + 1; // 1-2
                    
                    teammate.skills[skill] = Math.min(100, teammate.skills[skill] + gain);
                    
                    // 更新平均能力
                    teammate.averageSkill = Math.round(
                        (teammate.skills.serve + teammate.skills.spike + teammate.skills.block + 
                         teammate.skills.dig + teammate.skills.set) / 5
                    );
                    
                    const skillNames = {
                        serve: '发球',
                        spike: '扣球',
                        block: '拦网',
                        dig: '垫球',
                        set: '托球'
                    };
                    
                    skillGains.push({
                        name: teammate.name,
                        skill: skillNames[skill],
                        gain: gain
                    });
                });
                
                // 更新队伍统计
                this.updateTeamStats();
                
                // 检查并解锁技能
                this.checkAndUnlockSkills();
                
                this.updateUI();
                
                // 显示结果弹窗
                const modal = document.getElementById('event-modal');
                const title = document.getElementById('event-modal-title');
                const text = document.getElementById('event-modal-text');
                const choicesDiv = document.getElementById('event-modal-choices');
                
                title.textContent = '🎉 团队建设活动';
                
                let chemistryHTML = '';
                chemistryGains.forEach(item => {
                    chemistryHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.5); border-radius: 5px;">
                            <span style="font-weight: bold; color: #333;">${item.name}</span>
                            <span style="color: #2ecc71; font-weight: bold;">默契 ${item.oldChemistry} → ${item.newChemistry} (+${item.gain})</span>
                        </div>
                    `;
                });
                
                let skillHTML = '';
                if (skillGains.length > 0) {
                    skillHTML = '<h3 style="color: #f39c12; margin: 20px 0 10px 0;">队友能力提升</h3><div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">';
                    skillGains.forEach(item => {
                        skillHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.5); border-radius: 5px;">
                                <span style="font-weight: bold; color: #333;">${item.name}</span>
                                <span style="color: #e67e22; font-weight: bold;">${item.skill} +${item.gain}</span>
                            </div>
                        `;
                    });
                    skillHTML += '</div>';
                }
                
                text.innerHTML = `
                    <div style="text-align: center; line-height: 1.8; color: #333;">
                        <div style="font-size: 48px; margin: 20px 0;">🎉</div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <p style="font-size: 15px; line-height: 1.8; color: #555; margin: 0;">
                                你组织了一次完整的团建活动：<br>
                                先去打了保龄球，然后一起唱K，最后吃了烧烤。<br>
                                大家玩得很尽兴，队友们之间的配合更加默契了，<br>
                                有几个人还在活动中找到了新的训练灵感！
                            </p>
                        </div>
                        
                        <h3 style="color: #667eea; margin: 20px 0 10px 0;">队友默契大幅提升</h3>
                        <div style="background: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            ${chemistryHTML}
                        </div>
                        
                        ${skillHTML}
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
                            <div style="background: rgba(255, 193, 7, 0.2); padding: 10px; border-radius: 8px;">
                                <div style="font-size: 12px; color: #666;">心情</div>
                                <div style="font-size: 16px; font-weight: bold; color: #f39c12;">+20</div>
                            </div>
                            <div style="background: rgba(52, 152, 219, 0.2); padding: 10px; border-radius: 8px;">
                                <div style="font-size: 12px; color: #666;">压力</div>
                                <div style="font-size: 16px; font-weight: bold; color: #3498db;">-15</div>
                            </div>
                            <div style="background: rgba(155, 89, 182, 0.2); padding: 10px; border-radius: 8px; grid-column: span 2;">
                                <div style="font-size: 12px; color: #666;">声望</div>
                                <div style="font-size: 16px; font-weight: bold; color: #9b59b6;">+5</div>
                            </div>
                        </div>
                    </div>
                `;
                
                choicesDiv.innerHTML = `
                    <button class="choice-btn" onclick="game.closeTeamActivityModal()">太棒了！</button>
                `;
                
                modal.classList.add('show');
                
                // 追踪课余活动
                this.trackLifeActivity('teamBuilding');
            }
            
            // 关闭团队活动弹窗
            closeTeamActivityModal() {
                const modal = document.getElementById('event-modal');
                modal.classList.remove('show');
                
                // 检查是否触发奇遇事件
                const adventureTriggered = this.checkAdventureEvents('general');
                if (adventureTriggered) {
                    return;
                }
                
                // 继续正常流程
                this.currentScene = 'weeklyHub';
                this.showScene('weeklyHub');
            }
            
            // ====================================================
            // 结束队友系统
            // ====================================================
            
            nextWeek() {
                // 保存本周开始时的数据快照
                this.player.weekStartStats = {
                    serve: this.player.skills.serve,
                    spike: this.player.skills.spike,
                    block: this.player.skills.block,
                    dig: this.player.skills.dig,
                    set: this.player.skills.set,
                    maxEnergy: this.player.maxEnergy
                };
                
                this.player.week++;
                this.player.trainingCount = 0;
                this.player.money += (this.player.weeklyAllowance || 120); // 每周零花钱
                this.weekStartNoticeShown = false; // 重置周初提示标志
                
                // 自然恢复
                this.player.energy = this.player.maxEnergy; // 周初体力恢复到满值
                this.player.mood = Math.min(100, this.player.mood + 5);  // 改为+5（原来+10）
                this.player.stress = Math.max(0, this.player.stress - 10);
                
                // 永久物品的持续效果
                if (this.player.ownedItems) {
                    // 运动手环：每周自动恢复压力-5
                    if (this.player.ownedItems.electronics && this.player.ownedItems.electronics.includes('watch')) {
                        this.player.stress = Math.max(0, this.player.stress - 5);
                    }
                    // 新手机：每周心情+3
                    if (this.player.ownedItems.electronics && this.player.ownedItems.electronics.includes('phone')) {
                        this.player.mood = Math.min(100, this.player.mood + 3);
                    }
                    // 营养补剂套装：每周体力+10
                    if (this.player.ownedItems.electronics && this.player.ownedItems.electronics.includes('supplement')) {
                        this.player.energy = Math.min(this.player.maxEnergy, this.player.energy + 10);
                    }
                }
                
                // 处理buff（减少持续周数）
                if (this.player.activeBuffs) {
                    this.player.activeBuffs = this.player.activeBuffs.filter(buff => {
                        buff.remainingWeeks--;
                        // 营养餐计划：体力上限加成
                        if (buff.id === 'nutrition_plan' && buff.effect.maxEnergyBonus) {
                            if (buff.remainingWeeks === 0) {
                                // buff结束，移除体力上限加成
                                this.player.maxEnergy -= buff.effect.maxEnergyBonus;
                            }
                        }
                        return buff.remainingWeeks > 0;
                    });
                }
                
                // 重置队友每周互动状态 + 队友自动成长
                if (this.teammates && this.teammates.length > 0) {
                    for (let teammate of this.teammates) {
                        if (teammate.weeklyInteractions) {
                            teammate.weeklyInteractions.chatted = false;
                            teammate.weeklyInteractions.gifted = false;
                        }
                    }
                    
                    // 队友周初自动成长
                    this.processTeammateWeeklyGrowth();
                    
                    console.log('队友每周互动状态已重置，队友自动成长已处理');
                }
                
                // 自动保存游戏
                this.saveGame();
                
                this.updateUI();
                
                console.log(`第${this.player.week}周开始，当前队伍: ${this.player.team}`);
                
                // 新增：检查是否有固定比赛
                const matchEvent = this.checkScheduledMatch();
                console.log('比赛检查结果:', matchEvent);
                
                if (matchEvent) {
                    // 显示比赛预告场景或启动锦标赛
                    if (matchEvent.type === 'match') {
                        console.log('触发比赛预告:', matchEvent.matchName);
                        this.showMatchPreview(matchEvent.matchType, matchEvent.matchName);
                    } else if (matchEvent.type === 'tournament') {
                        console.log('触发锦标赛:', matchEvent.tournamentType);
                        this.startTournament(matchEvent.tournamentType);
                    } else if (matchEvent.type === 'hiddenEnding') {
                        console.log('触发隐藏结局:', matchEvent.endingId);
                        // 标记游戏已结束
                        this.player.gameOver = true;
                        this.player.endingType = matchEvent.endingId;
                        // 保存游戏状态（标记为已结束）
                        this.saveGame();
                        // 显示结局
                        this.showScene(matchEvent.endingId);
                    } else if (matchEvent.type === 'spectator') {
                        this.showScene(matchEvent.sceneId);
                    } else if (matchEvent.type === 'missed') {
                        this.showScene(matchEvent.sceneId);
                    }
                    return;
                }
                
                // 新增：触发周初事件
                const weeklyEvent = this.generateWeeklyEvent();
                if (weeklyEvent) {
                    this.showWeeklyEvent(weeklyEvent);
                    return;
                }
                
                // 检查当前目标是否到达截止日期（选拔类）
                const currentGoalInfo = this.getGoalInfo();
                if (currentGoalInfo && currentGoalInfo.deadline && this.player.week >= currentGoalInfo.deadline) {
                    // 选拔类目标（Tryout）不自动检查，需要玩家主动触发
                    // 只有比赛类目标才自动检查（但现在比赛不是目标了，所以这段代码实际上不会执行）
                    if (currentGoalInfo.id && !currentGoalInfo.id.includes('Tryout')) {
                        // 到达截止日期，检查目标完成情况
                        this.checkGoalCompletion();
                        return;
                    }
                }
                
                // 如果没有触发任何特殊事件，显示周主界面
                this.showScene('weeklyHub');
            }
            
            // ====================================================
            // 本地存档系统
            // ====================================================
            
            // 保存游戏到localStorage
            saveGame() {
                try {
                    const saveData = {
                        version: GAME_VERSION,
                        timestamp: Date.now(),
                        player: this.player,
                        tournament: this.tournament,
                        playerStats: this.playerStats,
                        shopItems: this.shopItems,
                        adventureEvents: this.adventureEvents,
                        currentScene: this.currentScene,
                        currentGoal: this.currentGoal,  // 保存当前目标
                        weekStartNoticeShown: this.weekStartNoticeShown,
                        rerollsRemaining: this.rerollsRemaining,
                        teammates: this.teammates,  // 保存队友数据
                        teamStats: this.teamStats,   // 保存队伍统计
                        inMatch: this.inMatch || false,  // 保存比赛进行中标记
                        matchCheckpoint: this.matchCheckpoint || null  // 保存比赛检查点
                    };
                    
                    localStorage.setItem('volleyballStarSave', JSON.stringify(saveData));
                    console.log('游戏已自动保存');
                } catch (error) {
                    console.error('保存游戏失败:', error);
                }
            }
            
            // 从localStorage加载游戏
            loadGame() {
                try {
                    const saveDataStr = localStorage.getItem('volleyballStarSave');
                    if (!saveDataStr) {
                        console.log('没有找到存档');
                        return false;
                    }
                    
                    const saveData = JSON.parse(saveDataStr);
                    
                    // 恢复游戏状态
                    this.player = saveData.player;
                    
                    // 检查游戏是否已结束
                    if (this.player.gameOver === true) {
                        console.log('此存档已结束，游戏类型:', this.player.endingType);
                        // 恢复其他必要数据
                        this.playerStats = saveData.playerStats || {
                            lifeActivities: {},
                            triggeredEvents: [],
                            permanentBuffs: {},
                            titles: []
                        };
                        this.teammates = saveData.teammates || [];
                        this.teamStats = saveData.teamStats || { averageChemistry: 0, averageSkill: 0, atmosphere: 0 };
                        return 'gameOver';
                    }
                    
                    // 兼容性检查：确保新字段存在
                    if (!this.player.unlockedSkills) {
                        this.player.unlockedSkills = [];
                    }
                    
                    this.tournament = saveData.tournament || {
                        active: false,
                        type: null,
                        currentRound: null,
                        roundsCompleted: [],
                        matchesWon: 0,
                        matchesLost: 0,
                        eliminated: false,
                        finalRank: null
                    };
                    this.playerStats = saveData.playerStats || {
                        lifeActivities: {},
                        triggeredEvents: [],
                        permanentBuffs: {},
                        titles: []
                    };
                    this.shopItems = saveData.shopItems || this.initShopItems();
                    this.adventureEvents = saveData.adventureEvents || this.initAdventureEvents();
                    this.currentScene = saveData.currentScene || 'weeklyHub';
                    this.currentGoal = saveData.currentGoal || 'collegeTryout';  // 恢复当前目标
                    this.weekStartNoticeShown = saveData.weekStartNoticeShown || false;
                    this.rerollsRemaining = saveData.rerollsRemaining || 5;
                    this.teammates = saveData.teammates || [];  // 恢复队友数据
                    this.teamStats = saveData.teamStats || { averageChemistry: 0, averageSkill: 0, atmosphere: 0 };  // 恢复队伍统计
                    this.inMatch = saveData.inMatch || false;  // 恢复比赛进行中标记
                    this.matchCheckpoint = saveData.matchCheckpoint || null;  // 恢复比赛检查点
                    
                    // 修正场景：某些临时场景不应该在刷新后恢复
                    const temporaryScenes = ['weekEnd', 'matchResult', 'tournamentRoundResult', 'eventResult'];
                    const isRoundStartScene = this.currentScene.startsWith('roundStart_');
                    const isTournamentResultScene = this.currentScene === 'tournamentRoundResult';
                    
                    if (temporaryScenes.includes(this.currentScene) || isRoundStartScene) {
                        console.log(`检测到临时场景 ${this.currentScene}，重置为 weeklyHub`);
                        this.currentScene = 'weeklyHub';
                        
                        // 如果是锦标赛轮次结果场景，且锦标赛还在进行中（未淘汰）
                        if (isTournamentResultScene && this.tournament && this.tournament.active && 
                            !this.tournament.eliminated && this.tournament.currentRound) {
                            console.log(`检测到锦标赛晋级结果场景刷新，标记需要恢复到当前轮次: ${this.tournament.currentRound}`);
                            this.needRestartTournamentRound = true;
                        }
                        
                        // 如果是锦标赛轮次开始场景，需要标记重新开始锦标赛轮次
                        if (isRoundStartScene && this.tournament && this.tournament.active && this.tournament.currentRound) {
                            console.log(`检测到锦标赛轮次开始场景，标记需要重新开始轮次: ${this.tournament.currentRound}`);
                            this.needRestartTournamentRound = true;
                        }
                    }
                    
                    // 智能修正目标（仅在锦标赛未进行时修正，锦标赛进行中不干预）
                    const tournamentInProgress = this.tournament && this.tournament.active && 
                                                 !this.tournament.eliminated &&
                                                 !(this.tournament.roundsCompleted && this.tournament.roundsCompleted.includes('final'));
                    
                    if (!tournamentInProgress) {
                        if (this.player.team === 'college' && this.currentGoal === 'collegeTryout') {
                            this.currentGoal = 'collegeMatch';
                            this.saveGame();
                        } else if (this.player.team === 'university' && 
                                   (this.currentGoal === 'collegeTryout' || this.currentGoal === 'universityTryout' || this.currentGoal === 'collegeMatch')) {
                            this.currentGoal = 'universityLeague';
                            this.saveGame();
                        }
                    }
                    
                    console.log('游戏加载成功，当前周次:', this.player.week);
                    return true;
                } catch (error) {
                    console.error('加载游戏失败:', error);
                    return false;
                }
            }
            
            // 检查是否有存档
            hasSaveData() {
                return localStorage.getItem('volleyballStarSave') !== null;
            }
            
            // 删除存档
            deleteSave() {
                try {
                    localStorage.removeItem('volleyballStarSave');
                    console.log('存档已删除');
                    return true;
                } catch (error) {
                    console.error('删除存档失败:', error);
                    return false;
                }
            }
            
            // 新增：检查固定比赛
            checkScheduledMatch() {
                console.log(`检查第${this.player.week}周是否有比赛...`);
                
                // 院际比赛：第5周
                if (this.player.week === 5) {
                    console.log('第5周检查: 队伍状态 =', this.player.team, '位置 =', this.player.position);
                    if (this.player.team === 'college' && this.player.position !== 'none') {
                        console.log('✓ 已加入院队且选择位置，触发院际比赛');
                        return { 
                            type: 'match', 
                            matchType: 'collegeMatch',
                            matchName: '院际比赛'
                        };
                    } else if (this.player.team === 'college' && this.player.position === 'none') {
                        console.log('✗ 已加入院队但未选择位置，触发隐藏结局：替补席');
                        // 加入院队但未选择位置，触发新的隐藏结局
                        return {
                            type: 'hiddenEnding',
                            endingId: 'benchwarmer'
                        };
                    } else {
                        console.log('✗ 未加入院队，触发隐藏结局：旁观者');
                        // 未加入院队，触发隐藏结局
                        return {
                            type: 'hiddenEnding',
                            endingId: 'bystander'
                        };
                    }
                }
                
                // 校际联赛：第12周（游戏结束）
                if (this.player.week === 12) {
                    console.log('第12周检查: 队伍状态 =', this.player.team);
                    
                    // 检查是否已经完成或淘汰锦标赛
                    if (this.tournament && this.tournament.eliminated) {
                        console.log('✓ 锦标赛已结束（淘汰），跳转到结局');
                        const endingId = this.getTournamentEnding();
                        return {
                            type: 'hiddenEnding',
                            endingId: endingId
                        };
                    }
                    
                    // 检查是否已经完成所有轮次（冠军）
                    if (this.tournament && this.tournament.roundsCompleted && 
                        this.tournament.roundsCompleted.includes('final')) {
                        console.log('✓ 锦标赛已结束（冠军），跳转到结局');
                        const endingId = this.getTournamentEnding();
                        return {
                            type: 'hiddenEnding',
                            endingId: endingId
                        };
                    }
                    
                    // 如果锦标赛已经在进行中，不重新触发
                    if (this.tournament && this.tournament.active) {
                        console.log('✓ 锦标赛已在进行中，不重新触发');
                        return null;
                    }
                    
                    if (this.player.team === 'university') {
                        console.log('✓ 已加入校队，触发校际联赛锦标赛');
                        return { 
                            type: 'tournament',  // 改为锦标赛类型
                            tournamentType: 'universityLeague'
                        };
                    } else {
                        console.log('✗ 未加入校队，触发隐藏结局：独行者');
                        // 未加入校队，触发隐藏结局
                        return {
                            type: 'hiddenEnding',
                            endingId: 'loner'
                        };
                    }
                }
                
                return null;
            }
            
            // ====================================================
            // 周初事件系统
            // ====================================================
            
            // 生成周初事件
            generateWeeklyEvent() {
                // 第1周不触发事件
                if (this.player.week === 1) {
                    return null;
                }
                
                const events = this.getWeeklyEventPool();
                const eligibleEvents = events.filter(event => {
                    // 检查事件的触发条件
                    if (event.condition) {
                        return event.condition(this.player);
                    }
                    return true;
                });
                
                if (eligibleEvents.length === 0) {
                    return null;
                }
                
                // 根据玩家状态计算权重
                const mood = this.player.mood;
                const stress = this.player.stress;
                
                // 计算正面/负面事件概率
                let positiveWeight = 1;
                let negativeWeight = 1;
                
                if (mood >= 70 && stress <= 30) {
                    positiveWeight = 7;
                    negativeWeight = 1;
                } else if (mood >= 50 && stress <= 50) {
                    positiveWeight = 4;
                    negativeWeight = 2;
                } else {
                    positiveWeight = 2;
                    negativeWeight = 5;
                }
                
                // 根据权重筛选事件
                const weightedEvents = eligibleEvents.map(event => {
                    let weight = 1;
                    if (event.mood === 'positive') {
                        weight = positiveWeight;
                    } else if (event.mood === 'negative') {
                        weight = negativeWeight;
                    }
                    return { event, weight };
                });
                
                // 加权随机选择
                const totalWeight = weightedEvents.reduce((sum, item) => sum + item.weight, 0);
                let random = Math.random() * totalWeight;
                
                for (let item of weightedEvents) {
                    random -= item.weight;
                    if (random <= 0) {
                        return item.event;
                    }
                }
                
                return weightedEvents[0].event;
            }
            
            // 显示周初事件
            showWeeklyEvent(event) {
                // 创建事件场景
                const effectText = this.formatEventEffects(event.effects);
                
                SCENES.weeklyEvent = {
                    text: `<h2>📰 ${event.title}</h2>
                        <p>${event.text}</p>
                        <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 8px;">
                            <strong>影响：</strong><br>
                            ${effectText}
                        </div>`,
                    choices: [{
                        text: '继续',
                        next: 'weeklyHub',
                        effect: event.effects
                    }]
                };
                
                this.showScene('weeklyEvent');
            }
            
            // 格式化事件效果显示
            formatEventEffects(effects) {
                let text = '';
                const skillNames = { serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球' };
                
                if (effects.serve) text += `🎯 ${skillNames.serve} ${effects.serve > 0 ? '+' : ''}${effects.serve}<br>`;
                if (effects.spike) text += `⚡ ${skillNames.spike} ${effects.spike > 0 ? '+' : ''}${effects.spike}<br>`;
                if (effects.block) text += `🛡️ ${skillNames.block} ${effects.block > 0 ? '+' : ''}${effects.block}<br>`;
                if (effects.dig) text += `🤸 ${skillNames.dig} ${effects.dig > 0 ? '+' : ''}${effects.dig}<br>`;
                if (effects.set) text += `🙌 ${skillNames.set} ${effects.set > 0 ? '+' : ''}${effects.set}<br>`;
                if (effects.energy) text += `💪 体力 ${effects.energy > 0 ? '+' : ''}${effects.energy}<br>`;
                if (effects.mood) text += `😊 心情 ${effects.mood > 0 ? '+' : ''}${effects.mood}<br>`;
                if (effects.stress) text += `😰 压力 ${effects.stress > 0 ? '+' : ''}${effects.stress}<br>`;
                if (effects.reputation) text += `⭐ 声望 ${effects.reputation > 0 ? '+' : ''}${effects.reputation}<br>`;
                if (effects.money) text += `💰 金钱 ${effects.money > 0 ? '+' : ''}${effects.money}<br>`;
                if (effects.relationship) text += `🤝 关系 ${effects.relationship > 0 ? '+' : ''}${effects.relationship}<br>`;
                
                return text || '无影响';
            }
            
            // 获取周初事件池
            getWeeklyEventPool() {
                return [
                    // 技能相关正面事件
                    { id: 'serve_master', title: '发球达人', text: '你的跳发球视频在校园论坛火了！有学弟学妹向你请教，你耐心指导后感觉自己理解更深了。', mood: 'positive', condition: (p) => p.skills.serve >= 30 && p.mood >= 60 && p.stress <= 40, effects: { serve: 3, reputation: 5, mood: 10 } },
                    { id: 'spike_show', title: '扣球表演', text: '体育课上老师让你示范扣球动作，你完美的演示赢得了全班掌声，连隔壁班都来围观了。', mood: 'positive', condition: (p) => p.skills.spike >= 30 && p.mood >= 60 && p.stress <= 40, effects: { spike: 2, reputation: 8, mood: 12 } },
                    { id: 'block_teaching', title: '拦网教学', text: '队友请你分享拦网技巧，你在讲解时突然顿悟了一个新的判断方法。教学相长！', mood: 'positive', condition: (p) => p.skills.block >= 30 && p.mood >= 60 && p.stress <= 40, effects: { block: 3, teammateChemistry: { random: 5 }, mood: 8 } },
                    { id: 'dig_hero', title: '救球英雄', text: '训练时你一个鱼跃救球成功，教练当场表扬："这就是永不放弃的精神！"全队士气大振。', mood: 'positive', condition: (p) => p.skills.dig >= 30 && p.mood >= 60 && p.stress <= 40, effects: { dig: 2, reputation: 6, mood: 10, stress: -5 } },
                    { id: 'set_master', title: '二传大师', text: '你精准的传球让队友连续扣球得分，大家都说和你配合特别舒服。默契度UP！', mood: 'positive', condition: (p) => p.skills.set >= 30 && p.mood >= 60 && p.stress <= 40, effects: { set: 3, teamChemistry: 8, mood: 10 } },
                    // 技能相关负面事件
                    { id: 'demo_fail', title: '演示失误', text: '有人请教发球技巧，你演示跳发时因为太累脚下一滑，扭到了脚踝...丢人又疼。', mood: 'negative', condition: (p) => p.skills.serve >= 25 && (p.mood <= 40 || p.stress >= 60), effects: { serve: -5, mood: -10, stress: 5 } },
                    { id: 'over_training', title: '过度训练', text: '你想突破扣球瓶颈，结果练得太猛手臂酸痛，教练批评你不懂劳逸结合。', mood: 'negative', condition: (p) => p.skills.spike >= 25 && (p.mood <= 40 || p.stress >= 60), effects: { spike: -3, energy: -15, stress: 8 } },
                    { id: 'skill_regress', title: '技术退步', text: '状态不好导致训练时频频失误，队友关心地问你是不是有什么心事。', mood: 'negative', condition: (p) => p.mood <= 40, effects: { serve: -2, spike: -2, mood: -5, relationship: 3 } },
                    // 社交相关事件
                    { id: 'birthday_surprise', title: '生日惊喜', text: '队友们偷偷给你准备了生日蛋糕（虽然不是你生日），说是庆祝你加入球队。感动哭了！', mood: 'positive', condition: (p) => p.relationships.teammates >= 60, effects: { mood: 20, stress: -10, relationship: 10 } },
                    { id: 'late_night_food', title: '深夜食堂', text: '队长请大家吃夜宵，聊天时你们发现彼此都是动漫迷，瞬间成了好兄弟。', mood: 'positive', condition: (p) => p.relationships.teammates >= 60, effects: { mood: 15, stress: -8, relationship: 8, money: -30 } },
                    { id: 'game_night', title: '游戏之夜', text: '室友组织游戏联机，你们一起通宵打游戏，虽然第二天很困但超开心！', mood: 'positive', condition: (p) => p.mood >= 50, effects: { mood: 18, stress: -12, energy: -20 } },
                    { id: 'isolated', title: '被孤立', text: '食堂吃饭时发现队友们都坐在一起，但没人叫你...是不是自己太不合群了？', mood: 'negative', condition: (p) => p.relationships.teammates <= 30, effects: { mood: -15, stress: 10 } },
                    { id: 'gossip', title: '流言蜚语', text: '听说有人在背后说你"只会训练不会做人"，虽然不想在意但还是很难受。', mood: 'negative', condition: (p) => p.relationships.teammates <= 30, effects: { mood: -12, stress: 8, relationship: -5 } },
                    // 金钱相关事件
                    { id: 'treat_dinner', title: '请客吃饭', text: '你请队友吃了顿好的，大家都说你够意思！队内氛围更融洽了。', mood: 'positive', condition: (p) => p.money >= 300, effects: { money: -150, relationship: 12, reputation: 5, mood: 10 } },
                    { id: 'new_shoes', title: '装备升级', text: '你买了双新球鞋，穿着感觉自己像职业选手，训练时信心满满！', mood: 'positive', condition: (p) => p.money >= 300, effects: { money: -200, mood: 15 } },
                    { id: 'broke', title: '囊中羞涩', text: '队友约你出去玩，你只能说"下次吧"...钱包空空的感觉真难受。', mood: 'negative', condition: (p) => p.money <= 50, effects: { mood: -10, stress: 5 } },
                    { id: 'instant_noodles', title: '泡面度日', text: '这周只能吃泡面了，营养跟不上导致训练效果下降，还被室友嘲笑"排球王子变泡面王子"。', mood: 'negative', condition: (p) => p.money <= 50, effects: { mood: -8, energy: -10 } },
                    // 压力/心情相关事件
                    { id: 'stress_burst', title: '压力爆发', text: '训练时你突然情绪失控对队友发火，事后非常后悔...大家都很担心你的状态。', mood: 'negative', condition: (p) => p.stress >= 70, effects: { stress: -20, mood: -15, relationship: -10 } },
                    { id: 'insomnia', title: '失眠之夜', text: '压力太大导致失眠，第二天上课差点睡着，训练时也无精打采。', mood: 'negative', condition: (p) => p.stress >= 70, effects: { stress: -10, energy: -25, mood: -10 } },
                    { id: 'lucky_day', title: '好运连连', text: '心情好运气也好！路上捡到100块，食堂阿姨多打了份肉，训练时状态爆棚！', mood: 'positive', condition: (p) => p.mood >= 80, effects: { money: 100, energy: 10, mood: 5, serve: 1, spike: 1 } },
                    { id: 'inspiration', title: '灵感迸发', text: '心情愉悦时你突然领悟了一个新的技术要领，感觉自己开窍了！', mood: 'positive', condition: (p) => p.mood >= 80, effects: { block: 3, dig: 2, mood: 5 } },
                    // 队伍相关事件
                    { id: 'college_honor', title: '院队荣誉', text: '院队在友谊赛中获胜，教练请大家吃饭庆祝，你感受到了集体的温暖。', mood: 'positive', condition: (p) => p.team === 'college', effects: { mood: 15, stress: -10, relationship: 8 } },
                    { id: 'college_pressure', title: '院队压力', text: '院队训练强度突然加大，教练说要为下次比赛做准备，你感觉有点吃不消。', mood: 'neutral', condition: (p) => p.team === 'college', effects: { energy: -20, stress: 10, serve: 2, spike: 1 } },
                    { id: 'university_star', title: '校队明星', text: '校报采访了你，标题是"新星崛起"，走在路上都有人认出你了！', mood: 'positive', condition: (p) => p.team === 'university', effects: { reputation: 15, mood: 20, stress: 5 } },
                    { id: 'university_competition', title: '校队竞争', text: '校队内部竞争激烈，你担心自己会被替补...必须更加努力才行。', mood: 'negative', condition: (p) => p.team === 'university', effects: { stress: 15, mood: -10 } },
                    // 纯随机日常事件（无条件或条件宽松）
                    { id: 'library_encounter', title: '图书馆奇遇', text: '在图书馆自习时，隔壁桌的学霸主动教你高数题，你感动得差点哭出来。虽然还是没听懂。', mood: 'positive', effects: { mood: 8, stress: -5 } },
                    { id: 'bike_stolen', title: '自行车被偷', text: '你的自行车不见了！报案后发现是被隔壁宿舍的人"借"走了，他说以为是共享单车...', mood: 'negative', effects: { mood: -12, stress: 8, money: -50 } },
                    { id: 'midterm_exam', title: '期中考试', text: '期中考试周到了，你在排球训练和复习之间疯狂切换，感觉脑子要炸了。', mood: 'negative', effects: { stress: 15, energy: -15, mood: -8 } },
                    { id: 'confession_scene', title: '校园表白', text: '有人在操场上表白，围观群众里有人起哄让你也表白，你尴尬得想找个地缝钻进去。', mood: 'neutral', effects: { mood: -5, stress: 5 } },
                    { id: 'movie_night', title: '电影之夜', text: '室友拉你去看午夜场电影，看完已经凌晨2点，第二天训练时困得不行。', mood: 'positive', effects: { mood: 15, energy: -20, stress: -10 } },
                    { id: 'data_overcharge', title: '流量超标', text: '月底发现流量超了，被扣了100块，原来是室友用你手机开热点下游戏...', mood: 'negative', effects: { mood: -10, money: -100, stress: 5 } },
                    { id: 'new_dish', title: '食堂新菜', text: '食堂推出新菜品"排球套餐"，虽然不知道为什么叫这个名字，但味道还不错！', mood: 'positive', effects: { mood: 10, energy: 10 } },
                    { id: 'ktv_party', title: '被拉去唱歌', text: '班级聚会被拉去KTV，你唱了首《倔强》，大家说你唱出了排球人的精神！', mood: 'positive', effects: { mood: 12, stress: -8, money: -60, relationship: 5 } },
                    { id: 'power_outage', title: '宿舍断电', text: '宿舍突然断电，你的手机也没电了，只能早早睡觉。意外地睡了个好觉！', mood: 'positive', effects: { energy: 20, mood: 5 } },
                    { id: 'game_all_night', title: '游戏通宵', text: '室友新买了游戏机，你们通宵打《马里奥派对》，笑到肚子疼。第二天后悔了。', mood: 'positive', effects: { mood: 20, energy: -30, stress: -15 } },
                    { id: 'dorm_inspection', title: '宿舍检查', text: '突击卫生检查！你们疯狂打扫了2小时，累得半死但通过了检查。', mood: 'neutral', effects: { energy: -15, stress: 10, mood: -5 } },
                    { id: 'midnight_snack', title: '深夜外卖', text: '凌晨1点你们点了炸鸡和可乐，边吃边聊人生理想，感觉青春就该这样！', mood: 'positive', effects: { mood: 15, energy: 10, money: -80, stress: -10 } },
                    { id: 'cockroach', title: '宿舍有虫', text: '宿舍出现了一只大蟑螂，你们四个大男生吓得跳上床，最后还是宿管阿姨帮忙解决的。', mood: 'neutral', effects: { mood: -8, stress: 5, relationship: 3 } },
                    { id: 'water_splash', title: '被水泼', text: '路过宿舍楼下时被楼上泼水盆的水淋了一身，抬头一看是你认识的学妹，她吓得连连道歉。', mood: 'neutral', effects: { mood: -5, relationship: 2 } },
                    { id: 'lottery_win', title: '中奖了', text: '学校抽奖活动你中了三等奖——一个保温杯，虽然不是什么大奖但还挺实用的！', mood: 'positive', effects: { mood: 10, money: 50 } },
                    { id: 'heater_broken', title: '热水器坏了', text: '洗澡洗到一半热水器坏了，你顶着满头泡沫冲了个冷水澡，差点感冒。', mood: 'negative', effects: { energy: -10, mood: -12, stress: 5 } },
                    { id: 'package_lost', title: '快递丢失', text: '你买的新球鞋快递显示已签收，但你根本没收到！客服说要调查，你只能等待。', mood: 'negative', effects: { mood: -15, stress: 10 } },
                    { id: 'sudden_rain', title: '突然下雨', text: '训练完回宿舍路上突然下大雨，你和队友在屋檐下躲雨，聊了很多平时不会聊的话题。', mood: 'positive', effects: { mood: 8, relationship: 8, energy: -5 } },
                    { id: 'confession_received', title: '被人告白', text: '有学妹给你递情书，你不知道怎么回应，整天都心神不宁，训练时频频失误。', mood: 'neutral', effects: { mood: 5, stress: 12 } },
                    { id: 'roommate_birthday', title: '室友生日', text: '室友过生日，你们一起庆祝到深夜，虽然第二天很困但友情更深了。', mood: 'positive', effects: { mood: 15, energy: -15, money: -100, relationship: 10 } },
                    { id: 'photo_leaked', title: '被偷拍', text: '发现校园论坛上有你训练时的照片，标题是"排球场上的阳光男孩"，评论区都在夸你帅。', mood: 'positive', effects: { mood: 18, reputation: 10, stress: 5 } },
                    { id: 'senior_advice', title: '学长指导', text: '一位毕业的学长回校，看到你训练后主动分享了一些经验，让你受益匪浅。', mood: 'positive', effects: { serve: 2, spike: 1, mood: 10, reputation: 5 } },
                    { id: 'banana_peel', title: '踩到香蕉皮', text: '真的有人会踩到香蕉皮！你在食堂门口华丽地滑倒了，周围的人都笑疯了。', mood: 'negative', effects: { mood: -10, reputation: -5, energy: -5 } },
                    { id: 'wrong_person', title: '认错人', text: '你在路上热情地跟"队友"打招呼，结果发现认错人了，对方一脸懵逼地看着你。', mood: 'neutral', effects: { mood: -8, stress: 5 } },
                    { id: 'food_poisoning', title: '吃坏肚子', text: '路边摊的烤串太诱人，你没忍住...结果半夜跑了三次厕所，第二天虚弱无力。', mood: 'negative', effects: { energy: -25, mood: -10 } },
                    { id: 'performance_show', title: '被拉去表演', text: '学校文艺晚会缺人，你被拉去表演"排球操"，虽然很尴尬但意外地受欢迎。', mood: 'positive', effects: { mood: 10, reputation: 8, stress: 10 } },
                    { id: 'chased_by_dog', title: '被狗追', text: '晨跑时被流浪狗追了两条街，你跑出了百米冲刺的速度，队友说你该去练田径。', mood: 'neutral', effects: { energy: -15, mood: -5 } },
                    { id: 'phone_broken', title: '手机摔碎', text: '接球时手机从口袋里飞出去，屏幕摔得粉碎。你的钱包也碎了。', mood: 'negative', effects: { mood: -20, money: -300 } },
                    { id: 'found_money', title: '捡到钱', text: '在操场上捡到200块，等了半小时没人来认领，你决定拿去请队友吃饭。', mood: 'positive', effects: { money: 50, mood: 10, relationship: 8 } },
                    { id: 'free_lunch', title: '免费午餐', text: '食堂阿姨说你是第1000位顾客，免费送你一份豪华套餐！今天运气真好！', mood: 'positive', effects: { mood: 15, energy: 15 } },
                    { id: 'exam_leak', title: '考试重点', text: '学长"不小心"透露了考试重点，你突击复习后考得还不错，压力减轻了不少。', mood: 'positive', effects: { stress: -15, mood: 12 } },
                    { id: 'concert_ticket', title: '演唱会门票', text: '抽奖抽到了演唱会门票！虽然不认识歌手，但免费的快乐就是这么简单。', mood: 'positive', effects: { mood: 20, stress: -10 } }
                ];
            }
            
            // 新增：显示比赛预告
            showMatchPreview(matchType, matchName) {
                let previewText = '';
                let matchInfo = '';
                
                if (matchType === 'collegeMatch') {
                    matchInfo = `
                        <h2>🏐 ${matchName}</h2>
                        <p>本周末将举行院际排球比赛！</p>
                        <p>作为院队的一员，你将代表学院出战。</p>
                        <p><strong>比赛规则：</strong>三局两胜制，每局25分（决胜局15分）</p>
                        <p><strong>对手实力：</strong>与你们水平相当的其他学院队伍</p>
                        <p>这是你证明自己的好机会，加油！</p>
                    `;
                } else if (matchType === 'universityLeague') {
                    matchInfo = `
                        <h2>🏐 ${matchName}</h2>
                        <p>本周末将举行校际排球联赛！</p>
                        <p>作为校队的主力，你将代表学校与其他高校对决。</p>
                        <p><strong>比赛规则：</strong>三局两胜制，每局25分（决胜局15分）</p>
                        <p><strong>对手实力：</strong>其他高校的精英选手</p>
                        <p>这是展现你实力的舞台，全力以赴！</p>
                    `;
                } else if (matchType === 'cityLeague') {
                    matchInfo = `
                        <h2>🏐 ${matchName}</h2>
                        <p>本周末将举行市级排球联赛！</p>
                        <p>这是本赛季最重要的比赛，你将面对全市最强的队伍。</p>
                        <p><strong>比赛规则：</strong>三局两胜制，每局25分（决胜局15分）</p>
                        <p><strong>对手实力：</strong>市级顶尖选手</p>
                        <p>这是你的巅峰之战，证明你的价值！</p>
                    `;
                }
                
                // 创建预告场景
                SCENES.matchPreview = {
                    text: matchInfo,
                    choices: [{
                        text: '开始比赛',
                        effect: { 
                            startFormalMatch: { 
                                matchType: matchType, 
                                matchName: matchName 
                            } 
                        }
                    }]
                };
                
                this.showScene('matchPreview');
            }
            
            generateWeeklySummary() {
                const scene = SCENES.weekEnd;
                
                // 检查并解锁配合技能
                if (this.checkAndUnlockSkills) {
                    this.checkAndUnlockSkills();
                }
                
                // 计算技能变化
                const changes = {
                    serve: this.player.skills.serve - this.player.weekStartStats.serve,
                    spike: this.player.skills.spike - this.player.weekStartStats.spike,
                    block: this.player.skills.block - this.player.weekStartStats.block,
                    dig: this.player.skills.dig - this.player.weekStartStats.dig,
                    set: this.player.skills.set - this.player.weekStartStats.set,
                    maxEnergy: this.player.maxEnergy - this.player.weekStartStats.maxEnergy
                };
                
                // 获取当前阶段
                const teamNames = {
                    'none': '基础训练',
                    'college': '院队',
                    'university': '校队'
                };
                const currentStage = teamNames[this.player.team];
                
                // 生成技能变化HTML（紧凑版）
                let skillChangesHTML = '<div style="background: #f8fafc; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 14px;">';
                skillChangesHTML += '<strong>本周成长</strong><br>';
                
                const skillIcons = {
                    serve: '🎯',
                    spike: '⚡',
                    block: '🛡️',
                    dig: '🏐',
                    set: '🤲'
                };
                
                const skillNames = {
                    serve: '发球',
                    spike: '扣球',
                    block: '拦网',
                    dig: '垫球',
                    set: '托球'
                };
                
                for (let skill in skillIcons) {
                    const change = changes[skill];
                    const icon = skillIcons[skill];
                    const name = skillNames[skill];
                    const newVal = this.player.skills[skill];
                    
                    if (change > 0) {
                        skillChangesHTML += `<span style="color: #22c55e;">${icon}${name} ${newVal}(+${change})</span> `;
                    } else if (change === 0) {
                        skillChangesHTML += `<span style="color: #9ca3af;">${icon}${name} ${newVal}</span> `;
                    } else {
                        skillChangesHTML += `<span style="color: #ef4444;">${icon}${name} ${newVal}(${change})</span> `;
                    }
                }
                
                if (changes.maxEnergy > 0) {
                    skillChangesHTML += `<br><span style="color: #22c55e;">💪体力上限+${changes.maxEnergy}</span>`;
                }
                
                skillChangesHTML += '</div>';
                
                // 生成目标进度HTML（紧凑版）
                const goalProgressHTML = this.generateGoalProgress();
                
                // 生成智能建议HTML（紧凑版）
                const suggestionsHTML = this.generateWeeklySuggestions(changes);
                
                // 组合完整的总结文本（紧凑版）
                scene.text = `<h2>📊 第${this.player.week}周·${currentStage}</h2>
                
                ${skillChangesHTML}
                
                ${goalProgressHTML}
                
                ${suggestionsHTML}`;
            }
            
            generateGoalProgress() {
                const goalInfo = this.getGoalInfo();
                
                // 如果目标已完成，不显示目标进度
                if (!goalInfo || goalInfo.completed) {
                    return '';
                }
                
                let progressHTML = '<div style="background: #f0fdf4; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 14px;">';
                progressHTML += `<strong>${goalInfo.icon} ${goalInfo.title}</strong>`;
                
                if (goalInfo.type === 'tryout') {
                    // 选拔类目标：显示要求和达标情况
                    progressHTML += ` <span style="color: #6b7280; font-size: 12px;">(${goalInfo.timeWindow})</span><br>`;
                    
                    const req = goalInfo.requirements;
                    const skillIcons = {
                        serve: '🎯', spike: '⚡', block: '🛡️', dig: '🏐', set: '🤲', reputation: '⭐'
                    };
                    const skillNames = { 
                        serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球', reputation: '声望' 
                    };
                    
                    let metCount = 0;
                    let totalCount = 0;
                    let unmetItems = [];
                    
                    // 处理技能要求
                    if (req.anyTwo !== undefined) {
                        const threshold = req.anyTwo;
                        const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                        const qualifiedSkills = skills.filter(s => this.player.skills[s] >= threshold);
                        
                        totalCount = 1;
                        if (qualifiedSkills.length >= 2) {
                            metCount = 1;
                        } else {
                            const sortedSkills = skills
                                .map(s => ({ skill: s, value: this.player.skills[s], diff: threshold - this.player.skills[s] }))
                                .filter(s => s.diff > 0)
                                .sort((a, b) => a.diff - b.diff)
                                .slice(0, 2);
                            sortedSkills.forEach(item => {
                                unmetItems.push({ key: item.skill, required: threshold, current: item.value, diff: item.diff });
                            });
                        }
                    } else if (req.anyThree !== undefined) {
                        const threshold = req.anyThree;
                        const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                        const qualifiedSkills = skills.filter(s => this.player.skills[s] >= threshold);
                        
                        totalCount = 1;
                        if (qualifiedSkills.length >= 3) {
                            metCount = 1;
                        } else {
                            const sortedSkills = skills
                                .map(s => ({ skill: s, value: this.player.skills[s], diff: threshold - this.player.skills[s] }))
                                .filter(s => s.diff > 0)
                                .sort((a, b) => a.diff - b.diff)
                                .slice(0, 3);
                            sortedSkills.forEach(item => {
                                unmetItems.push({ key: item.skill, required: threshold, current: item.value, diff: item.diff });
                            });
                        }
                    }
                    
                    // 处理声望要求
                    if (req.reputation !== undefined) {
                        totalCount++;
                        if (this.player.reputation >= req.reputation) {
                            metCount++;
                        } else {
                            unmetItems.push({
                                key: 'reputation',
                                required: req.reputation,
                                current: this.player.reputation,
                                diff: req.reputation - this.player.reputation
                            });
                        }
                    }
                    
                    // 显示进度
                    if (metCount === totalCount) {
                        progressHTML += `<span style="color: #22c55e;">✅ 全部达标！可以挑战目标了</span><br>`;
                    } else {
                        progressHTML += `<span style="color: #f59e0b;">进度：${metCount}/${totalCount}</span><br>`;
                        progressHTML += `<span style="color: #6b7280; font-size: 12px;">短板：`;
                        unmetItems.slice(0, 2).forEach((item, idx) => {
                            if (idx > 0) progressHTML += '，';
                            progressHTML += `${skillNames[item.key]}${item.current}(差${item.diff})`;
                        });
                        progressHTML += `</span>`;
                    }
                    
                } else if (goalInfo.type === 'match') {
                    // 比赛类目标：显示比赛时间和提示
                    const weeksUntil = goalInfo.triggerWeek - this.player.week;
                    
                    if (weeksUntil > 1) {
                        progressHTML += `<br><span style="color: #f59e0b;">📅 第${goalInfo.triggerWeek}周自动开始（还有${weeksUntil}周）</span><br>`;
                        progressHTML += `<span style="color: #6b7280; font-size: 12px;">💡 ${goalInfo.description}</span>`;
                    } else if (weeksUntil === 1) {
                        progressHTML += `<br><span style="color: #ef4444;">⚡ 下周开始比赛！</span><br>`;
                        progressHTML += `<span style="color: #6b7280; font-size: 12px;">� ${goalInfo.description}</span>`;
                    } else if (weeksUntil === 0) {
                        progressHTML += `<br><span style="color: #ef4444;">📅 本周将进行比赛！</span><br>`;
                        progressHTML += `<span style="color: #6b7280; font-size: 12px;">💪 保持最佳状态参赛</span>`;
                    } else {
                        progressHTML += `<br><span style="color: #22c55e;">✅ 比赛已完成</span>`;
                    }
                }
                
                progressHTML += '</div>';
                return progressHTML;
            }
            
            generateWeeklySuggestions(changes) {
                const suggestions = [];
                const goalInfo = this.getGoalInfo();
                
                // 1. 检查紧急状态
                if (this.player.energy < 20) {
                    suggestions.push({ priority: 1, text: '⚠️ 体力严重不足，建议优先休息恢复' });
                }
                if (this.player.stress > 80) {
                    suggestions.push({ priority: 1, text: '⚠️ 压力过大，必须进行放松活动' });
                }
                if (this.player.money < 100) {
                    suggestions.push({ priority: 1, text: '💰 金钱不足，考虑兼职赚钱' });
                }
                if (this.player.mood < 30) {
                    suggestions.push({ priority: 1, text: '😔 心情低落，建议休闲娱乐提升心情' });
                }
                
                // 2. 根据目标类型给出建议
                if (goalInfo.type === 'tryout') {
                    // 选拔类目标：检查进度
                    const req = goalInfo.requirements;
                    let metCount = 0;
                    let totalCount = 0;
                    let shortfalls = [];
                    
                    const skillNames = { serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球', reputation: '声望' };
                    
                    // 处理技能要求
                    if (req.anyTwo !== undefined) {
                        const threshold = req.anyTwo;
                        const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                        const qualifiedSkills = skills.filter(s => this.player.skills[s] >= threshold);
                        
                        totalCount = 1;
                        if (qualifiedSkills.length >= 2) {
                            metCount = 1;
                        } else {
                            const sortedSkills = skills
                                .map(s => ({ skill: s, value: this.player.skills[s], diff: threshold - this.player.skills[s] }))
                                .filter(s => s.diff > 0)
                                .sort((a, b) => a.diff - b.diff)
                                .slice(0, 2);
                            sortedSkills.forEach(item => {
                                shortfalls.push({ skill: skillNames[item.skill], diff: item.diff, key: item.skill });
                            });
                        }
                    } else if (req.anyThree !== undefined) {
                        const threshold = req.anyThree;
                        const skills = ['serve', 'spike', 'block', 'dig', 'set'];
                        const qualifiedSkills = skills.filter(s => this.player.skills[s] >= threshold);
                        
                        totalCount++;
                        if (qualifiedSkills.length >= 3) {
                            metCount++;
                        } else {
                            const sortedSkills = skills
                                .map(s => ({ skill: s, value: this.player.skills[s], diff: threshold - this.player.skills[s] }))
                                .filter(s => s.diff > 0)
                                .sort((a, b) => a.diff - b.diff)
                                .slice(0, 3);
                            sortedSkills.forEach(item => {
                                shortfalls.push({ skill: skillNames[item.skill], diff: item.diff, key: item.skill });
                            });
                        }
                    }
                    
                    // 检查声望
                    if (req.reputation !== undefined) {
                        totalCount++;
                        if (this.player.reputation >= req.reputation) {
                            metCount++;
                        } else {
                            shortfalls.push({ 
                                skill: '声望', 
                                diff: req.reputation - this.player.reputation, 
                                key: 'reputation' 
                            });
                        }
                    }
                    
                    const progressPercent = totalCount > 0 ? (metCount / totalCount) * 100 : 0;
                    
                    if (progressPercent >= 100) {
                        suggestions.push({ priority: 2, text: `🎉 已达标！可以挑战目标了` });
                    } else if (progressPercent >= 80) {
                        const topShortfall = shortfalls.sort((a, b) => b.diff - a.diff)[0];
                        if (topShortfall) {
                            suggestions.push({ priority: 2, text: `💡 接近目标！重点提升${topShortfall.skill}(差${topShortfall.diff})` });
                        }
                    } else if (progressPercent >= 50) {
                        const top2Shortfalls = shortfalls.sort((a, b) => b.diff - a.diff).slice(0, 2);
                        if (top2Shortfalls.length > 0) {
                            suggestions.push({ priority: 2, text: `💪 稳步前进！短板：${top2Shortfalls.map(s => `${s.skill}(${s.diff})`).join('、')}` });
                        }
                    } else {
                        suggestions.push({ priority: 2, text: `⚡ 加快节奏！建议每周训练满3次` });
                    }
                    
                } else if (goalInfo.type === 'match') {
                    // 比赛类目标：给出准备建议
                    const weeksUntil = goalInfo.triggerWeek - this.player.week;
                    
                    if (weeksUntil > 1) {
                        suggestions.push({ priority: 2, text: `📅 距离${goalInfo.title}还有${weeksUntil}周，抓紧准备` });
                        
                        // 根据平均技能给出建议
                        const avgSkill = (this.player.skills.serve + this.player.skills.spike + 
                                         this.player.skills.block + this.player.skills.dig + 
                                         this.player.skills.set) / 5;
                        
                        if (avgSkill < 30) {
                            suggestions.push({ priority: 3, text: `💪 技能偏低，建议加强训练` });
                        } else if (avgSkill < 50) {
                            suggestions.push({ priority: 3, text: `📈 继续提升，争取更好表现` });
                        } else {
                            suggestions.push({ priority: 3, text: `🌟 实力不错，保持状态即可` });
                        }
                    } else if (weeksUntil === 1) {
                        suggestions.push({ priority: 2, text: `⚡ ${goalInfo.title}下周开始！做好最后准备` });
                        
                        // 根据平均技能给出建议
                        const avgSkill = (this.player.skills.serve + this.player.skills.spike + 
                                         this.player.skills.block + this.player.skills.dig + 
                                         this.player.skills.set) / 5;
                        
                        if (avgSkill < 30) {
                            suggestions.push({ priority: 3, text: `💪 技能偏低，抓紧最后时间训练` });
                        } else if (avgSkill < 50) {
                            suggestions.push({ priority: 3, text: `📈 保持训练，调整状态` });
                        } else {
                            suggestions.push({ priority: 3, text: `🌟 实力不错，保持状态即可` });
                        }
                    } else if (weeksUntil === 0) {
                        suggestions.push({ priority: 2, text: `🏐 本周比赛！保持最佳状态` });
                    }
                }
                
                // 3. 职业相关建议（简化）
                if (this.player.position !== 'none') {
                    const posInfo = this.getPositionInfo();
                    const skillNames = { serve: '发球', spike: '扣球', block: '拦网', dig: '垫球', set: '托球' };
                    const coreSkillsMet = posInfo.coreSkills.every(skill => {
                        const baseReq = posInfo.baseRequirements[skill] || 0;
                        return this.player.skills[skill] >= baseReq;
                    });
                    
                    if (!coreSkillsMet) {
                        const coreNames = posInfo.coreSkills.map(s => skillNames[s]).join('、');
                        suggestions.push({ priority: 3, text: `${posInfo.icon} ${posInfo.name}核心技能：${coreNames}(+50%加成)` });
                    }
                }
                
                // 4. 训练效率建议（简化）
                if (this.player.trainingCount < 2) {
                    suggestions.push({ priority: 4, text: `📈 本周训练较少(${this.player.trainingCount}/3)，建议增加训练` });
                }
                
                // 计算总提升
                const totalGrowth = Math.abs(changes.serve) + Math.abs(changes.spike) + Math.abs(changes.block) + Math.abs(changes.dig) + Math.abs(changes.set);
                
                if (totalGrowth === 0 && this.player.trainingCount > 0) {
                    suggestions.push({ priority: 4, text: `🤔 训练了但无提升，注意保持良好状态` });
                } else if (totalGrowth >= 20) {
                    suggestions.push({ priority: 5, text: `🌟 本周表现出色！提升${totalGrowth}点` });
                }
                
                // 按优先级排序，取前2条（手机版只显示2条）
                const topSuggestions = suggestions.sort((a, b) => a.priority - b.priority).slice(0, 2);
                
                let html = '<div style="background: #dbeafe; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 14px;">';
                html += '<strong>💡 建议</strong><br>';
                topSuggestions.forEach(s => {
                    html += `<div style="margin: 4px 0; color: #1e40af;">• ${s.text}</div>`;
                });
                html += '</div>';
                
                return html;
            }
            
            updateUI() {
                document.getElementById('week').textContent = this.player.week;
                document.getElementById('training-count').textContent = `${this.player.trainingCount}/${this.player.maxTrainingPerWeek}`;
                document.getElementById('energy').textContent = this.player.energy;
                document.getElementById('mood').textContent = this.player.mood;
                document.getElementById('stress').textContent = this.player.stress;
                document.getElementById('reputation').textContent = this.player.reputation;
                document.getElementById('money').textContent = this.player.money;
                
                const teamNames = {
                    'none': '无',
                    'college': '院队',
                    'university': '校队'
                };
                document.getElementById('team').textContent = teamNames[this.player.team];
                
                // 显示职业信息
                const positionStat = document.getElementById('position-stat');
                const positionElement = document.getElementById('position');
                if (this.player.position !== 'none') {
                    const posInfo = this.getPositionInfo();
                    positionStat.style.display = 'block';
                    positionElement.textContent = `${posInfo.icon} ${posInfo.name}`;
                } else {
                    positionStat.style.display = 'none';
                }
                
                // 更新技能进度条（使用新的计算方式：最小25px + 剩余空间的百分比）
                for (let skill in this.player.skills) {
                    const value = this.player.skills[skill];
                    document.getElementById(`${skill}-value`).textContent = value;
                    const bar = document.getElementById(`${skill}-bar`);
                    
                    // 计算进度条宽度：基础25px + 剩余空间的百分比
                    // 假设进度条总宽度约225px（25px基础 + 200px可变）
                    const baseWidth = 4;  // 25/225 ≈ 11.1%
                    const variableWidth = 96;  // 200/225 ≈ 88.9%
                    const displayWidth = baseWidth + (variableWidth * value / 100);
                    
                    bar.style.width = `${displayWidth}%`;
                    bar.textContent = value;
                }
                
                // 更新队友平均能力
                const teamAverageBar = document.getElementById('team-average-skill-bar');
                if (this.teammates && this.teammates.length > 0) {
                    // 显示队友平均能力
                    teamAverageBar.style.display = 'block';
                    
                    // 计算队友平均能力
                    const avgSkill = this.teamStats.averageSkill || 0;
                    document.getElementById('team-average-value').textContent = avgSkill;
                    
                    const avgBar = document.getElementById('team-average-bar');
                    const baseWidth = 4;
                    const variableWidth = 96;
                    const displayWidth = baseWidth + (variableWidth * avgSkill / 100);
                    
                    avgBar.style.width = `${displayWidth}%`;
                    avgBar.textContent = avgSkill;
                } else {
                    // 没有队友时隐藏
                    teamAverageBar.style.display = 'none';
                }
                
                this.drawRadarChart();
                this.updateGoalDisplay();
            }
            
            drawRadarChart() {
                const canvas = document.getElementById('skills-radar');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                const radius = 75;
                
                // 清空画布
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 技能数据（五边形，从正上方开始，顺时针）
                const skills = [
                    { name: '发球', value: this.player.skills.serve, angle: -Math.PI / 2 },
                    { name: '扣球', value: this.player.skills.spike, angle: -Math.PI / 2 + Math.PI * 2 / 5 },
                    { name: '拦网', value: this.player.skills.block, angle: -Math.PI / 2 + Math.PI * 4 / 5 },
                    { name: '垫球', value: this.player.skills.dig, angle: -Math.PI / 2 + Math.PI * 6 / 5 },
                    { name: '托球', value: this.player.skills.set, angle: -Math.PI / 2 + Math.PI * 8 / 5 }
                ];
                
                // 绘制背景网格
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                for (let i = 1; i <= 5; i++) {
                    ctx.beginPath();
                    const r = (radius / 5) * i;
                    skills.forEach((skill, index) => {
                        const x = centerX + r * Math.cos(skill.angle);
                        const y = centerY + r * Math.sin(skill.angle);
                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    ctx.closePath();
                    ctx.stroke();
                }
                
                // 绘制轴线
                ctx.strokeStyle = '#ccc';
                ctx.lineWidth = 1;
                skills.forEach(skill => {
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    const x = centerX + radius * Math.cos(skill.angle);
                    const y = centerY + radius * Math.sin(skill.angle);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                });
                
                // 绘制数据区域
                ctx.fillStyle = 'rgba(102, 126, 234, 0.3)';
                ctx.strokeStyle = 'rgba(102, 126, 234, 0.8)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                skills.forEach((skill, index) => {
                    const value = Math.min(skill.value, 100);
                    const r = (radius / 100) * value;
                    const x = centerX + r * Math.cos(skill.angle);
                    const y = centerY + r * Math.sin(skill.angle);
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                
                // 绘制数据点
                ctx.fillStyle = '#667eea';
                skills.forEach(skill => {
                    const value = Math.min(skill.value, 100);
                    const r = (radius / 100) * value;
                    const x = centerX + r * Math.cos(skill.angle);
                    const y = centerY + r * Math.sin(skill.angle);
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // 绘制标签
                ctx.fillStyle = '#333';
                ctx.font = 'bold 13px "Microsoft YaHei", Arial, sans-serif';
                
                skills.forEach((skill, index) => {
                    const labelRadius = radius + 30;
                    const x = centerX + labelRadius * Math.cos(skill.angle);
                    const y = centerY + labelRadius * Math.sin(skill.angle);
                    
                    // 根据索引精确设置每个标签的对齐方式
                    switch(index) {
                        case 0: // 发球 - 正上方
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            break;
                        case 1: // 扣球 - 右上
                            ctx.textAlign = 'left';
                            ctx.textBaseline = 'middle';
                            break;
                        case 2: // 拦网 - 右下
                            ctx.textAlign = 'left';
                            ctx.textBaseline = 'middle';
                            break;
                        case 3: // 垫球 - 左下
                            ctx.textAlign = 'right';
                            ctx.textBaseline = 'middle';
                            break;
                        case 4: // 托球 - 左上
                            ctx.textAlign = 'right';
                            ctx.textBaseline = 'middle';
                            break;
                    }
                    
                    ctx.fillText(skill.name, x, y);
                });
            }
            
            applyEffect(effect) {
                // 检查effect是否存在
                if (!effect) {
                    console.error('applyEffect called with undefined or null effect');
                    return;
                }
                
                if (effect.reset) {
                    // 删除存档
                    this.deleteSave();
                    
                    // 重置游戏状态
                    this.player = {
                        name: generateRandomName(),  // 使用随机名字而不是固定的"新生"
                        week: TEST_MODE ? TEST_CONFIG.skipToWeek : 1,
                        trainingCount: 0,
                        maxTrainingPerWeek: TEST_MODE ? TEST_CONFIG.maxTrainingPerWeek : 3,
                        energy: TEST_MODE ? TEST_CONFIG.initialEnergy : 100,
                        maxEnergy: TEST_MODE ? TEST_CONFIG.initialEnergy : 100,
                        mood: TEST_MODE ? TEST_CONFIG.initialMood : 80,
                        stress: TEST_MODE ? TEST_CONFIG.initialStress : 20,
                        reputation: TEST_MODE ? TEST_CONFIG.initialReputation : 10,
                        money: TEST_MODE ? TEST_CONFIG.initialMoney : 100,
                        weeklyAllowance: 120,  // 每周零花钱
                        team: 'none',
                        position: 'none',
                        positionLevel: 0,
                        adaptationWeeks: 0,
                        skills: {
                            serve: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                            spike: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                            block: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                            dig: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                            set: TEST_MODE ? TEST_CONFIG.initialSkills : 0
                        },
                        attributes: {
                            strength: 0,
                            agility: 0,
                            stamina: 0,
                            coordination: 0
                        },
                        relationships: {
                            coach: 50
                            // teammates 已移除，改用队友个人默契度
                        },
                        achievements: [],
                        matchesPlayed: 0,
                        matchesWon: 0,
                        performanceHistory: [],
                        averagePerformance: 0
                    };
                    
                    // 重置其他游戏状态
                    this.rerollsRemaining = 5;
                    this.currentScene = 'nameInput';
                    this.currentMatch = null;
                    this.currentGoal = 'collegeTryout'; // 重置目标为初始目标
                    this.justTrained = false;
                    this.lastEventType = null;
                    this.currentEvent = null;
                    this.currentEventType = null;
                    this.watchedEpisodes = []; // 重置看过的小排球剧集
                    this.weekStartNoticeShown = false; // 重置周初提示标志
                    this.teammates = []; // 重置队友
                    this.teamStats = { averageChemistry: 0, averageSkill: 0, atmosphere: 0 }; // 重置队伍统计
                    this.tournament = {
                        active: false,
                        type: null,
                        currentRound: null,
                        roundsCompleted: [],
                        matchesWon: 0,
                        matchesLost: 0,
                        eliminated: false,
                        finalRank: null
                    };
                    this.playerStats = {
                        // 训练相关
                        totalTrainings: 0,
                        trainingByType: {
                            serve: 0,
                            spike: 0,
                            block: 0,
                            dig: 0,
                            set: 0,
                            composite: 0
                        },
                        
                        // 比赛相关
                        casualMatchesPlayed: 0,
                        casualMatchesWon: 0,
                        formalMatchesPlayed: 0,
                        formalMatchesWon: 0,
                        tournamentRoundsWon: 0,
                        
                        // 消费相关
                        totalMoneySpent: 0,
                        equipmentPurchased: 0,
                        coachingPurchased: 0,
                        entertainmentSpent: 0,
                        
                        // 生活相关
                        gamesPlayed: 0,
                        moviesWatched: 0,
                        socialEvents: 0,
                        restTaken: 0,
                        
                        // 课余活动追踪（用于奇遇事件）
                        lifeActivities: {
                            scratchCard: 0,
                            movie: 0,
                            game: 0,
                            social: 0,
                            gift: 0,
                            rest: 0,
                            massage: 0,
                            library: 0,
                            casualMatch: 0,
                            friendlyMatch: 0,
                            work: 0,
                            food: 0
                        },
                        
                        // 奇遇事件追踪
                        triggeredEvents: [],
                        scratchCardJackpots: 0,
                        hasLoveInterest: false,
                        weeklyDateCount: 0,
                        permanentBuffs: {
                            scratchCardDiscount: false,
                            movieMembership: false,
                            foodDiscount: false,
                            workBonus: false,
                            trainingBonus: 0,
                            stressReduction: 0,
                            energyRecovery: 0,
                            moodRecovery: 0,
                            reputationGrowth: 0,
                            injuryReduction: 0
                        },
                        titles: [],
                        
                        // 特殊行为
                        positionChanges: 0,
                        perfectWeeks: 0,
                        burnoutWeeks: 0,
                        richestWeek: 0,
                        brokestWeek: Infinity,
                        
                        // 技能发展
                        initialSkills: {
                            serve: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                            spike: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                            block: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                            dig: TEST_MODE ? TEST_CONFIG.initialSkills : 0,
                            set: TEST_MODE ? TEST_CONFIG.initialSkills : 0
                        },
                        
                        // 刮刮乐统计
                        scratchCards: {
                            total: 0,
                            grand: 0,
                            first: 0,
                            second: 0,
                            third: 0,
                            consolation: 0,
                            none: 0,
                            totalSpent: 0,
                            totalEarned: 0
                        }
                    };
                    this.shopItems = this.initShopItems();
                    this.player.ownedItems = {
                        shoes: 'basic',
                        protection: false,
                        jersey: false,
                        trainingEquipment: [],
                        electronics: [],
                        books: []
                    };
                    this.player.activeBuffs = [];
                    this.player.purchaseCount = {};
                    this.adventureEvents = this.initAdventureEvents();
                    
                    // 随机分配初始技能（非测试模式）
                    if (!TEST_MODE) {
                        this.rollAttributes();
                    }
                    
                    // 更新UI
                    document.getElementById('character-panel').classList.remove('show');
                    document.getElementById('game-header').classList.remove('show');
                    this.updateUI();
                    
                    // 先显示场景，再更新名字和技能显示
                    this.showScene(this.currentScene);
                    
                    // 延迟更新名字输入框和初始技能显示
                    setTimeout(() => {
                        const nameInput = document.getElementById('player-name-input');
                        if (nameInput) {
                            nameInput.value = this.player.name;
                        }
                        this.updateInitialSkillsDisplay();
                    }, 100);
                    
                    return;
                }
                
                // 新增：处理正式比赛启动
                if (effect.startFormalMatch) {
                    this.startFormalMatch(
                        effect.startFormalMatch.matchType, 
                        effect.startFormalMatch.matchName
                    );
                    return;
                }
                
                if (effect.nextWeek) {
                    this.nextWeek();
                    return;
                }
                
                if (effect.eventResult) {
                    // 构建属性变化显示
                    let changesText = '<br><br><strong>属性变化：</strong><br>';
                    let hasChanges = false;
                    
                    if (effect.serve) {
                        changesText += `🎯 发球 ${effect.serve > 0 ? '+' : ''}${effect.serve}<br>`;
                        hasChanges = true;
                    }
                    if (effect.spike) {
                        changesText += `⚡ 扣球 ${effect.spike > 0 ? '+' : ''}${effect.spike}<br>`;
                        hasChanges = true;
                    }
                    if (effect.block) {
                        changesText += `🛡️ 拦网 ${effect.block > 0 ? '+' : ''}${effect.block}<br>`;
                        hasChanges = true;
                    }
                    if (effect.dig) {
                        changesText += `🏐 垫球 ${effect.dig > 0 ? '+' : ''}${effect.dig}<br>`;
                        hasChanges = true;
                    }
                    if (effect.set) {
                        changesText += `🤲 托球 ${effect.set > 0 ? '+' : ''}${effect.set}<br>`;
                        hasChanges = true;
                    }
                    if (effect.energy) {
                        changesText += `💪 体力 ${effect.energy > 0 ? '+' : ''}${effect.energy}<br>`;
                        hasChanges = true;
                    }
                    if (effect.mood) {
                        changesText += `😊 心情 ${effect.mood > 0 ? '+' : ''}${effect.mood}<br>`;
                        hasChanges = true;
                    }
                    if (effect.stress) {
                        changesText += `😰 压力 ${effect.stress > 0 ? '+' : ''}${effect.stress}<br>`;
                        hasChanges = true;
                    }
                    if (effect.reputation) {
                        changesText += `⭐ 声望 ${effect.reputation > 0 ? '+' : ''}${effect.reputation}<br>`;
                        hasChanges = true;
                    }
                    if (effect.money) {
                        changesText += `💰 金钱 ${effect.money > 0 ? '+' : ''}${effect.money}<br>`;
                        hasChanges = true;
                    }
                    if (effect.relationship) {
                        changesText += `👥 队友关系 ${effect.relationship > 0 ? '+' : ''}${effect.relationship}<br>`;
                        hasChanges = true;
                    }
                    
                    SCENES.eventResult.text = `<h2>✨ 结果</h2>
                    <p>${effect.eventResult}</p>
                    ${hasChanges ? changesText : ''}`;
                }
                
                if (effect.goalUpdate) {
                    this.currentGoal = effect.goalUpdate;
                }
                
                if (effect.eventType) {
                    this.lastEventType = effect.eventType;
                    
                    // 追踪生活活动统计
                    if (effect.lifeActivity) {
                        switch(effect.lifeActivity) {
                            case 'game':
                                this.playerStats.gamesPlayed++;
                                break;
                            case 'movie':
                                this.playerStats.moviesWatched++;
                                break;
                            case 'social':
                                this.playerStats.socialEvents++;
                                break;
                            case 'rest':
                                this.playerStats.restTaken++;
                                break;
                        }
                    }
                }
                
                // 记录最后训练的技能类型（用于专精请教事件）
                if (effect.lastTraining) {
                    this.lastTrainingSkill = effect.lastTraining;
                }
                
                if (effect.trained) {
                    this.player.trainingCount++;
                    
                    // 统计训练次数
                    this.playerStats.totalTrainings++;
                    
                    // 统计各技能训练次数（简化：根据effect中的技能判断）
                    if (effect.serve) this.playerStats.trainingByType.serve++;
                    if (effect.spike) this.playerStats.trainingByType.spike++;
                    if (effect.block) this.playerStats.trainingByType.block++;
                    if (effect.dig) this.playerStats.trainingByType.dig++;
                    if (effect.set) this.playerStats.trainingByType.set++;
                    
                    // 如果多个技能都有提升，算作组合训练
                    const skillCount = [effect.serve, effect.spike, effect.block, effect.dig, effect.set].filter(v => v).length;
                    if (skillCount >= 3) {
                        this.playerStats.trainingByType.composite++;
                    }
                    
                    // 训练后自动保存
                    this.saveGame();
                }
                
                // 应用职业训练加成
                const skillEffects = ['serve', 'spike', 'block', 'dig', 'set'];
                skillEffects.forEach(skill => {
                    if (effect[skill]) {
                        const bonus = this.getTrainingBonus(skill);
                        const finalValue = Math.round(effect[skill] * (1 + bonus));
                        this.player.skills[skill] = Math.min(100, this.player.skills[skill] + finalValue);
                        
                        // 如果有加成，显示提示
                        if (bonus > 0 && effect.trained) {
                            console.log(`${skill} 训练获得职业加成: ${bonus * 100}%`);
                        }
                    }
                });
                
                if (effect.energy) this.player.energy = Math.max(0, Math.min(this.player.maxEnergy, this.player.energy + effect.energy));
                if (effect.maxEnergyBonus) this.player.maxEnergy = Math.min(150, this.player.maxEnergy + effect.maxEnergyBonus);
                if (effect.mood) this.player.mood = Math.max(0, Math.min(100, this.player.mood + effect.mood));
                if (effect.stress) this.player.stress = Math.max(0, Math.min(100, this.player.stress + effect.stress));
                if (effect.reputation) this.player.reputation += effect.reputation;
                if (effect.money) this.player.money += effect.money;
                if (effect.weeklyAllowance) this.player.weeklyAllowance = effect.weeklyAllowance;
                if (effect.team) {
                    const oldTeam = this.player.team;
                    this.player.team = effect.team;
                    
                    // 如果从院队升入校队，处理队友转换（方案B）
                    if (oldTeam === 'college' && effect.team === 'university' && this.teammates.length > 0) {
                        this.transferTeammatesToUniversity();
                    }
                }
                
                // 新的默契度系统
                if (effect.teamChemistry && this.teammates && this.teammates.length > 0) {
                    for (let teammate of this.teammates) {
                        teammate.chemistry = Math.max(0, Math.min(100, teammate.chemistry + effect.teamChemistry));
                    }
                    this.updateTeamStats();
                    // 检查是否解锁新技能
                    if (this.checkAndUnlockSkills) {
                        this.checkAndUnlockSkills();
                    }
                }
                
                if (effect.teammateChemistry && this.teammates && this.teammates.length > 0) {
                    if (effect.teammateChemistry.random !== undefined) {
                        const randomTeammate = this.teammates[Math.floor(Math.random() * this.teammates.length)];
                        randomTeammate.chemistry = Math.max(0, Math.min(100, randomTeammate.chemistry + effect.teammateChemistry.random));
                        this.updateTeamStats();
                        // 检查是否解锁新技能
                        if (this.checkAndUnlockSkills) {
                            this.checkAndUnlockSkills();
                        }
                    } else if (effect.teammateChemistry.index !== undefined) {
                        const teammate = this.teammates[effect.teammateChemistry.index];
                        if (teammate) {
                            teammate.chemistry = Math.max(0, Math.min(100, teammate.chemistry + effect.teammateChemistry.value));
                            this.updateTeamStats();
                            // 检查是否解锁新技能
                            if (this.checkAndUnlockSkills) {
                                this.checkAndUnlockSkills();
                            }
                        }
                    }
                }
                
                // 向后兼容：旧的 relationship 自动转换为 teamChemistry
                if (effect.relationship && this.teammates && this.teammates.length > 0) {
                    for (let teammate of this.teammates) {
                        teammate.chemistry = Math.max(0, Math.min(100, teammate.chemistry + effect.relationship));
                    }
                    this.updateTeamStats();
                }
                
                // 处理buff效果
                if (effect.buff) {
                    this.playerStats.permanentBuffs[effect.buff] = true;
                    console.log(`获得buff: ${effect.buff}`);
                }
                
                // 处理称号
                if (effect.title) {
                    if (!this.playerStats.titles) {
                        this.playerStats.titles = [];
                    }
                    if (!this.playerStats.titles.includes(effect.title)) {
                        this.playerStats.titles.push(effect.title);
                        console.log(`获得称号: ${effect.title}`);
                    }
                }
                
                this.updateUI();
                
                // 新增：支持回调函数
                if (effect.callback && typeof effect.callback === 'function') {
                    effect.callback();
                }
            }
            
            checkRequirement(req) {
                if (req.energy && this.player.energy < req.energy) return false;
                if (req.mood && this.player.mood < req.mood) return false;
                if (req.money && this.player.money < req.money) return false;
                if (req.team && this.player.team !== req.team) return false;
                if (req.reputation && this.player.reputation < req.reputation) return false;
                if (req.serve && this.player.skills.serve < req.serve) return false;
                if (req.spike && this.player.skills.spike < req.spike) return false;
                if (req.block && this.player.skills.block < req.block) return false;
                if (req.dig && this.player.skills.dig < req.dig) return false;
                if (req.set && this.player.skills.set < req.set) return false;
                if (req.maxCheck && req.trainingCount !== undefined) {
                    if (this.player.trainingCount > req.trainingCount) return false;
                }
                // 检查是否有队友
                if (req.teammates && (!this.teammates || this.teammates.length === 0)) return false;
                return true;
            }

            
            showScene(sceneId) {
                console.log('showScene called with:', sceneId);
                
                // 先处理特殊场景（不需要在SCENES中定义）
                // 排球点击小游戏
                if (sceneId === 'volleyballClickGame') {
                    this.startVolleyballClickGame();
                    return;
                }
                
                // 排球少年剧情
                if (sceneId === 'haikyuuEpisode') {
                    this.showHaikyuuEpisode();
                    return;
                }
                
                // 队友面板
                if (sceneId === 'teammates') {
                    this.renderTeammatesPanel();
                    return;
                }
                
                // 课余生活场景特殊渲染
                if (sceneId === 'lifeChoice') {
                    this.renderLifeChoice();
                    return;
                }
                
                // 商店场景特殊渲染
                if (sceneId === 'shopMain') {
                    this.renderShopMain();
                    return;
                }
                
                if (sceneId.startsWith('shopCategory_')) {
                    const category = sceneId.replace('shopCategory_', '');
                    this.renderShopCategory(category);
                    return;
                }
                
                // 职业选择场景特殊渲染
                if (sceneId === 'positionSelection') {
                    this.renderPositionSelection();
                    return;
                }
                
                // 比赛场景
                if (sceneId === 'casualMatch') {
                    this.startMatch('casual');
                    return;
                }
                
                // 友谊赛场景
                if (sceneId === 'friendlyMatch') {
                    this.startMatch('friendly');
                    return;
                }
                
                // matchResult 场景现在作为普通场景处理（由 showMatchResultByPerformance 创建）
                // 不再特殊处理
                
                // 检查SCENES中的常规场景
                const scene = SCENES[sceneId];
                if (!scene) {
                    console.error('Scene not found:', sceneId);
                    alert('场景未找到: ' + sceneId);
                    return;
                }
                
                // 动态更新特定场景
                if (sceneId === 'start' && this.player.name !== '新生') {
                    scene.text = `<h2>🎓 大学新生活</h2>
                    <p><strong>${this.player.name}</strong>，你是一名刚入学的大一新生，从未接触过排球。</p>
                    <p>开学第一周，你路过体育馆，看到排球社团正在招新。阳光透过窗户洒在球场上，学长学姐们矫健的身影让你心生向往。</p>
                    <p>"想试试吗？"一位学姐笑着向你招手。</p>`;
                }
                
                if (sceneId === 'weeklyHub') {
                    this.updateWeeklyHub();
                }
                
                if (sceneId === 'weekEnd') {
                    console.log('=== 结束本周逻辑开始 ===');
                    console.log('当前训练次数:', this.player.trainingCount);
                    console.log('最大训练次数:', this.player.maxTrainingPerWeek);
                    const remainingTraining = this.player.maxTrainingPerWeek - this.player.trainingCount;
                    console.log('剩余训练次数:', remainingTraining);
                    console.log('玩家对象:', this.player);
                    console.log('跳过确认标志:', this.skipWeekEndConfirmation);
                    
                    // 如果还有剩余训练次数且没有跳过确认标志，弹出确认对话框
                    if (remainingTraining > 0 && !this.skipWeekEndConfirmation) {
                        console.log('剩余训练次数 > 0，准备弹出确认对话框');
                        
                        const modal = document.getElementById('event-modal');
                        const title = document.getElementById('event-modal-title');
                        const text = document.getElementById('event-modal-text');
                        const choicesDiv = document.getElementById('event-modal-choices');
                        
                        console.log('Modal元素:', modal);
                        console.log('Title元素:', title);
                        console.log('Text元素:', text);
                        console.log('ChoicesDiv元素:', choicesDiv);
                        
                        // 重置modal状态，确保可以显示
                        modal.style.display = '';
                        modal.classList.remove('show');
                        
                        title.textContent = '⚠️ 确认结束本周';
                        text.innerHTML = `
                            <p style="text-align: center; line-height: 1.8;">
                                本周还有 <strong style="color: #e74c3c;">${remainingTraining}</strong> 次训练机会未使用<br>
                                确定要结束本周吗？
                            </p>
                        `;
                        
                        choicesDiv.innerHTML = '';
                        
                        // 确认按钮
                        const confirmBtn = document.createElement('button');
                        confirmBtn.className = 'choice-btn';
                        confirmBtn.textContent = '✓ 确定结束';
                        const self = this; // 保存this引用
                        confirmBtn.onclick = function() {
                            console.log('点击了确定结束按钮');
                            console.log('this对象:', self);
                            console.log('准备关闭modal');
                            modal.classList.remove('show');
                            console.log('modal已关闭，设置跳过确认标志并重新调用showScene');
                            // 设置跳过确认标志，然后重新调用showScene
                            self.skipWeekEndConfirmation = true;
                            self.showScene('weekEnd');
                            // 重置标志
                            self.skipWeekEndConfirmation = false;
                        };
                        choicesDiv.appendChild(confirmBtn);
                        
                        // 取消按钮
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'choice-btn';
                        cancelBtn.textContent = '✗ 取消';
                        cancelBtn.onclick = function() {
                            console.log('点击了取消按钮');
                            modal.classList.remove('show');
                            // 返回周选择界面
                            self.currentScene = 'weeklyHub';
                            self.showScene('weeklyHub');
                        };
                        choicesDiv.appendChild(cancelBtn);
                        
                        console.log('准备显示modal，添加show类');
                        // 使用 setTimeout 确保 DOM 更新后再添加 show 类
                        setTimeout(() => {
                            modal.classList.add('show');
                            console.log('Modal的classList:', modal.classList);
                            console.log('Modal的style.display:', modal.style.display);
                        }, 10);
                        console.log('=== 确认对话框已设置，return阻止继续执行 ===');
                        return; // 重要：阻止继续执行
                    } else {
                        console.log('剩余训练次数 = 0 或已确认，直接生成周总结');
                        // 训练次数已用完或已确认，直接生成周总结
                        this.generateWeeklySummary();
                        // 继续执行后面的场景显示逻辑
                    }
                }
                
                // 检查是否触发随机事件
                if (sceneId === 'checkRandomEvent' && this.lastEventType) {
                    const event = this.triggerRandomEvent(this.lastEventType);
                    this.lastEventType = null;
                    
                    if (event) {
                        this.showRandomEvent(event);
                        return;
                    } else {
                        // 没有触发事件，根据之前的类型决定下一步
                        this.currentScene = 'weeklyHub';
                        this.showScene('weeklyHub');
                        return;
                    }
                }
                
                const storyText = document.getElementById('story-text');
                const choicesDiv = document.getElementById('choices');
                
                // 处理文本：如果是函数则调用，否则直接使用
                const textContent = typeof scene.text === 'function' ? scene.text() : scene.text;
                storyText.innerHTML = textContent;
                
                // 如果是训练选择场景，更新当前体力显示
                if (sceneId === 'trainingChoice') {
                    const energyDisplay = document.getElementById('current-energy-display');
                    if (energyDisplay) {
                        energyDisplay.textContent = this.player.energy;
                    }
                }
                
                choicesDiv.innerHTML = '';
                
                scene.choices.forEach(choice => {
                    // 如果有分隔符，先添加分隔符
                    if (choice.separator && choice.separatorText) {
                        const separator = document.createElement('div');
                        separator.innerHTML = choice.separatorText;
                        separator.style.marginTop = '10px';
                        choicesDiv.appendChild(separator);
                    }
                    
                    // 如果只是分隔符（没有text），不创建按钮
                    if (!choice.text || choice.text.trim() === '') {
                        return;
                    }
                    
                    const button = document.createElement('button');
                    
                    // 判断是否是重要按钮（选拔、比赛等关键流程）
                    const importantKeywords = ['选拔', '开始比赛', '加入', '挑战', '参加比赛'];
                    const isImportant = importantKeywords.some(keyword => choice.text.includes(keyword));
                    
                    button.className = isImportant ? 'choice-btn-important' : 'choice-btn';
                    
                    // 如果有effect且是训练类型，动态生成带加成的文本
                    if (choice.effect && choice.effect.trained) {
                        // 提取原始文本的图标和名称部分
                        const match = choice.text.match(/^([🎯⚡🛡️🤸🙌🔥]+\s*[\u4e00-\u9fa5]+)/);
                        const baseName = match ? match[1] : choice.text.split('（')[0];
                        const effectPreview = this.getEffectPreview(choice.effect);
                        button.textContent = baseName + effectPreview;
                    } else {
                        button.textContent = choice.text;
                    }
                    
                    if (choice.requirement) {
                        const meetsRequirement = this.checkRequirement(choice.requirement);
                        if (!meetsRequirement) {
                            button.disabled = true;
                            button.textContent += ' (条件不足)';
                        }
                    }
                    
                    button.onclick = () => {
                        // 防止重复点击
                        if (button.disabled) return;
                        button.disabled = true;
                        
                        let shouldContinue = true;
                        
                        if (choice.effect) {
                            // 如果 effect 是函数，直接执行它
                            if (typeof choice.effect === 'function') {
                                choice.effect();
                                // 函数可能会处理场景跳转，所以检查是否有 next
                                if (!choice.next) {
                                    return;  // 没有 next，函数自己处理跳转
                                }
                            } else {
                                // effect 是对象，使用 applyEffect 处理
                                // 检查是否有会改变场景的特殊效果
                                if (choice.effect.nextWeek || choice.effect.startFormalMatch) {
                                    // 这些效果会自己处理场景跳转，不需要继续
                                    this.applyEffect(choice.effect);
                                    return;  // 直接返回，不执行后面的 showScene
                                }
                                
                                // 检查是否有callback（如锦标赛继续按钮）
                                if (choice.effect.callback) {
                                    // 先应用其他效果（技能、声望等奖励）
                                    this.applyEffect(choice.effect);
                                    // callback会处理场景跳转，直接返回
                                    return;
                                }
                                
                                this.applyEffect(choice.effect);
                                
                                // 检查是否需要触发随机事件
                                if (choice.effect.eventType) {
                                    const event = this.triggerRandomEvent(choice.effect.eventType);
                                    if (event) {
                                        // 触发事件，暂不跳转场景
                                        this.showRandomEvent(event);
                                        return;
                                    }
                                }
                            }
                        }
                        
                        if (choice.next) {
                            this.currentScene = choice.next;
                            this.showScene(choice.next);
                        }
                    };
                    
                    choicesDiv.appendChild(button);
                });
            }
        }
        
        // 启动游戏
        let game;
        
        // 分享功能
        function shareGame() {
            const shareData = {
                title: '排球之星 - 从菜鸟到冠军',
                text: '我在玩排球之星，从菜鸟到冠军的成长之路！快来一起玩吧！',
                url: window.location.href
            };
            
            // 检查是否支持原生分享API（移动端）
            if (navigator.share) {
                navigator.share(shareData)
                    .then(() => {
                        console.log('分享成功');
                    })
                    .catch((error) => {
                        if (error.name !== 'AbortError') {
                            console.log('分享失败', error);
                            fallbackShare();
                        }
                    });
            } else {
                // 桌面端或不支持的浏览器，复制链接
                fallbackShare();
            }
        }
        
        function fallbackShare() {
            const url = window.location.href;
            
            // 尝试使用剪贴板API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url)
                    .then(() => {
                        showShareMessage('✅ 链接已复制到剪贴板！\n快去分享给朋友吧！');
                    })
                    .catch(() => {
                        showShareMessage('📋 请复制链接：\n' + url);
                    });
            } else {
                // 降级方案：显示链接让用户手动复制
                showShareMessage('📋 请复制链接：\n' + url);
            }
        }
        
        function showShareMessage(message) {
            // 创建临时提示框
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.85);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                font-size: 14px;
                z-index: 10000;
                text-align: center;
                white-space: pre-line;
                max-width: 80%;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 3秒后自动消失
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired');
            
            // 更新页面显示的版本号
            const versionElement = document.getElementById('game-version');
            if (versionElement) {
                versionElement.textContent = 'v' + GAME_VERSION;
            }
            
            try {
                console.log('Creating game instance...');
                game = new VolleyballGame();
                console.log('Game instance created:', game);
            } catch (e) {
                console.error('Error creating game:', e);
                alert('游戏初始化失败: ' + e.message);
            }
        });
    </script>
</body>
</html>

